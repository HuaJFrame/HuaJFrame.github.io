<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>数据库逆向工程</title>
    <link href="/2023/03/06/%E5%B7%A5%E5%85%B7/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"/>
    <url>/2023/03/06/%E5%B7%A5%E5%85%B7/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="MyBatis-Generator"><a href="#MyBatis-Generator" class="headerlink" title="MyBatis Generator"></a>MyBatis Generator</h2><h3 id="Maven插件依赖"><a href="#Maven插件依赖" class="headerlink" title="Maven插件依赖"></a>Maven插件依赖</h3><blockquote><p>实际需求修改请看 <a href="http://mybatis.org/generator/running/runningWithMaven.html">http://mybatis.org/generator/running/runningWithMaven.html</a></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 控制Maven在构建过程中相关配置 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 构建过程中用到的插件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 具体插件，逆向工程的操作是以构建过程中插件形式出现的 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.generator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 插件的依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 逆向工程的核心依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.generator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-generator-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 数据库连接池 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="逆向工程的配置文件"><a href="#逆向工程的配置文件" class="headerlink" title="逆向工程的配置文件"></a>逆向工程的配置文件</h3><p>文件名必须是：<code>generatorConfig.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">generatorConfiguration</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">generatorConfiguration</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 指定本地数据库驱动位置 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;classPathEntry location=&quot;/Program Files/IBM/SQLLIB/java/db2java.zip&quot; /&gt; --&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    targetRuntime: 执行生成的逆向工程的版本</span><br><span class="hljs-comment">    MyBatis3Simple: 生成基本的CRUD（清新简洁版）</span><br><span class="hljs-comment">    MyBatis3: 生成带条件的CRUD（奢华尊享版）</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;DB2Tables&quot;</span> <span class="hljs-attr">targetRuntime</span>=<span class="hljs-string">&quot;MyBatis3Simple&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 是否生成注释 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commentGenerator</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;suppressDate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;suppressAllComments&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">commentGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 数据库的连接信息 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdbcConnection</span> <span class="hljs-attr">driverClass</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">connectionURL</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">userId</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdbcConnection</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- javaBean的生成策略--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaModelGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.pojo&quot;</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;.\src\main\java&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;trimStrings&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaModelGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- SQL映射文件的生成策略 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sqlMapGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.mapper&quot;</span></span><br><span class="hljs-tag">                         <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;.\src\main\resources&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">sqlMapGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Mapper接口的生成策略 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaClientGenerator</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;XMLMAPPER&quot;</span></span><br><span class="hljs-tag">                             <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.mapper&quot;</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;.\src\main\java&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaClientGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 逆向分析的表 --&gt;</span><br>        <span class="hljs-comment">&lt;!-- tableName设置为*号，可以对应所有表，此时不写domainObjectName --&gt;</span><br>        <span class="hljs-comment">&lt;!-- domainObjectName属性指定生成出来的实体类的类名 --&gt;</span><br>        <span class="hljs-comment">&lt;!-- http://mybatis.org/generator/configreference/table.html --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;t_emp&quot;</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">&quot;Emp&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;t_dept&quot;</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">&quot;Dept&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">generatorConfiguration</span>&gt;</span><br></code></pre></td></tr></table></figure><p>运行命令: <code>mvn mybatis-generator:generate</code></p><h1 id="Mybaits-Plus"><a href="#Mybaits-Plus" class="headerlink" title="Mybaits-Plus"></a>Mybaits-Plus</h1><p>可以用idea MybaitsX插件</p><h2 id="代码生成器（新，3-5-1版本及以上）"><a href="#代码生成器（新，3-5-1版本及以上）" class="headerlink" title="代码生成器（新，3.5.1版本及以上）"></a>代码生成器（新，3.5.1版本及以上）</h2><blockquote><p>参考连接 <a href="https://baomidou.com/pages/981406/">https://baomidou.com/pages/981406/</a></p></blockquote><h3 id="Maven依赖"><a href="#Maven依赖" class="headerlink" title="Maven依赖"></a>Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.velocity<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>velocity-engine-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- lombok，按需导入 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>MyBatis Plus Generator</code>支持的模板引擎有<code>Velocity</code>、<code>Beetl</code>、<code>FreeMarker</code>，按需导入</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.security.util;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.FastAutoGenerator;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.config.OutputFile;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.DateType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.fill.Column;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeGenerator</span> &#123;<br>    <span class="hljs-comment">// 数据库URL，注意将URL改成你自己对应的数据库名称</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/security_example?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC&amp;rewriteBatchedStatements=true&quot;</span>;<br>    <span class="hljs-comment">//数据库用户名</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br>    <span class="hljs-comment">//数据库密码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;******&quot;</span>;<br>    <span class="hljs-comment">//注意将这个参数改成你自己项目的目录</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">OUT_PUT_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\java_project\\security-example\\src\\main&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">JAVA_PATH</span> <span class="hljs-operator">=</span> OUT_PUT_DIR + <span class="hljs-string">&quot;\\&quot;</span> + <span class="hljs-string">&quot;java&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">MAPPER_PATH</span> <span class="hljs-operator">=</span> OUT_PUT_DIR + <span class="hljs-string">&quot;\\&quot;</span> + <span class="hljs-string">&quot;resources\\mapper&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        FastAutoGenerator.create(URL, USER_NAME, PASSWORD)<br>                <span class="hljs-comment">// 全局配置</span><br>                .globalConfig((scanner, builder) -&gt; builder.author(scanner.apply(<span class="hljs-string">&quot;请输入作者名称？&quot;</span>)).fileOverride()<br>                        .outputDir(JAVA_PATH)<br>                        .dateType(DateType.ONLY_DATE)<br>                        .commentDate(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>)<br>                        .fileOverride()<br>                        .disableOpenDir())<br><br>                <span class="hljs-comment">// 包配置</span><br>                .packageConfig((scanner, builder) -&gt; builder.parent(scanner.apply(<span class="hljs-string">&quot;请输入包名？&quot;</span>))<br>                        .moduleName(<span class="hljs-string">&quot;security&quot;</span>)<br>                        .entity(<span class="hljs-string">&quot;entity&quot;</span>)<br>                        .service(<span class="hljs-string">&quot;service&quot;</span>)<br>                        .serviceImpl(<span class="hljs-string">&quot;service.impl&quot;</span>)<br>                        .mapper(<span class="hljs-string">&quot;mapper&quot;</span>)<br>                        .xml(<span class="hljs-string">&quot;mapper.xml&quot;</span>)<br>                        .controller(<span class="hljs-string">&quot;controller&quot;</span>)<br>                        .pathInfo(Collections.singletonMap(OutputFile.mapperXml, MAPPER_PATH))<br>                )<br><br>                <span class="hljs-comment">// 策略配置</span><br>                .strategyConfig((scanner, builder) -&gt; builder.addInclude(getTables(scanner.apply(<span class="hljs-string">&quot;请输入表名，多个英文逗号分隔？所有输入 all&quot;</span>)))<br>                        .addTablePrefix(<span class="hljs-string">&quot;t_&quot;</span>)<br>                        .controllerBuilder()<br>                        .enableRestStyle()<br>                        .serviceBuilder()<br>                        .formatServiceFileName(<span class="hljs-string">&quot;I%sService&quot;</span>)<br>                        .formatServiceImplFileName(<span class="hljs-string">&quot;%sServiceImp&quot;</span>)<br>                        .entityBuilder()<br>                        .enableLombok()<br>                        .enableRemoveIsPrefix()<br>                        .idType(IdType.AUTO)<br>                        .addTableFills(<br>                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Column</span>(<span class="hljs-string">&quot;create_time&quot;</span>, FieldFill.INSERT)<br>                        )<br>                        .mapperBuilder()<br>                        .enableBaseResultMap()<br>                        .enableBaseColumnList()<br>                        .build())<br><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                    模板引擎配置，默认 Velocity 可选模板引擎 Beetl 或 Freemarker</span><br><span class="hljs-comment">                   .templateEngine(new BeetlTemplateEngine())</span><br><span class="hljs-comment">                   .templateEngine(new FreemarkerTemplateEngine())</span><br><span class="hljs-comment">                 */</span><br>                .execute();<br><br>    &#125;<br><br>    <span class="hljs-comment">// 处理 all 情况</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">getTables</span><span class="hljs-params">(String tables)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;all&quot;</span>.equals(tables) ? Collections.emptyList() : Arrays.asList(tables.split(<span class="hljs-string">&quot;,&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>数据库代码自动生成器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常用正则表达式</title>
    <link href="/2023/03/05/%E5%B7%A5%E5%85%B7/%E5%B8%B8%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <url>/2023/03/05/%E5%B7%A5%E5%85%B7/%E5%B8%B8%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<blockquote><p>转自： <a href="https://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html">https://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html</a></p></blockquote><h3 id="一、校验数字的表达式"><a href="#一、校验数字的表达式" class="headerlink" title="一、校验数字的表达式"></a>一、校验数字的表达式</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">数字：^[0-9]*$<br><br>n位的数字：^\d&#123;n&#125;$<br><br>至少n位的数字：^\d&#123;n,&#125;$<br><br>m-n位的数字：^\d&#123;m,n&#125;$<br><br>零和非零开头的数字：^(0|[1-9][0-9]*)$<br><br>非零开头的最多带两位小数的数字：^([1-9][0-9]*)+(.[0-9]&#123;1,2&#125;)?$<br><br>带1-2位小数的正数或负数：^(\-)?\d+(\.\d&#123;1,2&#125;)?$<br><br>正数、负数、和小数：^(\-|\+)?\d+(\.\d+)?$<br><br>有两位小数的正实数：^[0-9]+(.[0-9]&#123;2&#125;)?$<br><br>有1~3位小数的正实数：^[0-9]+(.[0-9]&#123;1,3&#125;)?$<br><br>非零的正整数：^[1-9]\d*$ 或 ^([1-9][0-9]*)&#123;1,3&#125;$ 或 ^\+?[1-9][0-9]*$<br><br>非零的负整数：^\-[1-9][]0-9&quot;*$ 或 ^-[1-9]\d*$<br><br>非负整数：^\d+$ 或 ^[1-9]\d*|0$<br><br>非正整数：^-[1-9]\d*|0$ 或 ^((-\d+)|(0+))$<br><br>非负浮点数：^\d+(\.\d+)?$ 或 ^[1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0$<br><br>非正浮点数：^((-\d+(\.\d+)?)|(0+(\.0+)?))$ 或 ^(-([1-9]\d*\.\d*|0\.\d*[1-9]\d*))|0?\.0+|0$<br><br>正浮点数：^[1-9]\d*\.\d*|0\.\d*[1-9]\d*$ 或 ^(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*))$<br><br>负浮点数：^-([1-9]\d*\.\d*|0\.\d*[1-9]\d*)$ 或 ^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$<br><br>浮点数：^(-?\d+)(\.\d+)?$ 或 ^-?([1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0)$<br></code></pre></td></tr></table></figure><h3 id="二、校验字符的表达式"><a href="#二、校验字符的表达式" class="headerlink" title="二、校验字符的表达式"></a>二、校验字符的表达式</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">汉字：^[\u4e00-\u9fa5]&#123;0,&#125;$<br><br>英文和数字：^[A-Za-z0-9]+$ 或 ^[A-Za-z0-9]&#123;4,40&#125;$<br><br>长度为3-20的所有字符：^.&#123;3,20&#125;$<br><br>由26个英文字母组成的字符串：^[A-Za-z]+$<br><br>由26个大写英文字母组成的字符串：^[A-Z]+$<br><br>由26个小写英文字母组成的字符串：^[a-z]+$<br><br>由数字和26个英文字母组成的字符串：^[A-Za-z0-9]+$<br><br>由数字、26个英文字母或者下划线组成的字符串：^\w+$ 或 ^\w&#123;3,20&#125;$<br><br>中文、英文、数字包括下划线：^[\u4E00-\u9FA5A-Za-z0-9_]+$<br><br>中文、英文、数字但不包括下划线等符号：^[\u4E00-\u9FA5A-Za-z0-9]+$ 或 ^[\u4E00-\u9FA5A-Za-z0-9]&#123;2,20&#125;$<br><br>可以输入含有^%&amp;&#x27;,;=?$\&quot;等字符：[^%&amp;&#x27;,;=?$\x22]+<br><br>禁止输入含有~的字符：[^~\x22]+<br></code></pre></td></tr></table></figure><h3 id="三、特殊需求表达式"><a href="#三、特殊需求表达式" class="headerlink" title="三、特殊需求表达式"></a>三、特殊需求表达式</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">Email地址：^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$<br><br>域名：[a-zA-Z0-9][-a-zA-Z0-9]&#123;0,62&#125;(/.[a-zA-Z0-9][-a-zA-Z0-9]&#123;0,62&#125;)+/.?<br><br>InternetURL：[a-zA-z]+://[^\s]* 或 ^http://([\w-]+\.)+[\w-]+(/[\w-./?%&amp;=]*)?$<br><br>手机号码：^(13[0-9]|14[0-9]|15[0-9]|16[0-9]|17[0-9]|18[0-9]|19[0-9])\d&#123;8&#125;$ (由于工信部放号段不定时，所以建议使用泛解析 ^([1][3,4,5,6,7,8,9])\d&#123;9&#125;$)<br><br>电话号码(&quot;XXX-XXXXXXX&quot;、&quot;XXXX-XXXXXXXX&quot;、&quot;XXX-XXXXXXX&quot;、&quot;XXX-XXXXXXXX&quot;、&quot;XXXXXXX&quot;和&quot;XXXXXXXX)：^(\(\d&#123;3,4&#125;-)|\d&#123;3.4&#125;-)?\d&#123;7,8&#125;$ <br><br>国内电话号码(0511-4405222、021-87888822)：\d&#123;3&#125;-\d&#123;8&#125;|\d&#123;4&#125;-\d&#123;7&#125; <br><br>18位身份证号码(数字、字母x结尾)：^((\d&#123;18&#125;)|([0-9x]&#123;18&#125;)|([0-9X]&#123;18&#125;))$<br><br>帐号是否合法(字母开头，允许5-16字节，允许字母数字下划线)：^[a-zA-Z][a-zA-Z0-9_]&#123;4,15&#125;$<br><br>密码(以字母开头，长度在6~18之间，只能包含字母、数字和下划线)：^[a-zA-Z]\w&#123;5,17&#125;$<br><br>强密码(必须包含大小写字母和数字的组合，不能使用特殊字符，长度在8-10之间)：^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).&#123;8,10&#125;$<br><br>日期格式：^\d&#123;4&#125;-\d&#123;1,2&#125;-\d&#123;1,2&#125;<br><br>一年的12个月(01～09和1～12)：^(0?[1-9]|1[0-2])$<br><br>一个月的31天(01～09和1～31)：^((0?[1-9])|((1|2)[0-9])|30|31)$ <br><br>钱的输入格式：<br>    1. 有四种钱的表示形式我们可以接受:&quot;10000.00&quot; 和 &quot;10,000.00&quot;, 和没有 &quot;分&quot; 的 &quot;10000&quot; 和 &quot;10,000&quot;：^[1-9][0-9]*$ <br><br>    2. 这表示任意一个不以0开头的数字,但是,这也意味着一个字符&quot;0&quot;不通过,所以我们采用下面的形式：^(0|[1-9][0-9]*)$<br><br>    3. 一个0或者一个不以0开头的数字.我们还可以允许开头有一个负号：^(0|-?[1-9][0-9]*)$ <br><br>    4. 这表示一个0或者一个可能为负的开头不为0的数字.让用户以0开头好了.把负号的也去掉,因为钱总不能是负的吧.下面我们要加的是说明可能的小数部分：^[0-9]+(.[0-9]+)?$<br><br>    5. 必须说明的是,小数点后面至少应该有1位数,所以&quot;10.&quot;是不通过的,但是 &quot;10&quot; 和 &quot;10.2&quot; 是通过的：^[0-9]+(.[0-9]&#123;2&#125;)?$<br><br>    6. 这样我们规定小数点后面必须有两位,如果你认为太苛刻了,可以这样：^[0-9]+(.[0-9]&#123;1,2&#125;)?$ <br><br>    7. 这样就允许用户只写一位小数.下面我们该考虑数字中的逗号了,我们可以这样：^[0-9]&#123;1,3&#125;(,[0-9]&#123;3&#125;)*(.[0-9]&#123;1,2&#125;)?$<br><br>    8. 1到3个数字,后面跟着任意个 逗号+3个数字,逗号成为可选,而不是必须：^([0-9]+|[0-9]&#123;1,3&#125;(,[0-9]&#123;3&#125;)*)(.[0-9]&#123;1,2&#125;)?$<br><br>        备注：这就是最终结果了,别忘了&quot;+&quot;可以用&quot;*&quot;替代如果你觉得空字符串也可以接受的话(奇怪,为什么?)最后,别忘了在用函数时去掉去掉那个反斜杠,一般的错误都在这里<br><br>xml文件：^([a-zA-Z]+-?)+[a-zA-Z0-9]+\\.[x|X][m|M][l|L]$<br><br>中文字符的正则表达式：[\u4e00-\u9fa5]<br><br>双字节字符：[^\x00-\xff]    (包括汉字在内，可以用来计算字符串的长度(一个双字节字符长度计2，ASCII字符计1))<br><br>空白行的正则表达式：\n\s*\r    (可以用来删除空白行)<br><br>HTML标记的正则表达式：&lt;(\S*?)[^&gt;]*&gt;.*?&lt;/\1&gt;|&lt;.*? /&gt;    (网上流传的版本太糟糕，上面这个也仅仅能部分，对于复杂的嵌套标记依旧无能为力)<br><br>首尾空白字符的正则表达式：^\s*|\s*$或(^\s*)|(\s*$)    (可以用来删除行首行尾的空白字符(包括空格、制表符、换页符等等)，非常有用的表达式)<br><br>腾讯QQ号：[1-9][0-9]&#123;4,&#125;    (腾讯QQ号从10000开始)<br><br>中国邮政编码：[1-9]\d&#123;5&#125;(?!\d)    (中国邮政编码为6位数字)<br><br>IP地址：\d+\.\d+\.\d+\.\d+    (提取IP地址时有用)<br><br>IP地址：((?:(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d)\\.)&#123;3&#125;(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d))    (由@飞龙三少 提供,感谢共享)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>正则表达式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常用工具类</title>
    <link href="/2023/02/26/%E5%B7%A5%E5%85%B7/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
    <url>/2023/02/26/%E5%B7%A5%E5%85%B7/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<blockquote><p>均来自互联网，自己有些微改动，持续更新中</p></blockquote><h3 id="MD5加密"><a href="#MD5加密" class="headerlink" title="MD5加密"></a>MD5加密</h3><p>Maven 依赖–spring boot</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--md5加密依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MD5Util</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 盐</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SALT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;1a2b3c4d&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">md5</span><span class="hljs-params">(String src)</span>&#123;<br>        <span class="hljs-keyword">return</span> DigestUtils.md5Hex(src);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 第一次加密</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inputPass 前端输入的密码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 加密后的密码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  String <span class="hljs-title function_">inputPassToFormPass</span><span class="hljs-params">(String inputPass)</span>&#123;<br>        <span class="hljs-comment">//md5加密密码前，先对密码进行处理，按以下salt的规则处理密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span> + SALT.charAt(<span class="hljs-number">0</span>) + SALT.charAt(<span class="hljs-number">3</span>) +<br>                inputPass + SALT.charAt(<span class="hljs-number">2</span>) + SALT.charAt(<span class="hljs-number">5</span>);<br>        <span class="hljs-keyword">return</span> md5(str);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 第二次加密</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> formPass 第一次加密后的结果</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> salt 盐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 加密后的存入数据库的密码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">formPassToDBPass</span><span class="hljs-params">(String formPass, String salt)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span> + salt.charAt(<span class="hljs-number">1</span>) + salt.charAt(<span class="hljs-number">5</span>) + formPass + salt.charAt(<span class="hljs-number">3</span>) + salt.charAt(<span class="hljs-number">6</span>);<br>        <span class="hljs-keyword">return</span> md5(str);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 实际调用的方法，直接包含两次加密</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inputPass 前端输入密码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> salt 盐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 加密后的存入数据库的密码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">inputPassToDBPass</span><span class="hljs-params">(String inputPass, String salt)</span>&#123;<br>        <span class="hljs-comment">//第一次加密</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">formPass</span> <span class="hljs-operator">=</span> inputPassToFormPass(inputPass);<br>        <span class="hljs-comment">//第二次加密</span><br>        <span class="hljs-keyword">return</span> formPassToDBPass(formPass, salt);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试一下</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//b6f500ed7576bf832f970eb71479667c</span><br>        System.out.println(inputPassToFormPass(<span class="hljs-string">&quot;123456&quot;</span>));<br>        System.out.println(formPassToDBPass(<span class="hljs-string">&quot;b6f500ed7576bf832f970eb71479667c&quot;</span>, <span class="hljs-string">&quot;asdfg1243&quot;</span>));<br>        System.out.println(inputPassToDBPass(<span class="hljs-string">&quot;123456&quot;</span>, <span class="hljs-string">&quot;asdfg1243&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Cookies工具类"><a href="#Cookies工具类" class="headerlink" title="Cookies工具类"></a>Cookies工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CookieUtil</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 得到Cookie的值, 不编码</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName 名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCookieValue</span><span class="hljs-params">(HttpServletRequest request, String cookieName)</span> &#123;<br>        <span class="hljs-keyword">return</span> getCookieValue(request, cookieName, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 得到Cookie的值，根据isDecode判断是否解码</span><br><span class="hljs-comment">     * 默认解码格式为utf-8</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName 名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> isDecoder  是否解码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCookieValue</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                        String cookieName,</span><br><span class="hljs-params">                                        <span class="hljs-type">boolean</span> isDecoder)</span> &#123;<br>        Cookie[] cookieList = request.getCookies();<br>        <span class="hljs-keyword">if</span> (cookieList == <span class="hljs-literal">null</span> || cookieName == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">retValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//遍历cookies开始查找</span><br>            <span class="hljs-keyword">for</span> (Cookie cookie : cookieList) &#123;<br>                <span class="hljs-keyword">if</span> (cookie.getName().equals(cookieName)) &#123;<br>                    <span class="hljs-keyword">if</span> (isDecoder) &#123;<br>                        retValue = URLDecoder.decode(cookie.getValue(),<br>                                <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        retValue = cookie.getValue();<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> retValue;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 得到Cookie的值，可指定解码格式</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName   名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> encodeString 解码格式</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCookieValue</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                        String cookieName,</span><br><span class="hljs-params">                                        String encodeString)</span> &#123;<br>        Cookie[] cookieList = request.getCookies();<br>        <span class="hljs-keyword">if</span> (cookieList == <span class="hljs-literal">null</span> || cookieName == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">retValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (Cookie cookie : cookieList) &#123;<br>                <span class="hljs-keyword">if</span> (cookie.getName().equals(cookieName)) &#123;<br>                    retValue = URLDecoder.decode(cookie.getValue(),<br>                            encodeString);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> retValue;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置Cookie的值 不设置生效时间默认浏览器关闭即失效,也不编码</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName  名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieValue 需要设置的值</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                 HttpServletResponse response,</span><br><span class="hljs-params">                                 String cookieName,</span><br><span class="hljs-params">                                 String cookieValue)</span> &#123;<br>        setCookie(request, response, cookieName, cookieValue, -<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置Cookie的值 在指定时间内生效,但不编码</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName   名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieValue  需要设置的值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieMaxage 生效时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                 HttpServletResponse response,</span><br><span class="hljs-params">                                 String cookieName,</span><br><span class="hljs-params">                                 String cookieValue,</span><br><span class="hljs-params">                                 <span class="hljs-type">int</span> cookieMaxage)</span> &#123;<br>        setCookie(request, response, cookieName, cookieValue, cookieMaxage,<br>                <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置Cookie的值 不设置生效时间,可以选择是否编码</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName  名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieValue 设置值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> isEncode    是否编码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                 HttpServletResponse response,</span><br><span class="hljs-params">                                 String cookieName,</span><br><span class="hljs-params">                                 String cookieValue,</span><br><span class="hljs-params">                                 <span class="hljs-type">boolean</span> isEncode)</span> &#123;<br>        setCookie(request, response, cookieName, cookieValue, -<span class="hljs-number">1</span>, isEncode);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置Cookie的值 在指定时间内生效, 编码参数</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName   名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieValue  设置值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieMaxage 生效时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> isEncode     是否编码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                 HttpServletResponse response,</span><br><span class="hljs-params">                                 String cookieName,</span><br><span class="hljs-params">                                 String cookieValue,</span><br><span class="hljs-params">                                 <span class="hljs-type">int</span> cookieMaxage,</span><br><span class="hljs-params">                                 <span class="hljs-type">boolean</span> isEncode)</span> &#123;<br>        doSetCookie(request, response, cookieName, cookieValue, cookieMaxage, isEncode);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置Cookie的值 在指定时间内生效, 编码参数(指定编码)</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName   名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieValue  设置值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieMaxage 生效时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> encodeString 编码格式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                 HttpServletResponse response,</span><br><span class="hljs-params">                                 String cookieName,</span><br><span class="hljs-params">                                 String cookieValue,</span><br><span class="hljs-params">                                 <span class="hljs-type">int</span> cookieMaxage,</span><br><span class="hljs-params">                                 String encodeString)</span> &#123;<br>        doSetCookie(request, response, cookieName, cookieValue, cookieMaxage, encodeString);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除Cookie带cookie value</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName 名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                    HttpServletResponse response,</span><br><span class="hljs-params">                                    String cookieName)</span> &#123;<br>        doSetCookie(request, response, cookieName, <span class="hljs-string">&quot;&quot;</span>, -<span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置Cookie的值，并使其在指定时间内生效</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName   名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieValue  设置值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieMaxage 生效时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> isEncode     是否编码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSetCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                          HttpServletResponse response,</span><br><span class="hljs-params">                                          String cookieName,</span><br><span class="hljs-params">                                          String cookieValue,</span><br><span class="hljs-params">                                          <span class="hljs-type">int</span> cookieMaxage,</span><br><span class="hljs-params">                                          <span class="hljs-type">boolean</span> isEncode)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (cookieValue == <span class="hljs-literal">null</span>) &#123;<br>                cookieValue = <span class="hljs-string">&quot;&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isEncode) &#123;<br>                cookieValue = URLEncoder.encode(cookieValue, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(cookieName, cookieValue);<br>            <span class="hljs-keyword">if</span> (cookieMaxage &gt; <span class="hljs-number">0</span>) &#123;<br>                cookie.setMaxAge(cookieMaxage);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != request) &#123;<span class="hljs-comment">// 设置域名的cookie</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">domainName</span> <span class="hljs-operator">=</span> getDomainName(request);<br>                System.out.println(domainName);<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;localhost&quot;</span>.equals(domainName)) &#123;<br>                    cookie.setDomain(domainName);<br>                &#125;<br>            &#125;<br>            cookie.setPath(<span class="hljs-string">&quot;/&quot;</span>);<br>            response.addCookie(cookie);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置Cookie的值，并使其在指定时间内生效</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieName 名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieValue 值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cookieMaxage 有效时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> encodeString 编码格式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSetCookie</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                          HttpServletResponse response,</span><br><span class="hljs-params">                                          String cookieName,</span><br><span class="hljs-params">                                          String cookieValue,</span><br><span class="hljs-params">                                          <span class="hljs-type">int</span> cookieMaxage,</span><br><span class="hljs-params">                                          String encodeString)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (cookieValue == <span class="hljs-literal">null</span>) &#123;<br>                cookieValue = <span class="hljs-string">&quot;&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                cookieValue = URLEncoder.encode(cookieValue, encodeString);<br>            &#125;<br>            <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(cookieName, cookieValue);<br>            <span class="hljs-keyword">if</span> (cookieMaxage &gt; <span class="hljs-number">0</span>) &#123;<br>                cookie.setMaxAge(cookieMaxage);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != request) &#123;<span class="hljs-comment">// 设置域名的cookie</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">domainName</span> <span class="hljs-operator">=</span> getDomainName(request);<br>                System.out.println(domainName);<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;localhost&quot;</span>.equals(domainName)) &#123;<br>                    cookie.setDomain(domainName);<br>                &#125;<br>            &#125;<br>            cookie.setPath(<span class="hljs-string">&quot;/&quot;</span>);<br>            response.addCookie(cookie);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得域名或ip地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">getDomainName</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">domainName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 通过request对象获取访问的url地址</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">serverName</span> <span class="hljs-operator">=</span> request.getRequestURL().toString();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;&quot;</span>.equals(serverName)) &#123;<br>            domainName = <span class="hljs-string">&quot;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 将url转换为小写</span><br>            serverName = serverName.toLowerCase();<br>            <span class="hljs-comment">// 如果url地址是以http://开头 将http://截取</span><br>            <span class="hljs-keyword">if</span> (serverName.startsWith(<span class="hljs-string">&quot;http://&quot;</span>)) &#123;<br>                serverName = serverName.substring(<span class="hljs-number">7</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (serverName.startsWith(<span class="hljs-string">&quot;https://&quot;</span>)) &#123;<br>                serverName = serverName.substring(<span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-comment">//截取后的长度</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> serverName.length();<br>            <span class="hljs-comment">// 判断url地址是否包含&quot;/&quot;</span><br>            <span class="hljs-keyword">if</span> (serverName.contains(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>                <span class="hljs-comment">//得到第一个&quot;/&quot;出现的位置</span><br>                end = serverName.indexOf(<span class="hljs-string">&quot;/&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">// 截取</span><br>            serverName = serverName.substring(<span class="hljs-number">0</span>, end);<br>            <span class="hljs-keyword">if</span>(serverName.matches(<span class="hljs-string">&quot;.*[a-zA-z].*&quot;</span>))&#123;<br>                <span class="hljs-comment">// 根据&quot;.&quot;进行分割</span><br>                <span class="hljs-keyword">final</span> String[] domains = serverName.split(<span class="hljs-string">&quot;\\.&quot;</span>);<br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> domains.length;<br>                <span class="hljs-keyword">if</span> (len &gt; <span class="hljs-number">3</span>) &#123;<br>                    <span class="hljs-comment">// www.xxx.com.cn</span><br>                    domainName = domains[len - <span class="hljs-number">3</span>] + <span class="hljs-string">&quot;.&quot;</span> + domains[len - <span class="hljs-number">2</span>] + <span class="hljs-string">&quot;.&quot;</span> +<br>                            domains[len - <span class="hljs-number">1</span>];<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len &gt; <span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-comment">// xxx.com or xxx.cn</span><br>                    domainName = domains[len - <span class="hljs-number">2</span>] + <span class="hljs-string">&quot;.&quot;</span> + domains[len - <span class="hljs-number">1</span>];<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    domainName = serverName;<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">//127.0.0.1——ip地址情况</span><br>                domainName = serverName;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (domainName.indexOf(<span class="hljs-string">&quot;:&quot;</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>            String[] ary = domainName.split(<span class="hljs-string">&quot;:&quot;</span>);<br>            domainName = ary[<span class="hljs-number">0</span>];<br>        &#125;<br>        <span class="hljs-keyword">return</span> domainName;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="电话号码校验工具类"><a href="#电话号码校验工具类" class="headerlink" title="电话号码校验工具类"></a>电话号码校验工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidatorUtil</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 电话号码正则</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">MOBILE_PATTERN</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;[1]([3-9])[0-9]&#123;9&#125;$&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isMobile</span><span class="hljs-params">(String mobile)</span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(mobile)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> MOBILE_PATTERN.matcher(mobile);<br>        <span class="hljs-keyword">return</span> matcher.matches();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="UUID工具类"><a href="#UUID工具类" class="headerlink" title="UUID工具类"></a>UUID工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 生成UUID的工具类，去除短横线-</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UUIDUtil</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">uuid</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> UUID.randomUUID().toString().replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="JSON工具类"><a href="#JSON工具类" class="headerlink" title="JSON工具类"></a>JSON工具类</h3><h4 id="基于Jcakson"><a href="#基于Jcakson" class="headerlink" title="基于Jcakson"></a>基于<code>Jcakson</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonParseException;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.JavaType;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.JsonMappingException;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Json工具类</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFarmer</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonUtil</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将对象转换成json字符串</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> obj 对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 字符串</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">object2JsonStr</span><span class="hljs-params">(Object obj)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> objectMapper.writeValueAsString(obj);<br>        &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>            <span class="hljs-comment">//打印异常信息</span><br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将字符串转换为对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jsonStr 对象字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> clazz 对象类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt; 泛型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">jsonStr2Object</span><span class="hljs-params">(String jsonStr, Class&lt;T&gt; clazz)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> objectMapper.readValue(jsonStr.getBytes(StandardCharsets.UTF_8), clazz);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将json数据转换成pojo对象list</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jsonStr list字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beanType 对象类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt; 泛型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> list集合</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_">jsonToList</span><span class="hljs-params">(String jsonStr, Class&lt;T&gt; beanType)</span> &#123;<br>        <span class="hljs-type">JavaType</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> objectMapper.getTypeFactory().constructParametricType(List.class, beanType);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> objectMapper.readValue(jsonStr, javaType);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="JWT工具类"><a href="#JWT工具类" class="headerlink" title="JWT工具类"></a>JWT工具类</h3><h4 id="基于jjwt"><a href="#基于jjwt" class="headerlink" title="基于jjwt"></a>基于jjwt</h4><blockquote><p>详情可见 <a href="https://github.com/jwtk/jjwt">https://github.com/jwtk/jjwt</a></p></blockquote><h5 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--jwt--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span> <span class="hljs-comment">&lt;!-- or jjwt-gson if Gson is preferred --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.security.util;<br><br><span class="hljs-keyword">import</span> io.jsonwebtoken.*;<br><span class="hljs-keyword">import</span> io.jsonwebtoken.security.Keys;<br><br><span class="hljs-keyword">import</span> javax.crypto.SecretKey;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFarmer</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtils</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 过期时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">EXPIRE</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 密钥，动态生成的密钥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SecretKey</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> Keys.secretKeyFor(SignatureAlgorithm.HS256);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成token</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> claims 要传送消息map</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(Map&lt;String,Object&gt; claims)</span> &#123;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">nowDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        <span class="hljs-comment">//过期时间,设定为一分钟</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expireDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + EXPIRE);<br>        <span class="hljs-comment">//头部信息,可有可无</span><br>        Map&lt;String, Object&gt; header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);<br>        header.put(<span class="hljs-string">&quot;typ&quot;</span>, <span class="hljs-string">&quot;jwt&quot;</span>);<br><br>        <span class="hljs-comment">//更强的密钥,JDK11起才能用</span><br>        <span class="hljs-comment">//  KeyPair keyPair = Keys.keyPairFor(SignatureAlgorithm.RS256);</span><br>        <span class="hljs-comment">//  PrivateKey key1 =  keyPair.getPrivate();  // 私钥</span><br>        <span class="hljs-comment">//PublicKey key2 =  keyPair.getPublic();  //公钥</span><br><br>        <span class="hljs-keyword">return</span> Jwts.builder().setHeader(header)<br>                <span class="hljs-comment">// .setSubject(&quot;----&quot;)//主题</span><br>                <span class="hljs-comment">// .setIssuer(&quot;----&quot;) //发送方</span><br>                .setClaims(claims)  <span class="hljs-comment">//自定义claims</span><br>                .setIssuedAt(nowDate)<span class="hljs-comment">//当前时间</span><br>                .setExpiration(expireDate) <span class="hljs-comment">//过期时间</span><br>                .signWith(KEY)<span class="hljs-comment">//签名算法和key</span><br>                .compact();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> header  传入头部信息map</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> claims  要传送消息map</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">( Map&lt;String, Object&gt; header, Map&lt;String,Object&gt; claims)</span> &#123;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">nowDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        <span class="hljs-comment">//过期时间,设定为一分钟</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expireDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + EXPIRE);<br><br>        <span class="hljs-keyword">return</span> Jwts.builder().setHeader(header)<br>                <span class="hljs-comment">// .setSubject(&quot;--------&quot;)//主题</span><br>                <span class="hljs-comment">//    .setIssuer(&quot;-------&quot;) //发送方</span><br>                .setClaims(claims)  <span class="hljs-comment">//自定义claims</span><br>                .setIssuedAt(nowDate)<span class="hljs-comment">//当前时间</span><br>                .setExpiration(expireDate) <span class="hljs-comment">//过期时间</span><br>                .signWith(KEY)<span class="hljs-comment">//签名算法和key</span><br>                .compact();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断是不是jwt签名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token 传入签名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSigned</span><span class="hljs-params">(String token)</span>&#123;<br>        <span class="hljs-keyword">return</span>  Jwts.parserBuilder()<br>                    .setSigningKey(KEY)<br>                    .build()<br>                    .isSigned(token);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 校验签名是否正确</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verify</span><span class="hljs-params">(String token)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Jwts.parserBuilder()<br>                    .setSigningKey(KEY)<br>                    .build()<br>                    .parseClaimsJws(token);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<span class="hljs-keyword">catch</span> (JwtException e)&#123;<br>            System.out.println(e.getMessage());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取payload 部分内容（即要传的信息）</span><br><span class="hljs-comment">     * 使用方法：如获取userId：getClaim(token).get(&quot;userId&quot;);</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Claims <span class="hljs-title function_">getClaim</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            claims = Jwts.parserBuilder()<br>                    .setSigningKey(KEY)<br>                    .build()<br>                    .parseClaimsJws(token)<br>                    .getBody();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> claims;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取头部信息map</span><br><span class="hljs-comment">     * 使用方法 : getHeader(token).get(&quot;alg&quot;);</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JwsHeader <span class="hljs-title function_">getHeader</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">JwsHeader</span> <span class="hljs-variable">header</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            header = Jwts.parserBuilder()<br>                    .setSigningKey(KEY)<br>                    .build()<br>                    .parseClaimsJws(token)<br>                    .getHeader();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> header;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取jwt发布时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">getIssuedAt</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">return</span> getClaim(token).getIssuedAt();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取jwt失效时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">getExpiration</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">return</span> getClaim(token).getExpiration();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 验证token是否失效</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> true:过期   false:没过期</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Date</span> <span class="hljs-variable">expiration</span> <span class="hljs-operator">=</span> getExpiration(token);<br>            <span class="hljs-keyword">return</span> expiration.before(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        &#125; <span class="hljs-keyword">catch</span> (ExpiredJwtException expiredJwtException) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 直接Base64解密获取header内容</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getHeaderByBase64</span><span class="hljs-params">(String token)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">header</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (isSigned(token))&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">byte</span>[] headerByte = Base64.getDecoder().decode(token.split(<span class="hljs-string">&quot;\\.&quot;</span>)[<span class="hljs-number">0</span>]);<br>                header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(headerByte);<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> header;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 直接Base64解密获取payload内容</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getPayloadByBase64</span><span class="hljs-params">(String token)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (isSigned(token)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">byte</span>[] payload_byte = Base64.getDecoder().decode(token.split(<span class="hljs-string">&quot;\\.&quot;</span>)[<span class="hljs-number">1</span>]);<br>                payload = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(payload_byte);<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> payload;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//用户自定义信息claims</span><br>        Map&lt;String,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);<br>        map.put(<span class="hljs-string">&quot;userId&quot;</span>,<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> generate(map);<br>        System.out.println(token);<br><br>        System.out.println(<span class="hljs-string">&quot;claim:&quot;</span> + getClaim(token).get(<span class="hljs-string">&quot;userId&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;header:&quot;</span> + getHeader(token));<br>        <span class="hljs-comment">// System.out.println(getIssuedAt(token));</span><br>        Claims claims=getClaim(token);<br><br>        <span class="hljs-comment">// System.out.println(getHeaderByBase64(token));</span><br>        System.out.println(getPayloadByBase64(token));<br><br>        SimpleDateFormat sdf=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy‐MM‐dd hh:mm:ss&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;签发时间:&quot;</span>+sdf.format(claims.getIssuedAt()));<br>        System.out.println(<span class="hljs-string">&quot;过期时间:&quot;</span>+sdf.format(claims.getExpiration()));<br>        System.out.println(<span class="hljs-string">&quot;当前时间:&quot;</span>+sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) );<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>工具类</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>网关</title>
    <link href="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/"/>
    <url>/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文将介绍什么是微服务网关，为什么要用网关并以 Spring Cloud Gateway 为例介绍网关的作用和用途</p><h1 id="什么是网关"><a href="#什么是网关" class="headerlink" title="什么是网关"></a>什么是网关</h1><p>是出现在系统边界上的一个面向 API 的、串行集中式的强管理服务，这里面的边界是企业 IT 系统的边界，可以理解为<strong>企业级应用防火墙</strong></p><p>作用是<strong>将外部访问与内部系统隔离</strong></p><p>API 网关是一个服务器，是系统对外的唯一入口。API 网关封装了系统内部架构，为每个客户端提供定制的 API。</p><p>所有的客户端和消费端都通过统一的网关接入微服务，在网关层<strong>处理非业务功能</strong></p><p>而 API 网关并非微服务场景中的必须组件，如下图：</p><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10001.png" class=""></div><br><p>不管有没有 API 网关，后端微服务均可以支持客户端的访问</p><p>但明显的是，当服务数量增加，随之复杂度也会增加，此时引入 API 网关也有如下好处：</p><ul><li>聚合接口使得服务对调用者透明，客户端与后端的耦合度降低</li><li>聚合后台服务，节省流量，提高性能，提升用户体验</li><li>提供安全、流控、过滤、缓存、计费、监控等 API 管理功能</li></ul><h1 id="为什么要用网关"><a href="#为什么要用网关" class="headerlink" title="为什么要用网关"></a>为什么要用网关</h1><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10002.png" class=""></div><br><p><strong>单体应用：</strong>浏览器发起请求到单体应用所在的机器，应用从数据库查询数据原路放回给浏览器，对于单体应用来说是不需要网关的</p><p><strong>微服务：</strong>微服务的应用可能部署在不同的机房，不同地区，不同域名下。此时客户端想要请求对应的服务，都需要知道机器的具体 IP 或者域名 URL，当微服务实例众多时，对于客户端来说是非常难记忆的，也是非常难维护的。</p><p>有了网关的话，客户端相关的请求直接发送到网关，由网关根据标识解析判断出具体的微服务地址，再把请求转发到微服务实例，这其中就把“记忆”的功能交给了网关，也就降低了客户端与服务之间的耦合</p><h1 id="Spring-Cloud-Gateway"><a href="#Spring-Cloud-Gateway" class="headerlink" title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h1><p>官方文档：<br><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html</a></p><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><ul><li><strong>路由（Route）：</strong>路由是网关最基础的部分，路由信息由 ID、目标 URI、一组断言和一组过滤器组成。如果断言路由为真，则说明请求的 URI 和配置相匹配</li><li><strong>断言（Predicate）：</strong>Java 8 中的断言函数。Spring Cloud Gateway 中的断言函数输入类型是 Spring 5.0 框架中的 ServerWebExchange。Spring Cloud Gateway 中的断言函数允许开发者去定义匹配来自于 Http Request 中的任何信息，比如请求头和参数等</li><li><strong>过滤器（Filter）：</strong>一个标准的 Spring Web Filter。Spring Cloud Gateway 中的 Filter 分为两种类型，分别是 Gateway Filter 和 Global Filter。过滤器将会对请求和响应进行处理</li></ul><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10003.png" class=""></div><br><p>如上图所示，其工作原理可以分为如下几步：</p><ol><li>客户端向 Spring Cloud Gateway 发起请求</li><li>由网关映射处理器映射 Gateway Handler Mapping 确定与请求相匹配的路由，将其发送到网关 Web 处理程序 Gateway Web Handler</li><li>网关 Web 处理程序 Gateway Web Handler 通过指定的 pre 逻辑的过滤器链将请求发送到代理服务</li><li>代理服务 Proxied Service 发起代理请求</li><li>代理服务 Proxied Service 请求后将再次通过指定的 post 逻辑的过滤器链将返回结果发送到网关 Web 处理器 Gateway Web Handler</li><li>最后再到网关处理器映射 Gateway Handler Mapping</li></ol><h2 id="路由配置案例"><a href="#路由配置案例" class="headerlink" title="路由配置案例"></a>路由配置案例</h2><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10004.png" class=""></div><br><h2 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h2><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10005.png" class=""></div><br><p>配置案例：</p><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10006.png" class=""></div><br><p>官网案例：<br><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gateway-request-predicates-factories">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gateway-request-predicates-factories</a></p><h2 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h2><h3 id="动态路由案例："><a href="#动态路由案例：" class="headerlink" title="动态路由案例："></a>动态路由案例：</h3><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10007.png" class=""></div><br><p>但是此刻的路由访问不了 order-service，当然也可以通过再一次配置达到访问的目的：</p><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10008.png" class=""></div><br><p>但是显然，如果随着动态路由的数量增多，那么配置的内容也会随之增加，所以就要<strong>遵循约定大于配置</strong>，因此有了如下配置：</p><p><strong>服务名称转发：</strong></p><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10009.png" class=""></div><br><h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>为客户端请求的 URL 再次添加前缀、后缀或者替换等操作或为拦截的请求进行额外的业务操作</p><p><strong>官方文档：</strong><br><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories</a></p><p><strong>案例：</strong></p><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10010.png" class=""></div><br><p><strong>自定义网关过滤器设置：</strong></p><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10011.png" class=""></div><br><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10012.png" class=""></div><br><p><strong>自定义全局过滤器：</strong></p><div align="center">    <img src="/2022/08/17/Spring-Project/Spring-Cloud/%E7%BD%91%E5%85%B3/10013.png" class=""></div><br>]]></content>
    
    
    <categories>
      
      <category>Spring Project</category>
      
      <category>Spring Cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
      <tag>网关</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>行为型模式</title>
    <link href="/2022/07/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/07/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>行为型模式（Behavioral Pattern）<strong>关注系统中对象之间的交互，研究系统在运行时对象之间的相互通信与协作，进一步明确对象的职责</strong></p><p><strong>行为型模式不仅仅关注类和对象本身，还重点关注它们之间的相互作用和职责划分</strong></p><p>行为型模式可以分为<strong>类行为型模式</strong>和<strong>对象行为型模式</strong>两种</p><p>类行为型模式通过继承关系在几个类之间分配行为，主要通过多态等方式来分配父类与子类的职责</p><p>对象行为型模式通过对象的关联关系来分配行为，主要通过对象关联来分配两个或多个类的职责</p><p>根据合成复用原则，大部分行为型模式都属于对象行为型设计模式</p><p>行为型模式共有十一种：</p><table><thead><tr><th align="center"><strong>设计原则名称</strong></th><th align="center"><strong>定义</strong></th><th align="center"><strong>使用频率</strong></th></tr></thead><tbody><tr><td align="center">职责链模式 （Chain of Responsibility Pattern）</td><td align="center">避免将一个请求的发送者与接收者耦合在一起，让多个对象都有机会处理请求。将接受请求的对象连成一条链，并且沿着这条链传递请求，直到有一个对象能够处理它为止</td><td align="center">⭐⭐</td></tr><tr><td align="center">命令模式 （Command Pattern）</td><td align="center">将一个请求封装为一个对象，从而可用不同的请求对客户进行参数化，对请求排队或者记录请求日志，以及支持可撤销的操作</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="center">解释器模式 （Interpreter Pattern）</td><td align="center">给定一个语言，定义它的文法的一种表示，并定义一个解释器，这个解释器使用该表示来解释语言中的句子</td><td align="center">⭐</td></tr><tr><td align="center">迭代器模式 （Interator Pattern）</td><td align="center">提供一种方法顺序访问一个聚合对象的各个元素，而又不用暴露该对象内部表示</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">中介者模式 （Mediator Pattern）</td><td align="center">定义一个对象来封装一系列对象的交互。中介者模式是各对象之间不需要显示地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互</td><td align="center">⭐⭐</td></tr><tr><td align="center">备忘录模式 （Memento Pattern）</td><td align="center">在不破坏封装的前提下捕获一个对象的内部状态，并在该对象之外保存这个状态，这样可以在以后将对象恢复到原先保存的状态</td><td align="center">⭐⭐</td></tr><tr><td align="center">观察者模式 （Oberver Pattern）</td><td align="center">定义对象之间的一种一对多依赖关系，使得每当一个对象状态发生改变时其相关依赖对象皆得到通知并被自动更新</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">状态模式 （State Pattern）</td><td align="center">允许一个对象在其内部状态改变时改变它的行为。对象看起来似乎修改了它的类</td><td align="center">⭐⭐⭐</td></tr><tr><td align="center">策略模式 （Strategy Pattern）</td><td align="center">定义一系列算法，将每一个算法封装起来，并让它们可以相互替换，策略模式让算法可以独立于使用它的客户而变化</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="center">模板方法模式 （Template Method Pattern）</td><td align="center">定义一个操作中算法的框架，而将一些步骤延迟到子类中。模板方法模式使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤</td><td align="center">⭐⭐⭐</td></tr><tr><td align="center">访问者模式 （Visitor Pattern）</td><td align="center">表示一个作用于某对象结构中的各个元素的操作。访问者模式让用户可以在不改变各元素的类的前提下定义作用于这些元素的新操作</td><td align="center">⭐</td></tr></tbody></table><h1 id="二、职责链模式"><a href="#二、职责链模式" class="headerlink" title="二、职责链模式"></a>二、职责链模式</h1><p>某公司欲开发一个软件系统的在线文档帮助系统，用户可以在任何一个查询环境中输入查询关键字，如果当前查询环境下没有相关内容，则系统会将查询按照一定的顺序转发给其他查询环境。<br>设查询环境如下：JavaSearchContext、SQLSearchContext、UMLSearchContext</p><h2 id="1-抽象处理者"><a href="#1-抽象处理者" class="headerlink" title="1. 抽象处理者"></a>1. 抽象处理者</h2><h3 id="1-1-AbstractSearchContext"><a href="#1-1-AbstractSearchContext" class="headerlink" title="1.1 AbstractSearchContext"></a>1.1 AbstractSearchContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractSearchContext</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> AbstractSearchContext abstractSearchContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAbstractSearchContext</span><span class="hljs-params">(AbstractSearchContext abstractSearchContext)</span> &#123;<br>        <span class="hljs-built_in">this</span>.abstractSearchContext = abstractSearchContext;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(String request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-具体处理者"><a href="#2-具体处理者" class="headerlink" title="2. 具体处理者"></a>2. 具体处理者</h2><h3 id="2-1-JavaSearchContext"><a href="#2-1-JavaSearchContext" class="headerlink" title="2.1 JavaSearchContext"></a>2.1 JavaSearchContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaSearchContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSearchContext</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(String request)</span> &#123;<br>        <span class="hljs-keyword">if</span> (request.equals(<span class="hljs-string">&quot;Java&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;在Java中搜索到该关键字&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.abstractSearchContext.handleRequest(request);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-SQLSearchContext"><a href="#2-2-SQLSearchContext" class="headerlink" title="2.2 SQLSearchContext"></a>2.2 SQLSearchContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQLSearchContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSearchContext</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(String request)</span> &#123;<br>        <span class="hljs-keyword">if</span> (request.equals(<span class="hljs-string">&quot;SQL&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;在SQL中搜索到该关键字&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.abstractSearchContext.handleRequest(request);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-UMLSearchContext"><a href="#2-3-UMLSearchContext" class="headerlink" title="2.3 UMLSearchContext"></a>2.3 UMLSearchContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UMLSearchContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSearchContext</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(String request)</span> &#123;<br>        <span class="hljs-keyword">if</span> (request.equals(<span class="hljs-string">&quot;UML&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;在UML中搜索到该关键字&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;该关键字在Java、SQL和UML中均不存在&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-客户端代码"><a href="#3-客户端代码" class="headerlink" title="3. 客户端代码"></a>3. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    AbstractSearchContext javaSC, sqlSC, umlSC;<br>    javaSC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaSearchContext</span>();<br>    sqlSC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLSearchContext</span>();<br>    umlSC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UMLSearchContext</span>();<br><br>    javaSC.setAbstractSearchContext(sqlSC);<br>    sqlSC.setAbstractSearchContext(umlSC);<br><br>    System.out.println(<span class="hljs-string">&quot;-----------测试一-----------&quot;</span>);<br>    javaSC.handleRequest(<span class="hljs-string">&quot;Java&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;-----------测试二-----------&quot;</span>);<br>    javaSC.handleRequest(<span class="hljs-string">&quot;SQL&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;-----------测试三-----------&quot;</span>);<br>    javaSC.handleRequest(<span class="hljs-string">&quot;UML&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;-----------测试四-----------&quot;</span>);<br>    javaSC.handleRequest(<span class="hljs-string">&quot;Python&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-优缺点和适用场景"><a href="#4-优缺点和适用场景" class="headerlink" title="4. 优缺点和适用场景"></a>4. 优缺点和适用场景</h2><h3 id="4-1-优点"><a href="#4-1-优点" class="headerlink" title="4.1 优点"></a>4.1 优点</h3><ul><li>使得一个对象无须知道是其他哪个对象处理请求，对象仅需知道该请求会被处理</li><li>链中的对象不知道链子的结构，由客户端进行创建，降低了系统的耦合</li><li>链中的对象仅需要维持一个后继者的引用，而不是链子中的所有成员，简化了对象之间的相互连接</li><li>支持动态的增删链中的对象，灵活性较强，并且无须修改其他类，符合开闭原则</li></ul><h3 id="4-2-缺点"><a href="#4-2-缺点" class="headerlink" title="4.2 缺点"></a>4.2 缺点</h3><ul><li>职责链较长时，牵连对象增多，增加系统的复杂度，并且不太好进行代码调试</li></ul><h3 id="4-3-适用场景"><a href="#4-3-适用场景" class="headerlink" title="4.3 适用场景"></a>4.3 适用场景</h3><ul><li>有多个对象可以处理同一个请求，具体那个对象处理该请求待运行时刻确认，客户端只管将请求提交到链上</li><li>在不指明指定的接收者时，向链子提交请求</li><li>客户端可以控制链子的具体对象和先后顺序以及长短</li><li>涉及对象的数量适中</li></ul><h1 id="三、命令模式"><a href="#三、命令模式" class="headerlink" title="三、命令模式"></a>三、命令模式</h1><p>别名<strong>动作（Action）模式</strong>或<strong>事务（Transaction）模式</strong></p><p>在PC端操作时，鼠标右键（RightClick）功能在桌面时可以用于显示桌面右键菜单（由DisplayDesktopRightClickMenu实现），在LOL游戏中还可以用于移动角色（由LolMoveCharacter实现）<br>现使用命令模式设计该系统，使得功能键类与功能类之间解耦，可以为同一个功能键设置不同的功能</p><h2 id="1-抽象命令类"><a href="#1-抽象命令类" class="headerlink" title="1. 抽象命令类"></a>1. 抽象命令类</h2><h3 id="1-1-Command"><a href="#1-1-Command" class="headerlink" title="1.1 Command"></a>1.1 Command</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Command</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-具体命令类"><a href="#2-具体命令类" class="headerlink" title="2. 具体命令类"></a>2. 具体命令类</h2><h3 id="2-1-DisplayCommand"><a href="#2-1-DisplayCommand" class="headerlink" title="2.1 DisplayCommand"></a>2.1 DisplayCommand</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisplayCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Command</span> &#123;<br><br>    <span class="hljs-keyword">private</span> DisplayDesktopRightClickMenu desktopRightClickMenu;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DisplayCommand</span><span class="hljs-params">()</span> &#123;<br>        desktopRightClickMenu = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayDesktopRightClickMenu</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        desktopRightClickMenu.display();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-MoveCommand"><a href="#2-2-MoveCommand" class="headerlink" title="2.2 MoveCommand"></a>2.2 MoveCommand</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoveCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Command</span> &#123;<br><br>    <span class="hljs-keyword">private</span> LolMoveCharacter lolMoveCharacter;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MoveCommand</span><span class="hljs-params">()</span> &#123;<br>        lolMoveCharacter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LolMoveCharacter</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        lolMoveCharacter.move();<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-调用者（Invoker）"><a href="#3-调用者（Invoker）" class="headerlink" title="3. 调用者（Invoker）"></a>3. 调用者（Invoker）</h2><h3 id="3-1-RightClick"><a href="#3-1-RightClick" class="headerlink" title="3.1 RightClick"></a>3.1 RightClick</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RightClick</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Command command;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCommand</span><span class="hljs-params">(Command command)</span> &#123;<br>        <span class="hljs-built_in">this</span>.command = command;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">click</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;单击右键&quot;</span>);<br>        command.execute();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-接收者（Receiver）"><a href="#4-接收者（Receiver）" class="headerlink" title="4. 接收者（Receiver）"></a>4. 接收者（Receiver）</h2><h3 id="4-1-DisplayDesktopRightClickMenu"><a href="#4-1-DisplayDesktopRightClickMenu" class="headerlink" title="4.1 DisplayDesktopRightClickMenu"></a>4.1 DisplayDesktopRightClickMenu</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisplayDesktopRightClickMenu</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;显示桌面右键菜单&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-LolMoveCharacter"><a href="#4-2-LolMoveCharacter" class="headerlink" title="4.2 LolMoveCharacter"></a>4.2 LolMoveCharacter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LolMoveCharacter</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">move</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;LOL游戏移动人物&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-客户端代码"><a href="#5-客户端代码" class="headerlink" title="5. 客户端代码"></a>5. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">RightClick</span> <span class="hljs-variable">rightClick</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RightClick</span>();<br>        Command moveCommand, displayCommand;<br>        moveCommand = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MoveCommand</span>(); <span class="hljs-comment">// 可以通过配置文件注入</span><br>        displayCommand = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayCommand</span>();<br><br>        rightClick.setCommand(moveCommand);<br>        rightClick.click();<br><br>        rightClick.setCommand(displayCommand);<br>        rightClick.click();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-优缺点及适用场景"><a href="#6-优缺点及适用场景" class="headerlink" title="6. 优缺点及适用场景"></a>6. 优缺点及适用场景</h2><h3 id="6-1-优点"><a href="#6-1-优点" class="headerlink" title="6.1 优点"></a>6.1 优点</h3><ul><li>降低系统的耦合度。调用者与接收者之间不存在直接的引用</li><li>符合开闭原则。新的命令可以很容易地加入到系统中，并且不会对系统源代码进行修改</li><li>可以容易地设计一个<strong>命令队列或宏命令（组合命令，也是组合模式和命令模式的集成）</strong></li><li>为请求的撤销（Undo）和恢复（Redo）操作提供了一种设计和实现方案</li></ul><h3 id="6-2-缺点"><a href="#6-2-缺点" class="headerlink" title="6.2 缺点"></a>6.2 缺点</h3><ul><li>增加系统复杂度和理解成本。每一个请求接收者都会对应一个具体命令类</li></ul><h3 id="6-3-适用场景"><a href="#6-3-适用场景" class="headerlink" title="6.3 适用场景"></a>6.3 适用场景</h3><ul><li>调用者和请求接收者解耦</li><li>需要请求排队执行</li><li>支持请求的撤销（Undo）和恢复（Redo）操作</li><li>需要将一组操作组合在一起形成宏命令</li></ul><h1 id="四、解释器模式"><a href="#四、解释器模式" class="headerlink" title="四、解释器模式"></a>四、解释器模式</h1><p>目前主要应用于正则表达式、XML稳定解释、Eclipse AST等<br>由于该模式使用频率较低，并且系统结构较为复杂，本文不以案例展示，仅介绍其优缺点及适用场景</p><h2 id="1-优缺点及适用场景"><a href="#1-优缺点及适用场景" class="headerlink" title="1. 优缺点及适用场景"></a>1. 优缺点及适用场景</h2><h3 id="1-1-优点"><a href="#1-1-优点" class="headerlink" title="1.1 优点"></a>1.1 优点</h3><ul><li>易于改变和扩展文法</li><li>每一条文法规则都可以表示为一个类</li><li>实现文法较为容易</li><li>增加新的解释表达式较为方便</li></ul><h3 id="1-2-缺点"><a href="#1-2-缺点" class="headerlink" title="1.2 缺点"></a>1.2 缺点</h3><ul><li>对于复杂文法难以维护</li><li>执行效率较低</li></ul><h3 id="1-3-适用场景"><a href="#1-3-适用场景" class="headerlink" title="1.3 适用场景"></a>1.3 适用场景</h3><ul><li>需要解释执行的语言中的句子表示为一颗抽象语法树</li><li>一些重复出现的问题可以用一种简单的语言进行表达</li><li>一个语言的文法较为简单</li><li>执行效率不是关键问题</li></ul><h1 id="五、迭代器模式"><a href="#五、迭代器模式" class="headerlink" title="五、迭代器模式"></a>五、迭代器模式</h1><p>某商品管理系统的商品名称存储在一个字符串数组中，现需要自定义一个双向迭代器（MyIterator）实现对该商品名称数组的双向（前向和后向）遍历</p><h2 id="一、抽象聚合类"><a href="#一、抽象聚合类" class="headerlink" title="一、抽象聚合类"></a>一、抽象聚合类</h2><h3 id="1-1-AbstractArray"><a href="#1-1-AbstractArray" class="headerlink" title="1.1 AbstractArray"></a>1.1 AbstractArray</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractArray</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractArray</span><span class="hljs-params">(Object[] objects)</span> &#123;<br>        <span class="hljs-built_in">this</span>.objects = objects;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Object[] objects;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> AbstractIterator <span class="hljs-title function_">createIterator</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="二、抽象迭代器"><a href="#二、抽象迭代器" class="headerlink" title="二、抽象迭代器"></a>二、抽象迭代器</h2><h3 id="2-1-AbstractIterator"><a href="#2-1-AbstractIterator" class="headerlink" title="2.1 AbstractIterator"></a>2.1 AbstractIterator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AbstractIterator</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">next</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLast</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">previous</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFirst</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getNextItem</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getPreviousItem</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="三、具体聚合类和具体迭代器（内部类实现）"><a href="#三、具体聚合类和具体迭代器（内部类实现）" class="headerlink" title="三、具体聚合类和具体迭代器（内部类实现）"></a>三、具体聚合类和具体迭代器（内部类实现）</h2><h3 id="3-1-GoodsArray"><a href="#3-1-GoodsArray" class="headerlink" title="3.1 GoodsArray"></a>3.1 GoodsArray</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodsArray</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractArray</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GoodsArray</span><span class="hljs-params">(Object[] objects)</span> &#123;<br>        <span class="hljs-built_in">super</span>(objects);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 具体迭代器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Itr</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AbstractIterator</span> &#123;<br><br>        <span class="hljs-type">int</span> cursor1;<br>        <span class="hljs-type">int</span> cursor2;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Itr</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-built_in">this</span>.cursor1 = <span class="hljs-number">0</span>;<br>            <span class="hljs-built_in">this</span>.cursor2 = objects.length - <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (cursor1 &lt; objects.length - <span class="hljs-number">1</span>) &#123;<br>                cursor1++;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLast</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> (cursor1 == objects.length - <span class="hljs-number">1</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">previous</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (cursor2 &gt; <span class="hljs-number">0</span>) &#123;<br>                cursor2--;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFirst</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> (cursor2 == <span class="hljs-number">0</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getNextItem</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> objects[cursor1];<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getPreviousItem</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> objects[cursor2];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AbstractIterator <span class="hljs-title function_">createIterator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Itr</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="四、客户端代码"><a href="#四、客户端代码" class="headerlink" title="四、客户端代码"></a>四、客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    String[] goodsName = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">100</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; goodsName.length - <span class="hljs-number">1</span>; i++) &#123;<br>        goodsName[i] = String.valueOf(i);<br>    &#125;<br>    <span class="hljs-type">AbstractArray</span> <span class="hljs-variable">goodsArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoodsArray</span>(goodsName);<br>    <span class="hljs-type">AbstractIterator</span> <span class="hljs-variable">goodsArrayItr</span> <span class="hljs-operator">=</span> goodsArray.createIterator();<br>    <span class="hljs-keyword">while</span> (!goodsArrayItr.isLast())&#123;<br>        goodsArrayItr.next();<br>        System.out.println(goodsArrayItr.getNextItem());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="五、优缺点及适用场景"><a href="#五、优缺点及适用场景" class="headerlink" title="五、优缺点及适用场景"></a>五、优缺点及适用场景</h2><h3 id="5-1-优点"><a href="#5-1-优点" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>支持不同的方式遍历一个聚合对象</li><li>简化了聚合类</li></ul><h3 id="5-2-缺点"><a href="#5-2-缺点" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>增加了系统复杂度。因为将存储数据和遍历数据的职责分离，需要新增迭代器类，类的个数成对增加</li><li>设计难度较大。需要考虑一个全面的迭代器不是一件容易的事情</li></ul><h3 id="5-3-适用场景"><a href="#5-3-适用场景" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>访问一个聚合对象的内容而无须暴露它的内部表示</li><li>需要为一个聚合对象提供多种遍历模式</li><li>为遍历不同的聚合对象提供一个统一的接口</li></ul><h1 id="六、中介者模式"><a href="#六、中介者模式" class="headerlink" title="六、中介者模式"></a>六、中介者模式</h1><p>虚拟聊天室 在“虚拟聊天室”实例中增加一个新的具体聊天室类和一个新的具体会员类，要求如下：<br>（1） 新的具体聊天室中发送的图片大小不得超过20<br>（2） 新的具体聊天室中发送的文字信息的长度不得超过100个字符，提供更强大的不雅字符过滤功能（如可过滤TMD、“操”等字符）。<br>（3） 新的具体会员类可以发送图片信息和文字信息。<br>（4） 新的具体会员类在发送文本信息时，可以在信息后加上发送时间，格式为：文本信息（发送时间）</p><h2 id="1-抽象中介者"><a href="#1-抽象中介者" class="headerlink" title="1. 抽象中介者"></a>1. 抽象中介者</h2><h3 id="1-1-AbstractChatRoom"><a href="#1-1-AbstractChatRoom" class="headerlink" title="1.1 AbstractChatRoom"></a>1.1 AbstractChatRoom</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractChatRoom</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfo</span><span class="hljs-params">(AbstractMember m, String info)</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendPic</span><span class="hljs-params">(AbstractMember m, String pic)</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfoAndPic</span><span class="hljs-params">(AbstractMember m, String info, String pic)</span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-具体中介者"><a href="#2-具体中介者" class="headerlink" title="2. 具体中介者"></a>2. 具体中介者</h2><h3 id="2-1-ChatRoom"><a href="#2-1-ChatRoom" class="headerlink" title="2.1 ChatRoom"></a>2.1 ChatRoom</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatRoom</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractChatRoom</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;AbstractMember&gt; members = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfo</span><span class="hljs-params">(AbstractMember m, String info)</span> &#123;<br>        <span class="hljs-keyword">if</span> (m.getClass() == Member.class) &#123;<br>            m.sendInfo(info);<br>            members.forEach(AbstractMember::receive);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m.getClass() == Vip.class) &#123;<br>            m.sendInfo(info);<br>            members.forEach(AbstractMember::receive);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendPic</span><span class="hljs-params">(AbstractMember m, String pic)</span> &#123;<br>        <span class="hljs-keyword">if</span> (m.getClass() == Member.class) &#123;<br>            m.sendPic(pic);<br>            members.forEach(AbstractMember::receive);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m.getClass() == Vip.class) &#123;<br>            m.sendPic(pic);<br>            members.forEach(AbstractMember::receive);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfoAndPic</span><span class="hljs-params">(AbstractMember m, String info, String pic)</span> &#123;<br>        <span class="hljs-keyword">if</span> (m.getClass() == Member.class) &#123;<br>            m.sendInfoAndPic(info, pic);<br>            members.forEach(AbstractMember::receive);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m.getClass() == Vip.class) &#123;<br>            m.sendInfoAndPic(info, pic);<br>            members.forEach(AbstractMember::receive);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ArrayList&lt;AbstractMember&gt; <span class="hljs-title function_">getMembers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> members;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-抽象同事类"><a href="#3-抽象同事类" class="headerlink" title="3. 抽象同事类"></a>3. 抽象同事类</h2><h3 id="3-1-AbstractMember"><a href="#3-1-AbstractMember" class="headerlink" title="3.1 AbstractMember"></a>3.1 AbstractMember</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMember</span> &#123;<br><br>    <span class="hljs-keyword">private</span> AbstractChatRoom chatRoom;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setChatRoom</span><span class="hljs-params">(AbstractChatRoom chatRoom)</span> &#123;<br>        <span class="hljs-built_in">this</span>.chatRoom = chatRoom;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cSendInfo</span><span class="hljs-params">(String info)</span> &#123;<br>        chatRoom.sendInfo(<span class="hljs-built_in">this</span>, info);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cSendPic</span><span class="hljs-params">(String pic)</span> &#123;<br>        chatRoom.sendPic(<span class="hljs-built_in">this</span>, pic);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cSendInfoAndPic</span><span class="hljs-params">(String info, String pic)</span> &#123;<br>        chatRoom.sendInfoAndPic(<span class="hljs-built_in">this</span>, info, pic);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfo</span><span class="hljs-params">(String info)</span> &#123;<br>        chatRoom.sendInfo(<span class="hljs-built_in">this</span>, info);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendPic</span><span class="hljs-params">(String pic)</span> &#123;<br>        chatRoom.sendPic(<span class="hljs-built_in">this</span>, pic);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfoAndPic</span><span class="hljs-params">(String info, String pic)</span> &#123;<br>        chatRoom.sendInfoAndPic(<span class="hljs-built_in">this</span>, info, pic);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-具体同事类"><a href="#4-具体同事类" class="headerlink" title="4. 具体同事类"></a>4. 具体同事类</h2><h3 id="4-1-Member"><a href="#4-1-Member" class="headerlink" title="4.1 Member"></a>4.1 Member</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 部分代码简略实现</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Member</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMember</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;接收消息&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfo</span><span class="hljs-params">(String info)</span> &#123;<br>        <span class="hljs-keyword">if</span> (info.length() &gt; <span class="hljs-number">100</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;消息过长！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> info.replaceAll(<span class="hljs-string">&quot;TMD&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>            info = f1.replaceAll(<span class="hljs-string">&quot;操&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>        &#125;<br>        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;发送了消息：&quot;</span> + info);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendPic</span><span class="hljs-params">(String pic)</span> &#123;<br>        <span class="hljs-keyword">if</span> (pic.length() &gt; <span class="hljs-number">100</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;照片过大！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;发送了照片：&quot;</span> + pic);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfoAndPic</span><span class="hljs-params">(String info, String photo)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;普通成员不能同时发送信息和照片&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-Vip"><a href="#4-2-Vip" class="headerlink" title="4.2 Vip"></a>4.2 Vip</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 部分代码简略实现</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Vip</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMember</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;接收消息&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfo</span><span class="hljs-params">(String info)</span> &#123;<br>        <span class="hljs-keyword">if</span> (info.length() &gt; <span class="hljs-number">100</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;消息过长！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> info.replaceAll(<span class="hljs-string">&quot;TMD&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>            info = f1.replaceAll(<span class="hljs-string">&quot;操&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>        &#125;<br>        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;发送了消息：&quot;</span> + info + <span class="hljs-string">&quot;(&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)) + <span class="hljs-string">&quot;)&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendPic</span><span class="hljs-params">(String pic)</span> &#123;<br>        <span class="hljs-keyword">if</span> (pic.length() &gt; <span class="hljs-number">100</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;照片过大！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;发送了照片：&quot;</span> + pic + <span class="hljs-string">&quot;(&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss:SSS&quot;</span>)) + <span class="hljs-string">&quot;)&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendInfoAndPic</span><span class="hljs-params">(String info, String pic)</span> &#123;<br>        <span class="hljs-keyword">if</span> (info.length() &gt; <span class="hljs-number">100</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;消息过长！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> info.replaceAll(<span class="hljs-string">&quot;TMD&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>            info = f1.replaceAll(<span class="hljs-string">&quot;操&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (pic.length() &gt; <span class="hljs-number">100</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;照片过大！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;发送了消息和照片：&quot;</span> + info + pic + <span class="hljs-string">&quot;(&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss:SSS&quot;</span>)) + <span class="hljs-string">&quot;)&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-客户端代码-1"><a href="#5-客户端代码-1" class="headerlink" title="5. 客户端代码"></a>5. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ChatRoom</span> <span class="hljs-variable">chatRoom</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>();<br><br>        <span class="hljs-type">Member</span> <span class="hljs-variable">member1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Member</span>();<br>        <span class="hljs-type">Member</span> <span class="hljs-variable">member2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Member</span>();<br>        <span class="hljs-type">Vip</span> <span class="hljs-variable">vip1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vip</span>();<br>        <span class="hljs-type">Vip</span> <span class="hljs-variable">vip2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vip</span>();<br><br>        member1.setName(<span class="hljs-string">&quot;member1&quot;</span>);<br>        member2.setName(<span class="hljs-string">&quot;member2&quot;</span>);<br>        vip1.setName(<span class="hljs-string">&quot;vip1&quot;</span>);<br>        vip2.setName(<span class="hljs-string">&quot;vip2&quot;</span>);<br><br>        member1.setChatRoom(chatRoom);<br>        member2.setChatRoom(chatRoom);<br>        vip1.setChatRoom(chatRoom);<br>        vip2.setChatRoom(chatRoom);<br><br>        chatRoom.getMembers().add(member1);<br>        chatRoom.getMembers().add(member2);<br>        chatRoom.getMembers().add(vip1);<br>        chatRoom.getMembers().add(vip2);<br><br>        member1.cSendInfo(<span class="hljs-string">&quot;付老师讲得课真好！&quot;</span>);<br>        member1.cSendPic(<span class="hljs-string">&quot;/member1表情包.jpg&quot;</span>);<br>        member2.cSendPic(<span class="hljs-string">&quot;/member2表情包.jpg&quot;</span>);<br>        vip1.cSendInfoAndPic(<span class="hljs-string">&quot;操！member1你和我想的一样&quot;</span>,<span class="hljs-string">&quot;/vip1表情包.jpg&quot;</span>);<br>        vip2.cSendInfoAndPic(<span class="hljs-string">&quot;哈哈哈&quot;</span>,<span class="hljs-string">&quot;/vip2表情包.jpg&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-优缺点及适用场景-1"><a href="#6-优缺点及适用场景-1" class="headerlink" title="6. 优缺点及适用场景"></a>6. 优缺点及适用场景</h2><h3 id="6-1-优点-1"><a href="#6-1-优点-1" class="headerlink" title="6.1 优点"></a>6.1 优点</h3><ul><li>简化对象之间的交互，适用中介者和同事的一对多关系，代替了原来同事间的多对多关系</li><li>将具体同事类之间解耦。例如上述例子中的具体同事类发送和接收消息的过程，如果是中介者和同事的一对多关系，那么中间件循环调用具体同事类的操作即可；如果是同事间的多对多关系，那么就需要在具体同时类中增加相应方法，这样会导致耦合度急剧增加</li><li>可以减少子类的生成。如果需要改变中介者的内容，只需要另外建立具体中介者（继承抽象中介者），而不需要对同事类进行扩展，这使得各个同事类之间可以被复用</li></ul><h3 id="6-2-缺点-1"><a href="#6-2-缺点-1" class="headerlink" title="6.2 缺点"></a>6.2 缺点</h3><ul><li>提高系统维护成本。具体中介者中会包含大量同事类之间的交互细节</li></ul><h3 id="6-3-适用场景-1"><a href="#6-3-适用场景-1" class="headerlink" title="6.3 适用场景"></a>6.3 适用场景</h3><ul><li>系统中对象之间存在复杂的引用关系（多对多）</li><li>一个对象由于引用了其他很多对象并且直接和这些对象通信，导致难以复用该对象</li><li>想通过一个中间类来封装多个类中的行为，而又不想生成太多的子类，此时可以通过引入中介者类来实现，在中介者类中定义对象交互的公共行为</li></ul><h1 id="七、备忘录模式"><a href="#七、备忘录模式" class="headerlink" title="七、备忘录模式"></a>七、备忘录模式</h1><p>目前主要应用于文字处理软件、图像编辑软件、数据库管理系统中<br>由于该模式使用频率较低，并且会导致系统小豪过大，本文不以案例展示，仅介绍其优缺点及适用场景</p><h2 id="1-优缺点及适用场景-1"><a href="#1-优缺点及适用场景-1" class="headerlink" title="1. 优缺点及适用场景"></a>1. 优缺点及适用场景</h2><h3 id="1-1-优点-1"><a href="#1-1-优点-1" class="headerlink" title="1.1 优点"></a>1.1 优点</h3><ul><li>提供了一种状态恢复机制，方便用户回到特定的历史步骤</li></ul><h3 id="1-2-缺点-1"><a href="#1-2-缺点-1" class="headerlink" title="1.2 缺点"></a>1.2 缺点</h3><ul><li>资源消耗过大。每保存一次对象的状态都需要消耗一定的系统资源</li></ul><h3 id="1-3-适用场景-1"><a href="#1-3-适用场景-1" class="headerlink" title="1.3 适用场景"></a>1.3 适用场景</h3><ul><li>需要将一个对象在某一时刻的全部状态或部分状态记录下来，以方便将来回到先前的状态</li></ul><h1 id="八、观察者模式"><a href="#八、观察者模式" class="headerlink" title="八、观察者模式"></a>八、观察者模式</h1><p>某在线股票软件需要提供如下功能：当股票购买者所购买的某支股票价格变化幅度达到5%时，系统将自动发送通知（包括新价格）给购买股票的股民。<br>现使用观察者模式设计该系统</p><h2 id="1-抽象目标类"><a href="#1-抽象目标类" class="headerlink" title="1. 抽象目标类"></a>1. 抽象目标类</h2><h3 id="1-1-AbstractStock"><a href="#1-1-AbstractStock" class="headerlink" title="1.1 AbstractStock"></a>1.1 AbstractStock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractStock</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> String name;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">double</span> amount;<br><br>    <span class="hljs-keyword">protected</span> ArrayList&lt;AbstractStockBuyer&gt; stockBuyers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addStockBuyer</span><span class="hljs-params">(AbstractStockBuyer stockBuyerObserver)</span> &#123;<br>        System.out.println(stockBuyerObserver.getName() + <span class="hljs-string">&quot;购买了&quot;</span> + <span class="hljs-built_in">this</span>.name + <span class="hljs-string">&quot;股票！&quot;</span>);<br>        stockBuyers.add(stockBuyerObserver);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">priceChange</span><span class="hljs-params">(<span class="hljs-type">double</span> change)</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPriceChange</span><span class="hljs-params">(<span class="hljs-type">double</span> change, <span class="hljs-type">double</span> amount)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="2-具体目标类"><a href="#2-具体目标类" class="headerlink" title="2. 具体目标类"></a>2. 具体目标类</h2><h3 id="2-1-Stock"><a href="#2-1-Stock" class="headerlink" title="2.1 Stock"></a>2.1 Stock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Stock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractStock</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Stock</span><span class="hljs-params">(String name, <span class="hljs-type">double</span> amount)</span> &#123;<br>        System.out.println(name + <span class="hljs-string">&quot;股票以&quot;</span> + amount + <span class="hljs-string">&quot;元上市啦！&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;-----------------------&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.amount = amount;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">priceChange</span><span class="hljs-params">(<span class="hljs-type">double</span> change)</span> &#123;<br>        <span class="hljs-built_in">this</span>.amount = amount * (<span class="hljs-number">1.00</span> + change * <span class="hljs-number">0.01</span>);<br>        <span class="hljs-keyword">if</span> (change &gt;= <span class="hljs-number">5.00</span>) &#123;<br>            notifyPriceChange(change, amount);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPriceChange</span><span class="hljs-params">(<span class="hljs-type">double</span> change, <span class="hljs-type">double</span> amount)</span> &#123;<br>        stockBuyers.forEach(as -&gt; as.observePriceChange(change, amount));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-抽象观察者"><a href="#3-抽象观察者" class="headerlink" title="3. 抽象观察者"></a>3. 抽象观察者</h2><h3 id="3-1-AbstractStockBuyer"><a href="#3-1-AbstractStockBuyer" class="headerlink" title="3.1 AbstractStockBuyer"></a>3.1 AbstractStockBuyer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractStockBuyer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractStockBuyer</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buy</span><span class="hljs-params">(AbstractStock as)</span> &#123;<br>        as.addStockBuyer(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">observePriceChange</span><span class="hljs-params">(<span class="hljs-type">double</span> change, <span class="hljs-type">double</span> amount)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-具体观察者"><a href="#4-具体观察者" class="headerlink" title="4. 具体观察者"></a>4. 具体观察者</h2><h3 id="4-1-StockBuyer"><a href="#4-1-StockBuyer" class="headerlink" title="4.1 StockBuyer"></a>4.1 StockBuyer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockBuyer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractStockBuyer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StockBuyer</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">observePriceChange</span><span class="hljs-params">(<span class="hljs-type">double</span> change, <span class="hljs-type">double</span> amount)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;提醒：&quot;</span> + <span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;，股票加个变化幅度达到了&quot;</span> + change + <span class="hljs-string">&quot;%，现在已经达到了&quot;</span> + String.format(<span class="hljs-string">&quot;%.2f&quot;</span>, amount) + <span class="hljs-string">&quot;元，快快来买！&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-客户端代码-2"><a href="#5-客户端代码-2" class="headerlink" title="5. 客户端代码"></a>5. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AbstractStock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stock</span>(<span class="hljs-string">&quot;xxxx&quot;</span>,<span class="hljs-number">100000</span>);<br><br>        <span class="hljs-type">AbstractStockBuyer</span> <span class="hljs-variable">buyer1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StockBuyer</span>(<span class="hljs-string">&quot;buyer1&quot;</span>);<br>        <span class="hljs-type">AbstractStockBuyer</span> <span class="hljs-variable">buyer2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StockBuyer</span>(<span class="hljs-string">&quot;buyer2&quot;</span>);<br>        <span class="hljs-type">AbstractStockBuyer</span> <span class="hljs-variable">buyer3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StockBuyer</span>(<span class="hljs-string">&quot;buyer3&quot;</span>);<br>        <span class="hljs-type">AbstractStockBuyer</span> <span class="hljs-variable">buyer4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StockBuyer</span>(<span class="hljs-string">&quot;buyer4&quot;</span>);<br><br>        buyer1.buy(stock);<br>        buyer2.buy(stock);<br>        buyer3.buy(stock);<br>        buyer4.buy(stock);<br><br>        stock.priceChange(<span class="hljs-number">3</span>);<br>        stock.priceChange(<span class="hljs-number">10</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-优缺点及适用场景-2"><a href="#6-优缺点及适用场景-2" class="headerlink" title="6. 优缺点及适用场景"></a>6. 优缺点及适用场景</h2><h3 id="6-1-优点-2"><a href="#6-1-优点-2" class="headerlink" title="6.1 优点"></a>6.1 优点</h3><ul><li>在目标和观察者之间建立一个抽象的耦合。目标只需要维持这一个抽象观察者的集合，而无须了解其具体观察者</li><li>支持广播通信</li><li>符合开闭原则。增加新的具体观察者也无须修改原有代码</li></ul><h3 id="6-2-缺点-2"><a href="#6-2-缺点-2" class="headerlink" title="6.2 缺点"></a>6.2 缺点</h3><ul><li>如果目标有很多直接和间接观察者，将所有观察者都通知到位会花费很多时间</li><li>如果观察者和观察目标之间存在循环依赖，可能会导致系统崩溃</li><li>没有相应的机制让观察者知道目标对象是如何发生变化的，而仅仅只是知道其变化了</li></ul><h3 id="6-3-适用场景-2"><a href="#6-3-适用场景-2" class="headerlink" title="6.3 适用场景"></a>6.3 适用场景</h3><ul><li>一个抽象模型有两个方面，其中一个方面依赖另一个方面，将这两个方面封装在独立的对象中使他们可以各自独立地改变和复用</li><li>需要在系统种创建一个触发链</li><li>一个对象的改变可能会引起一个或者多个其他对象也发生改变</li></ul><h1 id="九、状态模式"><a href="#九、状态模式" class="headerlink" title="九、状态模式"></a>九、状态模式</h1><p>某公司要为一银行开发一套信用卡业务系统，银行账户（Account）是该系统的核心类之一，通过分析，账户存在 3 中状态且在不同状态下账户存在不同的行为，具体说明如下：</p><ul><li>账户余额（balance）≥ 0，正常状态（NormalState），此时既可以存款也可以取款</li><li>2000 &lt; 账户余额（balance）&lt; 0，透支状态（OverdraftState），此时既可以存款也可以取款，但需要按天计算利息</li><li>账户余额（balance）≤ 2000，受限状态（RestrictedState），此时只能向账户存款而不能取款</li><li>根据余额的不同，以上 3 种状态可以相互转换</li></ul><p>试使用状态模式设计</p><h2 id="1-环境类"><a href="#1-环境类" class="headerlink" title="1. 环境类"></a>1. 环境类</h2><h3 id="1-1-Account"><a href="#1-1-Account" class="headerlink" title="1.1 Account"></a>1.1 Account</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> &#123;<br><br>    <span class="hljs-keyword">private</span> AccountState state;<br><br>    <span class="hljs-keyword">private</span> String owner;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-variable">balance</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(String owner, <span class="hljs-type">double</span> balance)</span> &#123;<br>        <span class="hljs-built_in">this</span>.owner = owner;<br>        <span class="hljs-built_in">this</span>.balance = balance;<br>        state = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NormalState</span>(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(AccountState state)</span> &#123;<br>        <span class="hljs-built_in">this</span>.state = state;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getBalance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> balance;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBalance</span><span class="hljs-params">(<span class="hljs-type">double</span> balance)</span> &#123;<br>        <span class="hljs-built_in">this</span>.balance = balance;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        System.out.println(<span class="hljs-built_in">this</span>.owner + <span class="hljs-string">&quot;存款&quot;</span> + amount);<br>        state.deposit(amount);<br>        System.out.println(<span class="hljs-string">&quot;现在余额为：&quot;</span> + <span class="hljs-built_in">this</span>.balance);<br>        System.out.println(<span class="hljs-string">&quot;现在账户状态为：&quot;</span> + <span class="hljs-built_in">this</span>.state.getClass().getName());<br>        System.out.println(<span class="hljs-string">&quot;-----------------------------------------------&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        System.out.println(<span class="hljs-built_in">this</span>.owner + <span class="hljs-string">&quot;取款&quot;</span> + amount);<br>        state.withdraw(amount);<br>        System.out.println(<span class="hljs-string">&quot;现在余额为：&quot;</span> + <span class="hljs-built_in">this</span>.balance);<br>        System.out.println(<span class="hljs-string">&quot;现在账户状态为：&quot;</span> + <span class="hljs-built_in">this</span>.state.getClass().getName());<br>        System.out.println(<span class="hljs-string">&quot;-----------------------------------------------&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeInterest</span><span class="hljs-params">()</span> &#123;<br>        state.computeInterest();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-抽象状态类"><a href="#2-抽象状态类" class="headerlink" title="2. 抽象状态类"></a>2. 抽象状态类</h2><h3 id="2-1-AccountState"><a href="#2-1-AccountState" class="headerlink" title="2.1 AccountState"></a>2.1 AccountState</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountState</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> Account account;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeInterest</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stateCheck</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-具体状态类"><a href="#3-具体状态类" class="headerlink" title="3. 具体状态类"></a>3. 具体状态类</h2><h3 id="3-1-NormalState"><a href="#3-1-NormalState" class="headerlink" title="3.1 NormalState"></a>3.1 NormalState</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NormalState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AccountState</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NormalState</span><span class="hljs-params">(Account account)</span> &#123;<br>        <span class="hljs-built_in">this</span>.account = account;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NormalState</span><span class="hljs-params">(AccountState accountState)</span> &#123;<br>        <span class="hljs-built_in">this</span>.account = accountState.account;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        account.setBalance(account.getBalance() + amount);<br>        stateCheck();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        account.setBalance(account.getBalance() - amount);<br>        stateCheck();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeInterest</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;正常状态，无须支付利息&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stateCheck</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (account.getBalance() &gt; -<span class="hljs-number">2000</span> &amp;&amp; account.getBalance() &lt;= <span class="hljs-number">0</span>) &#123;<br>            account.setState(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OverdraftState</span>(<span class="hljs-built_in">this</span>));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (account.getBalance() &lt;= -<span class="hljs-number">2000</span>) &#123;<br>            account.setState(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RestrictedState</span>(<span class="hljs-built_in">this</span>));<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-OverdraftState"><a href="#3-2-OverdraftState" class="headerlink" title="3.2 OverdraftState"></a>3.2 OverdraftState</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OverdraftState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AccountState</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OverdraftState</span><span class="hljs-params">(AccountState accountState)</span> &#123;<br>        <span class="hljs-built_in">this</span>.account = accountState.account;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        account.setBalance(account.getBalance() + amount);<br>        stateCheck();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        account.setBalance(account.getBalance() - amount);<br>        stateCheck();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeInterest</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;透支状态，需要支付利息&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stateCheck</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (account.getBalance() &gt; <span class="hljs-number">0</span>) &#123;<br>            account.setState(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NormalState</span>(<span class="hljs-built_in">this</span>));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (account.getBalance() &lt;= -<span class="hljs-number">2000</span>) &#123;<br>            account.setState(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RestrictedState</span>(<span class="hljs-built_in">this</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-RestrictedState"><a href="#3-3-RestrictedState" class="headerlink" title="3.3 RestrictedState"></a>3.3 RestrictedState</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AccountState</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RestrictedState</span><span class="hljs-params">(AccountState accountState)</span> &#123;<br>        <span class="hljs-built_in">this</span>.account = accountState.account;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        account.setBalance(account.getBalance() + amount);<br>        stateCheck();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;账户受限，取款失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeInterest</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;受限状态，需要支付利息&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stateCheck</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (account.getBalance() &gt; <span class="hljs-number">0</span>) &#123;<br>            account.setState(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NormalState</span>(<span class="hljs-built_in">this</span>));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (account.getBalance() &gt; -<span class="hljs-number">2000</span>) &#123;<br>            account.setState(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OverdraftState</span>(<span class="hljs-built_in">this</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端代码"><a href="#4-客户端代码" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">&quot;用户1&quot;</span>, <span class="hljs-number">0.0</span>);<br>        account.deposit(<span class="hljs-number">1000</span>);<br>        account.withdraw(<span class="hljs-number">2000</span>);<br>        account.deposit(<span class="hljs-number">3000</span>);<br>        account.withdraw(<span class="hljs-number">4000</span>);<br>        account.withdraw(<span class="hljs-number">1000</span>);<br>        account.computeInterest();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-优缺点及适用场景"><a href="#5-优缺点及适用场景" class="headerlink" title="5. 优缺点及适用场景"></a>5. 优缺点及适用场景</h2><h3 id="5-1-优点-1"><a href="#5-1-优点-1" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>封装了状态的转换规则，可以对状态转换代码进行集中管理</li><li>将所有与某个状态有关的行为放到一个类中，只需要注入一个不同的状态对象即可使环境对象拥有不同的行为</li><li>可以避免适用庞大的条件语句将业务方法和状态转换代码交织在一起</li></ul><h3 id="5-2-缺点-1"><a href="#5-2-缺点-1" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>会增加类和对象的个数，导致系统运行开销增大</li><li>增加系统设计难度，状态模式的结构和实现都较为复杂</li><li>对开闭原则的支持并不好，如果需要增加一个新的状态，则会导致其他状态类也要相继改变相应的源代码</li></ul><h3 id="5-3-适用场景-1"><a href="#5-3-适用场景-1" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>对象的行为依赖于它的状态（例如某些属性值），状态的改变将导致行为的变化</li><li>在代码中包含大量与对象有关的条件语句，这些条件语句的出现会导致代码的可维护性和灵活性变差</li></ul><h1 id="十、策略模式"><a href="#十、策略模式" class="headerlink" title="十、策略模式"></a>十、策略模式</h1><p>排序有多种方法，如选择排序、插入排序、快速排序等，某系统要求在多种排序方案中灵活选择某一种排序方案，但不修改源代码，现使用策略模式进行设计</p><h2 id="1-环境类-1"><a href="#1-环境类-1" class="headerlink" title="1. 环境类"></a>1. 环境类</h2><h3 id="1-1-ParamArray"><a href="#1-1-ParamArray" class="headerlink" title="1.1 ParamArray"></a>1.1 ParamArray</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParamArray</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] array;<br><br>    <span class="hljs-keyword">private</span> ArraySort arraySort;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ParamArray</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array)</span> &#123;<br>        <span class="hljs-built_in">this</span>.array = array;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSort</span><span class="hljs-params">(ArraySort arraySort)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;使用&quot;</span> + arraySort.getClass().getName() + <span class="hljs-string">&quot;算法&quot;</span>);<br>        <span class="hljs-built_in">this</span>.arraySort = arraySort;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sort() &#123;<br>        <span class="hljs-keyword">return</span> arraySort.sort(array);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-抽象策略类"><a href="#2-抽象策略类" class="headerlink" title="2. 抽象策略类"></a>2. 抽象策略类</h2><h3 id="2-1-ArraySort"><a href="#2-1-ArraySort" class="headerlink" title="2.1 ArraySort"></a>2.1 ArraySort</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArraySort</span> &#123;<br>    <span class="hljs-type">int</span>[] sort(<span class="hljs-type">int</span>[] array);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-具体策略类"><a href="#3-具体策略类" class="headerlink" title="3. 具体策略类"></a>3. 具体策略类</h2><h3 id="3-1-InsertionSort"><a href="#3-1-InsertionSort" class="headerlink" title="3.1 InsertionSort"></a>3.1 InsertionSort</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InsertionSort</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArraySort</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sort(<span class="hljs-type">int</span>[] array) &#123;<br>        <span class="hljs-comment">// i代表待排序的索引</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; array.length; i++)&#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> array[i];<br>            <span class="hljs-comment">// j代表以排好序的区域索引</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i - <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span>(j &gt;= <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-keyword">if</span>(t &lt; array[j])&#123;<br>                    array[j + <span class="hljs-number">1</span>] = array[j];<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// 退出循环，减少比较次数</span><br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                j--;<br>            &#125;<br>            array[j + <span class="hljs-number">1</span>] = t;<br>        &#125;<br>        <span class="hljs-keyword">return</span> array;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] a, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span>&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> a[i];<br>        a[i] = a[j];<br>        a[j] = t;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-QuickSort"><a href="#3-2-QuickSort" class="headerlink" title="3.2 QuickSort"></a>3.2 QuickSort</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickSort</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArraySort</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sort(<span class="hljs-type">int</span>[] array) &#123;<br>        Arrays.sort(array);<br>        <span class="hljs-keyword">return</span> array;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-SelectionSort"><a href="#3-3-SelectionSort" class="headerlink" title="3.3 SelectionSort"></a>3.3 SelectionSort</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SelectionSort</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArraySort</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sort(<span class="hljs-type">int</span>[] array) &#123;<br>        <span class="hljs-comment">// i代表着每轮选择出来的最小元素要交换的目标索引</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; array.length - <span class="hljs-number">1</span>; i++) &#123;<br>            <span class="hljs-comment">// s代表着当前最小元素的索引</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> i;<br>            <span class="hljs-comment">// j的作用是遍历s之后的数，查找是否还有比s还小的数</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> s + <span class="hljs-number">1</span>; j &lt; array.length; j++) &#123;<br>                <span class="hljs-keyword">if</span> (array[s] &gt; array[j]) &#123;<br>                    s = j;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (s != i) &#123;<br>                swap(array, s, i);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> array;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] a, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> a[i];<br>        a[i] = a[j];<br>        a[j] = t;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端类"><a href="#4-客户端类" class="headerlink" title="4. 客户端类"></a>4. 客户端类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span>[] before = &#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">9</span>,<span class="hljs-number">8</span>&#125;;<br>        <span class="hljs-type">ParamArray</span> <span class="hljs-variable">paramArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParamArray</span>(before);<br>        paramArray.setSort(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QuickSort</span>());<br><br>        <span class="hljs-type">int</span>[] after = paramArray.sort();<br>        System.out.println(<span class="hljs-string">&quot;排序后：&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j : after) &#123;<br>            System.out.print(j + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-优缺点和适用场景"><a href="#5-优缺点和适用场景" class="headerlink" title="5. 优缺点和适用场景"></a>5. 优缺点和适用场景</h2><h2 id="5-1-优点-2"><a href="#5-1-优点-2" class="headerlink" title="5.1 优点"></a>5.1 优点</h2><ul><li>完美支持开闭原则</li><li>避免多重条件选择语句</li><li>可以复用</li></ul><h2 id="5-2-缺点-2"><a href="#5-2-缺点-2" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h2><ul><li>客户端必须知道所有算法或行为的情况，才方便选择</li><li>可能会造成系统产生大量的策略类</li><li>不支持一个策略类完成部分功能后再使用另一个策略类完成剩余功能</li></ul><h3 id="5-3-适用场景-2"><a href="#5-3-适用场景-2" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>一个系统需要动态地选择几种处理策略</li><li>避免使用难以维护的多重选择语句</li><li>不希望客户端知道接触复杂的逻辑结构</li></ul><h1 id="十一、模板方法模式"><a href="#十一、模板方法模式" class="headerlink" title="十一、模板方法模式"></a>十一、模板方法模式</h1><p>假设每个人一天的时间花费在工作（work）和睡觉上（sleep），现有艺术家和程序员两种职业，艺术家的工作内容是绘画；程序员的工作内容是写程序。请试着使用模板方法描绘这两种职业的一天</p><h2 id="1-抽象类"><a href="#1-抽象类" class="headerlink" title="1. 抽象类"></a>1. 抽象类</h2><h3 id="1-1-People"><a href="#1-1-People" class="headerlink" title="1.1 People"></a>1.1 People</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">People</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;工作完睡觉&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">thisDay</span><span class="hljs-params">()</span> &#123;<br>        work();<br>        sleep();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-具体类"><a href="#2-具体类" class="headerlink" title="2. 具体类"></a>2. 具体类</h2><h3 id="2-1-Artist"><a href="#2-1-Artist" class="headerlink" title="2.1 Artist"></a>2.1 Artist</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Artist</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">People</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;我的工作是绘画&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-Programmer"><a href="#2-2-Programmer" class="headerlink" title="2.2 Programmer"></a>2.2 Programmer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Programmer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">People</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;我的工作是写程序&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-客户端代码-1"><a href="#3-客户端代码-1" class="headerlink" title="3. 客户端代码"></a>3. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">People</span> <span class="hljs-variable">programmer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Programmer</span>();<span class="hljs-comment">// 可通过配置文件注入</span><br>        programmer.thisDay();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-优缺点及适用场景"><a href="#4-优缺点及适用场景" class="headerlink" title="4. 优缺点及适用场景"></a>4. 优缺点及适用场景</h2><h3 id="4-1-优点-1"><a href="#4-1-优点-1" class="headerlink" title="4.1 优点"></a>4.1 优点</h3><ul><li>代码复用</li><li>可以通过子类覆盖父类的钩子方法来决定某一步骤是否执行</li><li>符合单一职责和开闭原则。通过子类来覆盖父类的基本方法，不同的子类可以提供不同的方法实现，更换和新增子类也很方便</li></ul><h3 id="4-2-缺点-1"><a href="#4-2-缺点-1" class="headerlink" title="4.2 缺点"></a>4.2 缺点</h3><ul><li>增加系统复杂度。每一个基本方法的不同实现都需要新增一个子类</li></ul><h3 id="4-3-适用场景-1"><a href="#4-3-适用场景-1" class="headerlink" title="4.3 适用场景"></a>4.3 适用场景</h3><ul><li>对复杂的算法进行分割。延迟到子类实现</li><li>可以将各子类的公共行为提取并集中到一个公共父类种，避免代码重复</li><li>需要通过子类来父类算法种的某个步骤是否执行，实现了子类对父类算法的方向控制（钩子方法）</li></ul><h1 id="十二、访问者模式"><a href="#十二、访问者模式" class="headerlink" title="十二、访问者模式"></a>十二、访问者模式</h1><p>由于访问者模式的使用条件较为苛刻，本身结构也较为复杂，因此在实际应用种使用频率不是特别高。<br>主要应用于 XML 文档解析、编译器的设计、复杂的集合对象处理等领域<br>本文不以案例展示，仅介绍其优缺点及适用场景</p><h2 id="1-优缺点及适用场景-2"><a href="#1-优缺点及适用场景-2" class="headerlink" title="1. 优缺点及适用场景"></a>1. 优缺点及适用场景</h2><h3 id="1-1-优点-2"><a href="#1-1-优点-2" class="headerlink" title="1.1 优点"></a>1.1 优点</h3><ul><li>增加新的访问操作很方便，无需修改源代码，符合开闭原则</li><li>将有关元素对象的访问行为集中到一个访问者对象种，而不是分散在一个个的元素类种，使职责更加清晰</li><li>访问者模式让用户能够在不修改现有元素类层次结构的情况下定义作用于该层次结构的操作</li></ul><h3 id="1-2-缺点-2"><a href="#1-2-缺点-2" class="headerlink" title="1.2 缺点"></a>1.2 缺点</h3><ul><li>增加新的元素类很困难。每增加一个新的元素类都意味着要在抽象访问者角色中增加一个新的抽象操作，并在每一个具体访问者类中新增相应的具体操作，违背了开闭原则</li><li>访问者模式破坏了对象的封装性。访问者模式要求访问者对象访问并调用每一个元素对象的操作，这意味着元素对象有时候必须暴露一些自己的内部操作和内部状态，否则无法供访问者访问</li></ul><h3 id="1-3-适用场景-2"><a href="#1-3-适用场景-2" class="headerlink" title="1.3 适用场景"></a>1.3 适用场景</h3><ul><li>一个对象结构包含多个类型的对象，希望对这些对象实施一些依赖其具体类型的操作</li><li>需要对一个结构对象进行很多不同的并且不相关的操作，而需要避免让这些操作污染这些对象的类，也不希望在增加新操作时修改这些类</li><li>对象结构中对象对应的类很少改变，但经常需要在此对象结构上定义新的操作</li></ul>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>结构型模式</title>
    <link href="/2022/07/03/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/07/03/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>结构型模式（Structural Pattern）关注<strong>如何将现有类或对象组织在一起形成更加强大的结构</strong><br>不同的结构型模式从不同的角度来组合类和对象，他们的尽可能满足各种面向对象设计原则的同时，为类或对象的组合提供一系列巧妙的解决方案<br>结构型模式可以描述两种不同的东西——<strong>类与类的实例（对象）</strong><br>因此结构型模式也被分为两种，分别是<strong>类结构型模式</strong>和<strong>对象结构型模式</strong></p><p>类结构型模式关心<strong>类的组合</strong>，由多个类组合成一个强大的系统，一般只存在继承和实现关系</p><p>对象结构型模式中关心<strong>类与对象的组合</strong>，通过关联关系在一个类中定义另外一个类的实例对象，如何通过该对象调用相应的方法</p><p>根据合成复用原则，在系统中尽量使用关联关系来代替继承关系，因此大部分结构型模式都是对象结构型模式</p><p>结构型模式共有七种：</p><table><thead><tr><th align="center"><strong>设计原则名称</strong></th><th align="center"><strong>定义</strong></th><th align="center"><strong>使用频率</strong></th></tr></thead><tbody><tr><td align="center">适配器模式 （Adapter Pattern）</td><td align="center">将一个类的接口转换成客户希望的另一个接口。适配器模式让那些不兼容的类可以一起工作</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="center">桥接模式 （Bridge Pattern）</td><td align="center">将抽象部分与它的实现部分解耦，使得两者能够独立变化</td><td align="center">⭐⭐⭐</td></tr><tr><td align="center">组合模式 （Composite Pattern）</td><td align="center">组合多个对象形成树形结构以表示具有部分-整体关系的层次结构。组合模式让客户端可以统一对待单个对象和组合对象</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="center">装饰模式 （Decorator Pattern）</td><td align="center">动态地给一个对象增加一些额外的职责。就扩展功能而言，装饰模式提供了一种比使用子类更加灵活的代替方案</td><td align="center">⭐⭐⭐</td></tr><tr><td align="center">外观模式 （Facade Pattern）</td><td align="center">为子系统的一组接口提供一个统一的入口。外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">享元模式 （Flyweight Pattern）</td><td align="center">运用共享技术有效地支持大量细粒度对象的复用</td><td align="center">⭐</td></tr><tr><td align="center">代理模式 （Proxy Pattern）</td><td align="center">给某一个对象提供一个代理或占位符，并由代理对象来控制原对象的访问</td><td align="center">⭐⭐⭐⭐</td></tr></tbody></table><h1 id="二、适配器模式"><a href="#二、适配器模式" class="headerlink" title="二、适配器模式"></a>二、适配器模式</h1><p>算法适配。 现有一个接口DataOperation定义了排序方法sort(int[])和查找方法search(int[],int)，已知类QuickSort的quickSort(int[])方法实现了快速排序算法，类BinarySearch的binarySearch(int[],int)方法实现了二分查找算法。现使用适配器模式设计一个系统，在不修改源代码的情况下将类QuickSort和类BinarySearch的方法适配到DataOperation接口中  </p><h2 id="1-目标类"><a href="#1-目标类" class="headerlink" title="1. 目标类"></a>1. 目标类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataOperation</span> &#123;<br>    <span class="hljs-type">int</span>[] sort(<span class="hljs-type">int</span>[] a);<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-type">int</span>[] a,<span class="hljs-type">int</span> b)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-适配者"><a href="#2-适配者" class="headerlink" title="2. 适配者"></a>2. 适配者</h2><h3 id="2-1-BinarySearch"><a href="#2-1-BinarySearch" class="headerlink" title="2.1 BinarySearch"></a>2.1 BinarySearch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BinarySearch</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">binarySearch</span><span class="hljs-params">(<span class="hljs-type">int</span>[] a,<span class="hljs-type">int</span> b)</span>&#123;<br>        <span class="hljs-keyword">return</span> Arrays.binarySearch(a, b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-QuickSort"><a href="#2-2-QuickSort" class="headerlink" title="2.2 QuickSort"></a>2.2 QuickSort</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickSort</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] quickSort(<span class="hljs-type">int</span>[] a) &#123;<br>        Arrays.sort(a);<br>        <span class="hljs-keyword">return</span> a;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-适配器"><a href="#3-适配器" class="headerlink" title="3. 适配器"></a>3. 适配器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataOperation</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BinarySearch binarySearch;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> QuickSort quickSort;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Adapter</span><span class="hljs-params">()</span> &#123;<br>        binarySearch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BinarySearch</span>();<br>        quickSort = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QuickSort</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sort(<span class="hljs-type">int</span>[] a) &#123;<br>        <span class="hljs-keyword">return</span> quickSort.quickSort(a);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-type">int</span>[] a, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">return</span> binarySearch.binarySearch(a, b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端代码"><a href="#4-客户端代码" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Adapter</span> <span class="hljs-variable">adapter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Adapter</span>();         <br><span class="hljs-type">int</span>[] a = &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">3</span>,<span class="hljs-number">10</span>&#125;;        <br>System.out.println(adapter.search(a, <span class="hljs-number">9</span>));<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i : adapter.sort(a)) &#123;          <br>    System.out.print(i+<span class="hljs-string">&quot; &quot;</span>);             <br>&#125;                                        <br></code></pre></td></tr></table></figure><h2 id="5-优缺点和适用场景"><a href="#5-优缺点和适用场景" class="headerlink" title="5. 优缺点和适用场景"></a>5. 优缺点和适用场景</h2><h3 id="5-1-优点"><a href="#5-1-优点" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>将目标类和适配者类解耦，无须修改原有结构</li><li>增加了类的透明性和复用性，具体业务都封装在适配者类中，并且适配者类可以重复适用</li><li>灵活性和扩张性都非常好，只需要灵活更换适配器即可</li></ul><h3 id="5-2-缺点"><a href="#5-2-缺点" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><p>由于类适配器模式的缺点较多，根据合成复用原则也适用较少，所以只总结了对象适配器模式的缺点：</p><ul><li>实现过程较为复杂，在该模式下如果适配器中需要置换适配者类的方法，那么就需要更改原代码，这样不符合开闭原则，所以需要另外建子类完成，增加系统复杂度</li></ul><h3 id="5-3-适用场景"><a href="#5-3-适用场景" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>系统中需要使用一些现有的类，而这些类的接口（例如方法名）不符合系统的需要，甚至没有这些类的源代码 </li><li>想创建一个可以重复使用的类，用于和一些彼此之间没有太大关联的类（包括在将来想引进的类）一起工作</li></ul><h1 id="三、桥接模式"><a href="#三、桥接模式" class="headerlink" title="三、桥接模式"></a>三、桥接模式</h1><p>毛笔和蜡笔是两种常见的文具，它们都归属于画笔。假如需要大、中、小 3 种型号的画笔，能够绘制 12 种不同的颜色，如果使用蜡笔，需要准备 3 × 12 &#x3D; 36 支，但如果使用毛笔，只需要提供 3 种型号的毛笔，外加一个包含 12 种颜色的调色板，涉及的对象个数仅为 3 + 12 &#x3D; 15，远小于 36，却能实现与 36 支蜡笔同样的功能。<br>请使用桥接模式实现毛笔绘制的系统结构</p><h2 id="1-抽象类"><a href="#1-抽象类" class="headerlink" title="1. 抽象类"></a>1. 抽象类</h2><h3 id="1-1-WritingBrush"><a href="#1-1-WritingBrush" class="headerlink" title="1.1 WritingBrush"></a>1.1 WritingBrush</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WritingBrush</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> Color color;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">draw</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> Color <span class="hljs-title function_">getColor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> color;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setColor</span><span class="hljs-params">(Color color)</span> &#123;<br>        <span class="hljs-built_in">this</span>.color = color;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-具体抽象类"><a href="#2-具体抽象类" class="headerlink" title="2. 具体抽象类"></a>2. 具体抽象类</h2><h3 id="2-1-BigWritingBrush"><a href="#2-1-BigWritingBrush" class="headerlink" title="2.1 BigWritingBrush"></a>2.1 BigWritingBrush</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigWritingBrush</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WritingBrush</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;使用大号毛笔，染上&quot;</span> + color.coloured() + <span class="hljs-string">&quot;后绘画&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-MidWritingBrush"><a href="#2-2-MidWritingBrush" class="headerlink" title="2.2 MidWritingBrush"></a>2.2 MidWritingBrush</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MidWritingBrush</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WritingBrush</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;使用中号毛笔，染上&quot;</span> + color.coloured() + <span class="hljs-string">&quot;后绘画&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-实现类接口"><a href="#3-实现类接口" class="headerlink" title="3. 实现类接口"></a>3. 实现类接口</h2><h3 id="3-1-Color"><a href="#3-1-Color" class="headerlink" title="3.1 Color"></a>3.1 Color</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Color</span> &#123;<br>    String <span class="hljs-title function_">coloured</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-具体实现类"><a href="#4-具体实现类" class="headerlink" title="4. 具体实现类"></a>4. 具体实现类</h2><h3 id="4-1-Red"><a href="#4-1-Red" class="headerlink" title="4.1 Red"></a>4.1 Red</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Red</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Color</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">coloured</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;红色&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-Green"><a href="#4-2-Green" class="headerlink" title="4.2 Green"></a>4.2 Green</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Green</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Color</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">coloured</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;绿色&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-客户端代码"><a href="#5-客户端代码" class="headerlink" title="5. 客户端代码"></a>5. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">WritingBrush</span> <span class="hljs-variable">bigWritingBrush</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigWritingBrush</span>();<br><br>        <span class="hljs-type">Color</span> <span class="hljs-variable">red</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Red</span>();<br>        <span class="hljs-type">Color</span> <span class="hljs-variable">green</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Green</span>();<br><br>        bigWritingBrush.setColor(red);<br>        System.out.println(bigWritingBrush.draw());<br><br>        bigWritingBrush.setColor(green);<br>        System.out.println(bigWritingBrush.draw());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-优缺点和适用场景"><a href="#6-优缺点和适用场景" class="headerlink" title="6. 优缺点和适用场景"></a>6. 优缺点和适用场景</h2><h3 id="6-1-优点"><a href="#6-1-优点" class="headerlink" title="6.1 优点"></a>6.1 优点</h3><ul><li>解耦。分离抽象接口及其实现部分 </li><li>取代多层继承方案。更贴和合成复用原则  </li><li>提高可扩展性。在抽象和接口两个维度中进行维护时均不需要修改任何一个维度，符合开闭原则</li></ul><h3 id="6-2-缺点"><a href="#6-2-缺点" class="headerlink" title="6.2 缺点"></a>6.2 缺点</h3><ul><li>增加系统的理解和设计难度 </li><li>需要正确地识别出抽象和实现两个维度</li></ul><h3 id="6-3-适用场景"><a href="#6-3-适用场景" class="headerlink" title="6.3 适用场景"></a>6.3 适用场景</h3><ul><li>如果一个系统需要在抽象化和具体化之间增加更多的灵活性，避免在两个层次之间建立静态的继承关系，通过调节模式可以使他们在抽象层建立一个关联关系  </li><li>抽象部分和实现部分可以用继承的方式独立扩张，而不互相影响，在程序运行时，可以动态地加一个抽象化子类的对象，和一个实现化子类的对象进行组合，即系统需要对抽象化对象和实现化对象进行动态耦合 </li><li>一个类存在两个或多个独立变化的维度，且这两个或多个维度都需要独立进行扩张  </li><li>对于那些不希望使用继承或因为多层继承导致系统类的个数急剧增加的系统，桥接模式尤为使用</li></ul><h1 id="四、组合模式"><a href="#四、组合模式" class="headerlink" title="四、组合模式"></a>四、组合模式</h1><p>某软件公司要开发一个杀毒软件，该软件既可以对某个文件夹（Folder）杀毒，也可以对某个指定的文件（File）杀毒。该软件还可以根据各类文件的特点为不同类型的文件提供不同德杀毒方式，例如图像文件（ImageFile）和文本文件（TextFile）的杀毒方式就有所差异。<br>使用组合模式来设计该杀毒软件的整体框架</p><p>以下采用的是安全组合模式，还有一种透明组合模式，但安全性不高，存在无意义的方法</p><h2 id="1-抽象构件"><a href="#1-抽象构件" class="headerlink" title="1. 抽象构件"></a>1. 抽象构件</h2><h3 id="1-1-KillVirus"><a href="#1-1-KillVirus" class="headerlink" title="1.1 KillVirus"></a>1.1 KillVirus</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">KillVirus</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">killVirus</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-AbstractFile"><a href="#1-2-AbstractFile" class="headerlink" title="1.2 AbstractFile"></a>1.2 AbstractFile</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractFile</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KillVirus</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-叶子构件"><a href="#2-叶子构件" class="headerlink" title="2. 叶子构件"></a>2. 叶子构件</h2><h3 id="2-1-File"><a href="#2-1-File" class="headerlink" title="2.1 File"></a>2.1 File</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">File</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractFile</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">File</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">killVirus</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-comment">// 文件特有的方法，而文件夹没有，比如修改扩展名</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-ImageFile"><a href="#2-2-ImageFile" class="headerlink" title="2.2 ImageFile"></a>2.2 ImageFile</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageFile</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">File</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ImageFile</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">killVirus</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;- - - - 对图片文件&#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27;进行杀毒&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-TextFile"><a href="#2-3-TextFile" class="headerlink" title="2.3 TextFile"></a>2.3 TextFile</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextFile</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">File</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextFile</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">killVirus</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;- - - - 对文本文件&#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27;进行杀毒&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-容器构件"><a href="#3-容器构件" class="headerlink" title="3. 容器构件"></a>3. 容器构件</h2><h3 id="3-1-Folder"><a href="#3-1-Folder" class="headerlink" title="3.1 Folder"></a>3.1 Folder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Folder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractFile</span> &#123;<br><br>    <span class="hljs-keyword">private</span> ArrayList&lt;AbstractFile&gt; files = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Folder</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(AbstractFile file)</span> &#123;<br>        files.add(file);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(AbstractFile file)</span> &#123;<br>        files.remove(file);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">killVirus</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;* * * * 对文件夹&#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27;进行杀毒&quot;</span>);<br>        <span class="hljs-keyword">for</span> (AbstractFile file : files) &#123;<br>            file.killVirus();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端代码-1"><a href="#4-客户端代码-1" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        Folder folder1, folder2;<br><br>        File file1, file2, file3, file4;<br><br>        file1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageFile</span>(<span class="hljs-string">&quot;小龙女.jpg&quot;</span>);<br>        file2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageFile</span>(<span class="hljs-string">&quot;张无忌.png&quot;</span>);<br>        file3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextFile</span>(<span class="hljs-string">&quot;葵花宝典.doc&quot;</span>);<br>        file4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextFile</span>(<span class="hljs-string">&quot;九阳真经.txt&quot;</span>);<br><br>        folder1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Folder</span>(<span class="hljs-string">&quot;图片文件夹&quot;</span>);<br>        folder2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Folder</span>(<span class="hljs-string">&quot;文本文件夹&quot;</span>);<br><br>        folder1.add(file1);<br>        folder1.add(file2);<br><br>        folder2.add(file3);<br>        folder2.add(file4);<br><br>        folder1.add(folder2);<br><br>        folder1.killVirus();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-优缺点和适用场景-1"><a href="#5-优缺点和适用场景-1" class="headerlink" title="5. 优缺点和适用场景"></a>5. 优缺点和适用场景</h2><h3 id="5-1-优点-1"><a href="#5-1-优点-1" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>为树形结构的面向对象实现提供了一种灵活的解决方案，通过对叶子对象和容器对象的递归组合可以形成复杂的树形结构，但对树形结构的控制却非常简单</li></ul><h3 id="5-2-缺点-1"><a href="#5-2-缺点-1" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>很难对容器中的构建类进行类型限制。比如上述例子中想针对一个文件夹只存图片文件，因为容器类和叶子类它们都源于同一个抽象层，所以较难实现</li></ul><h3 id="5-3-适用场景-1"><a href="#5-3-适用场景-1" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>在具有整体和部分的层次结构中希望通过一种方式忽略整体与部分的差异，并且客户端可以一致地对待它们</li><li>在一个使用面向对象语言开发的系统中需要处理一个树形结构   </li><li>在一个系统中能够分离出叶子对象和容器对象，而且它们的类型不固定，需要增加一些新的类型</li></ul><h1 id="五、装饰模式"><a href="#五、装饰模式" class="headerlink" title="五、装饰模式"></a>五、装饰模式</h1><p>某构件库提供了大量的基本构建，如窗体、文本框、列表框等，由于在使用该构建库时用户经常要求定制一些特殊的显示效果，如带滚动条的窗体、带黑色边框的文本框、既带滚动条又带黑色边框的列表框等，因此经常需要对该构件库进行扩展以增强其功能<br>请使用装饰模式来设计该图形节面构件库</p><h2 id="1-抽象构建"><a href="#1-抽象构建" class="headerlink" title="1. 抽象构建"></a>1. 抽象构建</h2><h3 id="1-1-Component"><a href="#1-1-Component" class="headerlink" title="1.1 Component"></a>1.1 Component</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Component</span> &#123;<br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-具体构件"><a href="#2-具体构件" class="headerlink" title="2. 具体构件"></a>2. 具体构件</h2><h3 id="2-1-TextBox"><a href="#2-1-TextBox" class="headerlink" title="2.1 TextBox"></a>2.1 TextBox</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextBox</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Component</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;显示文本框&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-Window"><a href="#2-2-Window" class="headerlink" title="2.2 Window"></a>2.2 Window</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Window</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Component</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;显示窗体&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-抽象装饰类"><a href="#3-抽象装饰类" class="headerlink" title="3. 抽象装饰类"></a>3. 抽象装饰类</h2><h3 id="3-1-ComponentDecorator"><a href="#3-1-ComponentDecorator" class="headerlink" title="3.1 ComponentDecorator"></a>3.1 ComponentDecorator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Component</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Component component;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ComponentDecorator</span><span class="hljs-params">(Component component)</span> &#123;<br>        <span class="hljs-built_in">this</span>.component = component;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> &#123;<br>        component.display();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-具体装饰类"><a href="#4-具体装饰类" class="headerlink" title="4. 具体装饰类"></a>4. 具体装饰类</h2><h3 id="4-1-BlackBorderDecorator"><a href="#4-1-BlackBorderDecorator" class="headerlink" title="4.1 BlackBorderDecorator"></a>4.1 BlackBorderDecorator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlackBorderDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ComponentDecorator</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BlackBorderDecorator</span><span class="hljs-params">(Component component)</span> &#123;<br>        <span class="hljs-built_in">super</span>(component);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> &#123;<br>        setBlackBorder();<br>        <span class="hljs-built_in">super</span>.display();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBlackBorder</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;增加黑边框&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-ScrollBarDecorator"><a href="#4-2-ScrollBarDecorator" class="headerlink" title="4.2 ScrollBarDecorator"></a>4.2 ScrollBarDecorator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScrollBarDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ComponentDecorator</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScrollBarDecorator</span><span class="hljs-params">(Component component)</span> &#123;<br>        <span class="hljs-built_in">super</span>(component);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> &#123;<br>        setScrollBar();<br>        <span class="hljs-built_in">super</span>.display();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setScrollBar</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;增加滚动条&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-客户端代码-1"><a href="#5-客户端代码-1" class="headerlink" title="5. 客户端代码"></a>5. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        Component textBox, window;<br>        textBox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextBox</span>();<br>        window = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Window</span>();<br><br>        textBox.display();<br>        window.display();<br><br>        ComponentDecorator blackBorderDeco, scrollBarDeco;<br>        blackBorderDeco = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlackBorderDecorator</span>(textBox);<br>        scrollBarDeco = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScrollBarDecorator</span>(window);<br><br>        blackBorderDeco.display();<br>        scrollBarDeco.display();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-优缺点和适用场景-1"><a href="#6-优缺点和适用场景-1" class="headerlink" title="6. 优缺点和适用场景"></a>6. 优缺点和适用场景</h2><h3 id="6-1-优点-1"><a href="#6-1-优点-1" class="headerlink" title="6.1 优点"></a>6.1 优点</h3><ul><li>对于扩展一个对象的功能，装饰模式比继承更加灵活，不会导致类的个数急剧增加</li><li>可以通过一种动态的方式来扩展一个对象的功能，通过配置文件可以在运行时选择不同的具体装饰类，从而实现不同的行为  </li><li>可以对一个对象进行多次装饰，通过使用不同的具体装饰类以及这些装饰类的排列组合，可以创造出很多不同行为的组合，得到功能强大的对象 </li><li>具体构建类与具体装饰类可以独立变化，用户可以根据需要增加新的具体构建类和具体装饰类，原有类库代码无需改变，符合开闭原则</li></ul><h3 id="6-2-缺点-1"><a href="#6-2-缺点-1" class="headerlink" title="6.2 缺点"></a>6.2 缺点</h3><ul><li>在一定程度上会影响程序的性能。因为适用装饰模式时会产生很多小对象，势必会占用更多的系统资源 </li><li>系统较为复杂。虽然提供了一种比继承更加灵活、机动的解决方案，但同时也意味着更容易出错，排错更加困难</li></ul><h3 id="6-3-适用场景-1"><a href="#6-3-适用场景-1" class="headerlink" title="6.3 适用场景"></a>6.3 适用场景</h3><ul><li>在不影响其他对象的情况下以动态、透明的方式给单个对象添加职责  </li><li>当不能采用继承的方式对系统进行扩展或者采用继承不利于系统扩展和维护时</li></ul><p>而不能采用继承的方式主要有两种情况：  </p><ul><li>第一类：系统存在大量的独立的扩展，为支持每一种扩展或者扩展之间的组合将产生大量的子类，使得子类数目爆炸增长  </li><li>第二类：该类被定义为不能继承类例如被 final 字段修饰</li></ul><h1 id="六、外观模式"><a href="#六、外观模式" class="headerlink" title="六、外观模式"></a>六、外观模式</h1><p>在电脑主机中只需要按下主机的开机按钮，即可调用其他硬件设备的启动方法，如内存的自检(check)、CPU的运行(run)、硬盘的读取(read)、操作系统的载入(load)等，如果某一过程发生错误则电脑启动失败<br>使用外观模式模拟该过程</p><h2 id="1-外观角色"><a href="#1-外观角色" class="headerlink" title="1. 外观角色"></a>1. 外观角色</h2><h3 id="1-1-Boot"><a href="#1-1-Boot" class="headerlink" title="1.1 Boot"></a>1.1 Boot</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Boot</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Check</span> <span class="hljs-variable">check</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Check</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Load</span> <span class="hljs-variable">load</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Load</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Read</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Read</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Run</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Run</span>();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">checkCondition</span> <span class="hljs-operator">=</span> lock.newCondition();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">loadCondition</span> <span class="hljs-operator">=</span> lock.newCondition();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">readCondition</span> <span class="hljs-operator">=</span> lock.newCondition();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">runCondition</span> <span class="hljs-operator">=</span> lock.newCondition();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">check</span><span class="hljs-params">()</span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (flag != <span class="hljs-number">1</span>)&#123;<br>                checkCondition.await();<br>            &#125;<br>            check.check();<br>            flag = <span class="hljs-number">2</span>;<br>            loadCondition.signal();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;内存检测失败！&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (flag != <span class="hljs-number">2</span>)&#123;<br>                loadCondition.await();<br>            &#125;<br>            load.load();<br>            flag = <span class="hljs-number">3</span>;<br>            readCondition.signal();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;载入操作系统失败！&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (flag != <span class="hljs-number">3</span>)&#123;<br>                readCondition.await();<br>            &#125;<br>            read.read();<br>            flag = <span class="hljs-number">4</span>;<br>            runCondition.signal();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;读取硬盘失败！&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (flag != <span class="hljs-number">4</span>)&#123;<br>                runCondition.await();<br>            &#125;<br>            run.run();<br>            flag = <span class="hljs-number">0</span>;<br>            System.out.println(<span class="hljs-string">&quot;启动成功！&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;运行CPU！&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">boot</span><span class="hljs-params">()</span>&#123;<br>        check();<br>        load();<br>        read();<br>        run();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-子系统角色"><a href="#2-子系统角色" class="headerlink" title="2. 子系统角色"></a>2. 子系统角色</h2><h3 id="2-1-Check"><a href="#2-1-Check" class="headerlink" title="2.1 Check"></a>2.1 Check</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Check</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">check</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;正在对内存检测&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;内存检测失败！&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-Load"><a href="#2-2-Load" class="headerlink" title="2.2 Load"></a>2.2 Load</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;正在载入操作系统&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;载入操作系统失败！&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-Read"><a href="#2-3-Read" class="headerlink" title="2.3 Read"></a>2.3 Read</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Read</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;正在读取硬盘&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;读取硬盘失败！&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-4-Run"><a href="#2-4-Run" class="headerlink" title="2.4 Run"></a>2.4 Run</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Run</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;正在运行CPU&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;运行CPU失败！&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-客户端代码"><a href="#3-客户端代码" class="headerlink" title="3. 客户端代码"></a>3. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Boot</span> <span class="hljs-variable">boot</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boot</span>();<br>    boot.boot();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-优缺点和适用场景"><a href="#4-优缺点和适用场景" class="headerlink" title="4. 优缺点和适用场景"></a>4. 优缺点和适用场景</h2><h3 id="4-1-优点"><a href="#4-1-优点" class="headerlink" title="4.1 优点"></a>4.1 优点</h3><ul><li>对客户端屏蔽了子系统组件  </li><li>实现了子系统和客户端之间的松耦合关系  </li><li>子系统对象的修改不会影响到其他子系统对象</li></ul><h3 id="4-2-缺点"><a href="#4-2-缺点" class="headerlink" title="4.2 缺点"></a>4.2 缺点</h3><ul><li>不能限制客户端直接适用子系统类  </li><li>如果设计不当，增加新的子系统类困难需要修改外观类的源代码</li></ul><h3 id="4-3-适用场景"><a href="#4-3-适用场景" class="headerlink" title="4.3 适用场景"></a>4.3 适用场景</h3><ul><li>当需要访问一系列复杂的子系统时，需要提供一个简单的入口、  </li><li>客户端与多个子系统之间存在很大的依赖性，需要减低客户端和子系统之间的耦合度</li></ul><h1 id="七、享元模式"><a href="#七、享元模式" class="headerlink" title="七、享元模式"></a>七、享元模式</h1><p>开发一个围棋软件，但围棋棋盘中包含大量的黑子和白子，它们的形状、大小一模一样，只是出现的位置不同而已。如果将每一个棋子作为一个独立的对象存储在内存中，将导致该围棋软件在运行时所需要的内存空间较大，那么如何降低运行代价、提供系统性能是需要解决的一个问题<br>为了解决该问题，适用享元模式设计该围棋软件的系统架构</p><h2 id="1-抽象享元类"><a href="#1-抽象享元类" class="headerlink" title="1. 抽象享元类"></a>1. 抽象享元类</h2><h3 id="1-1-GoChessPiece"><a href="#1-1-GoChessPiece" class="headerlink" title="1.1 GoChessPiece"></a>1.1 GoChessPiece</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoChessPiece</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getColor</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">(Coordinates coordinates)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;棋子颜色：&quot;</span> + getColor() + <span class="hljs-string">&quot;棋子位置：&quot;</span> + coordinates.getX() + <span class="hljs-string">&quot;,&quot;</span> + coordinates.getY());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-具体享元类"><a href="#2-具体享元类" class="headerlink" title="2. 具体享元类"></a>2. 具体享元类</h2><h3 id="2-1-BlackGoChessPiece"><a href="#2-1-BlackGoChessPiece" class="headerlink" title="2.1 BlackGoChessPiece"></a>2.1 BlackGoChessPiece</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlackGoChessPiece</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GoChessPiece</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getColor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;黑色&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-WhiteGoChessPiece"><a href="#2-2-WhiteGoChessPiece" class="headerlink" title="2.2 WhiteGoChessPiece"></a>2.2 WhiteGoChessPiece</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WhiteGoChessPiece</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GoChessPiece</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getColor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;白色&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-享元工厂类"><a href="#3-享元工厂类" class="headerlink" title="3. 享元工厂类"></a>3. 享元工厂类</h2><h3 id="3-1-GoChessPieceFactory"><a href="#3-1-GoChessPieceFactory" class="headerlink" title="3.1 GoChessPieceFactory"></a>3.1 GoChessPieceFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoChessPieceFactory</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * IoDH单例模式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">GoChessPieceFactory</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HolderClass</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">GoChessPieceFactory</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoChessPieceFactory</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GoChessPieceFactory <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> HolderClass.instance;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 享元池</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, GoChessPiece&gt; flyweightPool;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        flyweightPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>        GoChessPiece black, white;<br>        black = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlackGoChessPiece</span>();<br>        white = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhiteGoChessPiece</span>();<br><br>        flyweightPool.put(<span class="hljs-string">&quot;b&quot;</span>, black);<br>        flyweightPool.put(<span class="hljs-string">&quot;w&quot;</span>, white);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GoChessPiece <span class="hljs-title function_">getGoChessPiece</span><span class="hljs-params">(String color)</span> &#123;<br>        <span class="hljs-keyword">return</span> flyweightPool.get(color);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端代码-2"><a href="#4-客户端代码-2" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        GoChessPiece black1, black2, black3, white1, white2;<br><br>        black1 = GoChessPieceFactory.getGoChessPiece(<span class="hljs-string">&quot;b&quot;</span>);<br>        black2 = GoChessPieceFactory.getGoChessPiece(<span class="hljs-string">&quot;b&quot;</span>);<br>        black3 = GoChessPieceFactory.getGoChessPiece(<span class="hljs-string">&quot;b&quot;</span>);<br><br>        white1 = GoChessPieceFactory.getGoChessPiece(<span class="hljs-string">&quot;w&quot;</span>);<br>        white2 = GoChessPieceFactory.getGoChessPiece(<span class="hljs-string">&quot;w&quot;</span>);<br><br>        black1.display(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Coordinates</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>        black2.display(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Coordinates</span>(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>));<br>        black3.display(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Coordinates</span>(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>));<br><br>        white1.display(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Coordinates</span>(<span class="hljs-number">5</span>, <span class="hljs-number">4</span>));<br>        white2.display(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Coordinates</span>(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>));<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-优缺点和适用场景-2"><a href="#5-优缺点和适用场景-2" class="headerlink" title="5. 优缺点和适用场景"></a>5. 优缺点和适用场景</h2><h3 id="5-1-优点-2"><a href="#5-1-优点-2" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>减少内存中的对象数量  </li><li>耦合低，享元对象可以在不同的环境下适用</li></ul><h3 id="5-2-缺点-2"><a href="#5-2-缺点-2" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>提高系统复杂度</li></ul><h3 id="5-3-适用场景-2"><a href="#5-3-适用场景-2" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>一个系统中有大量相同或者相似的对象，造成内存的大量耗费 </li><li>需要使用一个享元池存储需要被频繁适用的享元对象</li></ul><h1 id="八、代理模式"><a href="#八、代理模式" class="headerlink" title="八、代理模式"></a>八、代理模式</h1><p>在某应用软件中需要记录业务方法的调用日志，在不修改现有业务类的基础上为每一个类提供一个日志记录代理类，在中输出日志，如在业务方法method()调用之前输出“方法method()被调用，调用时间为2012-10-10 10：10：10”</p><h2 id="1-抽象主题角色"><a href="#1-抽象主题角色" class="headerlink" title="1. 抽象主题角色"></a>1. 抽象主题角色</h2><h3 id="1-1-UserService"><a href="#1-1-UserService" class="headerlink" title="1.1 UserService"></a>1.1 UserService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-代理主题角色"><a href="#2-代理主题角色" class="headerlink" title="2. 代理主题角色"></a>2. 代理主题角色</h2><h3 id="2-1-UserServiceProxy"><a href="#2-1-UserServiceProxy" class="headerlink" title="2.1 UserServiceProxy"></a>2.1 UserServiceProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Object target;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserServiceProxy</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTarget</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-built_in">this</span>.getClass().getClassLoader(),<br>                target.getClass().getInterfaces(), <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        log(method.getName());<br>        method.invoke(target, args);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String methodName)</span> &#123;<br>        System.out.println(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss:SSS&quot;</span>)) + <span class="hljs-string">&quot;调用了&quot;</span> + methodName);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-真实主题角色"><a href="#3-真实主题角色" class="headerlink" title="3. 真实主题角色"></a>3. 真实主题角色</h2><h3 id="3-1-UserServiceImpl"><a href="#3-1-UserServiceImpl" class="headerlink" title="3.1 UserServiceImpl"></a>3.1 UserServiceImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行查询用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行删除用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行修改用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行插入用户&quot;</span>);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端代码-3"><a href="#4-客户端代码-3" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br>    <span class="hljs-type">UserServiceProxy</span> <span class="hljs-variable">userServiceProxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceProxy</span>(userService);<br>    <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (UserService) userServiceProxy.getProxy();<br>    proxy.select();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-优缺点和适用场景-3"><a href="#5-优缺点和适用场景-3" class="headerlink" title="5. 优缺点和适用场景"></a>5. 优缺点和适用场景</h2><h3 id="5-1-优点-3"><a href="#5-1-优点-3" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>能够协调使用调用者和被调用者，降低了系统耦合度   </li><li>具有较好的灵活性和扩展性，可以进行 AOP  </li><li>此外，不同类型的代理模式具有独特的优点，具体请君网上查找</li></ul><h3 id="5-2-缺点-3"><a href="#5-2-缺点-3" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>需要进行额外的工作，并且较为复杂</li></ul><h3 id="5-3-适用场景-3"><a href="#5-3-适用场景-3" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>AOP等等 </li><li>好多😀，例如远程代理、缓冲代理、权限代理、智能引用代理</li></ul>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>创建型模式</title>
    <link href="/2022/06/25/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/06/25/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>创建型模式（Creational Pattern）关注对象的创建过程，在系统开发中应用非常广泛<br>这种模式对类的实例化过程进行了抽象，能够将软件模块中<strong>对象的创建和对象的使用分离</strong>，对用户隐藏了类的实力的创建细节，这样会带来如下好处：</p><ul><li>无须关心创建对象的细节</li><li>降低系统的耦合度</li><li>让设计方案更易于修改和扩展</li></ul><p>而每一种创建型模式都会基于下列三点：</p><ul><li>创建什么（What）</li><li>由谁创建（Who）</li><li>何时创建（When）</li></ul><p>创建型模式共有六种：</p><table><thead><tr><th align="center"><strong>设计原则名称</strong></th><th align="center"><strong>定义</strong></th><th align="center"><strong>使用频率</strong></th></tr></thead><tbody><tr><td align="center">简单工厂模式 （Simple Factory Pattern）</td><td align="center">定义一个工程类，它可以根据参数的不同，返回不同类的实例，被创建的实例通常都具有共同的父类</td><td align="center">⭐⭐⭐</td></tr><tr><td align="center">工厂方法模式 （Factory Method Pattern）</td><td align="center">定义一个用于创建对象的接口，但是让子类决定将哪一个类实例化。工厂方法模式让一个类的实例化延迟到其子类</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">抽象工厂模式 （Abstract Factory Pattern）</td><td align="center">提供一个创建一系列相关或相互依赖对象的接口，而无须指定它们具体的类</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">建造者模式 （Builder Pattern）</td><td align="center">将一个复杂对象的构造与它的表示分离，使得同样的构造过程可以创建不同的表示</td><td align="center">⭐⭐</td></tr><tr><td align="center">原型模式 （Prototype Pattern）</td><td align="center">使用原型实例指定待创建对象的类型，并且通过复制这个原型来创建新的对象</td><td align="center">⭐⭐⭐</td></tr><tr><td align="center">单例模式 （Singleton Pattern）</td><td align="center">确保一个类只有一个实例，并提供一个全局的访问点来访问这个唯一实例</td><td align="center">⭐⭐⭐⭐</td></tr></tbody></table><h1 id="二、简单工厂模式"><a href="#二、简单工厂模式" class="headerlink" title="二、简单工厂模式"></a>二、简单工厂模式</h1><p>实现一个简单的加减乘除计算器</p><h2 id="1-创建什么"><a href="#1-创建什么" class="headerlink" title="1. 创建什么"></a>1. 创建什么</h2><h3 id="1-1-Operation"><a href="#1-1-Operation" class="headerlink" title="1.1 Operation"></a>1.1 Operation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Operation</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> result;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getResult</span><span class="hljs-params">(<span class="hljs-type">double</span> num1, <span class="hljs-type">double</span> num2)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-Add"><a href="#1-2-Add" class="headerlink" title="1.2 Add"></a>1.2 Add</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Add</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Operation</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getResult</span><span class="hljs-params">(<span class="hljs-type">double</span> num1, <span class="hljs-type">double</span> num2)</span> &#123;<br>        result = num1 + num2;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-Sub"><a href="#1-3-Sub" class="headerlink" title="1.3 Sub"></a>1.3 Sub</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Operation</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getResult</span><span class="hljs-params">(<span class="hljs-type">double</span> num1, <span class="hljs-type">double</span> num2)</span> &#123;<br>        result = num1 - num2;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-4-Mul"><a href="#1-4-Mul" class="headerlink" title="1.4 Mul"></a>1.4 Mul</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mul</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Operation</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getResult</span><span class="hljs-params">(<span class="hljs-type">double</span> num1, <span class="hljs-type">double</span> num2)</span> &#123;<br>        result = num1 * num2;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-5-Div"><a href="#1-5-Div" class="headerlink" title="1.5 Div"></a>1.5 Div</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Div</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Operation</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getResult</span><span class="hljs-params">(<span class="hljs-type">double</span> num1, <span class="hljs-type">double</span> num2)</span> &#123;<br>        result = num1 / num2;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-由谁创建"><a href="#2-由谁创建" class="headerlink" title="2. 由谁创建"></a>2. 由谁创建</h2><h2 id="2-1-OperationFactory"><a href="#2-1-OperationFactory" class="headerlink" title="2.1 OperationFactory"></a>2.1 OperationFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Operation operation;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationFactory</span><span class="hljs-params">(Operation operation)</span> &#123;<br>        <span class="hljs-built_in">this</span>.operation = operation;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Operation <span class="hljs-title function_">createOperation</span><span class="hljs-params">(String in)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (in) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;+&quot;</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">add</span>();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;-&quot;</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sub</span>();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;*&quot;</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">mul</span>();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/&quot;</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">div</span>();<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-何时创建"><a href="#3-何时创建" class="headerlink" title="3. 何时创建"></a>3. 何时创建</h2><h3 id="3-1-createOperation方法"><a href="#3-1-createOperation方法" class="headerlink" title="3.1 createOperation方法"></a>3.1 createOperation方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Operation <span class="hljs-title function_">createOperation</span><span class="hljs-params">(String in)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (in) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;+&quot;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">add</span>();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;-&quot;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sub</span>();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;*&quot;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">mul</span>();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/&quot;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">div</span>();<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端代码"><a href="#4-客户端代码" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Operation</span> <span class="hljs-variable">operation</span> <span class="hljs-operator">=</span> OperationFactory.createOperation(<span class="hljs-string">&quot;/&quot;</span>);<br><span class="hljs-keyword">if</span> (operation != <span class="hljs-literal">null</span>) &#123;                                    <br>    System.out.println(operation.getResult(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>));          <br>&#125; <span class="hljs-keyword">else</span> &#123;                                                    <br>    System.out.println(<span class="hljs-string">&quot;不正常输入！&quot;</span>);                           <br>&#125;                                                           <br></code></pre></td></tr></table></figure><h2 id="5-优缺点及适用场景"><a href="#5-优缺点及适用场景" class="headerlink" title="5. 优缺点及适用场景"></a>5. 优缺点及适用场景</h2><h3 id="5-1-优点"><a href="#5-1-优点" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>无须知道所创建的具体产品的类名，只需要知道对应的参数即可</li></ul><h3 id="5-2-缺点"><a href="#5-2-缺点" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>职责过重，工厂类集中了所有产品的创建逻辑</li><li>增加了系统的复杂度和理解难度</li><li>系统扩展困难，一旦需要添加新产品就不得不修改工厂逻辑，一定程度上违背了开闭原则</li></ul><h3 id="5-3-适用场景"><a href="#5-3-适用场景" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>工厂类负责创建的对象比较少，这样就可以避免工厂方法中的业务逻辑过于复杂</li><li>客户端只知道工厂类的参数，对如何创建对象并不关心</li></ul><h1 id="三、工厂方法模式"><a href="#三、工厂方法模式" class="headerlink" title="三、工厂方法模式"></a>三、工厂方法模式</h1><p>输出数据图形，曲线图（LineDiagram）创建器生成曲线图，柱形图（ColumnDiagram）创建器生成柱形图</p><h2 id="1-创建什么-1"><a href="#1-创建什么-1" class="headerlink" title="1. 创建什么"></a>1. 创建什么</h2><h3 id="1-1-Diagram"><a href="#1-1-Diagram" class="headerlink" title="1.1 Diagram"></a>1.1 Diagram</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Diagram</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-LineDiagram"><a href="#1-2-LineDiagram" class="headerlink" title="1.2 LineDiagram"></a>1.2 LineDiagram</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LineDiagram</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Diagram</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;生成曲线图&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-ColumnDiagram"><a href="#1-3-ColumnDiagram" class="headerlink" title="1.3 ColumnDiagram"></a>1.3 ColumnDiagram</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ColumnDiagram</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Diagram</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;生成柱形图&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-由谁创建-1"><a href="#2-由谁创建-1" class="headerlink" title="2. 由谁创建"></a>2. 由谁创建</h2><h3 id="2-1-DiagramFactroy"><a href="#2-1-DiagramFactroy" class="headerlink" title="2.1 DiagramFactroy"></a>2.1 DiagramFactroy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DiagramFactory</span> &#123;<br>    Diagram <span class="hljs-title function_">createDiagram</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-LineDiagramFactory"><a href="#2-2-LineDiagramFactory" class="headerlink" title="2.2 LineDiagramFactory"></a>2.2 LineDiagramFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LineDiagramFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DiagramFactory</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Diagram <span class="hljs-title function_">createDiagram</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LineDiagram</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-ColumnDiagramFactory"><a href="#2-3-ColumnDiagramFactory" class="headerlink" title="2.3 ColumnDiagramFactory"></a>2.3 ColumnDiagramFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ColumnDiagramFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DiagramFactory</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Diagram <span class="hljs-title function_">createDiagram</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ColumnDiagram</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-何时创建-1"><a href="#3-何时创建-1" class="headerlink" title="3.何时创建"></a>3.何时创建</h2><p>具体工厂中实现了抽象工厂的<code>createDiagram()</code>方法  </p><h2 id="4-客户端代码-1"><a href="#4-客户端代码-1" class="headerlink" title="4.客户端代码"></a>4.客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java">DiagramFactory diagramFactory;                                  <br>Diagram diagram;                                                <br><span class="hljs-keyword">try</span> &#123;                                                           <br>    diagramFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LineDiagramFactory</span>(); <span class="hljs-comment">// 可引入配置文件和反射机制实现</span><br>    diagram = diagramFactory.createDiagram();                   <br>    diagram.create();                                           <br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                                         <br>    e.printStackTrace();                                        <br>&#125;                                                               <br></code></pre></td></tr></table></figure><h2 id="5-优缺点及适用场景-1"><a href="#5-优缺点及适用场景-1" class="headerlink" title="5.优缺点及适用场景"></a>5.优缺点及适用场景</h2><h3 id="5-1-优点-1"><a href="#5-1-优点-1" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>解耦。用户只关心产品对应的工厂，无须关心实现细节，甚至无须知道具体产品的类名</li><li>可扩展性，完全符合开闭原则。例如添加新产品时，无须修改抽象产品和抽象工厂的方法</li></ul><h3 id="5-2-缺点-1"><a href="#5-2-缺点-1" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>复杂度较高。添加新产品时既需要添加新产品的具体类也要添加新工厂的具体类 </li><li>有一定的抽象性和理解难度。因为考虑到可扩展性，引入了抽象层，在客户端代码中也需要通过抽象层进行定义</li></ul><h3 id="5-3-适用场景-1"><a href="#5-3-适用场景-1" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>客户端不需要他所需要的对象的类 </li><li>抽象工厂类通过其子类来指定创建哪个对象</li></ul><h1 id="四、抽象工厂模式"><a href="#四、抽象工厂模式" class="headerlink" title="四、抽象工厂模式"></a>四、抽象工厂模式</h1><p>某系统为了改进数据库操作的性能，自定义数据为连接对象(Connection)和语句(Statement)对象，可针对不同类型的数据库提供不同的连接对象和语句对象，如提供Oracle或MySQL专用连接类和语句类，而且用户可以通过配置文件等方式根据实际需要动态更换系统数据库。  </p><h2 id="1-创建什么-2"><a href="#1-创建什么-2" class="headerlink" title="1.创建什么"></a>1.创建什么</h2><p>产品族：</p><ul><li>Mysql 相关 </li><li>Oracle 相关</li></ul><p>产品等级结构：</p><ul><li>连接对象 Connection  </li><li>语句对象 Statement</li></ul><h3 id="1-1-Connection"><a href="#1-1-Connection" class="headerlink" title="1.1 Connection"></a>1.1 Connection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Connection</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-MysqlConnection"><a href="#1-2-MysqlConnection" class="headerlink" title="1.2 MysqlConnection"></a>1.2 MysqlConnection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MysqlConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Connection</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Mysql连接对象&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-OracleConnection"><a href="#1-3-OracleConnection" class="headerlink" title="1.3 OracleConnection"></a>1.3 OracleConnection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Connection</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Oracle连接对象&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-4-Statement"><a href="#1-4-Statement" class="headerlink" title="1.4 Statement"></a>1.4 Statement</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Statement</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getStatement</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-5-MysqlStatement"><a href="#1-5-MysqlStatement" class="headerlink" title="1.5 MysqlStatement"></a>1.5 MysqlStatement</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MysqlStatement</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Statement</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getStatement</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Mysql语句对象&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-6-OracleStatement"><a href="#1-6-OracleStatement" class="headerlink" title="1.6 OracleStatement"></a>1.6 OracleStatement</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleStatement</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Statement</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getStatement</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Oracle语句对象&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-由谁创建-2"><a href="#2-由谁创建-2" class="headerlink" title="2. 由谁创建"></a>2. 由谁创建</h2><h3 id="2-1-DataBaseFactory"><a href="#2-1-DataBaseFactory" class="headerlink" title="2.1 DataBaseFactory"></a>2.1 DataBaseFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataBaseFactory</span> &#123;<br>    Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span>;<br>    Statement <span class="hljs-title function_">getStatement</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-MysqlDataBaseFactory"><a href="#2-2-MysqlDataBaseFactory" class="headerlink" title="2.2 MysqlDataBaseFactory"></a>2.2 MysqlDataBaseFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MysqlDataBaseFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataBaseFactory</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MysqlConnection</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">getStatement</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MysqlStatement</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-OracleDataBaseFactory"><a href="#2-3-OracleDataBaseFactory" class="headerlink" title="2.3 OracleDataBaseFactory"></a>2.3 OracleDataBaseFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleDataBaseFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataBaseFactory</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OracleConnection</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">getStatement</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OracleStatement</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-何时创建-2"><a href="#3-何时创建-2" class="headerlink" title="3. 何时创建"></a>3. 何时创建</h2><p>由确定的工厂创造确定的产品</p><h2 id="4-客户端代码-2"><a href="#4-客户端代码-2" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">DataBaseFactory</span> <span class="hljs-variable">dataBaseFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MysqlDataBaseFactory</span>(); <span class="hljs-comment">// 可引入配置文件和反射机制实现</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataBaseFactory.getConnection();                       <br><span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> dataBaseFactory.getStatement();                          <br>connection.getConnection();                                                    <br>statement.getStatement();                                                      <br></code></pre></td></tr></table></figure><h2 id="5-优缺点及适用场景-2"><a href="#5-优缺点及适用场景-2" class="headerlink" title="5. 优缺点及适用场景"></a>5. 优缺点及适用场景</h2><h3 id="5-1-优点-2"><a href="#5-1-优点-2" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>解耦。用户只关心产品对应的工厂，无须关心实现细节，甚至无须知道具体产品的类名</li><li>可扩展性，完全符合开闭原则。例如添加新的产品族时，无须修改抽象产品和抽象工厂的方法</li></ul><h3 id="5-2-缺点-2"><a href="#5-2-缺点-2" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>起初设计时难度较大，需要考虑周全。添加新的产品等级结构时，需要修改抽象工厂的方法，违背了开闭原则。例如在此基础上新增产品等级结构对象 Exception，那么对应的产品族 Mysql、Oracle 均需要新增 MysqlException、OracleException，并且基类 DataBaseFactory 也需要新增方法 getException，同时其子了 MysqlDataBaseFactory、OracleDataBaseFactory 也均需要另外实现 getException 方法</li></ul><h3 id="5-3-适用场景-2"><a href="#5-3-适用场景-2" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>用户只关心产品对应的工厂，无须关心实现细节，甚至无须知道具体产品的类名，这是所有类型的工厂模式都是很重要的</li><li>系统中有一个以上的产品族</li><li>属于同一个产品族的产品将在一起使用，它们之间可以没有任何关系，但是它们都有共同的约束，例如操作系统下的按钮和文本框，按钮与文本框之间没有直接关系，但是它们都是属于某一个操作系统下的，此时具有一个共同的约束条件，即操作系统的类型</li><li>产品等级结构稳定</li></ul><h1 id="五、建造者模式"><a href="#五、建造者模式" class="headerlink" title="五、建造者模式"></a>五、建造者模式</h1><p>设计一个游戏角色，它包含性别、脸型等多个部分组成，不同角色的性别、脸型、服装、发型等外部特性都有差异，例如“天使”拥有美丽的面容和披肩的长发；而“恶魔”极其丑陋，留着光头并穿一件刺眼的黑衣</p><h2 id="1-创建什么-3"><a href="#1-创建什么-3" class="headerlink" title="1. 创建什么"></a>1. 创建什么</h2><h3 id="1-1-Actor"><a href="#1-1-Actor" class="headerlink" title="1.1 Actor"></a>1.1 Actor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Actor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String type;<br><br>    <span class="hljs-keyword">private</span> String sex;<br><br>    <span class="hljs-keyword">private</span> String face;<br><br>    <span class="hljs-keyword">private</span> String costume;<br><br>    <span class="hljs-keyword">private</span> String hairstyle;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> type;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setType</span><span class="hljs-params">(String type)</span> &#123;<br>        <span class="hljs-built_in">this</span>.type = type;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSex</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sex;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSex</span><span class="hljs-params">(String sex)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sex = sex;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFace</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> face;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFace</span><span class="hljs-params">(String face)</span> &#123;<br>        <span class="hljs-built_in">this</span>.face = face;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCostume</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> costume;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCostume</span><span class="hljs-params">(String costume)</span> &#123;<br>        <span class="hljs-built_in">this</span>.costume = costume;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHairstyle</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> hairstyle;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHairstyle</span><span class="hljs-params">(String hairstyle)</span> &#123;<br>        <span class="hljs-built_in">this</span>.hairstyle = hairstyle;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-由谁创建-3"><a href="#2-由谁创建-3" class="headerlink" title="2. 由谁创建"></a>2. 由谁创建</h2><h3 id="2-1-ActorBuilder"><a href="#2-1-ActorBuilder" class="headerlink" title="2.1 ActorBuilder"></a>2.1 ActorBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActorBuilder</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">Actor</span> <span class="hljs-variable">actor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Actor</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildType</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSex</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFace</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildCostume</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildHairstyle</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否是光头？&lt;br&gt;</span><br><span class="hljs-comment">     * 钩子方法，控制是否执行&#123;<span class="hljs-doctag">@link</span> #buildHairstyle()&#125;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 默认为 false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBareHeaded</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Actor <span class="hljs-title function_">buildActor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> actor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-AngelBuilder"><a href="#2-2-AngelBuilder" class="headerlink" title="2.2 AngelBuilder"></a>2.2 AngelBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AngelBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActorBuilder</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildType</span><span class="hljs-params">()</span> &#123;<br>        actor.setType(<span class="hljs-string">&quot;天使&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSex</span><span class="hljs-params">()</span> &#123;<br>        actor.setSex(<span class="hljs-string">&quot;女&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFace</span><span class="hljs-params">()</span> &#123;<br>        actor.setFace(<span class="hljs-string">&quot;漂亮脸蛋&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildCostume</span><span class="hljs-params">()</span> &#123;<br>        actor.setCostume(<span class="hljs-string">&quot;白裙&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildHairstyle</span><span class="hljs-params">()</span> &#123;<br>        actor.setHairstyle(<span class="hljs-string">&quot;披肩长发&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-DevilBuilder"><a href="#2-3-DevilBuilder" class="headerlink" title="2.3 DevilBuilder"></a>2.3 DevilBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DevilBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActorBuilder</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildType</span><span class="hljs-params">()</span> &#123;<br>        actor.setType(<span class="hljs-string">&quot;恶魔&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSex</span><span class="hljs-params">()</span> &#123;<br>        actor.setSex(<span class="hljs-string">&quot;男&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFace</span><span class="hljs-params">()</span> &#123;<br>        actor.setFace(<span class="hljs-string">&quot;丑陋脸蛋&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildCostume</span><span class="hljs-params">()</span> &#123;<br>        actor.setCostume(<span class="hljs-string">&quot;刺眼黑衣&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildHairstyle</span><span class="hljs-params">()</span> &#123;<br>        actor.setHairstyle(<span class="hljs-string">&quot;光头&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBareHeaded</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-何时创建-3"><a href="#3-何时创建-3" class="headerlink" title="3. 何时创建"></a>3. 何时创建</h2><h3 id="3-1-ActorDirector"><a href="#3-1-ActorDirector" class="headerlink" title="3.1 ActorDirector"></a>3.1 ActorDirector</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActorDirector</span> &#123;<br>    <span class="hljs-keyword">public</span> Actor <span class="hljs-title function_">construct</span><span class="hljs-params">(ActorBuilder ab)</span> &#123;<br>        Actor actor;<br>        ab.buildType();<br>        ab.buildSex();<br>        ab.buildFace();<br>        ab.buildCostume();<br>        <span class="hljs-keyword">if</span> (!ab.isBareHeaded()) &#123;<br>            ab.buildHairstyle();<br>        &#125;<br>        actor = ab.buildActor();<br>        <span class="hljs-keyword">return</span> actor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-客户端代码-3"><a href="#4-客户端代码-3" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Actor</span> <span class="hljs-variable">actor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Actor</span>();                                       <br><span class="hljs-type">ActorDirector</span> <span class="hljs-variable">actorDirector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActorDirector</span>();               <br><span class="hljs-type">ActorBuilder</span> <span class="hljs-variable">angelBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AngelBuilder</span>(); <span class="hljs-comment">// 可引入配置文件和反射机制实现</span><br>actor = actorDirector.construct(angelBuilder);                   <br></code></pre></td></tr></table></figure><h2 id="5-优缺点及适用场景-3"><a href="#5-优缺点及适用场景-3" class="headerlink" title="5. 优缺点及适用场景"></a>5. 优缺点及适用场景</h2><h3 id="5-1-优点-3"><a href="#5-1-优点-3" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>耦合性低。客户端不必知道产品内部的组成细节，将产品本身与产品的创建过程解耦，使得相同的创建过程可以创建不同的产品对象</li><li>扩展方便。每一个具体建造者相对独立，与其他建造者无关。</li><li>可以精细地控制产品地创建过程。将复杂产品的创建步骤分解在不同的方法中，使得创建过程更加清晰，也方便程序进行控制</li></ul><h3 id="5-2-缺点-3"><a href="#5-2-缺点-3" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>有一定的局限性。适用建造者模式通常创建的产品有较多的共同点，其组成部分相似，如果产品间差异性很大，例如很多组成部分都不同，那么就不适合适用</li><li>增加理解难度和运行成本。如果产品的内部变化复杂，困难会导致需要定义很多具体建造者类来实现，这样会使系统变得庞大</li></ul><h3 id="5-3-适用场景-3"><a href="#5-3-适用场景-3" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>需要生成的产品对象有复杂的内部结构，这些产品对象通常包含多个成员变量</li><li>需要生成的产品对象的属性相互依赖，需要指定其生成的顺序</li><li>对象的创建过程，独立于创建该对象的内在建造者模式中，通过引入指挥者类，将创建过程封装在指挥者类中，而不在建造者类和客户类中</li><li>隔离复杂对象的创建和使用，并使得相同的创建过程可以创建不同的产品</li></ul><h1 id="六、原型模式"><a href="#六、原型模式" class="headerlink" title="六、原型模式"></a>六、原型模式</h1><p>请为某销售管理系统设计并实现一个客户类Customer，在客户类中包含一个名为客户地址的成员变量，客户地址的类型为Address，用浅克隆和深克隆分别实现Customer对象的复制</p><h2 id="深克隆和浅克隆"><a href="#深克隆和浅克隆" class="headerlink" title="深克隆和浅克隆"></a>深克隆和浅克隆</h2><p>浅克隆：</p><ul><li>基于同一个类型成员变量的地址</li><li>复制原型对象</li><li>复制基本类型的值</li></ul><p>深克隆：</p><ul><li>复制同一个类型成员变量的地址</li><li>复制原型对象</li><li>复制基本类型的值</li></ul><h2 id="1-创建什么-4"><a href="#1-创建什么-4" class="headerlink" title="1. 创建什么"></a>1. 创建什么</h2><h3 id="1-1-Address"><a href="#1-1-Address" class="headerlink" title="1.1 Address"></a>1.1 Address</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-由谁创建-4"><a href="#2-由谁创建-4" class="headerlink" title="2. 由谁创建"></a>2. 由谁创建</h2><h3 id="2-1-Customer"><a href="#2-1-Customer" class="headerlink" title="2.1 Customer"></a>2.1 Customer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>, Cloneable &#123;<br>    <br>    <span class="hljs-keyword">private</span> Address address;<br>    <br>    <span class="hljs-keyword">private</span> String name;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> Address <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddress</span><span class="hljs-params">(Address address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Customer <span class="hljs-title function_">deepClone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bao);<br>        oos.writeObject(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bao.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bis);<br>        <span class="hljs-keyword">return</span> (Customer) ois.readObject();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Customer <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> &#123;<br>        Object object;<br>        <span class="hljs-keyword">try</span> &#123;<br>            object = <span class="hljs-built_in">super</span>.clone();<br>            <span class="hljs-keyword">return</span> (Customer) object;<br>        &#125; <span class="hljs-keyword">catch</span> (CloneNotSupportedException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;不支持负责&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-何时创建-4"><a href="#3-何时创建-4" class="headerlink" title="3. 何时创建"></a>3. 何时创建</h2><p>Customer 的深克隆方法 deepClone 和浅克隆方法 clone</p><h2 id="4-客户端代码-4"><a href="#4-客户端代码-4" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shallow</span><span class="hljs-params">()</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;浅克隆：&quot;</span>);<br>    <span class="hljs-type">Customer</span> <span class="hljs-variable">customerPrototype</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>();<br>    customerPrototype.setAddress(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">&quot;北京&quot;</span>));<br>    <span class="hljs-type">Customer</span> <span class="hljs-variable">customerClone</span> <span class="hljs-operator">=</span> customerPrototype.clone();<br>    <span class="hljs-comment">// 对象比较</span><br>    System.out.println(customerPrototype == customerClone);<br>    System.out.println(customerPrototype.equals(customerClone));<br>    <span class="hljs-comment">// 属性类比较</span><br>    System.out.println(customerPrototype.getAddress() == customerClone.getAddress());<br>    System.out.println(customerPrototype.getAddress().equals(customerClone.getAddress()));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deep</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    System.out.println(<span class="hljs-string">&quot;深克隆：&quot;</span>);<br>    <span class="hljs-type">Customer</span> <span class="hljs-variable">customerPrototype</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>();<br>    customerPrototype.setAddress(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">&quot;南京&quot;</span>));<br>    <span class="hljs-type">Customer</span> <span class="hljs-variable">customerClone</span> <span class="hljs-operator">=</span> customerPrototype.deepClone();<br>    <span class="hljs-comment">// 对象比较</span><br>    System.out.println(customerPrototype == customerClone);<br>    System.out.println(customerPrototype.equals(customerClone));<br>    <span class="hljs-comment">// 属性类比较</span><br>    System.out.println(customerPrototype.getAddress() == customerClone.getAddress());<br>    System.out.println(customerPrototype.getAddress().equals(customerClone.getAddress()));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-优缺点及适用场景-4"><a href="#5-优缺点及适用场景-4" class="headerlink" title="5. 优缺点及适用场景"></a>5. 优缺点及适用场景</h2><h3 id="5-1-优点-4"><a href="#5-1-优点-4" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>提高效率。使用原型模式创建对象比直接new一个对象在性能上要好的多，因为Object类的clone方法是一个本地方法， 它直接操作内存中的二进制流，特别是复制大对象时，性能的差别非常明显。</li></ul><h3 id="5-2-缺点-4"><a href="#5-2-缺点-4" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>违背了开闭原则。需要为每个需要克隆的类提供clone方法</li><li>可能会提高复杂度。当克隆的代码比较复杂，存在多重的嵌套引用，如果要实现深克隆就需要为每一层对象都支持深克隆</li></ul><h3 id="5-3-适用场景-4"><a href="#5-3-适用场景-4" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>创建新对象成本较大</li><li>系统要保存对象的状态，而对象的状态变化很小</li><li>复杂度较低，不存在多重的嵌套引用</li></ul><h1 id="七、单例模式"><a href="#七、单例模式" class="headerlink" title="七、单例模式"></a>七、单例模式</h1><h2 id="1-创建什么-5"><a href="#1-创建什么-5" class="headerlink" title="1. 创建什么"></a>1. 创建什么</h2><p>自己</p><h2 id="2-由谁创建-5"><a href="#2-由谁创建-5" class="headerlink" title="2. 由谁创建"></a>2. 由谁创建</h2><p>自己，下列提供三种单例模式</p><h3 id="2-1-EagerSingleton"><a href="#2-1-EagerSingleton" class="headerlink" title="2.1 EagerSingleton"></a>2.1 EagerSingleton</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EagerSingleton</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">EagerSingleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EagerSingleton</span>();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EagerSingleton</span><span class="hljs-params">()</span> &#123;&#125;;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> EagerSingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-LazySingleton"><a href="#2-2-LazySingleton" class="headerlink" title="2.2 LazySingleton"></a>2.2 LazySingleton</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazySingleton</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">LazySingleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">LazySingleton</span><span class="hljs-params">()</span> &#123;&#125;;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LazySingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (LazySingleton.class) &#123;<br>                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazySingleton</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-IoDHSingleton"><a href="#2-3-IoDHSingleton" class="headerlink" title="2.3 IoDHSingleton"></a>2.3 IoDHSingleton</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IoDHSingleton</span> &#123; <span class="hljs-comment">// Initialization on Demand Holder</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">IoDHSingleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HolderClass</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">IoDHSingleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IoDHSingleton</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IoDHSingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> HolderClass.instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-何时创建-5"><a href="#3-何时创建-5" class="headerlink" title="3. 何时创建"></a>3. 何时创建</h2><p>自己</p><h2 id="4-客户端代码-5"><a href="#4-客户端代码-5" class="headerlink" title="4. 客户端代码"></a>4. 客户端代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">IoDHSingleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> IoDHSingleton.getInstance();<br></code></pre></td></tr></table></figure><h2 id="5-优缺点及适用场景-5"><a href="#5-优缺点及适用场景-5" class="headerlink" title="5. 优缺点及适用场景"></a>5. 优缺点及适用场景</h2><h3 id="5-1-优点-5"><a href="#5-1-优点-5" class="headerlink" title="5.1 优点"></a>5.1 优点</h3><ul><li>提供了唯一实例的受控访问</li><li>节约资源。因为系统中只存在一个这样的实例</li></ul><h3 id="5-2-缺点-5"><a href="#5-2-缺点-5" class="headerlink" title="5.2 缺点"></a>5.2 缺点</h3><ul><li>扩展困难。没有抽象层</li><li>职责过重。因为单例类可能既提供了业务方法，也需要提供创建自己的方法</li></ul><h3 id="5-3-适用场景-5"><a href="#5-3-适用场景-5" class="headerlink" title="5.3 适用场景"></a>5.3 适用场景</h3><ul><li>系统中只需要一个实例对象</li><li>客户调用类的单个实例只允许使用一个公共访问点</li></ul>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>面向对象设计原则</title>
    <link href="/2022/06/23/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/"/>
    <url>/2022/06/23/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/</url>
    
    <content type="html"><![CDATA[<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>简而言之就是讲究两点：</p><ul><li><strong>可维护性（Maintainability）</strong></li><li><strong>可复用性（Reusability）</strong></li></ul><p>常用的面向对象设计原则有七种：</p><table><thead><tr><th align="center">设计原则名称</th><th align="center">定义</th><th align="center">使用频率</th></tr></thead><tbody><tr><td align="center">单一职责原则 （Single Responsibility Principle，SRP）</td><td align="center">一个对象应该只包含单一的职责，并且该职责被完整地封装在一个类中</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="center">开闭原则 （Open-Closed Principle，OCP）</td><td align="center">软件实体应当对扩展开放，对修改关闭</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">里氏代换原则 （Liskov Substitution Principle，LSP）</td><td align="center">所有引用基类的地方必须能透明地使用其子类的对象</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">依赖倒转原则 （Dependence Inversion Principle，DIP）</td><td align="center">高层模块不应该依赖低层模块，它们都应该依赖抽象。抽象不应该依赖于细节，细节应该依赖于抽象</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="center">接口隔离原则 （Interface Segregation Principal，ISP）</td><td align="center">客户端不应该依赖那些它不需要的接口</td><td align="center">⭐⭐</td></tr><tr><td align="center">合成复用原则 （Composite Reuse Principal，CRP）</td><td align="center">优先使用对象组合，而不是通过继承来达到复用的目的</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="center">迪米特法则 （Law of Demeter，LoD）</td><td align="center">每一个软件单位对其他单位都只有最少的知识，而且局限于那些本单位密切相关的软件单位</td><td align="center">⭐⭐⭐</td></tr></tbody></table><h1 id="二、面向对象设计原则"><a href="#二、面向对象设计原则" class="headerlink" title="二、面向对象设计原则"></a>二、面向对象设计原则</h1><h2 id="1-单一职责原则"><a href="#1-单一职责原则" class="headerlink" title="1. 单一职责原则"></a>1. 单一职责原则</h2><p><strong>简而言之就是控制类的粒度大小</strong></p><p>如下图类：</p><img src="/2022/06/23/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/1.png" class=""><p>使用单一职责原则对其重构后需要3个类：</p><ul><li>DbUtil：负责连接数据库，其中包含方法 getConnection()</li><li>CustomerDao：负责操作数据库中的 Customer 表，包括增删改查操作，例如 findCustomers()</li><li>CustomerDataChart：负责图表的生成和显示，包括 createCharte() 和 displayChart() 方法</li></ul><h2 id="2-开闭原则"><a href="#2-开闭原则" class="headerlink" title="2. 开闭原则"></a>2. 开闭原则</h2><p>就是指软件实体应尽量在不修改原有代码的情况下进行扩展</p><p>为了满足开闭原则，需要对系统进行抽象化设计，抽象化是开闭原则的关键</p><p>在 Java 中，可以为系统定义一个相对稳定的抽象层，而将不同的实现行为移至具体的实现层中完成</p><p>例如，接口、抽象类等机制，可以通过它们定义抽象层，再通过具体类进行扩展</p><p>因此，如果需要修改系统的行为，无须对抽象层进行修改，只需增加新的具体类来实现新的业务功能即可</p><h2 id="3-里氏代换原则"><a href="#3-里氏代换原则" class="headerlink" title="3. 里氏代换原则"></a>3. 里氏代换原则</h2><p>举例说明就是，我喜欢动物，那我一定喜欢狗，因为狗是动物的子类；但是我喜欢狗，不能因此推断出</p><p>我喜欢所有动物。</p><p>里氏代换是实现开闭原则的重要方式之一，由于在使用基类对象的地方都可以使用子类对象，</p><p><strong>因此在程序中尽量使用基类类型来对对象进行定义</strong>，而在运行时再确定子类类型，用子类对象代替父类对象</p><h2 id="4-依赖倒转原则"><a href="#4-依赖倒转原则" class="headerlink" title="4. 依赖倒转原则"></a>4. 依赖倒转原则</h2><p>通俗地讲，<strong>就是高层模块定义接口，低层模块负责实现</strong><br>比如可以在高层模块中定义接口，低层模块中定义类，并继承接口，实现接口中的所有成员<br>在实际项目开发过程中，开闭原则、里氏代换原则、依赖倒转原则常常会同时出现</p><p><strong>开闭原则是目标，里氏代换原则是基础，依赖倒转是手段</strong></p><h2 id="5-接口隔离原则"><a href="#5-接口隔离原则" class="headerlink" title="5. 接口隔离原则"></a>5. 接口隔离原则</h2><p>简而言之，<strong>当一个接口太大时需要将它分割成一些更细小的接口，使用该接口的客户端仅需知道与之相关的方法即可</strong></p><p>在使用时也需要主要<strong>控制接口的粒度</strong>，接口不能太小，如果太小会导致系统中的接口泛滥，不利于维护；接口也不能太大，太大就违背了接口隔离原则</p><h2 id="6-合成复用原则"><a href="#6-合成复用原则" class="headerlink" title="6. 合成复用原则"></a>6. 合成复用原则</h2><p>同释义，<strong>优先使用对象组合</strong>，而不是通过继承来达到复用的目的<br>为什么不适用继承来达到复用？<br>问题在于继承复用会破坏系统的封装性，因为继承会将实现细节暴露给子类，如果基类发生改变，那么子类也不得不发生改变</p><h2 id="迪米特原则"><a href="#迪米特原则" class="headerlink" title=". 迪米特原则"></a>. 迪米特原则</h2><p><strong>不要和“陌生人”说话，而你的朋友是：</strong></p><ol><li>当前对象本身（this）</li><li>以参数形式传入到当前对象方法中的对象</li><li>当前对象的成员对象</li><li>如果当前对象的成员对象是一个集合，那么集合中的元素也都是朋友</li><li>当前对象所创建的对象</li></ol>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>设计模式</tag>
      
      <tag>设计原则</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>进程的调度算法</title>
    <link href="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/"/>
    <url>/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="一、调度算法的评价指标"><a href="#一、调度算法的评价指标" class="headerlink" title="一、调度算法的评价指标"></a>一、调度算法的评价指标</h1><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10001.png" class=""></div><br><h2 id="1-CPU-利用率"><a href="#1-CPU-利用率" class="headerlink" title="1. CPU 利用率"></a>1. CPU 利用率</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10002.png" class=""></div><br><h2 id="2-系统吞吐量"><a href="#2-系统吞吐量" class="headerlink" title="2. 系统吞吐量"></a>2. 系统吞吐量</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10003.png" class=""></div><br><h2 id="3-周转时间"><a href="#3-周转时间" class="headerlink" title="3. 周转时间"></a>3. 周转时间</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10004.png" class=""></div><br><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10005.png" class=""></div><br><h2 id="4-等待时间"><a href="#4-等待时间" class="headerlink" title="4. 等待时间"></a>4. 等待时间</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10006.png" class=""></div><br><h2 id="5-响应时间"><a href="#5-响应时间" class="headerlink" title="5. 响应时间"></a>5. 响应时间</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10007.png" class=""></div><br><h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10008.png" class=""></div><br><h1 id="二、调度算法"><a href="#二、调度算法" class="headerlink" title="二、调度算法"></a>二、调度算法</h1><h2 id="1-先来先服务-FCFS"><a href="#1-先来先服务-FCFS" class="headerlink" title="1. 先来先服务 FCFS"></a>1. 先来先服务 FCFS</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10009.png" class=""></div><br><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10010.png" class=""></div><br><h2 id="2-短作业优先-SJF"><a href="#2-短作业优先-SJF" class="headerlink" title="2. 短作业优先 SJF"></a>2. 短作业优先 SJF</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10011.png" class=""></div><br><h3 id="非抢占式"><a href="#非抢占式" class="headerlink" title="非抢占式"></a>非抢占式</h3><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10012.png" class=""></div><br><h3 id="抢占式"><a href="#抢占式" class="headerlink" title="抢占式"></a>抢占式</h3><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10013.png" class=""></div><br><h2 id="3-高响应比优先-HRRN"><a href="#3-高响应比优先-HRRN" class="headerlink" title="3. 高响应比优先 HRRN"></a>3. 高响应比优先 HRRN</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10014.png" class=""></div><br><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10015.png" class=""></div><br><h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><div align="center">    <img src="/2022/06/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/10016.png" class=""></div><br>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>操作系统</category>
      
    </categories>
    
    
    <tags>
      
      <tag>操作系统</tag>
      
      <tag>调度算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Elasticsearch学习</title>
    <link href="/2022/06/03/Elasticsearch/Elasticsearch%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/06/03/Elasticsearch/Elasticsearch%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在互联网中，我们查询的信息主要包括文章、视频、图片、网站信息等等</p><p>根据数据的格式，我们会将数据分为三大类：</p><ul><li><strong>结构化数据</strong>，通常表现为二维的表结构，例如MySQL、Oracle 中的表结构数据<ul><li>优点：方便管理，方便查询</li><li>缺点：扩张结构较难</li></ul></li><li><strong>非结构化数据</strong>，无法用二维表表示的数据，例如服务器日志、通讯记录、工作文档、报表等，这些数据维度管，数据量大，数据的存储、查询成本大，往往需要专业的人员和统计模型进行处理，通常会将这些数据保存到 NoSQL 数据库中去，例如 Redis 、 MongoDB，通常是以 key - value 键值对<ul><li>优点：查询快</li><li>缺点：由于他们的非特征性和歧义性，会更难理解</li></ul></li><li><strong>半结构化数据</strong>，将数据结构和内容混在一起，没有明显的区分，例如存储员工的简历，通常装载在XML、Html等中 ，保存在 MongoDB、Redis 、HBase 中<ul><li>优点：能够灵活的扩展</li><li>缺点：查询内容不易<br>如何快速、准确地查询结构化数据、非结构化数据当中的内容，ElasticSearch 就是为此诞生的</li></ul></li></ul><h1 id="一、索引"><a href="#一、索引" class="headerlink" title="一、索引"></a>一、索引</h1><p>索引创建之后是<strong>不允许被修改</strong>的，只能被删除</p><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">## 查看 es 中的所有索引<br>GET /_cat/indices<br><br>## 查看 es 中的所有索引，包含标题<br>GET /_cat/indices?v<br></code></pre></td></tr></table></figure><h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Text">## 创建索引<br>PUT /索引名<br><br>## 创建索引，并设置属性<br>PUT /索引名<br>&#123;<br>&quot;settings&quot;: &#123;<br>&quot;number_of_shards&quot;: 1,## 指定主分片的数量<br>&quot;number_of_replicas&quot;: 0## 指定副本分片的数量<br>&#125; <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Text">DELETE /索引名<br></code></pre></td></tr></table></figure><h1 id="二、映射"><a href="#二、映射" class="headerlink" title="二、映射"></a>二、映射</h1><ul><li>字符串类型：keyword、text</li><li>数字类型：integer、long</li><li>小数类型：float、double</li><li>布尔类型：boolean</li><li>日期类型：date</li></ul><h2 id="创建-1"><a href="#创建-1" class="headerlink" title="创建"></a>创建</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs text">## 创建商品索引 products 指定 mapping &#123;<br>id,<br>title,<br>price,<br>created_at,<br>description<br>&#125;<br>PUT /products<br>&#123;<br>&quot;settings&quot;: &#123;<br>&quot;number_of_shards&quot;: 1,## 指定主分片的数量<br>&quot;number_of_replicas&quot;: 0## 指定副本分片的数量<br>&#125;,<br>&quot;mappings&quot;: &#123;<br>&quot;properties&quot;: &#123;<br>&quot;id&quot;: &#123;<br>&quot;type&quot;: &quot;integer&quot;<br>&#125;,<br>&quot;title&quot;: &#123;<br>&quot;type&quot;: &quot;keyword&quot;<br>&#125;,<br>&quot;price&quot;: &#123;<br>&quot;type&quot;: &quot;double&quot;<br>&#125;,<br>&quot;created_at&quot;: &#123;<br>&quot;type&quot;: &quot;date&quot;<br>&#125;,<br>&quot;description&quot;: &#123;<br>&quot;type&quot;: &quot;text&quot;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /索引名/_mapping<br></code></pre></td></tr></table></figure><h1 id="三、文档"><a href="#三、文档" class="headerlink" title="三、文档"></a>三、文档</h1><h2 id="创建-2"><a href="#创建-2" class="headerlink" title="创建"></a>创建</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /索引名/_doc/id ## 指定文档 id<br>如：<br><br>POST /products/_doc/1<br>&#123;<br>&quot;title&quot;: &quot;iphone13&quot;,<br>&quot;price&quot;: 8999.9,<br>&quot;created_at&quot;: &quot;2021-09-15&quot;,<br>&quot;description&quot;: &quot;xxxxxxx&quot;<br>&#125;<br><br>POST /索引名/_doc ## 不指定文档 id，那么内部将会自动分配一个 uuid<br>如：<br><br>POST /products/_doc/1<br>&#123;<br>&quot;title&quot;: &quot;iphone13&quot;,<br>&quot;price&quot;: 8999.9,<br>&quot;created_at&quot;: &quot;2021-09-15&quot;,<br>&quot;description&quot;: &quot;xxxxxxx&quot;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="查询-1"><a href="#查询-1" class="headerlink" title="查询"></a>查询</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /索引名/_doc/id<br></code></pre></td></tr></table></figure><h2 id="删除-1"><a href="#删除-1" class="headerlink" title="删除"></a>删除</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">DELETE /索引名/_doc/id<br></code></pre></td></tr></table></figure><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text"># 第一种方式<br>PUT /索引名/_doc/id<br>如：<br>PUT /products/doc/1 ## 先删除，再插入。可能会导致原来存有的映射丢失<br>&#123;<br>&quot;title&quot;: &quot;iphone14&quot;<br>&#125;<br><br># 第二种方式<br>POST /索引名/_doc/id/_update<br>&#123;<br>&quot;doc&quot;: &#123;<br><br>&#125;<br>&#125;<br>如：<br>POST /products/_doc/1/_update<br>&#123;<br>&quot;doc&quot;: &#123;<br>&quot;title&quot;: &quot;iphone14&quot;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="五、批量操作-bulk"><a href="#五、批量操作-bulk" class="headerlink" title="五、批量操作 _bulk"></a>五、批量操作 _bulk</h1><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text"># 文档批量操作 _bulk<br>POST /索引名/_doc/_bulk<br>如：<br>POST /products/_doc/_bulk<br># 特别注意：<br># 一、批操作不能回车换行<br># 二、不是一个原子性操作，不会因为某一条有误而导致整个批操作失败<br><br># 以下是关于 添加 更新 删除 的批操作<br>&#123;&quot;index&quot;: &#123;&quot;_id&quot;: 2&#125;&#125;<br> &#123;&quot;id&quot;: 2,&quot;title&quot;: &quot;日本豆&quot;,&quot;price&quot;: 1.8,&quot;created_at&quot;: &quot;2012-11-12&quot;,&quot;description&quot;: &quot;好难吃的日本豆！&quot;&#125;<br>&#123;&quot;update&quot;:&#123;&quot;_id&quot;: 3&#125;&#125;<br> &#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;小于豆腐&quot;&#125;&#125;<br>&#123;&quot;delete&quot;:&#123;&quot;_id&quot;:2&#125;&#125;<br></code></pre></td></tr></table></figure><h1 id="六、Query-Domain-Specified-Language-DSL"><a href="#六、Query-Domain-Specified-Language-DSL" class="headerlink" title="六、Query Domain Specified Language(DSL)"></a>六、Query Domain Specified Language(DSL)</h1><p><code>Query DSL</code> 是利用 <code>Rest API</code>传递 <code>JSON</code> 格式的请求体数据与 ES 进行交互</p><p>这种方式的查询语法让 ES 检索变得更加强大，更加简洁</p><p>语法:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search &#123;Json格式请求体数据&#125;<br>或<br>Get /索引名/_search &#123;Json格式请求体数据&#125;<br></code></pre></td></tr></table></figure><h2 id="查询所有-match-all"><a href="#查询所有-match-all" class="headerlink" title="查询所有 [match_all]"></a>查询所有 [match_all]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;match_all&quot;: &#123;&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="关键词查询-term"><a href="#关键词查询-term" class="headerlink" title="关键词查询 [term]"></a>关键词查询 [term]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs text"># 注意：term 基于关键词查询<br># 一、查询 keyword 类型时，不会进行分词，所以要使用全部内容进行搜索<br># 二、查询 text 类型时，默认 es 标准分词器对中文单字分词，对英文单词分词<br># 三、查询 integer、double、double、date 类型时，不会进行分词<br>Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;term&quot;: &#123;<br>&quot;映射名&quot;: &#123;<br>&quot;value&quot;: xxxx<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;term&quot;: &#123;<br>&quot;price&quot;: &#123;<br>&quot;value&quot;: 49999<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li>在 ES 中除了 text 类型会进行分词，其余类型均不会分词</li><li>在 ES 中默认使用标准分词器，即对中文是单字分词，英文是单词分词</li></ul><h2 id="范围查询-range"><a href="#范围查询-range" class="headerlink" title="范围查询 [range]"></a>范围查询 [range]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;range&quot;: &#123;<br>&quot;映射名&quot;: &#123;<br><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;range&quot;: &#123;<br>&quot;price&quot;: &#123;<br>&quot;gte&quot;: 1400,<br>&quot;lte&quot;: 9999<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="前缀查询-prefix"><a href="#前缀查询-prefix" class="headerlink" title="前缀查询 [prefix]"></a>前缀查询 [prefix]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;prefix&quot;: &#123;<br>&quot;映射名&quot;: &#123;<br>&quot;value&quot;: &quot;xxx&quot;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;prefix&quot;: &#123;<br>&quot;title&quot;: &#123;<br>&quot;value&quot;: &quot;ipho&quot;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="通配符查询-wildcard"><a href="#通配符查询-wildcard" class="headerlink" title="通配符查询 [wildcard]"></a>通配符查询 [wildcard]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br># ? 用来匹配一个任意字符<br># * 用来匹配多个任意字符<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;wildcard&quot;: &#123;<br>&quot;映射名&quot;: &#123;<br>&quot;value&quot;: &quot;x*?&quot;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;wildcard&quot;: &#123;<br>&quot;description&quot;: &#123;<br>&quot;value&quot;: &quot;inp*&quot;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="多id查询-ids"><a href="#多id查询-ids" class="headerlink" title="多id查询 [ids]"></a>多id查询 [ids]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;ids&quot;: &#123;<br>&quot;values&quot;: [<br>            &quot;id1&quot;,<br>            &quot;id2&quot;<br>            ]<br>&#125;<br>&#125;<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;ids&quot;: &#123;<br>&quot;values&quot;: [&quot;xxxxxx&quot;, &quot;xxxxxxxxxx&quot;]<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="模糊查询-fuzzy"><a href="#模糊查询-fuzzy" class="headerlink" title="模糊查询 [fuzzy]"></a>模糊查询 [fuzzy]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text"># 注意：最大模糊错误在 0 - 2 之间<br>Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;fuzzy&quot;: &#123;<br>&quot;映射名&quot;: &quot;xxxx&quot;<br>&#125;<br>&#125;<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;fuzzy&quot;: &#123;<br>&quot;description&quot;: &quot;iphoneoooes&quot;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ul><li>搜索关键词长度小于等于 2 不允许存在模糊</li><li>搜索关键词长度 3 - 5 允许存在一次模糊</li><li>搜索关键词长度大于等于 5 允许存在两次模糊</li></ul><h2 id="布尔查询-bool"><a href="#布尔查询-bool" class="headerlink" title="布尔查询 [bool]"></a>布尔查询 [bool]</h2><blockquote><p>用来组合多个条件实现复杂查询</p><p><strong>must</strong>：相当于 &amp;&amp; 同时成立</p><p><strong>should</strong>：相当于 || 成立一个就行</p><p><strong>must_not</strong>：相当于 ！ 不能满足一个</p></blockquote><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;bool&quot;: &#123;<br>&quot;should | must | must_not&quot;: &#123;<br><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>如：<br># 查询满足 id 为 1 或 title 含有豆腐的值<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;bool&quot;: &#123;<br>&quot;should&quot;: [<br>                &#123;<br>                &quot;ids&quot;: &#123;<br>                &quot;values&quot;: [1]<br>                &#125;<br>                &#125;,<br>                &#123;<br>                &quot;term&quot;: &#123;<br>                &quot;title&quot;: &#123;<br>                &quot;values&quot;: &quot;豆腐&quot;<br>                &#125;<br>                &#125;<br>                &#125;<br>            ]<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="多字段查询-multi-match"><a href="#多字段查询-multi-match" class="headerlink" title="多字段查询 [multi_match]"></a>多字段查询 [multi_match]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text"># query 根据字段类型选择是否分词：<br># 如果 fields 中含有不分词，将查询条件作为整体进行查询<br># 如果 fields 中含有分词，将查询条件分词之后进行查询<br>Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;multi_match&quot;: &#123;<br>&quot;query&quot;: &quot;xxxxx&quot;,<br>&quot;fields&quot;: [&quot;映射名1&quot;, &quot;映射名2&quot;]<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="默认字段分词查询-query-string"><a href="#默认字段分词查询-query-string" class="headerlink" title="默认字段分词查询 [query_string]"></a>默认字段分词查询 [query_string]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text"># query 根据字段类型选择是否分词：<br># 如果 fields 中含有不分词，将查询条件作为整体进行查询<br># 如果 fields 中含有分词，将查询条件分词之后进行查询<br>Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;query_string&quot;: &#123;<br>&quot;default_field&quot;: &quot;映射名&quot;<br>&quot;query&quot;: &quot;xxxxxx&quot;<br>&#125;<br>&#125;<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;query_string&quot;: &#123;<br>&quot;default_field&quot;: &quot;description&quot;,<br>&quot;query&quot;: &quot;屏幕真的很不错&quot;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="返回指定条数-size"><a href="#返回指定条数-size" class="headerlink" title="返回指定条数 [size]"></a>返回指定条数 [size]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>...<br>&#125;,<br>&quot;size&quot;: n<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;match_all&quot;: &#123;&#125;<br>&#125;,<br>&quot;size&quot;: 5<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="分页查询-from"><a href="#分页查询-from" class="headerlink" title="分页查询 [from]"></a>分页查询 [from]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>...<br>&#125;,<br>&quot;from&quot;: 从第几页开始查询<br>&quot;size&quot;: 每页大小<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;match_all&quot;: &#123;&#125;<br>&#125;,<br>&quot;from&quot;: 0<br>&quot;size&quot;: 5<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="指定字段排序-sort"><a href="#指定字段排序-sort" class="headerlink" title="指定字段排序 [sort]"></a>指定字段排序 [sort]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>...<br>&#125;,<br>&quot;sort&quot;: [<br>&#123;<br>&quot;映射名&quot;: &#123;<br>&quot;order&quot;: &quot;desc&quot;## 默认是降序<br>&#125;<br>&#125;<br>]<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>&quot;match_all&quot;: &#123;&#125;<br>&#125;,<br>&quot;sort&quot;: [<br>&#123;<br>&quot;price&quot;: &#123;<br>&quot;order&quot;: &quot;desc&quot;<br>&#125;<br>&#125;<br>]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="放回指定字段-source"><a href="#放回指定字段-source" class="headerlink" title="放回指定字段 [_source]"></a>放回指定字段 [_source]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">Get /索引名/_doc/_search | Get /索引名/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>...<br>&#125;,<br>&quot;_source&quot;: [&quot;映射名1&quot;, &quot;映射名2&quot;, &quot;映射名3&quot;]<br>&#125;<br>如：<br>GET /products/_search<br>&#123;<br>&quot;query&quot;: &#123;<br>...<br>&#125;,<br>&quot;_source&quot;: [&quot;id&quot;, &quot;title&quot;, &quot;description&quot;]<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NIO学习</title>
    <link href="/2022/04/15/Java%E5%9F%BA%E7%A1%80/NIO%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/04/15/Java%E5%9F%BA%E7%A1%80/NIO%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>通过画线理解同步阻塞、同步非阻塞、同步复用（多路复用）、异步非阻塞</p><h1 id="同步阻塞"><a href="#同步阻塞" class="headerlink" title="同步阻塞"></a>同步阻塞</h1><div align="center">    <img src="/2022/04/15/Java%E5%9F%BA%E7%A1%80/NIO%E5%AD%A6%E4%B9%A0/1.png" class=""></div><br><h1 id="同步非阻塞"><a href="#同步非阻塞" class="headerlink" title="同步非阻塞"></a>同步非阻塞</h1><h2 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a>情况一</h2><div align="center">    <img src="/2022/04/15/Java%E5%9F%BA%E7%A1%80/NIO%E5%AD%A6%E4%B9%A0/2.png" class=""></div><br><h2 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h2><div align="center">    <img src="/2022/04/15/Java%E5%9F%BA%E7%A1%80/NIO%E5%AD%A6%E4%B9%A0/3.png" class=""></div><br><h1 id="异步非阻塞"><a href="#异步非阻塞" class="headerlink" title="异步非阻塞"></a>异步非阻塞</h1><div align="center">    <img src="/2022/04/15/Java%E5%9F%BA%E7%A1%80/NIO%E5%AD%A6%E4%B9%A0/4.png" class=""></div><br>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java网络编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>主从复制原理</title>
    <link href="/2022/03/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/"/>
    <url>/2022/03/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h1><ol><li>主节点通过bgsave命令fork子进程进行RDB持久化，该过程非常消耗CPU、内存（页表复制）、磁盘I&#x2F;O</li><li>主节点通过网络将RDB文件发送给从节点，对主节点的带宽会带来很大的消耗</li><li>从节点清空老数据、载入新RDB文件，其过程是阻塞的，无法响应客户端命令；如果从节点执行bgrewriteaof，也会带来额外的消耗</li></ol><h1 id="增量复制"><a href="#增量复制" class="headerlink" title="增量复制"></a>增量复制</h1><ol><li><p>复制偏移量：执行复制的主从节点，分别会维护一个偏移量offset，用来记录下一次同步从哪儿开始</p></li><li><p>复制积压缓冲区：主节点内部维护了一个固定长度的、先进先出的队列作为复制积压缓冲区，当主从节点offset的差距过大超过缓冲区时，将无法执行部分复制，只能执行全量复制</p><p> 使用缓冲区可以避免从节点要去主节点的硬盘中获取数据</p></li><li><p>每个Redis节点，都有其运行ID，运行ID由节点在启动时自动生成，主节点会将自己的运行ID发送给从节点，从节点会将主节点的运行ID保存起来。从节点Redis断开重连的时候，就会根据运行ID来判断同步的进度：</p><ol><li>如果从节点保存的运行ID与主节点的运行ID相同，说明主从节点之前同步过，主节点会继续尝试使用增量复制（到底能不能复制还得看offset和复制积压缓冲区的情况） </li><li>如果从节点保存的运行ID与主节点的运行ID不相同，说明从节点在断开前同步的Redis节点并不是当前的主节点，只能进行全量复制</li></ol></li></ol><div align="center">    <img src="/2022/03/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/1.png" class=""></div><br><h1 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h1><div align="center">    <img src="/2022/03/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/2.png" class=""></div><br>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>为什么Redis非常快</title>
    <link href="/2022/03/15/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B8%BA%E4%BB%80%E4%B9%88Redis%E9%9D%9E%E5%B8%B8%E5%BF%AB/"/>
    <url>/2022/03/15/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B8%BA%E4%BB%80%E4%B9%88Redis%E9%9D%9E%E5%B8%B8%E5%BF%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="基于内存"><a href="#基于内存" class="headerlink" title="基于内存"></a>基于内存</h1><p>绝大部分请求都是纯粹的内存操作。</p><h1 id="数据结构简单"><a href="#数据结构简单" class="headerlink" title="数据结构简单"></a>数据结构简单</h1><p>对数据操作非常简单</p><h1 id="对数据操作非常简单"><a href="#对数据操作非常简单" class="headerlink" title="对数据操作非常简单"></a>对数据操作非常简单</h1><p>避免了多线程上下文切换和竞争产生的消耗</p><h1 id="避免了多线程上下文切换和竞争产生的消耗"><a href="#避免了多线程上下文切换和竞争产生的消耗" class="headerlink" title="避免了多线程上下文切换和竞争产生的消耗"></a>避免了多线程上下文切换和竞争产生的消耗</h1><p>使用了多路I&#x2F;O复用模型，非阻塞IO</p><h1 id="底层模型"><a href="#底层模型" class="headerlink" title="底层模型"></a>底层模型</h1><p>使用底层模型不同，它们之间底层实现方式以及与客户端之间通信的应用协议不一样，Redis直接自己构建了VM 机制 ，因为一般的系统调用系统函数的话，会浪费一定的时间去移动和请求</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>九大数据结构</title>
    <link href="/2022/02/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B9%9D%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <url>/2022/02/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B9%9D%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="String"><a href="#String" class="headerlink" title="String"></a>String</h1><ul><li>一个key对应一个value</li><li>String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。</li><li>字符串value最多可以是512M</li></ul><h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><ul><li>简单动态字符串(Simple Dynamic String,缩写SDS)，类似于Java的ArrayList</li><li>当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</li></ul><div align="center">    <img src="/2022/02/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B9%9D%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.png" class=""></div><br><h1 id="List"><a href="#List" class="headerlink" title="List"></a>List</h1><ul><li>列表是简单的字符串列表，按照插入顺序排序。可以添加一个元素到列表的头部（左边）或者尾部（右边）</li><li>底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</li></ul><h2 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h2><ul><li>压缩链表zipList和快速链表quickList</li><li>链表元素较少的情况时使用一块连续的内存存储，这个结构是zipList，它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</li><li>数据量比较多的时候才会改成quickList，因为普通的链表需要的附加指针空间太大，会比较浪费空间。</li><li>将链表和ziplist结合起来组成了quicklist，也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</li></ul><div align="center">    <img src="/2022/02/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B9%9D%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/2.png" class=""></div><br><h1 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h1><ul><li>与list类似是一个列表的功能，特殊之处在于set是可以自动排重的</li><li>Redis的Set是string类型的无序集合。它底层其实是一个value为null的hash表，所以添加，删除，查找的复杂度都是O(1)。</li></ul><h2 id="数据结构-2"><a href="#数据结构-2" class="headerlink" title="数据结构"></a>数据结构</h2><ul><li>Set数据结构是dict字典，字典是用哈希表实现的。</li><li>Java中HashSet的内部实现使用的是HashMap，只不过所有的value都指向同一个对象。</li><li>Redis的set结构也是一样，它的内部也使用hash结构，所有的value都指向同一个内部值。</li></ul><h1 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h1><ul><li>是一个键值对集合</li><li>一个string类型的field和value的映射表，hash特别适合用于存储对象。类似Java里面的Map&lt;String,Object&gt;</li></ul><h2 id="数据结构-3"><a href="#数据结构-3" class="headerlink" title="数据结构"></a>数据结构</h2><ul><li>压缩链表zipList和哈希表hashTable</li><li>当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</li></ul><h1 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h1><ul><li>有序集合zset与普通集合set非常相似，是一个没有重复元素的字符串集合。</li><li>不同之处是有序集合的每个成员都关联了一个评分（score）,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以是重复了。</li><li>因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</li><li>访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</li></ul><h2 id="数据结构-4"><a href="#数据结构-4" class="headerlink" title="数据结构"></a>数据结构</h2><ul><li>Hash和跳跃表skipList</li><li>hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值。</li><li>跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</li></ul><h2 id="跳跃表"><a href="#跳跃表" class="headerlink" title="跳跃表"></a>跳跃表</h2><div align="center">    <img src="/2022/02/03/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%B9%9D%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/3.webp" class=""></div><br><h1 id="BitMaps"><a href="#BitMaps" class="headerlink" title="BitMaps"></a>BitMaps</h1><p>用于布隆过滤器</p><h1 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h1><p>统计不重复数据，用于大数据基数统计</p><h1 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h1><p>适合存经纬度，基于Zset实现</p><h1 id="Streams"><a href="#Streams" class="headerlink" title="Streams"></a>Streams</h1><p>内存表kafka，用于消息的订阅发布</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>缓存淘汰算法和淘汰策略</title>
    <link href="/2022/02/02/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AE%97%E6%B3%95%E5%92%8C%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/"/>
    <url>/2022/02/02/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AE%97%E6%B3%95%E5%92%8C%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="常用淘汰算法"><a href="#常用淘汰算法" class="headerlink" title="常用淘汰算法"></a>常用淘汰算法</h1><h2 id="FIFO"><a href="#FIFO" class="headerlink" title="FIFO"></a>FIFO</h2><blockquote><p>First In First Out，先进先出</p><p>根据缓存被存储的时间，离当前最远的数据优先被淘汰</p></blockquote><h2 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h2><blockquote><p>Least Recently Used，最近最少使用。<br>算法根据数据的历史访问记录来进行淘汰数据，其核心思想是<br>“如果数据最近被访问过，那么将来被访问的几率也更高”。</p></blockquote><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><ol><li>新数据插到链表头部</li><li>每当缓存命中，则将数据移动到链表头部</li><li>当链表满时，将链表尾部的数据丢弃</li></ol><h2 id="LFU"><a href="#LFU" class="headerlink" title="LFU"></a>LFU</h2><blockquote><p>Least Frequently Used，最不经常使用算法，<br>在一段时间内，数据被使用次数最少的，优先被淘汰</p></blockquote><h1 id="淘汰策略"><a href="#淘汰策略" class="headerlink" title="淘汰策略"></a>淘汰策略</h1><h2 id="摆烂型"><a href="#摆烂型" class="headerlink" title="摆烂型"></a>摆烂型</h2><h3 id="noeviction"><a href="#noeviction" class="headerlink" title="noeviction"></a>noeviction</h3><p>当内存限制达到时，谁也不删除，返回错误</p><h2 id="针对所有key"><a href="#针对所有key" class="headerlink" title="针对所有key"></a>针对所有key</h2><h3 id="allkeys-lru"><a href="#allkeys-lru" class="headerlink" title="allkeys-lru"></a>allkeys-lru</h3><p>尝试回收最少使用的键，使得新添加的数据有空间存放</p><h3 id="allkey-random"><a href="#allkey-random" class="headerlink" title="allkey-random"></a>allkey-random</h3><p>回收随机的键，使得新添加的数据有空间存放</p><h2 id="针对过期key"><a href="#针对过期key" class="headerlink" title="针对过期key"></a>针对过期key</h2><h3 id="volatile-lru"><a href="#volatile-lru" class="headerlink" title="volatile-lru"></a>volatile-lru</h3><p>尝试回收最少使用的键，使得新添加的数据有空间存放，但是仅限于在过期集合的键</p><h3 id="volatile-random"><a href="#volatile-random" class="headerlink" title="volatile-random"></a>volatile-random</h3><p>回收随机的键，使得新添加的数据有空间存放，但仅限于过期集合的键</p><h3 id="volatile-ttl"><a href="#volatile-ttl" class="headerlink" title="volatile-ttl"></a>volatile-ttl</h3><p>回收在过期集合的键，并且优先回收过期时间较长的键，使得新添加的数据有空间存放</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>缓存穿透、击穿、雪崩</title>
    <link href="/2022/01/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9/"/>
    <url>/2022/01/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9/</url>
    
    <content type="html"><![CDATA[<h1 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h1><p>key对应的数据在数据源中并不存在，每次针对此key的请求从缓存中获取不到，请求都会压到数据源，从而可能压垮数据源。</p><p>比如用一个不存在的用户id获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。</p><div align="center">    <img src="/2022/01/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9/1.png" class=""></div><br><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>对空值缓存</li><li>设置白名单</li><li>采用布隆过滤器</li><li>进行实时监控</li></ol><h1 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h1><p>key对应的数据存在，但在redis中过期，此时又有大量的并发请求，而这些请求发现缓存过期又会从DB中加载并设到缓存，这个时候可能会把DB压垮</p><div align="center">    <img src="/2022/01/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9/2.png" class=""></div><br><h2 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>预先设置热门数据</li><li>调整时长</li><li>使用同步锁，在缓存失效并且面对大量请求时，只让一个请求去数据库请求数据并设到缓存中，其他请求等待这个请求缓存后的结果。</li></ol><div align="center">    <img src="/2022/01/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9/3.png" class=""></div><br><h1 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h1><p>在缓存击穿的基础上有更多的key值过期</p><div align="center">    <img src="/2022/01/24/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9/4.png" class=""></div><br><h2 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>多级缓存架构 nginx缓存 + redis缓存 + 其他缓存</li><li>使用锁或队列，让请求在可承受范围内访问DB，并设到缓存中方便其他请求使用</li><li>将缓存失效时间分散开</li></ol>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式锁的实现</title>
    <link href="/2022/01/20/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2022/01/20/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="满足的条件"><a href="#满足的条件" class="headerlink" title="满足的条件"></a>满足的条件</h1><h2 id="互斥性"><a href="#互斥性" class="headerlink" title="互斥性"></a>互斥性</h2><p>任意时刻，只有一个客户端持有锁</p><h2 id="不会发生死锁"><a href="#不会发生死锁" class="headerlink" title="不会发生死锁"></a>不会发生死锁</h2><p>即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。</p><h2 id="解铃还须系铃人"><a href="#解铃还须系铃人" class="headerlink" title="解铃还须系铃人"></a>解铃还须系铃人</h2><p>加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了。</p><h2 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h2><p>加锁和解锁必须具有原子性</p><h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="1-多个客户端申请获取锁"><a href="#1-多个客户端申请获取锁" class="headerlink" title="1.多个客户端申请获取锁"></a>1.多个客户端申请获取锁</h2><blockquote><p>即执行多个setnx语句</p></blockquote><h2 id="2-获取成功"><a href="#2-获取成功" class="headerlink" title="2.获取成功"></a>2.获取成功</h2><blockquote><p>即执行setnx语句成功后的客户端，其他客户端等待重试</p></blockquote><h2 id="3-执行业务逻辑"><a href="#3-执行业务逻辑" class="headerlink" title="3.执行业务逻辑"></a>3.执行业务逻辑</h2><blockquote><p>从db获取数据，放入缓存</p></blockquote><h2 id="4-释放锁"><a href="#4-释放锁" class="headerlink" title="4.释放锁"></a>4.释放锁</h2><blockquote><p>执行del语句</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上步骤解决了互斥性</p><h1 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h1><blockquote><p>如果业务逻辑出现异常，导致锁无法释放</p></blockquote><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>设置锁的过期时间，解决死锁问题</p><h1 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h1><p>在解决问题一后，可能存在释放了其他客户端上的锁，现象如下：</p><ol><li>index1业务逻辑没执行完，3秒后锁被自动释放。</li><li>index2获取到锁，执行业务逻辑，3秒后锁被自动释放。</li><li>index3获取到锁，执行业务逻辑</li><li>index1业务逻辑执行完成，开始调用del释放锁，这时释放的是index3的锁，导致index3的业务只执行1s就被别人释放。</li></ol><p>最终等于没锁的情况。</p><h2 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h2><p>setnx获取锁时，设置一个指定的唯一值（例如：uuid）；释放前获取这个值，判断是否自己的锁</p><p>解决了上锁和释放锁是同一个客户端</p><h1 id="问题三"><a href="#问题三" class="headerlink" title="问题三"></a>问题三</h1><p>在解决问题二后，删除操作缺乏原子性，现象如下：</p><p>可能存在有一个客户端刚好执行到删除del语句，而且已经完成了uuid的判断，但已经过期，此时第二个客户端开始上锁，可恰好第一个客户端开始执行del语句，导致第二个客户端的lock被删除</p><h2 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h2><p>LUA脚本保证删除的原子性</p><p>解决了原子性</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>持久化机制</title>
    <link href="/2022/01/06/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/"/>
    <url>/2022/01/06/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><p>Redis是基于内存运行的，<strong>将redis数据写入到硬盘这一过程就叫持久化</strong></p><h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><p>全称Redis Database</p><p>在指定的时间间隔内将某一时刻的<strong>内存快照（Snapshot）</strong>，以二进制的方式写入磁盘</p><h3 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h3><div align="center">    <img src="/2022/01/06/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/1.png" class=""></div><br><h3 id="持久化流程"><a href="#持久化流程" class="headerlink" title="持久化流程"></a>持久化流程</h3><p>Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个<strong>临时文件</strong>中，待持久化过程都结束了，再用这个<strong>临时文件替换上次持久化好的文件</strong>。</p><p>整个过程中，<strong>主进程是不进行任何IO操作</strong>的，这就确保了极高的性能。</p><p>如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。</p><div align="center">    <img src="/2022/01/06/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/2.png" class=""></div><br><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol><li>适合大规模的数据恢复</li><li>对数据完整性和一致性要求不高</li><li>节省磁盘空间</li><li>恢复速度快</li></ol><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol><li>最后一次持久化后的数据可能丢失</li><li>使用了写时复制技术，会比较消耗性能</li></ol><h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p>全称Append Of File</p><p>以日志的形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来(读操作不记录)，</p><p>只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，</p><p>换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p><h3 id="持久化流程-1"><a href="#持久化流程-1" class="headerlink" title="持久化流程"></a>持久化流程</h3><ol><li>客户端的请求写命令会被<code>append</code>追加到AOF缓冲区内</li><li>AOF缓冲区根据AOF持久化策略<code>[always,everysec,no]</code>将操作<code>sync</code>同步到磁盘的AOF文件中</li><li>AOF文件大小超过重写策略或手动重写时，会对AOF文件<code>rewrite</code>重写，压缩AOF文件容量</li><li>Redis服务重启时，会重新<code>load</code>加载AOF文件中的写操作达到数据恢复的目的</li></ol><div align="center">    <img src="/2022/01/06/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/3.png" class=""></div><br><h3 id="同步频率设置"><a href="#同步频率设置" class="headerlink" title="同步频率设置"></a>同步频率设置</h3><ul><li><p>appendfsync always</p><p>  始终同步，每次Redis的写入都会立刻记入日志；性能较差但数据完整性比较好</p></li><li><p>appendfsync everysec</p><p>  每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</p></li><li><p>appendfsync no</p><p>  redis不主动进行同步，把同步时机交给操作系统。</p></li></ul><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ol><li>备份机制更稳健，丢失数据概率更低。</li><li>读的日志文本，通过操作AOF稳健，可以处理误操作。</li></ol><h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ol><li>比起RDB占用更多的磁盘空间</li><li>恢复备份速度要慢</li><li>每次读写都同步的话，有一定的性能压力</li><li>存在个别Bug，造成恢复不能</li></ol><div align="center">    <img src="/2022/01/06/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/4.png" class=""></div><br><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>AOF和RDB同时开启，系统默认取AOF的数据（数据不会存在丢失）</p><h2 id="AOF和RDB同时开启，系统默认取AOF的数据（数据不会存在丢失）"><a href="#AOF和RDB同时开启，系统默认取AOF的数据（数据不会存在丢失）" class="headerlink" title="AOF和RDB同时开启，系统默认取AOF的数据（数据不会存在丢失）"></a>AOF和RDB同时开启，系统默认取AOF的数据（数据不会存在丢失）</h2><p>官方推荐两个都启用。</p><p>如果对数据不敏感，可以选单独用RDB。</p><p>不建议单独用 AOF，因为可能会出现Bug。</p><p>如果只是做纯内存缓存，可以都不用。</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>布隆过滤器</title>
    <link href="/2021/12/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
    <url>/2021/12/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="位图"><a href="#位图" class="headerlink" title="位图"></a>位图</h1><p>位图中的每一个槽只占1 bit的内存，所以即便面对10亿数据也只占用119多M的内存</p><h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><blockquote><p>在面临大数据的情况下，判断一个数是否存在</p></blockquote><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><blockquote><p>将判断的值分多个hash函数进行计算，如果其中有一个hash函<br>数的值不等于1，则可以判定这个数不存在;</p><p>反之大概率存在</p></blockquote><h1 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h1><ul><li>占用内存小</li><li>增加和查询的时间复杂度为：<code>O(K)</code>，<code>K</code>为哈希函数的个数</li><li>哈希函数相互之间没有关系，方便硬件并行运算</li><li>布隆过滤器本身不存储元素本身，在某些对保密要求比较严格的场合有很大优势</li><li>数据量很大时，布隆过滤器可以表示全集</li><li>使用同一组散列函数的布隆过滤器可以进行交、并、差运算</li></ul><h1 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h1><ul><li>存在误判率</li><li>不能获取元素本身</li><li>一般情况下不能从布隆过滤器删除元素</li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>非关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>非关系型数据库</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL原理</title>
    <link href="/2021/11/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E5%8E%9F%E7%90%86/"/>
    <url>/2021/11/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="一、概论"><a href="#一、概论" class="headerlink" title="一、概论"></a>一、概论</h1><p>使用索引查找数据性能很快，避免了全表扫描时的多次磁盘IO。</p><p>但是，使用索引实际上也需要在索引中查找数据，而且数据量和表中的是一样的</p><p>那为什么索引就能快呢？</p><p>这就跟索引使用了哪些数据结构有关</p><p>而索引是帮助Mysql高效获取数据的 <strong>排好序</strong> 的 <strong>数据结构</strong></p><h1 id="二、索引分类"><a href="#二、索引分类" class="headerlink" title="二、索引分类"></a>二、索引分类</h1><h2 id="主键索引"><a href="#主键索引" class="headerlink" title="主键索引"></a>主键索引</h2><p>主键自带索引效果，也就意味着通过主键来查询表中的记录，性能是非常好的</p><h2 id="普通索引"><a href="#普通索引" class="headerlink" title="普通索引"></a>普通索引</h2><p>为普通的列创建索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 格式<br><span class="hljs-keyword">create</span> index 索引名称 <span class="hljs-keyword">on</span> 表名(列名)<br># 例子<br><span class="hljs-keyword">create</span> index idx_name <span class="hljs-keyword">on</span> employees(name)<br></code></pre></td></tr></table></figure><h2 id="唯一索引"><a href="#唯一索引" class="headerlink" title="唯一索引"></a>唯一索引</h2><p>就像是唯一列，列中的数据是唯一的。性能比普通的性能更好</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 格式<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index 索引名称 <span class="hljs-keyword">on</span> 表名(列名)<br># 例子<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index index_name <span class="hljs-keyword">on</span> employees(name)<br></code></pre></td></tr></table></figure><h2 id="联合索引（组合索引）"><a href="#联合索引（组合索引）" class="headerlink" title="联合索引（组合索引）"></a>联合索引（组合索引）</h2><p>一次性维表中的多个字段一起创建索引，但建议不要超过5个；<strong>最左前缀法则（如何命中联合索引中的索引列）</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 格式<br><span class="hljs-keyword">create</span> index 索引名称 <span class="hljs-keyword">on</span> 表名(列<span class="hljs-number">1</span>,列<span class="hljs-number">2</span>,列<span class="hljs-number">3</span>)<br># 例子<br><span class="hljs-keyword">create</span> index idx_name_age_position <span class="hljs-keyword">on</span> employees(name,age,position)<br></code></pre></td></tr></table></figure><h2 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h2><p>MyISAM存储引擎支持全文索引。在实际开发中，并不会使用MySQL提供的MyISAM存储引擎的全文索引功能来实现全文查找，而是会通过使用第三方的搜索引擎中间件比如说ElasicSearch（使用较多）、Solr</p><h1 id="三、InnoDB和MyISAM的区别"><a href="#三、InnoDB和MyISAM的区别" class="headerlink" title="三、InnoDB和MyISAM的区别"></a>三、InnoDB和MyISAM的区别</h1><h2 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h2><ul><li>也称<strong>聚簇索引</strong>——把索引和数据存放在一个**文件(.ibd)**中，通过找到所有后就能直接在索引树上的叶子节点中获取完整的数据</li><li>可以实现行&#x2F;表锁</li><li>支持外键</li><li>支持事务</li></ul><div align="center">    <img src="/2021/11/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E5%8E%9F%E7%90%86/1.png" class=""></div><br><h2 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h2><ul><li>也称非聚簇索引——把索引和数据分开放到(.myi)和(.myd)文件中，查找到索引后还要去另一个文件中查找数据，相比聚簇索引而言查询性能会稍微差一些</li><li>天然支持表锁</li><li>支持全文索引</li><li>不支持外键</li><li>不支持事务</li></ul><div align="center">    <img src="/2021/11/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E5%8E%9F%E7%90%86/2.png" class=""></div><br><h1 id="四、索引常问面试题"><a href="#四、索引常问面试题" class="headerlink" title="四、索引常问面试题"></a>四、索引常问面试题</h1><h2 id="为什么非主键索引的叶子节点存放的数据是主键值"><a href="#为什么非主键索引的叶子节点存放的数据是主键值" class="headerlink" title="为什么非主键索引的叶子节点存放的数据是主键值"></a>为什么非主键索引的叶子节点存放的数据是主键值</h2><div align="center">    <img src="/2021/11/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E5%8E%9F%E7%90%86/3.png" class=""></div><br><ul><li><strong>节约存储空间</strong>。避免存储冗余重复的数据</li><li><strong>维护简单</strong>。因为id是唯一且难以变更的，数据的增删很难会影响到id的变化<br>​- 倘若存储的数据还包含其他非主键数据，当其被修改时不仅在数据库中需要修改，而且还需要对索引进行修改</li></ul><h2 id="为什么InnoDB表必须创建主键"><a href="#为什么InnoDB表必须创建主键" class="headerlink" title="为什么InnoDB表必须创建主键"></a>为什么InnoDB表必须创建主键</h2><p><strong>增加性能</strong>。如果InnoDB表不创建主键，MySQL优化器会自动创建一个虚拟的主键，于是普通索引（辅助索引）就会使用这个虚拟主键进行查找，并且创建虚拟主键则会增加性能开销</p><h2 id="为什么使用主键时推荐使用整型的自增主键"><a href="#为什么使用主键时推荐使用整型的自增主键" class="headerlink" title="为什么使用主键时推荐使用整型的自增主键"></a>为什么使用主键时推荐使用整型的自增主键</h2><ul><li><p><strong>使用整型</strong></p><p>  <strong>避免不必要的开销</strong>。整型的数据大小是非常好比较的，如果使用字符串则需要进行依次编码后才能进行比较</p></li><li><p><strong>使用自增</strong></p><p>  <strong>避免不必要的开销</strong>。当使用了不规律的数据时，索引树需要通过<strong>自旋</strong>的方式使叶子节点从小到大-从左到右有序排列，而多次的<strong>自旋</strong>会给系统带来一定的性能开销</p></li></ul><h1 id="五、联合索引和最左前缀法则"><a href="#五、联合索引和最左前缀法则" class="headerlink" title="五、联合索引和最左前缀法则"></a>五、联合索引和最左前缀法则</h1><h2 id="联合索引的存储结构"><a href="#联合索引的存储结构" class="headerlink" title="联合索引的存储结构"></a>联合索引的存储结构</h2><p>联合索引会使节点中存放的<strong>索引键增多</strong></p><div align="center">    <img src="/2021/11/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E5%8E%9F%E7%90%86/4.png" class=""></div><br><h2 id="最左前缀法则"><a href="#最左前缀法则" class="headerlink" title="最左前缀法则"></a>最左前缀法则</h2><p>表示一条sql语句在联合索引中有没有走索引（命中索引&#x2F;不会全表扫描）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 创建联合索引<br><span class="hljs-keyword">create</span> index idex_a_b_c <span class="hljs-keyword">on</span> table1(a,b,c)<br># 判断<span class="hljs-keyword">sql</span>语句有没有命中索引<br><br># 命中a<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> a <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br># 命中a<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> a <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">and</span> b <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;<br># 命中a<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> a <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">and</span> b <span class="hljs-operator">=</span> <span class="hljs-number">20</span> <span class="hljs-keyword">and</span> c <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br># 未命中b，因为a没有被命中，所以b也不会被命中<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> b <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br># 未命中b也没命中c，因为a没有被命中，所以b也不会被命中，b没有被命中c也不会被命中<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> b <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">and</span> c <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br># 命中a但没有命中b，因为b没有被命中，所以c也不会被命中<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> a <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">and</span> c <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br># 既没有命中a，也没有命中b，更没有命中c<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> c <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br># 命中abc，mysql中有一个内部优化器，会做一次内部优化<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> table1 <span class="hljs-keyword">where</span> a <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">and</span> c <span class="hljs-operator">=</span> <span class="hljs-number">30</span> <span class="hljs-keyword">and</span> b <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>关系型数据库</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ学习</title>
    <link href="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/"/>
    <url>/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="MQ（Message-Queue）是什么？"><a href="#MQ（Message-Queue）是什么？" class="headerlink" title="MQ（Message Queue）是什么？"></a>MQ（Message Queue）是什么？</h1><h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>实现系统间的解耦</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>通过利用高效的消息传递机制进行平台无关的数据交流，并基于数据通信进行分布式系统的集成</p><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/1.png" class=""></div><br><ul><li>生成者：不断向消息队列中生产消息</li><li>消费者：不断向队列中获取消息</li><li>消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，轻松地实现系统间解耦</li></ul><blockquote><p>因此跨系统通讯时，首选消息队列</p></blockquote><h2 id="消息中间件"><a href="#消息中间件" class="headerlink" title="消息中间件"></a>消息中间件</h2><p>如何实现，就用到了消息中间件</p><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/2.png" class=""></div><br><h2 id="AMQP协议"><a href="#AMQP协议" class="headerlink" title="AMQP协议"></a>AMQP协议</h2><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/3.png" class=""></div><br><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/4.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/5.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/6.png" class=""></div><br><h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Text">rabbitmq-plugins enable rabbitmq_management<br></code></pre></td></tr></table></figure><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">rabbitmq-server<br></code></pre></td></tr></table></figure><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl start rabbitmq-server<br><br>systemctl status rabbitmq-server<br><br>systemctl restart rabbitmq-server<br><br>systemctl stop rabbitmq-server<br><br>journalctl -xe 查看报错日志<br></code></pre></td></tr></table></figure><h1 id="管理命令和管理界面"><a href="#管理命令和管理界面" class="headerlink" title="管理命令和管理界面"></a>管理命令和管理界面</h1><p>通过自行配置开放端口号进入到WEB的管理界面</p><p>在没有WEB界面下，可以通过以下命令进行管理</p><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/7.png" class=""></div><br><h2 id="默认端口说明"><a href="#默认端口说明" class="headerlink" title="默认端口说明"></a>默认端口说明</h2><p>15672(HTTP)：HTTP WEB界面端口<br>5672(AMQP)：TCP 通讯端口（Java操作时会用到的端口）<br>25672(CLUSTERING)：集群通讯</p><h1 id="AMQP协议-1"><a href="#AMQP协议-1" class="headerlink" title="AMQP协议"></a>AMQP协议</h1><p>Advanced Message Queuing Protocal 高级消息队列协议是一个进程间传递异步消息的网路协议</p><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/8.png" class=""></div><br><p>Virtual Host 相当于MySQL中的库，操作时，常常为每一个应用建立一个虚拟主机</p><h1 id="七种消息发布模式"><a href="#七种消息发布模式" class="headerlink" title="七种消息发布模式"></a>七种消息发布模式</h1><blockquote><p><a href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p></blockquote><h1 id="点对点模型"><a href="#点对点模型" class="headerlink" title="点对点模型"></a>点对点模型</h1><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Text">hello world<br></code></pre></td></tr></table></figure><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/9.png" class=""></div><br><h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>登录</li></ul><h2 id="生成者"><a href="#生成者" class="headerlink" title="生成者"></a>生成者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.helloworld;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/13 20:58</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Provider</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSendMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-comment">//从连接中创建一个通道对象</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 通道绑定对应的消息队列</span><br><span class="hljs-comment">         * 参数1：队列名称，如果队列不存在自动创建</span><br><span class="hljs-comment">         * 参数2：定义的队列是否持久化？持久化会将队列写入磁盘，重启后仍存在</span><br><span class="hljs-comment">         * 参数3：是否独占队列？独占表示一个队列只允许当前连接可用</span><br><span class="hljs-comment">         * 参数4：是否在消费完成后自动消除队列？</span><br><span class="hljs-comment">         * 参数5：附加参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 发布消息</span><br><span class="hljs-comment">         * 参数1：交换机名称</span><br><span class="hljs-comment">         * 参数2：队列名称</span><br><span class="hljs-comment">         * 参数3：传递消息额外设置</span><br><span class="hljs-comment">         * 参数4：消息的具体内容</span><br><span class="hljs-comment">         */</span><br>        channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;hello&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-string">&quot;hello rabbit&quot;</span>.getBytes());<br>        RabbitMQUtils.closeConnectionAndChanel(channel, connection);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="绑定队列和发送队列"><a href="#绑定队列和发送队列" class="headerlink" title="绑定队列和发送队列"></a>绑定队列和发送队列</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通道绑定对应的消息队列</span><br><span class="hljs-comment"> * 参数1：队列名称，如果队列不存在自动创建</span><br><span class="hljs-comment"> * 参数2：定义的队列是否持久化？持久化会将队列写入磁盘，重启后仍存在，仅是队列持久化，其中的消息内容并不会持久化</span><br><span class="hljs-comment"> * 参数3：是否独占队列？独占表示一个队列只允许当前连接可用</span><br><span class="hljs-comment"> * 参数4：是否在消费者消费完成（断开连接）后自动消除队列？</span><br><span class="hljs-comment"> * 参数5：附加参数</span><br><span class="hljs-comment"> */</span><br>channel.queueDeclare(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发布消息</span><br><span class="hljs-comment"> * 参数1：交换机名称</span><br><span class="hljs-comment"> * 参数2：队列名称</span><br><span class="hljs-comment"> * 参数3：传递消息额外设置，例如可以传参MessageProperties.PERSISTENT_TEXT_PLAIN表示队列中的消息持久化</span><br><span class="hljs-comment"> * 参数4：消息的具体内容</span><br><span class="hljs-comment"> */</span><br>channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;hello&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-string">&quot;hello rabbit&quot;</span>.getBytes());<br></code></pre></td></tr></table></figure><h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.helloworld;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/13 20:20</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//创建连接mq的连接工厂对象</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-comment">//从连接中创建一个通道对象</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 通道绑定对应的消息队列</span><br><span class="hljs-comment">         * 参数1：队列名称，如果队列不存在自动创建</span><br><span class="hljs-comment">         * 参数2：定义的队列是否持久化？持久化会将队列写入磁盘，重启后仍存在</span><br><span class="hljs-comment">         * 参数3：是否独占队列？独占表示一个队列只允许当前连接可用</span><br><span class="hljs-comment">         * 参数4：是否在消费者消费完成（断开连接）后自动消除队列？</span><br><span class="hljs-comment">         * 参数5：附加参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 消费消息</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：开始消息时的自动确认机制</span><br><span class="hljs-comment">         * 参数3：消费时的回调接口</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span> <span class="hljs-comment">// 最后一个参数：消息队列中取出的消息</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;new String(body) = &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">//不建议关闭，因为消费者要一直监听</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="任务模型"><a href="#任务模型" class="headerlink" title="任务模型"></a>任务模型</h1><blockquote><p>Work queues</p></blockquote><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/10.png" class=""></div><br><h2 id="平均消费消息"><a href="#平均消费消息" class="headerlink" title="平均消费消息"></a>平均消费消息</h2><h3 id="生成者-1"><a href="#生成者-1" class="headerlink" title="生成者"></a>生成者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.task;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/14 16:44</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Provider</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">taskProviderTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        channel.queueDeclare(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">200</span>; i++) &#123;<br>            channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">null</span>,(i + <span class="hljs-string">&quot; hello task&quot;</span>).getBytes());<br>        &#125;<br>        RabbitMQUtils.closeConnectionAndChanel(channel, connection);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="消费者1"><a href="#消费者1" class="headerlink" title="消费者1"></a>消费者1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.task;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/14 16:44</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        channel.queueDeclare(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.basicConsume(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;Customer1: &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="消费者2"><a href="#消费者2" class="headerlink" title="消费者2"></a>消费者2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.task;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/14 16:44</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        channel.queueDeclare(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.basicConsume(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;Customer2: &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/11.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/12.png" class=""></div><br><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Text">默认情况下，RabbitMQ在任务模型下会将消息按顺序发送给下一个使用者。<br><br>如果消息总量能够整除消费者的数量，那么每个消费者都能够收到相同数量的消息。这种分发消息的方式成为循环。<br><br>但是对于存在一个消费者快，一个消费者慢的情况而言，循环分发消息的方式就不适应了。<br></code></pre></td></tr></table></figure><h2 id="消息自动确认机制"><a href="#消息自动确认机制" class="headerlink" title="消息自动确认机制"></a>消息自动确认机制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 在默认的消息消费的机制（平均分配）下，代表着开始消息时的自动确认机制的第二参数，是开启的，</span><br><span class="hljs-comment"> * 这种情况下它不关心你的业务是否处理完，消息在接收到消息时会自动地向消息队列中表示确认。</span><br><span class="hljs-comment"> * 举例说明：如果分配给该消费者5个消息，此时消费者无论消息是否完成都会自动地向消息队列中表示确认，</span><br><span class="hljs-comment"> * 如果进行到第3个消息时宕机了，剩下的2个消息就会被丢失了，这并不是我们希望发生的</span><br><span class="hljs-comment"> */</span><br>channel.basicConsume(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>         System.out.println(<span class="hljs-string">&quot;Customer2: &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="避免信息丢失的方法"><a href="#避免信息丢失的方法" class="headerlink" title="避免信息丢失的方法"></a>避免信息丢失的方法</h2><h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 不能让消息队列将消息一次性地给消费者，让消息一个一个地来，所以就让消息通道中只有一个消息</span><br>channel.basicQos(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 关闭消息确认机制</span><br>channel.basicConsume(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            System.out.println(<span class="hljs-string">&quot;Customer1: &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>      &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 手动确认消息。如果服务器突然宕机，未确认的消息就会重新回到消息队列中等待消费</span><br><span class="hljs-comment">// 第一个参数，标记为手动确认消息标识</span><br><span class="hljs-comment">// 第二个参数，是否开启多消息同时确认，false每次确认一个。因为通道中每次只有一个消息，所以此处设为false</span><br>channel.basicAck(envelope.getDeliveryTag(), <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><h2 id="能者多劳消费消息"><a href="#能者多劳消费消息" class="headerlink" title="能者多劳消费消息"></a>能者多劳消费消息</h2><blockquote><p>通过上例方法不仅能够实现避免消息丢失，而且还能实现能者多劳。</p></blockquote><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/13.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/14.png" class=""></div><br><h1 id="广播-x2F-发布-x2F-订阅模型"><a href="#广播-x2F-发布-x2F-订阅模型" class="headerlink" title="广播&#x2F;发布&#x2F;订阅模型"></a>广播&#x2F;发布&#x2F;订阅模型</h1><blockquote><p>Publish&#x2F;Subscribe</p></blockquote><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/15.png" class=""></div><br><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>交换机和队列的自动生成取决于消费者</p><h2 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>注册</li><li>提交订单时，既要与订单表进行交互，也要和库存进行交互</li><li>生成日志</li></ul><h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.fanout;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/19 20:34</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Provider</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 将通道指明指定交换机</span><br><span class="hljs-comment">         * 参数1.交换机名称</span><br><span class="hljs-comment">         * 参数2.交换机类型</span><br><span class="hljs-comment">         */</span><br>        channel.exchangeDeclare(<span class="hljs-string">&quot;logs&quot;</span>, <span class="hljs-string">&quot;fanout&quot;</span>);<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 发送消息</span><br><span class="hljs-comment">         */</span><br>        channel.basicPublish(<span class="hljs-string">&quot;logs&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-string">&quot;faount type message&quot;</span>.getBytes());<br>        RabbitMQUtils.closeConnectionAndChanel(channel, connection);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-1"><a href="#消费者-1" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.fanout;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/19 20:42</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">// 通道绑定交换机</span><br>        channel.exchangeDeclare(<span class="hljs-string">&quot;logs&quot;</span>, <span class="hljs-string">&quot;fanout&quot;</span>);<br>        <span class="hljs-comment">// 临时队列</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br>        <span class="hljs-comment">// 绑定交换机和队列</span><br>        channel.queueBind(queueName, <span class="hljs-string">&quot;logs&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-comment">// 消费消息</span><br>        channel.basicConsume(queueName, <span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;消费者1：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/16.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/17.png" class=""></div><br><h1 id="路由模型"><a href="#路由模型" class="headerlink" title="路由模型"></a>路由模型</h1><blockquote><p>Routing</p></blockquote><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/18.png" class=""></div><br><h2 id="适用场景-2"><a href="#适用场景-2" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>日志打印，根据日志类型分发到不同的消费者中去</li></ul><h2 id="生产者-1"><a href="#生产者-1" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.direct;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/20 16:20</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Provider</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">// 通过通道声明交换机  参数1：交换机名称  参数2：路由模式</span><br>        channel.exchangeDeclare(<span class="hljs-string">&quot;logs_direct&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>        <span class="hljs-comment">// 发送消息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">routingKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;info&quot;</span>;<br>        channel.basicPublish(<span class="hljs-string">&quot;logs_direct&quot;</span>, routingKey, <span class="hljs-literal">null</span>, (<span class="hljs-string">&quot;这是direct模型发布的基于route key：[&quot;</span>+routingKey+<span class="hljs-string">&quot;]发送的消息&quot;</span>).getBytes());<br>        RabbitMQUtils.closeConnectionAndChanel(channel, connection);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-2"><a href="#消费者-2" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.direct;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/20 16:26</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">// 通道声明交换机和交换机的类型</span><br>        channel.exchangeDeclare(<span class="hljs-string">&quot;logs_direct&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>        <span class="hljs-comment">// 创建一个临时队列</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br>        <span class="hljs-comment">// 基于route key绑定队列和交换机</span><br>        channel.queueBind(queue, <span class="hljs-string">&quot;logs_direct&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>        <span class="hljs-comment">// 获取队列中的消息</span><br>        channel.basicConsume(queue, <span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;消费者1：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.direct;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/20 16:26</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">// 通道声明交换机和交换机的类型</span><br>        channel.exchangeDeclare(<span class="hljs-string">&quot;logs_direct&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>        <span class="hljs-comment">// 创建一个临时队列</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br>        <span class="hljs-comment">// 基于route key绑定队列和交换机</span><br>        channel.queueBind(queue, <span class="hljs-string">&quot;logs_direct&quot;</span>, <span class="hljs-string">&quot;info&quot;</span>);<br>        channel.queueBind(queue, <span class="hljs-string">&quot;logs_direct&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>        channel.queueBind(queue, <span class="hljs-string">&quot;logs_direct&quot;</span>, <span class="hljs-string">&quot;warning&quot;</span>);<br>        <span class="hljs-comment">// 获取队列中的消息</span><br>        channel.basicConsume(queue, <span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;消费者1：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/19.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/20.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/21.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/22.png" class=""></div><br><h1 id="主题模型"><a href="#主题模型" class="headerlink" title="主题模型"></a>主题模型</h1><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/23.png" class=""></div><br><h2 id="适用场景-3"><a href="#适用场景-3" class="headerlink" title="适用场景"></a>适用场景</h2><blockquote></blockquote><h2 id="注意点-1"><a href="#注意点-1" class="headerlink" title="注意点"></a>注意点</h2><p><strong>只有主题模型才支持通配符</strong></p><h2 id="生产者-2"><a href="#生产者-2" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.topics;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 14:00</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Provider</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        channel.exchangeDeclare(<span class="hljs-string">&quot;topics&quot;</span>,<span class="hljs-string">&quot;topic&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">routeKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user.save&quot;</span>;<br>        channel.basicPublish(<span class="hljs-string">&quot;topics&quot;</span>,routeKey,<span class="hljs-literal">null</span>,(<span class="hljs-string">&quot;topic模型,routeKey: &quot;</span>+routeKey).getBytes());<br>        RabbitMQUtils.closeConnectionAndChanel(channel, connection);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-3"><a href="#消费者-3" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.topics;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 14:14</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        channel.exchangeDeclare(<span class="hljs-string">&quot;topics&quot;</span>,<span class="hljs-string">&quot;topic&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br>        channel.queueBind(queue,<span class="hljs-string">&quot;topics&quot;</span>,<span class="hljs-string">&quot;user.*&quot;</span>);<br>        channel.basicConsume(queue,<span class="hljs-literal">true</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;消费者1： &quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.topics;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> com.huajframe.utils.RabbitMQUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 14:14</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        channel.exchangeDeclare(<span class="hljs-string">&quot;topics&quot;</span>,<span class="hljs-string">&quot;topic&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br>        channel.queueBind(queue,<span class="hljs-string">&quot;topics&quot;</span>,<span class="hljs-string">&quot;user.#&quot;</span>);<br>        channel.basicConsume(queue,<span class="hljs-literal">true</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                System.out.println(<span class="hljs-string">&quot;消费者2： &quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/24.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/25.png" class=""></div><br><h1 id="与Spring-boot整合"><a href="#与Spring-boot整合" class="headerlink" title="与Spring boot整合"></a>与Spring boot整合</h1><h2 id="pom依赖"><a href="#pom依赖" class="headerlink" title="pom依赖"></a>pom依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="yml配置"><a href="#yml配置" class="headerlink" title="yml配置"></a>yml配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-rabbitmq</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.137</span><span class="hljs-number">.66</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">13399</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">jframe</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/hua_rabbitmq_study</span><br></code></pre></td></tr></table></figure><p><code>RabbitTemplate</code> 用来简化操作，注入即可</p><h1 id="Spring-boot点对点模型"><a href="#Spring-boot点对点模型" class="headerlink" title="Spring boot点对点模型"></a>Spring boot点对点模型</h1><h2 id="生产者-3"><a href="#生产者-3" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.springbootrabbitmq;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-meta">@SpringBootTest(classes = RabbitmqApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitmqApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">// hello world</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> &#123;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;hello world&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-4"><a href="#消费者-4" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.springbootrabbitmq.hello;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 默认是持久化、非独占、不是自动删除</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 14:47</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RabbitListener(queuesToDeclare = @Queue(value = &quot;hello&quot;, durable = &quot;false&quot;, autoDelete = &quot;true&quot;))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloCustomer</span> &#123;<br><br>    <span class="hljs-meta">@RabbitHandler</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;message = &quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Spring-boot任务模型"><a href="#Spring-boot任务模型" class="headerlink" title="Spring boot任务模型"></a>Spring boot任务模型</h1><blockquote><p>任务模型中，Spring AMQP实现的默认方式是公平调度</p></blockquote><h2 id="生产者-4"><a href="#生产者-4" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// work</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">workTest</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;work&quot;</span>,<span class="hljs-string">&quot;work模型&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-5"><a href="#消费者-5" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.springbootrabbitmq.work;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 任务模型中，Spring AMQP实现的默认方式是公平调度</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 17:15</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkCustomer</span> &#123;<br><br>    <span class="hljs-meta">@RabbitListener(queuesToDeclare = @Queue(&quot;work&quot;))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive1</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者1：message = &quot;</span> + message);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queuesToDeclare = @Queue(&quot;work&quot;))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者2：message = &quot;</span> + message);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Spring-boot广播模型"><a href="#Spring-boot广播模型" class="headerlink" title="Spring boot广播模型"></a>Spring boot广播模型</h1><h2 id="生产者-5"><a href="#生产者-5" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// fanout</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">fanoutTest</span><span class="hljs-params">()</span>&#123;<br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;logs&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;fanout模型发送消息&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-6"><a href="#消费者-6" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.springbootrabbitmq.fanout;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 17:28</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutCustomer</span> &#123;<br><br>    <span class="hljs-meta">@RabbitListener(bindings = &#123;</span><br><span class="hljs-meta">            @QueueBinding(</span><br><span class="hljs-meta">                    value = @Queue, // 创建临时队列</span><br><span class="hljs-meta">                    exchange = @Exchange(value = &quot;logs&quot;, type = &quot;fanout&quot;)// 指定交换机</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive1</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者1：message = &quot;</span> + message);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(bindings = &#123;</span><br><span class="hljs-meta">            @QueueBinding(</span><br><span class="hljs-meta">                    value = @Queue, // 创建临时队列</span><br><span class="hljs-meta">                    exchange = @Exchange(value = &quot;logs&quot;, type = &quot;fanout&quot;)// 指定交换机</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者2：message = &quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Spring-boot路由模型"><a href="#Spring-boot路由模型" class="headerlink" title="Spring boot路由模型"></a>Spring boot路由模型</h1><h2 id="生产者-6"><a href="#生产者-6" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// routing</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">routingTest</span><span class="hljs-params">()</span>&#123;<br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;directs&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;发送error的key的路由信息&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-7"><a href="#消费者-7" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.springbootrabbitmq.routing;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 17:35</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingCustomer</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(bindings = &#123;</span><br><span class="hljs-meta">            @QueueBinding(</span><br><span class="hljs-meta">                    value = @Queue,// 创建临时队列</span><br><span class="hljs-meta">                    exchange = @Exchange(value = &quot;directs&quot;, type = &quot;direct&quot;),// 指定交换机</span><br><span class="hljs-meta">                    key = &#123;&quot;info&quot;,&quot;error&quot;,&quot;warn&quot;&#125;</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive1</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者1：message = &quot;</span> + message);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(bindings = &#123;</span><br><span class="hljs-meta">            @QueueBinding(</span><br><span class="hljs-meta">                    value = @Queue,// 创建临时队列</span><br><span class="hljs-meta">                    exchange = @Exchange(value = &quot;directs&quot;, type = &quot;direct&quot;),// 指定交换机</span><br><span class="hljs-meta">                    key = &#123;&quot;error&quot;&#125;</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者2：message = &quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Spring-boot主题模型"><a href="#Spring-boot主题模型" class="headerlink" title="Spring boot主题模型"></a>Spring boot主题模型</h1><h2 id="生产者-7"><a href="#生产者-7" class="headerlink" title="生产者"></a>生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// topics</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">topicsTest</span><span class="hljs-params">()</span>&#123;<br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;topics&quot;</span>,<span class="hljs-string">&quot;user.save&quot;</span>,<span class="hljs-string">&quot;user.save 消息&quot;</span>);<br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;topics&quot;</span>,<span class="hljs-string">&quot;user.save.xx&quot;</span>,<span class="hljs-string">&quot;user.save.xx 消息&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="消费者-8"><a href="#消费者-8" class="headerlink" title="消费者"></a>消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.huajframe.springbootrabbitmq.topics;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hua JFrame</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021/09/21 17:41</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicsCustomer</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(bindings = &#123;</span><br><span class="hljs-meta">            @QueueBinding(</span><br><span class="hljs-meta">                    value = @Queue,</span><br><span class="hljs-meta">                    exchange = @Exchange(type = &quot;topic&quot;, name = &quot;topics&quot;),</span><br><span class="hljs-meta">                    key = &#123;&quot;user.*&quot;&#125;</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive1</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者1 message = &quot;</span> + message);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(bindings = &#123;</span><br><span class="hljs-meta">            @QueueBinding(</span><br><span class="hljs-meta">                    value = @Queue,</span><br><span class="hljs-meta">                    exchange = @Exchange(type = &quot;topic&quot;, name = &quot;topics&quot;),</span><br><span class="hljs-meta">                    key = &#123;&quot;user.#&quot;&#125;</span><br><span class="hljs-meta">            )</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive2</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者2 message = &quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="MQ的应用场景"><a href="#MQ的应用场景" class="headerlink" title="MQ的应用场景"></a>MQ的应用场景</h1><h2 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h2><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/26.png" class=""></div><br><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/27.png" class=""></div><br><h2 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h2><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/28.png" class=""></div><br><h2 id="流量削峰"><a href="#流量削峰" class="headerlink" title="流量削峰"></a>流量削峰</h2><div align="center">    <img src="/2021/09/07/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AD%A6%E4%B9%A0/29.png" class=""></div><br>]]></content>
    
    
    <categories>
      
      <category>消息中间件</category>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线程的创建</title>
    <link href="/2021/07/28/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA/"/>
    <url>/2021/07/28/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>参考笔记 <a href="https://nyimac.gitee.io/2020/06/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">https://nyimac.gitee.io/2020/06/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Java并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>并发编程</tag>
      
      <tag>多线程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ死信队列、延时队列</title>
    <link href="/2021/07/12/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E3%80%81%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97/"/>
    <url>/2021/07/12/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E3%80%81%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97/</url>
    
    <content type="html"><![CDATA[<h1 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h1><p><code>DLX</code> 全称<code>Dead-Letter-Exchange</code>,称之为<strong>死信交换器</strong>，</p><p>当消息变成一个死信之后，如果这个消息所在的队列存在<code>x-dead-letter-exchange</code>参数，</p><p>那么它会被发送到<code>x-dead-letter-exchange</code>对应值的交换器上，这个交换器就称之为死信交换器，</p><p><strong>与这个死信交换器绑定的队列就是死信队列</strong>。</p><p><strong>如下情况会被加入到死信队列中</strong></p><ul><li>消息被<strong>消费方拒绝</strong>，使用 <code>channel.basicNack</code> 或 <code>channel.basicReject</code>， 并且此时 <code>requeue</code>属性被设置为 <code>false</code></li><li>消息在队列的存活时间超过了设置的 <code>TTL</code> 时间，即<strong>过期</strong>（两种方式设置）了<ol><li>通过对队列进行设置，这种设置后，该队列中<strong>所有的消息都存在相同的过期时间</strong></li><li>通过对消息本身进行设置，那么<strong>每条消息的过期时间都不一样</strong></li><li>如果同时使用这2种方法，那么<strong>以过期时间小的那个数值为准</strong></li></ol></li><li>消息队列的数量已经<strong>超过了最大队列长度</strong></li></ul><h1 id="延时队列"><a href="#延时队列" class="headerlink" title="延时队列"></a>延时队列</h1><p>在 <code>RabbitMQ</code> 中不存在延时队列，但是我们可以通过<code>设置消息的过期时间和死信队列</code>来模拟出延时队列。</p><p>消费者监听死信交换器绑定的队列，而不要监听消息发送的队列。</p><p>有了以上的基础知识，我们完成以下需求：</p><p><strong>需求</strong>：用户在系统中创建一个订单，如果10s后，用户没有进行支付，那么自动取消订单。</p><p><strong>分析</strong>：</p><p>上面这个情况，我们就适合使用延时队列来实现，那么延时队列如何创建</p><ol><li>为订单消息设置<code>TTL = 10s</code>，或者为订单队列设置<code>TTL = 10s</code></li><li>订单如果在 <code>10s</code> 没有被消费，则加入到指定的死信队列中</li><li>专门处理取消订单的消费者就会来消费这个死信队列</li></ol>]]></content>
    
    
    <categories>
      
      <category>消息中间件</category>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ消息事务与确认机制</title>
    <link href="/2021/06/01/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E6%B6%88%E6%81%AF%E4%BA%8B%E5%8A%A1%E4%B8%8E%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6/"/>
    <url>/2021/06/01/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E6%B6%88%E6%81%AF%E4%BA%8B%E5%8A%A1%E4%B8%8E%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<blockquote><p>参考文章：<a href="https://www.jianshu.com/p/63ed636c773d">https://www.jianshu.com/p/63ed636c773d</a></p></blockquote><h1 id="事务机制"><a href="#事务机制" class="headerlink" title="事务机制"></a>事务机制</h1><p><strong>基于 AMQP 实现了事务机制</strong>，类似于MySQL的事务</p><p>RabbitMQ提供了三个方法对消息发送进行事务管理：</p><ul><li><code>txSelect()</code>：用于将通道 <code>Channel</code> 开启事务模式，服务端会返回<code>Tx.Select-OK</code></li><li><code>txCommit()</code>：用于提交事务</li><li><code>txRollback()</code>：用于回滚事务</li></ul><p><strong>使用格式如下：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> RabbitMQUtils.getConnection();<br><span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><span class="hljs-keyword">try</span>&#123;<br>    channel.txSelect();<br>    <span class="hljs-comment">// publish...</span><br>    channel.txCommit();<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    channel.txRollback();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>开启事务后，消息起初并不会到指定的队列中</p><p>而是首先发送到一个临时队列中</p><p>只有当调用了<code>txCommit()</code>后，刚刚存储到临时队列中的消息才会到指定的队列中去</p><h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p><strong>开启-提交-回滚，三次操作，每次都相当于一次请求</strong>，降低了消息的吞吐量</p><p>因为走的通信太多，大量消息就会大量请求服务器，这样会非常耗时</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>在消费者中，要将 <code>autoACK</code> 设置为 <code>false</code>，手动提交<code>ack</code></p><p>而为<code>true</code>是不支持事物的，也就是说即使在收到消息之后回滚事务也是无济于事的，因为队列已经把消息移除了</p><h1 id="确认机制"><a href="#确认机制" class="headerlink" title="确认机制"></a>确认机制</h1><p><strong>基于<code>confirm</code>模式实现确认机制</strong></p><p>考虑到<code>AMQP</code>的事务机制性能消耗大</p><p>RabbitMQ提供了另一种低消耗的事务管理方式，使用 <code>confirmSelect()</code>方法</p><h2 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h2><p><code>confirm</code>模式下的 <code>channel</code>发送的消息会生成一个唯一的有序 ID (从1开始)</p><p>一旦消息成功发送到相应的队列之后，RabbitMQ服务端 会发送给生产者一个确认标志，包含消息的 ID</p><blockquote><p>这样生产者就知道该消息已经发送成功了</p></blockquote><p>如果消息和队列是持久化的，那么只有当 RabbitMQ服务器将消息成功写入到 <strong>磁盘</strong>之后，服务端才会发送确认标志</p><p>此外，服务端也可以设置<code>basic.ack</code> 和 <code>mutiple</code> 域，表明是否是批量确认的消息，即该序号之前的消息都已经收到了</p><p><code>confirm</code> 的机制是异步的，生产者可以在等待的同时继续发送下一条消息，并且异步等待回调处理</p><ul><li>消息发送成功，会返回 <code>ack</code> 消息供异步处理</li><li>消息发送失败，会返回 <code>nack</code> 消息</li></ul><p><code>confirm</code> 的事件没有明确说明，并且同一个消息只会被 <code>confirm</code> 一次</p><p><strong>处理 <code>ack</code> 和 <code>nack</code> 的方式有三种</strong></p><h2 id="串行-confirm"><a href="#串行-confirm" class="headerlink" title="串行 confirm"></a>串行 confirm</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//开启confirm模式</span><br>channel.confirmSelect();<br><span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br><span class="hljs-comment">//发送消息</span><br>channel.basicPublish(EXCHANGE_NAME,<br>                     <span class="hljs-string">&quot;&quot;</span>,<br>                     MessageProperties.PERSISTENT_TEXT_PLAIN,<br>                     message.getBytes());<br><span class="hljs-comment">//判断是否回复</span><br><span class="hljs-keyword">if</span>(channel.waitForConfirms())&#123;<br>    System.out.println(<span class="hljs-string">&quot;Message send success.&quot;</span>); <br> &#125;<br></code></pre></td></tr></table></figure><p>其中<code>waitForConfirms</code>可以换成带有时间参数的方法<code>waitForConfirms(Long mills)</code>指定等待响应时间</p><h2 id="批量-confirm"><a href="#批量-confirm" class="headerlink" title="批量 confirm"></a>批量 confirm</h2><p>每发送一批次消息就调用<code>waitForConfirms()</code>方法等待服务端<code>confirm</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//开启confirm模式</span><br>channel.confirmSelect();<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span><span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    <span class="hljs-comment">//发送消息</span><br>    channel.basicPublish(EXCHANGE_NAME,<br>                     <span class="hljs-string">&quot;&quot;</span>,<br>                     MessageProperties.PERSISTENT_TEXT_PLAIN,<br>                     message.getBytes());<br>    <span class="hljs-keyword">if</span>(i%<span class="hljs-number">100</span>==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">//每发送100条判断一次是否回复</span><br>        <span class="hljs-keyword">if</span>(channel.waitForConfirms())&#123;<br>          System.out.println(<span class="hljs-string">&quot;Message send success.&quot;</span>); <br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>批量的方法从数量级上降低了confirm的性能消耗，提高了效率。</p><p>但是有个致命的缺陷，一旦回复确认失败，当前确认批次的消息会全部重新发送，导致消息重复发送。</p><p>所以批量的confirm虽然性能提高了，但是消息的重复率也提高了。</p><h2 id="异步-confirm"><a href="#异步-confirm" class="headerlink" title="异步 confirm"></a>异步 confirm</h2><p><code>Channel</code> 对象提供的 <code>ConfirmListener()</code> 回调方法只包含<code>deliveryTag</code>(当前<code>Channel</code>发出的消息序列号)</p><p>我们需要自己为每一个<code>Channel</code>维护一个<code>unconfirm</code>的序列号的集合</p><ul><li>每<code>push</code>一条数据，集合元素加1</li><li>每回调一次<code>handleAck</code>方法，<code>unconfirm</code>集合就删掉相应的一条(<code>multiple=false</code>) 或者多条(<code>multiple=true</code>)记录</li><li>从程序运行效率上来看，这个<code>unconfirm</code>集合最好采用有序集合<code>SortedSet</code>存储结构。</li></ul><p>使用监听方法，当服务端<code>confirm</code>了一条或多条消息后，调用回调方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//声明一个用来记录消息唯一ID的有序集合SortedSet</span><br><span class="hljs-keyword">final</span> SortedSet&lt;Long&gt; confirmSet = Collections.synchronizedSortedSet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;Long&gt;());<br><span class="hljs-comment">//开启confirm模式</span><br>channel.confirmSelect();<br><span class="hljs-comment">//异步监听方法 处理ack与nack方法</span><br>channel.addConfirmListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfirmListener</span>() &#123;<br>    <span class="hljs-comment">//处理ack multiple 是否批量 如果是批量 则将比该条小的所有数据都移除 否则只移除该条</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleAck</span><span class="hljs-params">(<span class="hljs-type">long</span> deliveryTag, <span class="hljs-type">boolean</span> multiple)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (multiple) &#123;<br>            confirmSet.headSet(deliveryTag + <span class="hljs-number">1</span>).clear();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            confirmSet.remove(deliveryTag);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//处理nack 与ack相同</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNack</span><span class="hljs-params">(<span class="hljs-type">long</span> deliveryTag, <span class="hljs-type">boolean</span> multiple)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(<span class="hljs-string">&quot;There is Nack, SeqNo: &quot;</span> + deliveryTag + <span class="hljs-string">&quot;, multiple: &quot;</span> + multiple);<br>        <span class="hljs-keyword">if</span> (multiple) &#123;<br>            confirmSet.headSet(deliveryTag + <span class="hljs-number">1</span>).clear();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            confirmSet.remove(deliveryTag);<br>        &#125;<br>    &#125;<br>&#125;);<br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-comment">//获取消息confirm的唯一ID</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">nextSeqNo</span> <span class="hljs-operator">=</span> channel.getNextPublishSeqNo();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello World.&quot;</span>;<br>    <span class="hljs-comment">//发送消息</span><br>    channel.basicPublish(EXCHANGE_NAME,<span class="hljs-string">&quot;&quot;</span>,MessageProperties.PERSISTENT_TEXT_PLAIN,message.getBytes());<br>    <span class="hljs-comment">//将ID加入到有序集合中</span><br>    confirmSet.add(nextSeqNo);<br>&#125;<br></code></pre></td></tr></table></figure><p>每一个<code>comfirm</code>的通道维护一个集合，每发送一条数据，集合增加一个元素，每异步响应一条<code>ack</code>或者<code>nack</code>的数据，集合删除一条。</p><p><code>SortedSet</code>是一个有序的集合，它的有序是值大小的有序，不是插入时间的有序。</p><p>JDK中<code>waitForConfirms()</code>方法也是使用了<code>SortedSet</code>集合</p>]]></content>
    
    
    <categories>
      
      <category>消息中间件</category>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>并发与并行</title>
    <link href="/2021/05/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C/"/>
    <url>/2021/05/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>并发是一个CPU在不同的时间去不同线程中执行指令。</p><p>并行是多个CPU同时处理不同的线程。</p><p>引用 Rob Pike 的一段描述：</p><ul><li>并发（concurrent）是同一时间应对（dealing with）多件事情的能力</li><li>并行（parallel）是同一时间动手做（doing）多件事情的能力</li></ul><h1 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h1><h2 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h2><p>以调用方角度来讲，如果</p><ul><li>需要等待结果返回，才能继续运行就是同步</li><li>不需要等待结果返回，就能继续运行就是异步</li></ul><h3 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h3><p>多线程可以让方法执行变为异步的（即不要巴巴干等着）比如说读取磁盘文件时，假设读取操作花费了 5 秒钟，如 果没有线程调度机制，这 5 秒 cpu 什么都做不了，其它代码都得暂停…</p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><ul><li>比如在项目中，视频文件需要转换格式等操作比较费时，这时开一个新线程处理视频转换，避免阻塞主线程</li><li>tomcat 的异步 servlet 也是类似的目的，让用户线程处理耗时较长的操作，避免阻塞</li><li>tomcat 的工作线程 ui 程序中，开线程进行其他操作，避免阻塞 ui 线程</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li>单核 cpu 下，多线程不能实际提高程序运行效率，只是为了能够在不同的任务之间切换，不同线程轮流使用 cpu ，不至于一个线程总占用 cpu，别的线程没法干活</li><li>多核 cpu 可以并行跑多个线程，但能否提高程序运行效率还是要分情况的<ul><li>有些任务，经过精心设计，将任务拆分，并行执行，当然可以提高程序的运行效率。但不是所有计算任务都能拆分</li><li>也不是所有任务都需要拆分，任务的目的如果不同，谈拆分和效率没啥意义</li></ul></li><li>IO 操作不占用 cpu，只是我们一般拷贝文件使用的是【阻塞 IO】，这时相当于线程虽然不用 cpu，但需要一 直等待 IO 结束，没能充分利用线程。所以才有后面的【非阻塞 IO】和【异步 IO】优化</li></ol>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>操作系统</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机基础</tag>
      
      <tag>操作系统</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>进程与线程的区别</title>
    <link href="/2021/04/24/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <url>/2021/04/24/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h1><p>程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至 CPU，数据加载至内存。</p><p>在指令运行过程中还需要用到磁盘、网络等设备。</p><p><strong>进程就是用来加载指令、管理内存、管理 IO 的。</strong></p><ul><li>当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。</li><li>进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器 等），也有的程序只能启动一个实例进程（例如网易云音乐、360 安全卫士等）</li></ul><h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><ul><li>一个进程之内可以分为一到多个线程。</li><li>一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给 CPU 执行 。</li><li>Java 中，线程作为最小调度单位，进程作为资源分配的最小单位。 在 windows 中进程是不活动的，只是作为线程的容器</li></ul><h1 id="二者对比"><a href="#二者对比" class="headerlink" title="二者对比"></a>二者对比</h1><ul><li>进程基本上相互独立的，而线程存在于进程内，是进程的一个子集，进程拥有共享的资源，如内存空间等，供其内部的线程共享<ul><li>进程间通信较为复杂，同一台计算机的进程通信称为 IPC（Inter-process communication</li><li>不同计算机之间的进程通信，需要通过网络，并遵守共同的协议，例如 HTTP</li></ul></li><li>线程通信相对简单，因为它们共享进程内的内存，一个例子是多个线程可以访问同一个共享变量。<strong>线程更轻量，线程上下文切换成本一般上要比进程上下文切换低</strong></li></ul>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>操作系统</category>
      
    </categories>
    
    
    <tags>
      
      <tag>操作系统</tag>
      
      <tag>进程</tag>
      
      <tag>线程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ消息幂等性问题</title>
    <link href="/2021/04/10/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7%E9%97%AE%E9%A2%98/"/>
    <url>/2021/04/10/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是幂等性"><a href="#什么是幂等性" class="headerlink" title="什么是幂等性"></a>什么是幂等性</h1><p>在编程中一个幂等操作的特点是其任意<strong>多次执行所产生的影响均与一次执行的影响相同</strong></p><p>HTTP方法的幂等性是指一次和多次请求某一个资源应该具有同样的副作用。幂等性属于语义范畴，正如编译器只能帮助检查语法错误一样，HTTP规范也没有办法通过消息格式等语法手段来定义它。</p><p><strong>简之：一个请求，不管重复来多少次，结果是不会改变的。</strong></p><p>消费者在消费 <code>MQ</code>中的消息时，<code>MQ</code> 已把消息发送给消费者，消费者在给 <code>MQ</code> 返回 <code>ack</code> 时网络中断，</p><p>故 <code>MQ</code> 未收到确认信息，该条消息会重新发给其他的消费者，或者在网络重连后再次发送给该消费者，</p><p><strong>但实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息</strong></p><p>所以，<code>MQ</code> 消费者的幂等性问题，主要在于 <code>MQ</code> 的重试机制，因为网络原因或客户端延迟消费导致重复消费。</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p><strong><code>RabbitMQ</code> 这种消息重试(补偿)机制是默认的。</strong></p><h1 id="确保幂等性方案"><a href="#确保幂等性方案" class="headerlink" title="确保幂等性方案"></a>确保幂等性方案</h1><h2 id="全局ID"><a href="#全局ID" class="headerlink" title="全局ID"></a>全局ID</h2><p>每个消息都有一个自身<code>ID</code>，以保证再重试中不会被重复消费</p><h2 id="业务逻辑ID"><a href="#业务逻辑ID" class="headerlink" title="业务逻辑ID"></a>业务逻辑ID</h2><p>比如使用<strong>订单号码（业务逻辑ID）</strong>，以保证再重试中不会被重复消费</p>]]></content>
    
    
    <categories>
      
      <category>消息中间件</category>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ补偿机制与@RabbitListener注解原理</title>
    <link href="/2021/04/09/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6%E4%B8%8E-RabbitListener%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86/"/>
    <url>/2021/04/09/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6%E4%B8%8E-RabbitListener%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="补偿机制"><a href="#补偿机制" class="headerlink" title="补偿机制"></a>补偿机制</h1><p><code>RabbitMQ</code> 默认情况下，如果消费者程序出现异常的情况下，会自动实现<strong>补偿（重试）机制</strong></p><p>即队列服务器发送补偿请求</p><h1 id="RabbitListener原理"><a href="#RabbitListener原理" class="headerlink" title="@RabbitListener原理"></a>@RabbitListener原理</h1><p><code>@RabbitListener</code>底层使用 <code>AOP</code> 进行拦截</p><ul><li>如果程序没有抛出异常，则会自动提交事务</li><li>如果程序捕捉到异常信息，会自动实现补偿机制，该消息会缓存到 <code>RabbitMQ</code>服务端中，一直重试到不跑出异常为止</li></ul><p><strong>补偿机制一直重复显然是会占用资源的，所以我们可以尝试修改补偿机制</strong></p><div align="center">    <img src="/2021/04/09/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6%E4%B8%8E-RabbitListener%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86/1.png" class=""></div><br><p>当超过最大重试次数之后，消息队列默认就会**<strong>放弃这条消息</strong>。</p><p>针对不同的情况也可以将消息发送到**<strong>死信队列</strong>中，由专门的消费者进行处理，避免占用过多的资源</p><h1 id="如何选择合理的补偿机制"><a href="#如何选择合理的补偿机制" class="headerlink" title="如何选择合理的补偿机制"></a>如何选择合理的补偿机制</h1><h2 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a>情况一</h2><blockquote><p>消费者获取到消息后，调用第三方接口，但接口暂时无法访问，是否需要重试？</p></blockquote><p><strong>需要</strong>,接口可能是由于网络延时导致接口无法访问，是属于正常现象</p><h2 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h2><blockquote><p>消费者获取到消息后，抛出数据转换异常，是否需要重试？</p></blockquote><p><strong>不需要</strong>,因为重试的原因是抛出了异常，再重试多次也无济于事，所以是消费者内部的原因，需要消费者内部修正</p>]]></content>
    
    
    <categories>
      
      <category>消息中间件</category>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ实现分布式事务</title>
    <link href="/2021/04/05/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    <url>/2021/04/05/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p><strong>采用最终一致性原理</strong></p><p>也就是说过程中可能会产生不一致，但是最终会保持一致</p><h1 id="要素"><a href="#要素" class="headerlink" title="要素"></a>要素</h1><p>RabbitMQ解决分布式事务需要保证以下三要素</p><ol><li><p>确认生产者一定要将数据发送到 MQ服务器中</p><p>采用 MQ 消息确认机制</p></li><li><p>MQ消费者消息能够正确消费消息</p><p> 采用手动 ACK 模式，同时也要注意重试幂等性问题</p></li><li><p>保证第一个事务先执行</p><p> 采用补偿机制，创建一个消费者进行监听第一个事务，如果第一个事务没有执行成功，进行补偿</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>消息中间件</category>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线程的生命周期</title>
    <link href="/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
    <url>/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
    
    <content type="html"><![CDATA[<p>线程的生命周期包含5个阶段，包括：新建、就绪、运行、阻塞、销毁。</p><ul><li>新建：就是刚使用<code>new()</code>方法，new出来的线程；</li><li>就绪：就是调用的线程的<code>start()</code>方法后，这时候线程处于等待CPU分配资源阶段，谁先抢的CPU资源，谁开始执行;</li><li>运行：当就绪的线程被调度并获得CPU资源时，便进入运行状态，<code>run()</code>方法定义了线程的操作和功能;</li><li>阻塞：在运行状态的时候，可能因为某些原因导致运行状态的线程变成了阻塞状态，比如<code>sleep()</code>、<code>wait()</code>之后线程就处于了阻塞状态，这个时候需要其他机制将处于阻塞状态的线程唤醒，比如调用<code>notify()</code>或者<code>notifyAll()</code>方法。唤醒的线程不会立刻执行<code>run()</code>方法，它们要再次等待CPU分配资源进入运行状态;</li><li>销毁：如果线程正常执行完毕后或线程被提前强制性的终止或出现异常导致结束，那么线程就要被销毁，释放资源;</li></ul><p>完整的生命周期图如下：</p><div align="center">    <img src="/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/1.png" class=""></div><br><h1 id="新建状态"><a href="#新建状态" class="headerlink" title="新建状态"></a>新建状态</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>();<br></code></pre></td></tr></table></figure><p>这里的创建，仅仅是在JAVA的这种编程语言层面被创建，而在操作系统层面，真正的线程还没有被创建。</p><p>只有当我们调用了 <code>start()</code> 方法之后，该线程才会被创建出来，进入Runnable状态。只有当我们调用了 <code>start()</code> 方法之后，该线程才会被创建出来</p><div align="center">    <img src="/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/2.png" class=""></div><br><h1 id="就绪状态"><a href="#就绪状态" class="headerlink" title="就绪状态"></a>就绪状态</h1><p>调用<code>start()</code>方法后，JVM 进程会去创建一个新的线程，而此线程不会马上被 CPU 调度运行，进入Running状态，这里会有一个中间状态，就是Runnable状态，你可以理解为等待被 CPU 调度的状态</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java">t1.start()<br></code></pre></td></tr></table></figure><div align="center">    <img src="/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/3.png" class=""></div><br><p>**<strong>那么处于Runnable状态的线程能发生哪些状态转变？</strong></p><p>Runnable状态的线程**<strong>无法直接进入Blocked状态和Terminated状态的。</strong></p><p>只有处在Running状态的线程，换句话说，只有获得CPU调度执行权的线程才有资格进入Blocked状态和Terminated状态，Runnable状态的线程要么能被转换成Running状态，要么被意外终止。</p><div align="center">    <img src="/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/4.png" class=""></div><br><h1 id="运行状态"><a href="#运行状态" class="headerlink" title="运行状态"></a>运行状态</h1><p>当CPU调度发生，并从任务队列中选中了某个Runnable线程时，该线程会进入Running执行状态，并且开始调用run()方法中逻辑代码。</p><p>那么处于Running状态的线程能发生哪些状态转变？</p><div align="center">    <img src="/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/5.png" class=""></div><br><ul><li>被转换成Terminated状态，比如调用 <code>stop()</code> 方法;</li><li>被转换成Blocked状态，比如调用了<code>sleep</code>, <code>wait</code> 方法被加入 waitSet 中；</li><li>被转换成Blocked状态，如进行 IO 阻塞操作，如查询数据库进入阻塞状态；</li><li>被转换成Blocked状态，比如获取某个锁的释放，而被加入该锁的阻塞队列中；</li><li>该线程的时间片用完，CPU 再次调度，进入Runnable状态；</li><li>线程主动调用 <code>yield </code>方法，让出 CPU 资源，进入Runnable状态</li></ul><h1 id="阻塞状态"><a href="#阻塞状态" class="headerlink" title="阻塞状态"></a>阻塞状态</h1><p>Blocked状态的线程能够发生哪些状态改变？</p><div align="center">    <img src="/2021/02/03/JVM/%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/6.png" class=""></div><br><ul><li>被转换成Terminated状态，比如调用 <code>stop()</code> 方法，或者是 JVM 意外 Crash;</li><li>被转换成Runnable状态，阻塞时间结束，比如读取到了数据库的数据后；</li><li>完成了指定时间的休眠，进入到Runnable状态；</li><li>正在wait中的线程，被其他线程调用<code>notify/notifyAll</code>方法唤醒，进入到Runnable状态；</li><li>线程获取到了想要的锁资源，进入Runnable状态；</li><li>线程在阻塞状态下被打断，如其他线程调用了<code>interrupt</code>方法，进入到Runnable状态；</li></ul><h1 id="终止状态"><a href="#终止状态" class="headerlink" title="终止状态"></a>终止状态</h1><p>一旦线程进入了Terminated状态，就意味着这个线程生命的终结，哪些情况下，线程会进入到Terminated状态呢？</p><ul><li>线程正常运行结束，生命周期结束；</li><li>线程运行过程中出现意外错误；</li><li>JVM 异常结束，所有的线程生命周期均被结束。</li></ul>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常见方法</title>
    <link href="/2021/02/03/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95/"/>
    <url>/2021/02/03/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本文参考他人学习笔记</p><p><a href="https://nyimac.gitee.io/2020/06/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">https://nyimac.gitee.io/2020/06/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Java并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>并发编程</tag>
      
      <tag>多线程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>内存模型</title>
    <link href="/2021/02/02/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"/>
    <url>/2021/02/02/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是JMM"><a href="#什么是JMM" class="headerlink" title="什么是JMM"></a>什么是JMM</h1><p>JMM 即 Java Memory Model，它定义了主存（共享内存）、工作内存（线程私有）抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、 CPU 指令优化等。</p><h1 id="JMM主要体现在以下几个方面"><a href="#JMM主要体现在以下几个方面" class="headerlink" title="JMM主要体现在以下几个方面"></a>JMM主要体现在以下几个方面</h1><h2 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h2><p>保证指令不会受到线程上下文切换的影响</p><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Atomicity</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (object) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i1 &lt; <span class="hljs-number">50000</span>; i1++) &#123;<br>                    i++;<br>                &#125;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (object) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i1 &lt; <span class="hljs-number">50000</span>; i1++) &#123;<br>                    i--;<br>                &#125;<br>            &#125;<br>        &#125;);<br>        t1.start();<br>        t2.start();<br>        t1.join();<br>        t2.join();<br>        System.out.println(i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="理解"><a href="#理解" class="headerlink" title="理解"></a>理解</h3><div align="center">    <img src="/2021/02/02/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/1.png" class=""></div><br><h2 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h2><p>保证指令不会受 cpu 缓存的影响</p><h3 id="问题引例"><a href="#问题引例" class="headerlink" title="问题引例"></a>问题引例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Visibility</span> &#123;<br><br>    <span class="hljs-keyword">static</span>  <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (run) &#123;<br>                <span class="hljs-comment">// ...</span><br>            &#125;<br>        &#125;);<br>        t.start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        run = <span class="hljs-literal">false</span>; <br>        <span class="hljs-comment">// 代码最终并不会停下来，因为t线程要频繁从主内</span><br>        <span class="hljs-comment">//存中读取run的值，JIT编译器会将run的值缓存至自</span><br>        <span class="hljs-comment">//己工作内存中的高速缓存中，</span><br>        <span class="hljs-comment">//减少对主存中run的访问，提高效率</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="volatile-关键字"><a href="#volatile-关键字" class="headerlink" title="volatile 关键字"></a>volatile 关键字</h3><ul><li>它可以修饰成员变量和静态成员变量，</li><li>用来避免线程从自己的工作缓存中查找变量的值，</li><li>必须到主存中获取它的值，线程操作 volatile 变量都是直接操作主存</li></ul><h4 id="理解-1"><a href="#理解-1" class="headerlink" title="理解"></a>理解</h4><p>一个线程对 volatile 变量的修改对另一个线程而言是可见的，<br>不能保证原子性，仅用在一个写线程，多个读线程的情况。</p><h3 id="synchronized-关键字"><a href="#synchronized-关键字" class="headerlink" title="synchronized 关键字"></a>synchronized 关键字</h3><p>synchronized 语句块既可以保证代码块的原子性，同时也能保证代码块内变量的可见性。<br>但缺点是 synchronized 属于重量级操作，性能相对较低</p><h4 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Visibility</span> &#123;<br><br>    <span class="hljs-keyword">static</span>  <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (run) &#123;<br>                <span class="hljs-comment">// ...</span><br>                System.out.println(<span class="hljs-number">1</span>); <span class="hljs-comment">// 为什么使用sout语句也能将线程停下来？</span><br>            &#125;<br>        &#125;);<br>        t.start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        run = <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">println</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123; <br>        <span class="hljs-comment">// 因为sout语句内部使用了 synchronized 语句块</span><br>        print(x);<br>        newLine();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h2><p>保证指令不会受 cpu 指令并行优化的影响</p><h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><div align="center">    <img src="/2021/02/02/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/2.png" class=""></div><br><div align="center">    <img src="/2021/02/02/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/3.png" class=""></div><br><blockquote><p>出现 0 的情况的现象叫做指令重排，是 JIT 编译器在运行时的一些优化，这个现象需要通过大量测试才能复现</p></blockquote><h3 id="解决指令重排"><a href="#解决指令重排" class="headerlink" title="解决指令重排"></a>解决指令重排</h3><p>为 ready 参数添加 volatile 关键字修饰，确保可见性，避免指令重排</p><h3 id="理解-2"><a href="#理解-2" class="headerlink" title="理解"></a>理解</h3><div align="center">    <img src="/2021/02/02/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/4.png" class=""></div><br>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>内存结构</title>
    <link href="/2021/02/02/JVM/%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/"/>
    <url>/2021/02/02/JVM/%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<div align="center">    <img src="/2021/02/02/JVM/%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/1.png" class=""></div><br><h1 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h1><p>线程私有</p><p>程序计数器（Program Counter Register）是一块较小的内存空间，它可以看作是当前线程所执行的 字节码的行号指示器。</p><p>字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，它是程序控制流的指示器，分支、循环、跳转、异常处 理、线程恢复等基础功能都需要依赖这个计数器来完成。</p><h1 id="Java虚拟机栈"><a href="#Java虚拟机栈" class="headerlink" title="Java虚拟机栈"></a>Java虚拟机栈</h1><p>线程私有</p><p>虚拟机栈描述的是Java方法执行的线程内存模型：</p><p>每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧（Stack Frame）用于存储局部变量表、操作数栈、动态连接、方法出口等信息。</p><p>每一个方法被调用直至执行完毕的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。</p><h1 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h1><p>线程私有</p><p>本地方法栈（Native Method Stacks）与虚拟机栈所发挥的作用是非常相似的，</p><p>其区别只是虚拟机 栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则是为虚拟机使用到的本地（Native） 方法服务。</p><h1 id="本地方法栈-1"><a href="#本地方法栈-1" class="headerlink" title="本地方法栈"></a>本地方法栈</h1><p>线程私有</p><p>本地方法栈（Native Method Stacks）与虚拟机栈所发挥的作用是非常相似的，</p><p>其区别只是虚拟机 栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则是为虚拟机使用到的本地（Native） 方法服务。</p><h1 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h1><p>线程共享</p><p>存储已被虚拟机加载的类型信息、常量、静态变量、即时编译器编译后的代码缓存等数据</p><h2 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h2><p>存放编译期生成的各种字面量与符号引用，这部分内容将在类加载后存放到方法区的运行时常量池中。</p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>类加载机制</title>
    <link href="/2021/01/31/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"/>
    <url>/2021/01/31/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<div align="center">    <img src="/2021/01/31/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/1.png" class=""></div><br><h1 id="类加载的时机"><a href="#类加载的时机" class="headerlink" title="类加载的时机"></a>类加载的时机</h1><p>在对象的创建过程中，完成了检查阶段</p><div align="center">    <img src="/2021/01/31/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/2.png" class=""></div><br><ol><li>加载 （Loading）</li><li>验证（Verification）</li><li>准备（Preparation）</li><li>解析（Resolution）</li><li>初始化 （Initialization）</li><li>使用（Using）</li><li>卸载（Unloading）</li></ol><p>其中验证、准备、解析三个部分统称为连接（Linking）</p><p>其中加载、验证、准备、解析、初始化和卸载这五个阶段的顺序是确定的，类型的加载过程必须按照这种顺序按部就班地开始。</p><p>而解析阶段则不一定：它在某些情况下可以在初始化阶段之后再开始， 这是为了支持Java语言的运行时绑定特性（也称为动态绑定或晚期绑定）。</p><p><strong>注意：</strong><br>这里笔者写的是 按部就班地“开始”，而不是按部就班地“进行”或按部就班地“完成”，强调这点是因为这些阶段通常都 是互相交叉地混合进行的，会在一个阶段执行的过程中调用、激活另一个阶段。</p><p>加载阶段与连接阶段的部分动作（如一部分字节码文件格式验证动作）是交叉进行的，加载阶段 尚未完成，连接阶段可能已经开始，但这些夹在加载阶段之中进行的动作，仍然属于连接阶段的一部 分，这两个阶段的开始时间仍然保持着固定的先后顺序。</p><h1 id="类加载的过程"><a href="#类加载的过程" class="headerlink" title="类加载的过程"></a>类加载的过程</h1><h2 id="第一个阶段——加载"><a href="#第一个阶段——加载" class="headerlink" title="第一个阶段——加载"></a>第一个阶段——加载</h2><ol><li>通过一个<strong>类的全限定名</strong>来获取定义此类的<strong>二进制字节流</strong>。</li><li>将这个<strong>字节流所代表的静态存储结构</strong>转化为<strong>方法区的运行时数据结构</strong>。</li><li>在内存中生成一个<strong>代表这个类的java.lang.Class对象</strong>，作为方法区这个类的各种数据的<strong>访问入口</strong>。</li></ol><div align="center">    <img src="/2021/01/31/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/3.png" class=""></div><br><h2 id="第二个阶段——验证"><a href="#第二个阶段——验证" class="headerlink" title="第二个阶段——验证"></a>第二个阶段——验证</h2><p>验证是连接阶段的第一步，这一阶段的目的是<strong>保证Class文件的字节流中包含的信息符合《Java虚拟机规范》的全部约束要求</strong>，保证这些信息<strong>被当作代码运行后不会危害虚拟机自身的安全</strong></p><p>验证内容主要包含如下四点：</p><ul><li>文件格式验证</li><li>元数据验证</li><li>字节码验证</li><li>符号引用验证</li></ul><h2 id="第三个阶段——准备"><a href="#第三个阶段——准备" class="headerlink" title="第三个阶段——准备"></a>第三个阶段——准备</h2><p>准备阶段是正式为类中定义的变量（即静态变量，被static修饰的变量）**<strong>*<em><strong>分配内存</strong>并</em>*设置类变量初始值</strong>（对象创建过程的隐式创建）的阶段</p><p>假设一个类变量的定义为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;<br></code></pre></td></tr></table></figure><p>那变量value在准备阶段过后的初始值为<code>0</code>而不是<code>123</code>，因为这时尚未开始执行任何Java方法，而把 value赋值为<code>123</code>的 <code>putstatic</code> 指令是程序被编译后，存放于类构造器<code>&lt;clinit&gt;()</code>方法之中，所以把value赋值 为123的动作要到<strong>类的初始化阶段</strong>才会被执行</p><h2 id="第四个阶段——解析"><a href="#第四个阶段——解析" class="headerlink" title="第四个阶段——解析"></a>第四个阶段——解析</h2><p>解析阶段是Java虚拟机将<strong>常量池内的符号引用</strong>替换为<strong>直接引用</strong>的过程</p><h2 id="第五个阶段——初始化"><a href="#第五个阶段——初始化" class="headerlink" title="第五个阶段——初始化"></a>第五个阶段——初始化</h2><p>类的初始化阶段是类加载过程的最后一个步骤，初始化阶段就是执行类构造器<code>&lt;clinit&gt;()</code>方法的过程</p><p><code>&lt;clinit&gt;()</code>方法是由编译器自动收集类中的<strong>所有类变量的赋值动作</strong>和<strong>静态语句块（<code>static&#123;&#125;</code>块）中的语句</strong>合并产生的</p><h1 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h1><p>在类加载阶段中的“通过一个类的全限定名来获取描述该类的二进制字节流”这个动作放到Java虚拟机外部去实现，以便让应用程序自己决定如何去获取所需的类。</p><p>而实现这个动作的代码被称为“类加载器”（Class Loader）</p><h2 id="类与类加载器"><a href="#类与类加载器" class="headerlink" title="类与类加载器"></a>类与类加载器</h2><p>类加载器虽然只用于实现类的加载动作，但它在Java程序中起到的作用却**<strong>远超类加载阶段</strong>。</p><p>对于 任意一个类，都必须由加载它的类加载器和这个类本身一起共同确立其在Java虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。</p><p>这句话表达地更通俗一些：<strong>比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义，否则，即使这两个类来源于同一个 Class文件，被同一个Java虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等</strong></p><h2 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h2><p>站在Java虚拟机的角度来看，只存在两种不同的类加载器：一种是启动类加载器（Bootstrap Class Loader），另外一种就是其他所有的类加载器。</p><h3 id="启动类加载器"><a href="#启动类加载器" class="headerlink" title="启动类加载器"></a>启动类加载器</h3><p><code>Bootstrap Class Loader</code></p><p>这个类加载器使用C++语言实现，是虚拟机的一部分。</p><p>负责加载存放在<code>&lt;JAVA_HOME&gt;\lib</code>目录，或者被<code>-Xbootclasspath</code>参数所指定的路径中存放的，而且是Java虚拟机能够识别的类库</p><h3 id="其他所有的类加载器"><a href="#其他所有的类加载器" class="headerlink" title="其他所有的类加载器"></a>其他所有的类加载器</h3><p>这些类加载器都由Java语言实现，独立存在于虚拟机外部，并且全都继承自抽象类 <code>java.lang.ClassLoader</code></p><h4 id="扩展类加载器"><a href="#扩展类加载器" class="headerlink" title="扩展类加载器"></a>扩展类加载器</h4><p>Extension Class Loader</p><p>这个类加载器是在类<code>sun.misc.Launcher$ExtClassLoade</code>r中以Java代码的形式实现的。</p><p>主要负责加载<code>&lt;JAVA_HOME&gt;\lib\ext</code>目录中，或者被<code>java.ext.dirs</code>系统变量所指定的路径中所有的类库。</p><p>顾名思义，它是一种Java系统类库的扩展机制。用户可以将具有通用性的类库存放至ext目录里来扩展Java SE的功能</p><h4 id="应用程序类加载器"><a href="#应用程序类加载器" class="headerlink" title="应用程序类加载器"></a>应用程序类加载器</h4><p><code>Application Class Loader</code></p><p>这个类加载器是在类<code>sun.misc.Launcher$AppClassLoader</code>中以Java代码的形式实现的。</p><p>主要负责加载用户类路径上所有的类库</p><h3 id="互相配合"><a href="#互相配合" class="headerlink" title="互相配合"></a>互相配合</h3><p>在JDK 9之前的Java应用都是由这三种类加载器互相配合来完成加载的，而各种类加载器之间的层次关系被称之为类加载器的“双亲委派模型”</p><div align="center">    <img src="/2021/01/31/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/4.png" class=""></div><br><h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p>如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到最顶层的启动类加载器中，只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去完成加载。</p><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>一个显而易见的好处就是Java中的类随着它的类加载器一起具备了一种带有优先级的层次关系。</p><p>例如类<code>java.lang.Object</code>，它存放在<code>rt.jar</code>之中，无论哪一个类加载器要加载这个类，最终都是委派给处于模型最顶端的启动类加载器进行加载，因此Object类在程序的各种类加载器环境中都能够保证是同一个类。</p><p>如果没有使用双亲委派模型，都由各个类加载器自行去加载的话，如果用户自己也编写了一个名为<code>java.lang.Object</code>的类，并放在程序的<code>ClassPath</code>中，那系统中就会出现多个不同的Object类，Java类型体系中最基础的行为也就无从保证，应用程序将会变得一片混乱。</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve) <span class="hljs-keyword">throws</span> ClassNotFoundException&#123;<br>    <span class="hljs-comment">// 首先，检查请求的类是否已经被加载过了</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> findLoadedClass(name);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>                c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                c = findBootstrapClassOrNull(name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e)&#123;<br>            <span class="hljs-comment">// 如果父类加载器抛出ClassNotFoundException</span><br>            <span class="hljs-comment">// 说明父类加载器无法完成加载请求</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">// 在父类加载器无法加载时</span><br>            <span class="hljs-comment">// 再调用本身的findClass方法来进行类加载</span><br>            c = findClass(name);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (resolve) &#123;<br>        resolveClass(c);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>垃圾收集</title>
    <link href="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/"/>
    <url>/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/</url>
    
    <content type="html"><![CDATA[<h1 id="对象已死？"><a href="#对象已死？" class="headerlink" title="对象已死？"></a>对象已死？</h1><h2 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h2><p>很多教科书判断对象是否存活的算法是这样的：</p><p>在对象中添加一个引用计数器，每当有一个地方引用它时，计数器值就加一；当引用失效时，计数器值就减一；任何时刻计数器为零的对象就是不可能再被使用的。</p><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>引用计数算法（Reference Counting）虽然占用了一些额外的内存空间来进行计数，但它的原理简单，判定效率也很高，在大多数情况下它都是一个不错的算法。</p><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>这个看似简单的算法有很多例外情况要考虑，必须要配合大量额外处理才能保证正确地工作，譬如单纯的引用计数就很难解决对象之间相互循环引用的问题。</p><h2 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h2><p>当前主流的商用程序语言（Java、C#，上溯至前面提到的古老的Lisp）的内存管理子系统，都是通过可达性分析（Reachability Analysis）算法来判定对象是否存活的。</p><p>基本思路就是通过一系列称为“<code>GC Roots</code>”的根对象作为起始节点集，从这些节点开始，根据引用关系向下搜索，搜索过程所走过的路径称为<br>“引用链”（Reference Chain），如果某个对象到GC Roots间没有任何引用链相连，或者用图论的话来说就是从GC Roots到这个对象不可达时，则证明此对象是不可能再被使用的。</p><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/1.png" class=""></div><br><h2 id="GC-Roots对象"><a href="#GC-Roots对象" class="headerlink" title="GC Roots对象"></a>GC Roots对象</h2><ul><li>在<strong>虚拟机栈</strong>（栈帧中的本地变量表）中引用的对象，譬如各个线程被调用的方法堆栈中使用到的参数、局部变量、临时变量等</li><li>方法区中<strong>类静态属性</strong>引用的对象，譬如Java类的引用类型静态变量</li><li>方法区中<strong>常量</strong>引用的对象，譬如字符串常量池（String Table）里的引用</li><li>本地方法栈中<strong>JNI（Native方法）</strong>引用的对象<br>Java<strong>虚拟机内部</strong>引用的对象，譬如基本数据类型对应的Class对象，常驻的异常对象，系统类加载器</li><li>所有被<strong>同步锁</strong>（synchronized关键字）持有的对象</li><li><strong>反应Java虚拟机内部情况</strong>的对象，譬如JMXBean、JVMTI中注册的回调、本地代码缓存等</li></ul><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul><li>强引用，类似<strong>Object obj &#x3D; new Object()这种引用关系，只要强引用关系存在，垃圾收集器就永远不会收掉被引用的对象</strong></li><li>软引用，有用，但非必须的对象。在系统将要<strong>发生内存溢出异常前</strong>，会把这些对象列进回收范围之中<strong>进行第二次回收</strong></li><li>弱引用，描述那些非必须对象，但是它的强度比软引用更弱一些，<strong>每次都会被垃圾收集器收集</strong></li><li>虚引用，最弱的一种引用关系，一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。唯一目的只是为了能在这个对象<strong>被收集器回收时收到一个系统通知</strong></li></ul><h2 id="生存还是死亡"><a href="#生存还是死亡" class="headerlink" title="生存还是死亡"></a>生存还是死亡</h2><p>即使在可达性分析算法中判定为不可达的对象，也不是“非死不可”的，这时候它们暂时还处于“缓刑”阶段，要真正宣告一个对象死亡，至少要经历两次标记过程：</p><p>如果对象在进行可达性分析后发现没有与<code>GC Roots</code>相连接的引用链，那它将会被第一次标记，</p><p>随后进行一次筛选，筛选的条件是此对象是否有必要执行<code>finalize()</code>方法。</p><p>假如对象没有覆盖<code>finalize()</code>方法(无药可救)，或者<code>finalize()</code>方法已经被虚拟机调用过，那么虚拟机将这两种情况都视为“没有必要执行”。</p><h1 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h1><p>从如何判定对象消亡的角度出发，垃圾收集算法可以划分为“引用计数式垃圾收集”（ReferenceCounting GC）和“追踪式垃圾收集”（Tracing GC）两大类，这两类也常被称作“直接垃圾收集”和“间接垃圾收集”。</p><p>由于引用计数式垃圾收集算法在本书讨论到的主流Java虚拟机中均未涉及，所以我们暂不把它作为正文主要内容来讲解，本节介绍的所有算法均属于追踪式垃圾收集的范畴。</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul><li>部分收集<code>（Partial GC）</code>：指目标不是完整收集整个Java堆的垃圾收集，其中又分为：</li><li>新生代收集<code>（Minor GC/Young GC）</code>：指目标只是新生代的垃圾收集。</li><li>老年代收集<code>（Major GC/Old GC）</code>：指目标只是老年代的垃圾收集。目前只有CMS收集器会有单独收集老年代的行为。另外请注意“Major GC”这个说法现在有点混淆，在不同资料上常有不同所指，读者需按上下文区分到底是指老年代的收集还是整堆收集。</li><li>混合收集<code>（Mixed GC）</code>：指目标是收集整个新生代以及部分老年代的垃圾收集。目前只有G1收集器会有这种行为。</li><li>整堆收集<code>（Full GC）</code>：收集整个Java堆和方法区的垃圾收集。</li></ul><h2 id="标记-清除"><a href="#标记-清除" class="headerlink" title="标记-清除"></a>标记-清除</h2><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/2.png" class=""></div><br><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><p>速度非常快</p><h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ol><li>是执行效率不稳定，如果Java堆中包含大量对象，而且其中大部分是需要被回收的，这时必须进行大量标记和清除的动作，导致标记和清除两个过程的执行效率都随对象数量增长而降低</li><li>容易产生内存碎片，标记、清除之后会产生大量不连续的内存碎片，空间碎片太多可能会导致当以后在程序运行过程中需要分配较大对象时无法找到足够的连续内存而不得不提前触发另一次垃圾收集动作。<br>比如上图中有一块较大的对象想存放，但是存放不下</li></ol><h2 id="标记-整理"><a href="#标记-整理" class="headerlink" title="标记-整理"></a>标记-整理</h2><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/3.png" class=""></div><br><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>老年代</p><h3 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h3><p>没有内存碎片</p><h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><p>添加了一步整理的过程，需要移动对象，速度相对较慢</p><h2 id="标记复制算法"><a href="#标记复制算法" class="headerlink" title="标记复制算法"></a>标记复制算法</h2><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/4.png" class=""></div><br><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/5.png" class=""></div><br><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/6.png" class=""></div><br><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/7.png" class=""></div><br><h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><p>现在的商用Java虚拟机大多都优先采用了复制收集算法去回收新生代；但不适用于老年代，因为存活率高，会有较多的复制操作，效率将会降低</p><h3 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h3><p>不会产生内存碎片，速度也相对较快</p><h3 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h3><p>占用双倍的内存空间</p><h1 id="分代收集"><a href="#分代收集" class="headerlink" title="分代收集"></a>分代收集</h1><h2 id="Java堆内存"><a href="#Java堆内存" class="headerlink" title="Java堆内存"></a>Java堆内存</h2><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/8.png" class=""></div><br><h2 id="新生代"><a href="#新生代" class="headerlink" title="新生代"></a>新生代</h2><p>使用<code>Minor GC/Young GC</code>，标记-复制算法</p><h2 id="老年代"><a href="#老年代" class="headerlink" title="老年代"></a>老年代</h2><p>使用<code>Major GC/Old GC</code>，标记-整理算法</p><h1 id="经典垃圾收集器"><a href="#经典垃圾收集器" class="headerlink" title="经典垃圾收集器"></a>经典垃圾收集器</h1><h2 id="STW"><a href="#STW" class="headerlink" title="STW"></a>STW</h2><p><code>“Stop The World”</code>这个词语也许听起来很酷，但这项工作是由虚拟机在后台自动发起和自动完成的，在用户不可知、不可控的情况下把用户的正常工作的线程全部停掉，这对很多应用来说都是不能接受的。</p><h2 id="Serial收集器"><a href="#Serial收集器" class="headerlink" title="Serial收集器"></a>Serial收集器</h2><p>Serial收集器是最基础、历史最悠久的收集器，曾经（在JDK 1.3.1之前）是HotSpot虚拟机新生代收集器的唯一选择。</p><p>是一个单线程工作的收集器，但它的“单线程”的意义并不仅仅是说明它只会使用一个处理器或一条收集线程去完成垃圾收集工作，更重要的是强调在它进行垃圾收集时，必须暂停其他所有工作线程，直到它收集结束。</p><p>写到这里，笔者似乎已经把Serial收集器描述成一个最早出现，但目前已经老而无用，食之无味，弃之可惜的“鸡肋”了，但事实上，迄今为止，它依然是HotSpot虚拟机运行在客户端模式下的默认新生代收集器，有着优于其他收集器的地方，那就是简单而高效（与其他收集器的单线程相比），对于内存资源受限的环境，它是所有收集器里额外内存消耗（Memory Footprint）最小的</p><p>在用户桌面的应用场景以及近年来流行的部分微服务应用中，分配给虚拟机管理的内存一般来说并不会特别大，收集几十兆甚至一两百兆的新生代（仅仅是指新生代使用的内存，桌面应用甚少超过这个容量），垃圾收集的停顿时间完全可以控制在十几、几十毫秒，最多一百多毫秒以内，只要不是频繁发生收集，这点停顿时间对许多用户来说是完全可以接受的。所以，Serial收集器对于运行在客户端模式下的虚拟机来说是一个很好的选择。</p><h3 id="运行示意图"><a href="#运行示意图" class="headerlink" title="运行示意图"></a>运行示意图</h3><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/9.png" class=""></div><br><h2 id="Serial-Old收集器"><a href="#Serial-Old收集器" class="headerlink" title="Serial Old收集器"></a>Serial Old收集器</h2><p>Serial Old是Serial收集器的老年代版本，它同样是一个单线程收集器，使用标记-整理算法。</p><h3 id="运行示意图-1"><a href="#运行示意图-1" class="headerlink" title="运行示意图"></a>运行示意图</h3><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/10.png" class=""></div><br><h2 id="ParNew收集器"><a href="#ParNew收集器" class="headerlink" title="ParNew收集器"></a>ParNew收集器</h2><p>ParNew收集器实质上是Serial收集器的多线程并行版本</p><p>ParNew收集器除了支持多线程并行收集之外，其他与Serial收集器相比并没有太多创新之处，但它却是不少运行在服务端模式下的HotSpot虚拟机，尤其是JDK 7之前的遗留系统中首选的新生代收集器，其中有一个与功能、性能无关但其实很重要的原因是：</p><p>除了Serial收集器外，目前只有它能与CMS收集器配合工作。</p><p>自JDK 9开始，ParNew加CMS收集器的组合就不再是官方 推荐的服务端模式下的收集器解决方案了</p><h3 id="运行示意图-2"><a href="#运行示意图-2" class="headerlink" title="运行示意图"></a>运行示意图</h3><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/11.png" class=""></div><br><h3 id="注意-1"><a href="#注意-1" class="headerlink" title="注意"></a>注意</h3><p>并行和并发都是并发编程中的专业名词，在谈论垃圾收集器的上下文语境中，它们可以理解为：</p><ul><li><p>并行（Parallel）：并行描述的是多条垃圾收集器线程之间的关系，说明同一时间有多条这样的线程在协同工作，通常默认此时用户线程是处于等待状态。</p></li><li><p>并发（Concurrent）：并发描述的是垃圾收集器线程与用户线程之间的关系，说明同一时间垃圾收集器线程与用户线程都在运行。</p></li></ul><p>由于用户线程并未被冻结，所以程序仍然能响应服务请求，但由于垃圾收集器线程占用了一部分系统资源，此时应用程序的处理的吞吐量将受到一定影响。</p><h2 id="Parallel-Scavenge收集器"><a href="#Parallel-Scavenge收集器" class="headerlink" title="Parallel Scavenge收集器"></a>Parallel Scavenge收集器</h2><p><code>Parallel Scavenge</code>收集器也是一款新生代收集器，它同样是基于标记-复制算法实现的收集器，也是能够并行收集的多线程收集器……</p><p><code>Parallel Scavenge</code>的诸多特性从表面上看和<code>ParNew</code>非常相似</p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>达到一个可控制的吞吐量，所谓吞吐量就是处理器用于运行用户代码的时间与处理器总消耗时间的比值</p><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/12.png" class=""></div><br><h3 id="参数设置"><a href="#参数设置" class="headerlink" title="参数设置"></a>参数设置</h3><ul><li>控制最大垃圾收集停顿时间的<code>-XX：MaxGCPauseMillis</code></li><li>直接设置吞吐量大小的<code>-XX：GCTimeRatio</code></li><li>自适应的调节策略<code>-XX：+UseAdaptiveSizePolicy</code></li></ul><h2 id="Parallel-Old收集器"><a href="#Parallel-Old收集器" class="headerlink" title="Parallel Old收集器"></a>Parallel Old收集器</h2><p><code>Parallel Old</code>是<code>Parallel Scavenge</code>收集器的老年代版本，支持多线程并发收集，基于标记-整理算法实现。</p><h3 id="运行示意图-3"><a href="#运行示意图-3" class="headerlink" title="运行示意图"></a>运行示意图</h3><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/13.png" class=""></div><br><h2 id="CMS收集器"><a href="#CMS收集器" class="headerlink" title="CMS收集器"></a>CMS收集器</h2><p><code>CMS（Concurrent Mark Sweep）</code>收集器是一种以获取最短回收停顿时间为目标的收集器，基于标记-清除算法实现</p><p>目前很大一部分的Java应用集中在互联网网站或者基于浏览器的<code>B/S</code>系统的服务端上，这类应用通常都会较为 关注服务的响应速度，希望系统停顿时间尽可能短，以给用户带来良好的交互体验。</p><h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><p>以获取最短回收停顿时间为目标的收集器</p><h3 id="运行过程"><a href="#运行过程" class="headerlink" title="运行过程"></a>运行过程</h3><ol><li>初始标记<br> 会触发STW，仅仅只是标记一下GC Roots能直接关联到的对象，速度很快</li><li>并发标记<br> 从GC Roots的直接关联对象开始遍历整个对象图的过程，这个过程耗时较长但是不需要停顿用户线程，可以与垃圾收集线程一起并发运行</li><li>重新标记<br> 会触发STW，是为了修正并发标记期间，因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，这个阶段的停顿时间通常会比初始标记阶段稍长一些，但也远比并发标记阶段的时间短</li><li>并发清除<br> 清理删除掉标记阶段判断的已经死亡的对象，由于不需要移动存活对象，所以这个阶段也是可以与用户线程同时并发的</li></ol><h3 id="运行示意图-4"><a href="#运行示意图-4" class="headerlink" title="运行示意图"></a>运行示意图</h3><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/14.png" class=""></div><br><h3 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h3><ol><li>CMS收集器对处理器资源非常敏感。</li><li>CMS收集器无法处理“浮动垃圾”<code>（Floating Garbage）</code></li><li>CMS是一款基于“标记-清除”算法实现的收集器，缺点非常明显，一是不稳定，二是有垃圾碎片</li></ol><h2 id="Garbage-First收集器"><a href="#Garbage-First收集器" class="headerlink" title="Garbage First收集器"></a>Garbage First收集器</h2><p>Garbage First（简称G1）收集器是垃圾收集器技术发展历史上的里程碑式的成果，它开创了收集器面向局部收集的设计思路和基于Region的内存布局形式。</p><p>G1是一款主要面向服务端应用的垃圾收集器。</p><h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul><li>同时注重吞吐量和低延迟，默认暂停目标 200ms</li><li>超大堆内存，会将堆划分为多个大小相等的Region</li><li>整体上是标记+整理算法，两个区域之间是复制算法</li></ul><h3 id="理解"><a href="#理解" class="headerlink" title="理解"></a>理解</h3><p>首先要有一个思想上的改变，在G1收集器出现之前的所有 其他收集器，包括CMS在内，垃圾收集的目标范围要么是整个新生代（Minor GC），要么就是整个老年代（Major GC），再要么就是整个Java堆（Full GC）。</p><p>而G1跳出了这个樊笼，它可以面向堆内存任何部分来组成回收集（Collection Set，一般简称CSet）进行回收，衡量标准不再是它属于哪个分代，而 是哪块内存中存放的垃圾数量最多，回收收益最大，这就是G1收集器的Mixed GC模式。</p><h3 id="TAMS"><a href="#TAMS" class="headerlink" title="TAMS"></a>TAMS</h3><p>G1为每一个Region设计了两个名为TAMS（Top at Mark Start）的指针，把Region中的一部分空间划分出来用于并发回收过程中的新对象分配，并发回收时新分配的对象地址都必须要在这两个指针位置以上。</p><h3 id="SATB"><a href="#SATB" class="headerlink" title="SATB"></a>SATB</h3><p>原始快照</p><h3 id="运行过程-1"><a href="#运行过程-1" class="headerlink" title="运行过程"></a>运行过程</h3><ol><li><p>初始标记</p><p> 会触发STW，仅仅只是标记一下GC Roots能直接关联到的对象，并且修改TAMS指针的值，让下一阶段用户线程并发运行时，能正确地在可用的Region中分配新对象。</p></li><li><p>并发标记</p><p> 从GC Root开始对堆中对象进行可达性分析，递归扫描整个堆里的对象图，找出要回收的对象，这阶段耗时较长，但可与用户程序并发执行。</p></li><li><p>最终标记</p><p> 会触发STW，用于处理并发阶段结束后仍遗留下来的最后那少量的SATB记录。</p></li><li><p>筛选回收</p><p> 会触发STW，负责更新Region的统计数据，对各个Region的回收价值和成本进行排序，根据用户所期望的停顿时间来制定回收计划，可以自由选择任意多个Region 构成回收集，然后把决定回收的那一部分Region的存活对象复制到空的Region中，再清理掉整个旧Region的全部空间。</p></li></ol><h3 id="运行示意图-5"><a href="#运行示意图-5" class="headerlink" title="运行示意图"></a>运行示意图</h3><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/15.png" class=""></div><br><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/16.png" class=""></div><br><h4 id="Young-Collection"><a href="#Young-Collection" class="headerlink" title="Young Collection"></a>Young Collection</h4><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/17.png" class=""></div><br><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/18.png" class=""></div><br><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/19.png" class=""></div><br><h4 id="Young-Collection-Concurrent-Mark"><a href="#Young-Collection-Concurrent-Mark" class="headerlink" title="Young Collection + Concurrent Mark"></a>Young Collection + Concurrent Mark</h4><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/20.png" class=""></div><br><h4 id="Mixed-Collection"><a href="#Mixed-Collection" class="headerlink" title="Mixed Collection"></a>Mixed Collection</h4><div align="center">    <img src="/2021/01/30/JVM/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/21.png" class=""></div><br><h3 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">-XX: +UseG1GC<br>-xx: G1HeapRegionSize = size<br>-xx: MaxGCPauseMillis = time<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>对象的创建过程</title>
    <link href="/2021/01/30/JVM/%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/"/>
    <url>/2021/01/30/JVM/%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="一、检查"><a href="#一、检查" class="headerlink" title="一、检查"></a>一、检查</h1><ol><li>检查指令的参数是否能在常量池中定位到一个类的符号引用</li><li>检查这个符号引用代表的类是否已被加载、解析和初始化过</li><li>类加载检查是否符合《Java虚拟机规范》的全部约束要求</li></ol><h1 id="二、分配内存"><a href="#二、分配内存" class="headerlink" title="二、分配内存"></a>二、分配内存</h1><p>1.选择分配方式。</p><pre><code class="hljs">Java堆中的内存如果是绝对规整的，将会采用“指针碰撞”的分配方式；反之采用“空闲列表”的分配方式。而Java堆中的内存是否规整又采用的垃圾收集器是否带有空间压缩整理的能力决定。因此使用Serial、ParNew等带压缩整理过程的收集器时，系统采用的分配算法是指针碰撞，既简单又高校。使用CMS这种基于清除算法的收集器时，采用比较复杂的空闲列表来分配内存</code></pre><p>2.因为创建对象是虚拟机中非常频繁的行为，要解决线程问题。</p><pre><code class="hljs">虚拟机提供了两种解决方案：一种是采用CAS配上失败重试的方式保证更新操作的原子性；另一种是为每个线程在Java堆中预先分配一块内存，称为本地线程分配缓存(Thread Local Allocation Buffer, TLAB)</code></pre><h1 id="三、初始化"><a href="#三、初始化" class="headerlink" title="三、初始化"></a>三、初始化</h1><ol><li><p>隐式初始化。</p><p> 虚拟机将分配到不包括对象头在内的内存空间初始化为0，如果这分配内存时采用TLAB解决线程安全问题，那么这一步会提前至TLAB分配时顺便进行。</p></li><li><p>显示初始化。</p><p> 虚拟机为对象头进行必要的设置，<br> 例如这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄等信息。<br> 从虚拟机的视角来看，一个新的对象已经产生了。</p></li><li><p>执行<code>&lt;init&gt;()</code>方法，按照开发者的意愿对对象进行初始化，此时一个真正可用的对象才算完全被构造出来。</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTTPS</title>
    <link href="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTPS/"/>
    <url>/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTPS/</url>
    
    <content type="html"><![CDATA[<h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul><li>HTTPS（Hypertext Transfer Protocol Secure：超文本传输安全协议）是一种透过计算机网络进行安全通信的传输协议。</li><li>HTTPS 经由 HTTP 进行通信，但利用 <strong>SSL&#x2F;TLS 来加密数据包</strong>。HTTPS 开发的主要目的，是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。</li></ul><h2 id="与HTTP的对比"><a href="#与HTTP的对比" class="headerlink" title="与HTTP的对比"></a>与HTTP的对比</h2><h3 id="默认端口"><a href="#默认端口" class="headerlink" title="默认端口"></a>默认端口</h3><ul><li>HTTPS 默认工作在 TCP 协议443端口</li><li>HTTP 默认工作在 TCP 协议 80 端口</li></ul><h3 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h3><ul><li>HTTPS（SSL+HTTP） 数据传输过程是加密的，安全性较好</li><li>HTTP 明文传输，数据都是未加密的，安全性较差</li></ul><h3 id="协议证书"><a href="#协议证书" class="headerlink" title="协议证书"></a>协议证书</h3><ul><li>使用 HTTPS 协议需要到** CA（Certificate Authority，数字证书认证机构）** 申请证书，一般免费证书较少，因而需要一定费用。</li><li>HTTP不用</li></ul><h3 id="响应速度"><a href="#响应速度" class="headerlink" title="响应速度"></a>响应速度</h3><ul><li>HTTPS除了 TCP 的三个包，还要加上 ssl 握手需要的 9 个包，所以一共是 12 个包</li><li>HTTP 使用 TCP 三次握手建立连接，客户端和服务器需要交换 3 个包</li></ul><h3 id="资源消耗"><a href="#资源消耗" class="headerlink" title="资源消耗"></a>资源消耗</h3><ul><li>HTTPS因为要加上ssl握手需要的包，所以会根据消耗资源</li><li>HTTP不需要ssl握手</li></ul><h3 id="握手过程对比"><a href="#握手过程对比" class="headerlink" title="握手过程对比"></a>握手过程对比</h3><h4 id="HTTPS-1"><a href="#HTTPS-1" class="headerlink" title="HTTPS"></a>HTTPS</h4><div align="center"><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTPS/1.gif" class=""></div><ol><li>客户端发送请求https连接。</li><li>服务器返回加密公钥，通常是SSL证书。</li><li>客户端从这个SSL证书解析出公钥，并随机生成一个key，通过公钥加密这个key发送给服务器（这一步是安全的因为只有服务器才有私钥能读出这个key）。</li><li>服务器通过私钥解密出key。</li><li>客户端使用这个key来加密需要传输的数据。</li><li>服务器使用key来解析数据。</li></ol><p>简单的来说SSL加密的方式是使用一个密钥来加密另一个密钥（key），在使用被加密的密钥来加密数据。<br>这样的做法固然保证了安全性，但每次连接时都需要使用密钥加密，导致请求会需要额外的开销，同时服务器第一次返回的公钥的可靠性需要第三方来保证，通常是购买SSL证书。这也会造成额外的经济开销。</p><h5 id="1、客户端发起-HTTPS-请求"><a href="#1、客户端发起-HTTPS-请求" class="headerlink" title="1、客户端发起 HTTPS 请求"></a>1、客户端发起 HTTPS 请求</h5><p>这个没什么好说的，就是用户在浏览器里输入一个 https 网址，然后连接到 server 的 443 端口。</p><h5 id="2、服务端的配置"><a href="#2、服务端的配置" class="headerlink" title="2、服务端的配置"></a>2、服务端的配置</h5><p>采用 HTTPS 协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请，区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面(startssl 就是个不错的选择，有 1 年的免费服务)。</p><p>这套证书其实就是一对公钥和私钥，如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。</p><h5 id="3、传送证书"><a href="#3、传送证书" class="headerlink" title="3、传送证书"></a>3、传送证书</h5><p>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。</p><h5 id="4、客户端解析证书"><a href="#4、客户端解析证书" class="headerlink" title="4、客户端解析证书"></a>4、客户端解析证书</h5><p>这部分工作是有客户端的TLS来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。</p><p>如果证书没有问题，那么就生成一个随机值，然后用证书对该随机值进行加密，就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。</p><h5 id="5、传送加密信息"><a href="#5、传送加密信息" class="headerlink" title="5、传送加密信息"></a>5、传送加密信息</h5><p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。</p><h5 id="6、服务端解密信息"><a href="#6、服务端解密信息" class="headerlink" title="6、服务端解密信息"></a>6、服务端解密信息</h5><p>服务端用私钥解密后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密，所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。</p><h5 id="7、传输加密后的信息"><a href="#7、传输加密后的信息" class="headerlink" title="7、传输加密后的信息"></a>7、传输加密后的信息</h5><p>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原。</p><h5 id="8、客户端解密信息"><a href="#8、客户端解密信息" class="headerlink" title="8、客户端解密信息"></a>8、客户端解密信息</h5><p>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容，整个过程第三方即使监听到了数据，也束手无策。</p><h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><div align="center"><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTPS/2.jpg" class=""></div><h5 id="1、第一次握手"><a href="#1、第一次握手" class="headerlink" title="1、第一次握手"></a>1、第一次握手</h5><p>客户端尝试连接服务器，向服务器发送 syn 包（同步序列编号Synchronize Sequence Numbers），syn&#x3D;j，客户端进入 SYN_SEND 状态等待服务器确认</p><h5 id="2、第二次握手"><a href="#2、第二次握手" class="headerlink" title="2、第二次握手"></a>2、第二次握手</h5><p>服务器接收客户端syn包并确认（ack&#x3D;j+1），同时向客户端发送一个 SYN包（syn&#x3D;k），即 SYN+ACK 包，此时服务器进入 SYN_RECV 状态</p><h5 id="3、第三次握手"><a href="#3、第三次握手" class="headerlink" title="3、第三次握手"></a>3、第三次握手</h5><p>第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack&#x3D;k+1），此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手</p>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>计算机网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机网络</tag>
      
      <tag>HTTPS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTTP</title>
    <link href="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/"/>
    <url>/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/</url>
    
    <content type="html"><![CDATA[<h1 id="HTTP报文格式"><a href="#HTTP报文格式" class="headerlink" title="HTTP报文格式"></a>HTTP报文格式</h1><h2 id="HTTP请求报文格式"><a href="#HTTP请求报文格式" class="headerlink" title="HTTP请求报文格式"></a>HTTP请求报文格式</h2><center><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/1.png" class=""></center><h3 id="请求行支持的方法"><a href="#请求行支持的方法" class="headerlink" title="请求行支持的方法"></a>请求行支持的方法</h3><center><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/2.png" class=""></center><h2 id="HTTP响应报文格式"><a href="#HTTP响应报文格式" class="headerlink" title="HTTP响应报文格式"></a>HTTP响应报文格式</h2><center><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/3.png" class=""></center><h3 id="常见状态码"><a href="#常见状态码" class="headerlink" title="常见状态码"></a>常见状态码</h3><ul><li>100：这个状态码是告诉客户端<strong>应该继续发送请求</strong>，这个临时响应是用来<strong>通知客户端的，部分的请求服务器已经接受</strong>，但是客户端应继续发送求请求的剩余部分，如果请求已经完成，就忽略这个响应，而且服务器会在请求完成后向客户发送一个最终的结果</li><li>200：这个是最常见的http状态码，表示服务器<strong>已经成功接受请求，并将返回客户端所请求的最终结果</strong></li><li>202：表示服务器已经接受了请求，但是<strong>还没有处理</strong>，而且这个请求最终会不会<strong>处理还不确定</strong></li><li>204：服务器成功<strong>处理了请求，但没有返回任何实体内容</strong> ，可能会返回新的头部元信息</li><li>301：客户端请求的网页<strong>已经永久移动到新的位置</strong>，当链接发生变化时，返回301代码<strong>告诉客户端链接的变化</strong>，客户端保存新的链接，并向新的链接发出请求，已返回请求结果</li><li>404：请求失败，客户端请求的资源<strong>没有找到或者是不存在</strong></li><li>500：服务器遇到未知的错误，导致无法完成客户端当前的请求</li><li>503：服务器由于临时的服务器<strong>过载或者是维护</strong>，无法解决当前的请求</li></ul><h2 id="请求和响应报文的对比"><a href="#请求和响应报文的对比" class="headerlink" title="请求和响应报文的对比"></a>请求和响应报文的对比</h2><center><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/4.png" class=""></center><h2 id="HTTP-x2F-1-0"><a href="#HTTP-x2F-1-0" class="headerlink" title="HTTP&#x2F;1.0"></a>HTTP&#x2F;1.0</h2><p><strong>HTTP 1.0规定浏览器与服务器只保持短暂的连接，浏览器的每次请求都需要与服务器建立一个TCP连接，服务器完成请求处理后立即断开TCP连接</strong></p><p>当一个网页文件中包含了很多图像的地址的时候，那就需要很多次的http请求和响应，每次请求和响应都需要一个单独的连接，每次连接只是传输一个文档和图像，上一次和下一次请求完全分离。</p><p>即使图像文件都很小，但是客户端和服务器端每次建立和关闭连接却是一个相对比较费时的过程，并且会严重影响客户机和服务器的性能。当一个网页文件中包含JavaScript文件，CSS文件等内容时，也会出现类似上述的情况。</p><h3 id="连接方式"><a href="#连接方式" class="headerlink" title="连接方式"></a>连接方式</h3><ul><li>HTTP&#x2F;1.0采用非持续连接方式。</li><li>在该方式下，每次浏览器要请求一个文件都要与服务器建立TCP连接，当收到响应后就立即关闭连接<center></li></ul><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/5.png" class=""></center><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>每次请求都需要有两倍的<strong>RTT（请求和响应所花费的时间，往返时延，Round-Trip Time）</strong></li><li>为了减少时延，<strong>浏览器通常会建立多个并行的TCP连接同时请求多个对象</strong>。但是，这会大量占用万维网服务器的资源，特别是万维网服务器往往要同时服务大量客户的请求，这会使其负担很重</li></ul><h2 id="HTTP-x2F-1-1"><a href="#HTTP-x2F-1-1" class="headerlink" title="HTTP&#x2F;1.1"></a>HTTP&#x2F;1.1</h2><p>为了<strong>克服HTTP 1.0的这个缺陷</strong>，HTTP 1.1支持持久连接（HTTP&#x2F;1.1的默认模式使用带流水线的持久连接），在一个TCP连接上可以传送多个HTTP请求和响应，减少了建立和关闭连接的消耗和延迟。</p><p>一个包含有许多图像的网页文件的多个请求和应答可以在一个连接中传输，但每个单独的网页文件的请求和应答仍然需要使用各自的连接。</p><p>HTTP 1.1还允许客户端<strong>不用等待上一次请求结果返回，就可以发出下一次请求</strong>，但服务器端必须按照接收到客户端请求的先后顺序依次回送响应结果，以保证客户端能够区分出每次请求的响应内容，这样也显著地减少了整个下载过程所需要的时间。</p><p>在HTTP 1.1，request和response头中都有可能出现一个connection的头，此header的含义是当client和server通信时对于长链接如何进行处理。</p><p>在HTTP 1.1中，<strong>client和server都是默认对方支持长链接</strong>的， 如果client使用HTTP 1.1协议，但又不希望使用长链接，则需要在header中指明connection的值为close；如果server方也不想支持长链接，则在response中也需要明确说明connection的值为close。</p><p>不论request还是response的header中包含了值为close的connection，都表明当前正在使用的TCP链接在当天请求处理完毕后会被断掉。以后client再进行新的请求时就必须创建新的TCP链接了。</p><p>HTTP 1.1在继承了HTTP 1.0优点的基础上，也克服了HTTP 1.0的性能问题。</p><p>HTTP 1.1通过增加更多的请求头和响应头来改进和扩充HTTP 1.0的功能。如，HTTP 1.0不支持Host请求头字段，WEB浏览器无法使用主机头名来明确表示要访问服务器上的哪个WEB站点，这样就无法使用WEB服务器在同一个IP地址和端口号上配置多个虚拟WEB站点。在HTTP 1.1中增加Host请求头字段后，WEB浏览器可以使用主机头名来明确表示要访问服务器上的哪个WEB站点，这才实现了在一台WEB服务器上可以在同一个IP地址和端口号上使用不同的主机名来创建多个虚拟WEB站点。</p><p>HTTP 1.1的持续连接，也需要增加新的请求头来帮助实现，例如，Connection请求头的值为Keep-Alive时，客户端通知服务器返回本次请求结果后保持连接；Connection请求头的值为close时，客户端通知服务器返回本次请求结果后关闭连接。HTTP 1.1还提供了与身份认证、状态管理和Cache缓存等机制相关的请求头和响应头。HTTP&#x2F;1.0不支持文件断点续传，RANGE:bytes是HTTP&#x2F;1.1新增内容，HTTP&#x2F;1.0每次传送文件都是从文件头开始，即0字节处开始。RANGE:bytes&#x3D;XXXX表示要求服务器从文件XXXX字节处开始传送，这就是我们平时所说的断点续传！</p><h3 id="连接方式-1"><a href="#连接方式-1" class="headerlink" title="连接方式"></a>连接方式</h3><ul><li>HTTP&#x2F;1.1采用持续连接方式</li><li>在该方式下，万维网服务器在发送响应后仍然保留这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上传输后续的HTTP请求报文和响应报文</li><li>不局限于传输同一个页面上的引用对象，而是只要这些文档都在同一个服务器上就行</li></ul><center><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/6.png" class=""></center><h2 id="HTTP-1-0和HTTP-1-1的区别"><a href="#HTTP-1-0和HTTP-1-1的区别" class="headerlink" title="HTTP 1.0和HTTP 1.1的区别"></a>HTTP 1.0和HTTP 1.1的区别</h2><h3 id="长连接"><a href="#长连接" class="headerlink" title="长连接"></a>长连接</h3><ul><li>HTTP 1.1<strong>支持长连接和请求的流水线处理</strong>，在一个TCP连接上可以传送多个HTTP请求和响应，减少了建立和关闭连接的消耗和延迟，并**<strong>且默认开启长连接keep-alive</strong>，一定程度上弥补了HTTP 1.0每次请求都要创建连接的缺点。</li><li>HTTP 1.0需要使用keep-alive参数来告知服务器端要建立一个长连接。</li></ul><h3 id="节约带宽"><a href="#节约带宽" class="headerlink" title="节约带宽"></a>节约带宽</h3><ul><li>HTTP 1.1<strong>支持只发送header信息（不带任何body信息）</strong>，如果服务器认为客户端有权限请求服务器，则返回100，客户端接收到100才开始把请求body发送到服务器；如果返回401，客户端就可以<strong>不用发送请求body了节约了带宽</strong>。</li><li>HTTP 1.0中存在一些浪费带宽的现象，例如客户端只是需要某个对象的一部分，而服务器却将<strong>整个对象送过来了，并且不支持断点续传功能</strong>。</li></ul><h3 id="HOST域"><a href="#HOST域" class="headerlink" title="HOST域"></a>HOST域</h3><ul><li>HTTP 1.1的请求消息和响应消息都支持host域，且请求消息中如果没有HOST域会报告一个错误（400 Bad Request）。</li><li>在HTTP 1.0中认为每台服务器都绑定一个唯一的IP地址，因此，请求消息中的URL并没有传递主机名（hostname），HTTP1.0没有host域。</li></ul><h3 id="缓存处理"><a href="#缓存处理" class="headerlink" title="缓存处理"></a>缓存处理</h3><ul><li>HTTP 1.1则引入了更多的缓存控制策略例如Entity tag，If-Unmodified-Since, If-Match, If-None-Match等更多可供选择的缓存头来控制缓存策略。</li><li>在HTTP 1.0中主要使用header里的If-Modified-Since,Expires来做为缓存判断的标准</li></ul><h3 id="错误通知的管理"><a href="#错误通知的管理" class="headerlink" title="错误通知的管理"></a>错误通知的管理</h3><p>HTTP 1.1中新增了24个错误状态响应码，如409（Conflict）表示请求的资源与资源的当前状态发生冲突；410（Gone）表示服务器上的某个资源被永久性的删除。</p><h2 id="HTTP-x2F-2-0"><a href="#HTTP-x2F-2-0" class="headerlink" title="HTTP&#x2F;2.0"></a>HTTP&#x2F;2.0</h2><p>相比 HTTP&#x2F;1.x，HTTP&#x2F;2 在底层传输做了很大的改动和优化：</p><h3 id="传输数据"><a href="#传输数据" class="headerlink" title="传输数据"></a>传输数据</h3><p>HTTP&#x2F;2 采用<strong>二进制格式</strong>传输数据，而非 HTTP&#x2F;1.x 的文本格式。二进制格式在协议的解析和优化扩展上带来更多的优势和可能。</p><h3 id="头部数据压缩"><a href="#头部数据压缩" class="headerlink" title="头部数据压缩"></a>头部数据压缩</h3><ul><li>HTTP&#x2F;2 <strong>对消息头采用 HPACK 进行压缩传输</strong>，能够节省消息头占用的网络的流量。而 HTTP&#x2F;1.x 每次请求，都会携带大量冗余头信息，浪费了很多带宽资源。头压缩能够很好的解决该问题。</li><li>在HTTP 1.1中，HTTP请求和响应都是由状态行、请求&#x2F;响应头部、消息主体三部分组成。一般而言，消息主体都会经过gzip压缩，或者本身传输的就是压缩过后的二进制文件，但状态行和头部却没有经过任何压缩，直接以纯文本传输。<br>随着Web功能越来越复杂，每个页面产生的请求数也越来越多，导致消耗在头部的流量越来越多，尤其是每次都要传输UserAgent、Cookie这类不会频繁变动的内容，完全是一种浪费。</li><li>HTTP 1.1不支持header数据的压缩，HTTP 2.0使用HPACK算法对header的数据进行压缩，这样数据体积小了，在网络上传输就会更快。</li></ul><h3 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h3><ul><li>直白的说就是所有的请求都是通过一个TCP 连接并发完成。</li><li>HTTP&#x2F;1.x 虽然通过 pipeline 也能并发请求，但是多个请求之间的响应会被阻塞的，所以 pipeline 至今也没有被普及应用；也可以多建立几个TCP连接，来支持处理更多并发的请求，但是创建TCP连接本身也是有开销的。</li><li>而 HTTP&#x2F;2 做到了真正的并发请求，而且并发请求的数量比HTTP 1.1大了好几个数量级。同时，流还支持优先级和流量控制。</li></ul><h3 id="服务器推送"><a href="#服务器推送" class="headerlink" title="服务器推送"></a>服务器推送</h3><p>为了改善延迟，HTTP 2.0引入了server push，服务端能够更快的把资源推送给客户端。例如服务端可以主动把 JS 和 CSS 文件推送给客户端，而不需要客户端解析 HTML 再发送这些请求。当客户端需要的时候，它已经在客户端了。</p><center><img src="/2021/01/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP/7.jpeg" class=""></center>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>计算机网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机网络</tag>
      
      <tag>HTTP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TCP和UDP</title>
    <link href="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/"/>
    <url>/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/</url>
    
    <content type="html"><![CDATA[<h1 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h1><h2 id="一、TCP流量控制"><a href="#一、TCP流量控制" class="headerlink" title="一、TCP流量控制"></a>一、TCP流量控制</h2><h3 id="1-1-什么是流量控制有什么用？"><a href="#1-1-什么是流量控制有什么用？" class="headerlink" title="1.1 什么是流量控制有什么用？"></a>1.1 什么是流量控制有什么用？</h3><p>​如果数据发送的过快，则就接收方可能来不及接收，造成数据的丢失</p><p>​ 所谓流量控制就是<strong>让发送方的发送速率不要太快，让接收方来得及接收</strong>。</p><h3 id="1-2-滑动窗口实例"><a href="#1-2-滑动窗口实例" class="headerlink" title="1.2 滑动窗口实例"></a>1.2 滑动窗口实例</h3><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/1.png" class=""></center><h3 id="1-3-0窗口探测报文（携带1字节）"><a href="#1-3-0窗口探测报文（携带1字节）" class="headerlink" title="1.3 0窗口探测报文（携带1字节）"></a>1.3 0窗口探测报文（携带1字节）</h3><p>当接收方告知发送方法接收窗口为0的时候开始启动持续计时器，等待接收方缓存有了新的存储空间</p><p>​这个过程没过一个持续计时器都会发送零窗口探测报文</p><p><strong>TCP协议规定无论接收方的接收窗口为多大都需要接收0窗口探测报文</strong></p><p>发送0窗口探测报文也会有一个超时重传的机制</p><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/2.png" class=""></center><br><p><strong>宏观来讲</strong>：客户端的发送窗口由服务端的接收窗口决定，进而达到服务端对客户端的流量控制。当服务端的接收窗口为0时，客户端会开始启动持续计时器，每过一个持续计时器都会向服务端发送0窗口探测报文，目的是为了防止服务端有了新的存储空间向客户端重新发送接收窗口时却丢失造成死锁的情况。</p><h2 id="二、拥塞控制"><a href="#二、拥塞控制" class="headerlink" title="二、拥塞控制"></a>二、拥塞控制</h2><h3 id="2-1-什么是拥塞控制"><a href="#2-1-什么是拥塞控制" class="headerlink" title="2.1 什么是拥塞控制"></a>2.1 什么是拥塞控制</h3><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/3.png" class=""></center><ul><li><strong>ssthresh</strong>： 慢开始门限值</li><li><strong>cwnd</strong>： 拥塞窗口值</li></ul><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/4.png" class=""></center><h3 id="2-2-快恢复"><a href="#2-2-快恢复" class="headerlink" title="2.2 快恢复"></a>2.2 快恢复</h3><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/5.png" class=""></center><h3 id="2-3-TCP超时重传的选择"><a href="#2-3-TCP超时重传的选择" class="headerlink" title="2.3 TCP超时重传的选择"></a>2.3 TCP超时重传的选择</h3><p>超时时间的选择</p><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/6.png" class=""></center><h2 id="三、TCP可靠传输的实现"><a href="#三、TCP可靠传输的实现" class="headerlink" title="三、TCP可靠传输的实现"></a>三、TCP可靠传输的实现</h2><h3 id="3-1-如何描述发送窗口的状态"><a href="#3-1-如何描述发送窗口的状态" class="headerlink" title="3.1 如何描述发送窗口的状态"></a>3.1 如何描述发送窗口的状态</h3><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/7.png" class=""></center><h3 id="3-2-TCP传输过程中的特性"><a href="#3-2-TCP传输过程中的特性" class="headerlink" title="3.2 TCP传输过程中的特性"></a>3.2 TCP传输过程中的特性</h3><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/8.png" class=""></center><h2 id="四、TCP的运输连接管理"><a href="#四、TCP的运输连接管理" class="headerlink" title="四、TCP的运输连接管理"></a>四、TCP的运输连接管理</h2><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/9.png" class=""></center><h3 id="4-1-TCP的连接建立"><a href="#4-1-TCP的连接建立" class="headerlink" title="4.1 TCP的连接建立"></a>4.1 TCP的连接建立</h3><h4 id="4-1-1-连接建立的三个前提"><a href="#4-1-1-连接建立的三个前提" class="headerlink" title="4.1.1 连接建立的三个前提"></a>4.1.1 连接建立的三个前提</h4><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/10.png" class=""></center><h4 id="4-1-2-连接建立的具体过程"><a href="#4-1-2-连接建立的具体过程" class="headerlink" title="4.1.2 连接建立的具体过程"></a>4.1.2 连接建立的具体过程</h4><blockquote><p>TCP的标准规定: SYN&#x3D;1的报文段不能携带数据，但要消耗一个序号.</p><p>普通报文段不携带数据，则不需要消耗序号</p></blockquote><ul><li><strong>SYN</strong>：同步序列编号</li><li><strong>seq</strong>：序列编号</li><li><strong>ack</strong>：确认编号</li><li><strong>ACK</strong>：确认值，为1表示确认</li></ul><blockquote><p>TCP建立过程中，客户机首先发送一个SYN消息和一个seq，服务器使用SYN+ACK应答表示接收，最后客户机再以ACK消息响应。</p></blockquote><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/11.png" class=""></center><p>如果只有两次报文握手的情况</p><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/12.png" class=""></center><p><strong>两次报文握手不行:</strong><br>因为在网络情况下，可能第一个TCP连接请求报文段滞留在网络环境中，TCP连接请求发送重传，服务器和客户端成功建立连接之后释放连接，滞留在网络中的第一个TCP报文段送到了服务器，会导致服务器一致保持在连接建立的状态下，浪费服务器主机的进程资源.</p><p><strong>第三次报文的作用</strong>: 防止已经失效的tcp请求报文又突然传到了服务器，因而导致错误.</p><h2 id="五、TCP连接的释放-四报文挥手"><a href="#五、TCP连接的释放-四报文挥手" class="headerlink" title="五、TCP连接的释放(四报文挥手)"></a>五、TCP连接的释放(四报文挥手)</h2><p><strong>FIN：Finish结束标识</strong></p><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/13.png" class=""></center><p><strong>MSL为最长报文段寿命</strong></p><h3 id="保活计时器"><a href="#保活计时器" class="headerlink" title="保活计时器"></a>保活计时器</h3><center><img src="/2021/01/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%92%8CUDP/14.png" class=""></center><h2 id="二者区别"><a href="#二者区别" class="headerlink" title="二者区别"></a>二者区别</h2><table><thead><tr><th align="center"></th><th align="center">TCP</th><th align="center">UDP</th></tr></thead><tbody><tr><td align="center">是否面向连接</td><td align="center">是</td><td align="center">否</td></tr><tr><td align="center">是否可靠</td><td align="center">是</td><td align="center">否</td></tr><tr><td align="center">是否有状态</td><td align="center">是</td><td align="center">否</td></tr><tr><td align="center">传输效率</td><td align="center">较慢</td><td align="center">较快</td></tr><tr><td align="center">传输形式</td><td align="center">字节流</td><td align="center">数据报文段</td></tr><tr><td align="center">首部开销</td><td align="center">20 ～ 60 bytes</td><td align="center">8 bytes</td></tr><tr><td align="center">是否提供广播或多播服务</td><td align="center">否</td><td align="center">是</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>计算机网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机网络</tag>
      
      <tag>TCP</tag>
      
      <tag>UDP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL优化</title>
    <link href="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/"/>
    <url>/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<blockquote><p>以下内容均为转载自<br><a href="https://www.bilibili.com/video/BV1kh411Y7vx?p=17&amp;&gt;">https://www.bilibili.com/video/BV1kh411Y7vx?p=17&amp;&gt;</a> spm_id_from&#x3D;pageDriver<br>的课程资料</p></blockquote><h1 id="一、SQL优化"><a href="#一、SQL优化" class="headerlink" title="一、SQL优化"></a>一、SQL优化</h1><p>SQL优化的目的是为了SQL语句能够具备优秀的查询性能，实现这样的目的有很多的途径：</p><ul><li>工程优化如何实现：数据库标准、表的结构标准、字段的标准、创建索引</li><li>SQL语句的优化：当前SQL语句有没有命中索引。</li></ul><h2 id="1-工程优化如何实现"><a href="#1-工程优化如何实现" class="headerlink" title="1.工程优化如何实现"></a>1.工程优化如何实现</h2><p>参考《MySQL军规升级版》</p><h2 id="2-Explain执行计划——SQL优化神器"><a href="#2-Explain执行计划——SQL优化神器" class="headerlink" title="2.Explain执行计划——SQL优化神器"></a>2.Explain执行计划——SQL优化神器</h2><p>得知道当前系统里有哪些SQL是慢SQL，查询性能超过1s的sql，然后再通过Explain工具可以对当前SQL语句的性能进行判断——为什么慢，怎么解决。</p><p>要想知道哪些SQL是慢SQL，有两种方式，一种是开启本地MySQL的慢查询日志；另一种是阿里云提供的RDS（第三方部署的MySQL服务器），提供了查询慢SQL的功能。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-keyword">like</span> &quot;customer100%&quot;<br></code></pre></td></tr></table></figure><p>通过在SQL语句前面加上explain关键字，执行后并不会真正的执行sql语句本身，而是通过explain工具来分析当前这条SQL语句的性能细节：比如是什么样的查询类型、可能用到的索引及实际用到的索引，和一些额外的信息。</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210518092433386.png" class="" title="image-20210518092433386"></div><h2 id="3-MySQL的内部优化器"><a href="#3-MySQL的内部优化器" class="headerlink" title="3.MySQL的内部优化器"></a>3.MySQL的内部优化器</h2><p>在SQL查询开始之前，MySQL内部优化器会进行一次自我优化，让这一次的查询性能尽可能的好。</p><p>当前执行的SQL</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_book <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br><span class="hljs-keyword">show</span> warnings;<br></code></pre></td></tr></table></figure><p>内部优化器优化后的效果：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/* select#1 */</span> <span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">AS</span> `id`,<span class="hljs-string">&#x27;千锋Java厉害&#x27;</span> <span class="hljs-keyword">AS</span> `name` <span class="hljs-keyword">from</span> `db_mysql_pro`.`tb_book` <span class="hljs-keyword">where</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="4-select-type列"><a href="#4-select-type列" class="headerlink" title="4.select_type列"></a>4.select_type列</h2><p>关闭 MySQL 对衍生表的合并优化：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> session optimizer_switch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;derived_merge=off&#x27;</span>; <br></code></pre></td></tr></table></figure><p>执行了这样的计划：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> tb_author <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_book <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) der;<br></code></pre></td></tr></table></figure><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210518093837712.png" class="image-20210518093837712.png.png"></div><ul><li>derived：</li></ul><p>第一条执行的sql是from后面的子查询，该子查询只要在from后面，就会生成一张衍生表，因此他的查询类型：derived</p><ul><li>subquery：</li></ul><p>在select之后 from之前的子查询</p><ul><li>primary：</li></ul><p>最外部的select</p><ul><li>simple：</li></ul><p>不包含子查询的简单的查询</p><ul><li>union：</li></ul><p>使用union进行的联合查询的类型</p><h2 id="5-table列"><a href="#5-table列" class="headerlink" title="5.table列"></a>5.table列</h2><p>当前查询正在查哪张表</p><h2 id="6-type列"><a href="#6-type列" class="headerlink" title="6.type列"></a>6.type列</h2><p>type列可以直观的判断出当前的sql语句的性能。type里的取值和性能的优劣顺序如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">null</span> <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">system</span> <span class="hljs-operator">&gt;</span> const <span class="hljs-operator">&gt;</span> eq_ref <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ref</span> <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">range</span> <span class="hljs-operator">&gt;</span> index <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">all</span><br></code></pre></td></tr></table></figure><p>对于SQL优化来说，要尽量保证type列的值是属于range及以上级别。</p><ul><li>null</li></ul><p>性能最好的，一般在使用了聚合函数操作索引列，结果直接从索引树获取即可，因此是性能最好。</p><ul><li>system</li></ul><p>很少见。直接和一条记录进行匹配。</p><ul><li>const</li></ul><p>使用主键索引或唯一索引和常量进行比较，这种性能非常好</p><ul><li>eq_ref</li></ul><p>在进行多表连接查询时。如果查询条件是使用了主键进行比较，那么当前查询类型是eq_ref</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_book_author <span class="hljs-keyword">left</span> <span class="hljs-keyword">JOIN</span> tb_book <span class="hljs-keyword">on</span> tb_book_author.book_id <span class="hljs-operator">=</span> tb_book.id<br></code></pre></td></tr></table></figure><ul><li><p>ref</p><ul><li>简单查询：EXPLAIN select * from tb_book where name&#x3D;’book1’</li></ul><p>​      如果查询条件是普通列索引，那么类型ref</p><ul><li>复杂查询：EXPLAIN select book_id from tb_book left join tb_book_author on tb_book.id &#x3D; tb_book_author.book_id</li></ul><p>​     如果查询条件是普通列索引，那么类型ref</p></li><li><p>range:</p></li></ul><p> 使用索引进行范围查找</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_book <span class="hljs-keyword">where</span> id<span class="hljs-operator">&gt;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><ul><li>index</li></ul><p>查询没有进行条件判断。但是所有的数据都可以直接从索引树上获取(book表中的所有列都有索引)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_book<br></code></pre></td></tr></table></figure><ul><li>all</li></ul><p>没有走索引，进行了全表扫描</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_author<br></code></pre></td></tr></table></figure><h2 id="7-id列"><a href="#7-id列" class="headerlink" title="7.id列"></a>7.id列</h2><p>在多个select中，id越大越先执行，如果id相同。上面的先执行。</p><h2 id="8-possible-keys列"><a href="#8-possible-keys列" class="headerlink" title="8.possible keys列"></a>8.possible keys列</h2><p>这一次的查询可能会用到的索引。也就是说mysql内部优化器会进行判断，如果这一次查询走索引的性能比全表扫描的性能要查，那么内部优化器就让此次查询进行全表扫描——这样的判断依据我们可以通过trace工具来查看</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;custome%&#x27;</span><br></code></pre></td></tr></table></figure><p>这条sql走索引查询的行数是500多万，那么总的数据行数也就500多万，因此直接进行全表扫描性能更快</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210518103742876.png" class="" title="image-20210518103742876"></div><h2 id="9-key列"><a href="#9-key列" class="headerlink" title="9.key列"></a>9.key列</h2><p>实际该sql语句使用的索引</p><h2 id="10-rows列"><a href="#10-rows列" class="headerlink" title="10.rows列"></a>10.rows列</h2><p>该sql语句可能要查询的数据条数</p><h2 id="11-key-len列"><a href="#11-key-len列" class="headerlink" title="11.key_len列"></a>11.key_len列</h2><p>键的长度，通过这一列可以让我们知道当前命中了联合索引中的哪几列。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;customer10011&#x27;</span> # <span class="hljs-number">74</span><br>EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;customer10011&#x27;</span> <span class="hljs-keyword">and</span> age<span class="hljs-operator">=</span><span class="hljs-number">30</span> # <span class="hljs-number">74</span> <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">78</span><br>EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;customer10011&#x27;</span> <span class="hljs-keyword">and</span> age<span class="hljs-operator">=</span><span class="hljs-number">30</span> <span class="hljs-keyword">and</span> position<span class="hljs-operator">=</span><span class="hljs-string">&#x27;dev&#x27;</span> # <span class="hljs-number">74</span> <span class="hljs-number">4</span> <span class="hljs-number">62</span> <span class="hljs-operator">=</span> <span class="hljs-number">140</span><br>EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;customer10011&#x27;</span> <span class="hljs-keyword">and</span> position<span class="hljs-operator">=</span><span class="hljs-string">&#x27;dev&#x27;</span> # <span class="hljs-number">74</span><br></code></pre></td></tr></table></figure><p>name长度是74，也就是当看到key-len是74，表示使用了联合索引中的name列</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210518104705482.png" class="" title="image-20210518104705482"></div><p>计算规则：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> 字符串<br><span class="hljs-bullet">1.</span> char(n): n字节长度<br><span class="hljs-bullet">2.</span> varchar(n): 2字节存储字符串长度,如果是utf-8,则长度3n + 2<br><br><span class="hljs-bullet">-</span> 数值类型<br><span class="hljs-bullet">1.</span> tinyint: 1字节<br><span class="hljs-bullet">2.</span> smallint: 2字节<br><span class="hljs-bullet">3.</span> int: 4字节<br><span class="hljs-bullet">4.</span> bigint: 8字节<br><br><span class="hljs-bullet">-</span> 时间类型<br><span class="hljs-bullet">1.</span> date: 3字节<br><span class="hljs-bullet">2.</span> timestamp: 4字节<br><span class="hljs-bullet">3.</span> datetime: 8字节<br><br>如果字段允许为NULL,需要1字节记录是否为NULL<br>索引最大长度是768字节,当字符串过长时, mysql会做一个类似左前缀索引的处理,将前半部分的字符提取出来做索引<br></code></pre></td></tr></table></figure><h2 id="12-extra列"><a href="#12-extra列" class="headerlink" title="12.extra列"></a>12.extra列</h2><p>extra列提供了额外的信息，是能够帮助我们判断当前sql的是否使用了覆盖索引、文件排序、使用了索引进行查询条件等等的信息。</p><ul><li><p>Using index:使用了覆盖索引</p><p>所谓的覆盖索引，指的是当前查询的所有数据字段都是索引列，这就意味着可以直接从索引列中获取数据，而不需要进行查表。</p><p>使用覆盖索引进行性能优化这种手段是之后sql优化经常要用到的。</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> book_id,author_id <span class="hljs-keyword">from</span> tb_book_author <span class="hljs-keyword">where</span> book_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-comment">-- 覆盖索引</span><br>EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_book_author <span class="hljs-keyword">where</span> book_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-comment">-- 没有使用覆盖索引</span><br></code></pre></td></tr></table></figure><ul><li><p>using where</p><p>使用了普通索引列做查询条件</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_author <span class="hljs-keyword">where</span> name <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;a&#x27;</span><br></code></pre></td></tr></table></figure><ul><li>using index condition</li></ul><p>查询结果没有使用覆盖索引，建议可以使用覆盖索引来优化</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_book_author <span class="hljs-keyword">where</span> book_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><ul><li>Using temporary</li></ul><p>在非索引列上进行去重操作就需要使用一张临时表来实现，性能是非常差的。当前name列没有索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-keyword">DISTINCT</span> name <span class="hljs-keyword">from</span> tb_author<br></code></pre></td></tr></table></figure><ul><li>Using filesort</li></ul><p>使用文件排序： 会使用磁盘+内存的方式进行文件排序，会涉及到两个概念：单路排序、双路排序</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_author <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name<br></code></pre></td></tr></table></figure><ul><li>Select tables optimized away</li></ul><p>直接在索引列上进行聚合函数的操作，没有进行任何的表的操作</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(id) <span class="hljs-keyword">from</span> tb_book<br></code></pre></td></tr></table></figure><h1 id="二、Trace工具"><a href="#二、Trace工具" class="headerlink" title="二、Trace工具"></a>二、Trace工具</h1><p>在执行计划中我们发现有的sql会走索引，有的sql即使明确使用了索引也不会走索引。这是因为mysql的内部优化器任务走索引的性能比不走索引全表扫描的性能要差，因此mysql内部优化器选择了使用全表扫描。依据来自于trace工具的结论。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> session optimizer_trace<span class="hljs-operator">=</span>&quot;enabled=on&quot;, end_markers_in_json<span class="hljs-operator">=</span><span class="hljs-keyword">on</span>; <span class="hljs-comment">-- 开启trace</span><br> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> position; <span class="hljs-comment">-- 执行查询</span><br> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.OPTIMIZER_TRACE; <span class="hljs-comment">-- 获得trace的分析结果</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;join_preparation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> -- 阶段<span class="hljs-number">1</span><span class="hljs-punctuation">:</span>进入到准备阶段<br>        <span class="hljs-attr">&quot;select#&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;expanded_query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/* select#1 */ select `employees`.`id` AS `id`,`employees`.`name` AS `name`,`employees`.`age` AS `age`,`employees`.`position` AS `position`,`employees`.`hire_time` AS `hire_time` from `employees` where (`employees`.`name` &gt; &#x27;a&#x27;) order by `employees`.`position`&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* steps */</span><br>      <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* join_preparation */</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;join_optimization&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> -- 阶段<span class="hljs-number">2</span><span class="hljs-punctuation">:</span> 进入到优化阶段<br>        <span class="hljs-attr">&quot;select#&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;condition_processing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> -- 条件处理<br>              <span class="hljs-attr">&quot;condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;WHERE&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;original_condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;transformation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;equality_propagation&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;resulting_condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;transformation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;constant_propagation&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;resulting_condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;transformation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trivial_condition_removal&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;resulting_condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>              <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* steps */</span><br>            <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* condition_processing */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;substitute_generated_columns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* substitute_generated_columns */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;table_dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> -- 表依赖详情<br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;row_may_be_null&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;map_bit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;depends_on_map_bits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* depends_on_map_bits */</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* table_dependencies */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;ref_optimizer_key_uses&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* ref_optimizer_key_uses */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;rows_estimation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;range_analysis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;table_scan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;rows&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5598397</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;cost&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">576657</span><br>                  <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* table_scan */</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;potential_range_indexes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> -- 可能使用到的索引<br>                    <span class="hljs-punctuation">&#123;</span><br>                      <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PRIMARY&quot;</span><span class="hljs-punctuation">,</span> -- 主键索引<br>                      <span class="hljs-attr">&quot;usable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                      <span class="hljs-attr">&quot;cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;not_applicable&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                      <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;idx_name_age_position&quot;</span><span class="hljs-punctuation">,</span> -- 联合索引<br>                      <span class="hljs-attr">&quot;usable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                      <span class="hljs-attr">&quot;key_parts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                        <span class="hljs-string">&quot;name&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-string">&quot;age&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-string">&quot;position&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-string">&quot;id&quot;</span><br>                      <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* key_parts */</span><br>                    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                      <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;idx_hire_time&quot;</span><span class="hljs-punctuation">,</span><br>                      <span class="hljs-attr">&quot;usable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                      <span class="hljs-attr">&quot;cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;not_applicable&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                  <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* potential_range_indexes */</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;setup_range_conditions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                  <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* setup_range_conditions */</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;group_index_range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;chosen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;not_group_by_or_distinct&quot;</span><br>                  <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* group_index_range */</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;skip_scan_range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;potential_skip_scan_indexes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                      <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;idx_name_age_position&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;usable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;query_references_nonkey_column&quot;</span><br>                      <span class="hljs-punctuation">&#125;</span><br>                    <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* potential_skip_scan_indexes */</span><br>                  <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* skip_scan_range */</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;analyzing_range_alternatives&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> -- 分析各个索引使用的成本<br>                    <span class="hljs-attr">&quot;range_scan_alternatives&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                      <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;idx_name_age_position&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;ranges&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                          <span class="hljs-string">&quot;a &lt; name&quot;</span><br>                        <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* ranges */</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;index_dives_for_eq_ranges&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;rowid_ordered&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;using_mrr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;index_only&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> -- 是否使用了覆盖索引<br>                        <span class="hljs-attr">&quot;rows&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2799198</span><span class="hljs-punctuation">,</span> -- 要扫描的行数<br>                        <span class="hljs-attr">&quot;cost&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2.08e6</span><span class="hljs-punctuation">,</span> -- 要花费的时间<br>                        <span class="hljs-attr">&quot;chosen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> -- 是否选择使用这个索引<br>                        <span class="hljs-attr">&quot;cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cost&quot;</span> -- 不选择的原因：开销比较大<br>                      <span class="hljs-punctuation">&#125;</span><br>                    <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* range_scan_alternatives */</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;analyzing_roworder_intersect&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                      <span class="hljs-attr">&quot;usable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                      <span class="hljs-attr">&quot;cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;too_few_roworder_scans&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* analyzing_roworder_intersect */</span><br>                  <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* analyzing_range_alternatives */</span><br>                <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* range_analysis */</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* rows_estimation */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;considered_execution_plans&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;plan_prefix&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* plan_prefix */</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;best_access_path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> -- 最优访问路径<br>                  <span class="hljs-attr">&quot;considered_access_paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> -- 最后选择的访问路径<br>                    <span class="hljs-punctuation">&#123;</span><br>                      <span class="hljs-attr">&quot;rows_to_scan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5598397</span><span class="hljs-punctuation">,</span> -- 全表扫描的行数<br>                      <span class="hljs-attr">&quot;access_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;scan&quot;</span><span class="hljs-punctuation">,</span> -- 全表扫描<br>                      <span class="hljs-attr">&quot;resulting_rows&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5.6e6</span><span class="hljs-punctuation">,</span> -- 结果的行数<br>                      <span class="hljs-attr">&quot;cost&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">576655</span><span class="hljs-punctuation">,</span> -- 花费的时间<br>                      <span class="hljs-attr">&quot;chosen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> -- 选择这种方式<br>                      <span class="hljs-attr">&quot;use_tmp_table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>                    <span class="hljs-punctuation">&#125;</span><br>                  <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* considered_access_paths */</span><br>                <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* best_access_path */</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;condition_filtering_pct&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;rows_for_plan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5.6e6</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;cost_for_plan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">576655</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;sort_cost&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5.6e6</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;new_cost_for_plan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6.18e6</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;chosen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* considered_execution_plans */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;attaching_conditions_to_tables&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;original_condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;attached_conditions_computation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* attached_conditions_computation */</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;attached_conditions_summary&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;attached&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>              <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* attached_conditions_summary */</span><br>            <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* attaching_conditions_to_tables */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;optimizing_distinct_group_by_order_by&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;simplifying_order_by&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;original_clause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`.`position`&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;items&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                  <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;item&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`.`position`&quot;</span><br>                  <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* items */</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;resulting_clause_is_simple&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;resulting_clause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`.`position`&quot;</span><br>              <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* simplifying_order_by */</span><br>            <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* optimizing_distinct_group_by_order_by */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;reconsidering_access_paths_for_index_ordering&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;clause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ORDER BY&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* steps */</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;index_order_summary&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index_provides_order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;order_direction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;undefined&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;unknown&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;plan_changed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>              <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* index_order_summary */</span><br>            <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* reconsidering_access_paths_for_index_ordering */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;finalizing_table_conditions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;original_table_condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;final_table_condition   &quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;(`employees`.`name` &gt; &#x27;a&#x27;)&quot;</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* finalizing_table_conditions */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;refine_plan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`&quot;</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* refine_plan */</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;considering_tmp_tables&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;adding_sort_to_table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;employees&quot;</span><br>              <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* filesort */</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* considering_tmp_tables */</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* steps */</span><br>      <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* join_optimization */</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;join_execution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;select#&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;sorting_table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;employees&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;filesort_information&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;direction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;asc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;expression&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;`employees`.`position`&quot;</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* filesort_information */</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;filesort_priority_queue_optimization&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;usable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;not applicable (no LIMIT)&quot;</span><br>            <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* filesort_priority_queue_optimization */</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;filesort_execution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* filesort_execution */</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;filesort_summary&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;memory_available&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">262144</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;key_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">40</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;row_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">190</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;max_rows_per_buffer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1379</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;num_rows_estimate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5598397</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;num_rows_found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5913852</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;num_initial_chunks_spilled_to_disk&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1954</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;peak_memory_used&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">262144</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;sort_algorithm&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;std::stable_sort&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;sort_mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&lt;fixed_sort_key, packed_additional_fields&gt;&quot;</span><br>            <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* filesort_summary */</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* steps */</span><br>      <span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">/* join_execution */</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span> <span class="hljs-comment">/* steps */</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h1 id="三、SQL优化实战"><a href="#三、SQL优化实战" class="headerlink" title="三、SQL优化实战"></a>三、SQL优化实战</h1><h2 id="1-order-by优化"><a href="#1-order-by优化" class="headerlink" title="1.order by优化"></a>1.order by优化</h2><p>在排序应用场景中，很容易出现文件排序的问题，文件排序会对性能造成影响，因此需要优化</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"># <span class="hljs-keyword">using</span> filesort<br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;customer&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> position;<br># 没有使用文件排序 <br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;customer&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age, position;<br># 不满足最左前缀法则，使用了文件排序<br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;customer&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> position, age;<br># 满足最左前缀法则，使用索引排序<br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;customer&#x27;</span> <span class="hljs-keyword">and</span> age<span class="hljs-operator">=</span><span class="hljs-number">20</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> position, age;<br><span class="hljs-keyword">show</span> WARNINGS;<br><span class="hljs-comment">/* select#1 */</span> <span class="hljs-keyword">select</span> `db_mysql_pro`.`employees`.`id` <span class="hljs-keyword">AS</span> `id`,`db_mysql_pro`.`employees`.`name` <span class="hljs-keyword">AS</span> `name`,`db_mysql_pro`.`employees`.`age` <span class="hljs-keyword">AS</span> `age`,`db_mysql_pro`.`employees`.`position` <span class="hljs-keyword">AS</span> `position`,`db_mysql_pro`.`employees`.`hire_time` <span class="hljs-keyword">AS</span> `hire_time` <span class="hljs-keyword">from</span> `db_mysql_pro`.`employees` <span class="hljs-keyword">where</span> ((`db_mysql_pro`.`employees`.`age` <span class="hljs-operator">=</span> <span class="hljs-number">20</span>) <span class="hljs-keyword">and</span> (`db_mysql_pro`.`employees`.`name` <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;customer&#x27;</span>)) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> `db_mysql_pro`.`employees`.`position`<br># 排序方向不同，没有使用索引排序<br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;customer&#x27;</span> <span class="hljs-keyword">and</span> age<span class="hljs-operator">=</span><span class="hljs-number">20</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age, position <span class="hljs-keyword">desc</span>;<br># 使用范围查询，使用了文件排序<br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;customer&#x27;</span>,<span class="hljs-string">&#x27;aa&#x27;</span>) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age, position;<br># 使用范围查询，使用了文件排序<br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> name <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name;<br></code></pre></td></tr></table></figure><p>优化手段：</p><ul><li>如果排序的字段创建了联合索引，那么尽量在业务不冲突的情况下，遵循最左前缀法则来写排序语句。</li><li>如果文件排序没办法避免，那么尽量想办法使用覆盖索引。all-&gt;index</li></ul><h2 id="2-group-by优化"><a href="#2-group-by优化" class="headerlink" title="2.group by优化"></a>2.group by优化</h2><p>group by 的原理是先排序后分组，因此对于group by 的优化参考order by</p><h2 id="3-文件排序的原理"><a href="#3-文件排序的原理" class="headerlink" title="3.文件排序的原理"></a>3.文件排序的原理</h2><p>在执行文件排序的时候，会把查询的数据的大小与系统变量：max_length_for_sort_data的大小进行比较（默认是1024字节）,如果比系统变量小，那么执行单路排序，反之则执行双路排序</p><ul><li>单路排序</li></ul><p>​       把所有的数据扔到sort_buffer内存缓冲区中，进行排序，然后结束</p><ul><li><p>双路排序</p><p>取数据的排序字段和主键字段，在内存缓冲区中排序完成后，将主键字段做一次回表查询，获取完整数据。</p></li></ul><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210518144357614.png" class="" title="image-20210518144357614"></div><h2 id="4-分页优化"><a href="#4-分页优化" class="headerlink" title="4.分页优化"></a>4.分页优化</h2><p>对于这样的优化查询，mysql会把全部的10010数据拿到，并舍弃掉前面的10000条</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 一次行获取10010，再舍弃掉前10000条</span><br>Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees limit <span class="hljs-number">1000000</span>,<span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p> 如果在主键连续的情况下，可以使用主键来做条件，但是这种情况是很少见的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> id<span class="hljs-operator">&gt;</span><span class="hljs-number">100000</span> limit <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>对于主键不连续情况下的例子：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">Explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name limit <span class="hljs-number">1000000</span>,<span class="hljs-number">10</span><br><span class="hljs-comment">-- 通过先进行覆盖索引的查找，然后在使用join做连接查询获取所有数据。这样比全表扫描要快</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees a <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name limit <span class="hljs-number">1000000</span>,<span class="hljs-number">10</span>)  b <span class="hljs-keyword">on</span> a.id <span class="hljs-operator">=</span> b.id;<br></code></pre></td></tr></table></figure><h2 id="5-join优化"><a href="#5-join优化" class="headerlink" title="5.join优化"></a>5.join优化</h2><p>在join中会涉及到大表（数据量大）和小表（数据量小）的概念。MySQL内部优化器会根据关联字段是否创建了索引来使用不同的算法：</p><ul><li><p>Nlj(嵌套循环算法)：如果关联字段使用了索引，mysql会对小表做全表扫描，用小表的数据去和大表的数据去做索引字段的关联查询（type：ref）</p></li><li><p>bnlj（块嵌套循环算法）：如果关联字段没有使用索引，mysql会提供一个join buffer缓冲区，先把小表放到缓冲区中，然后全表扫描大表，把大表的数据和缓冲区中的小表数据在内存中进行匹配。</p></li></ul><p>结论：使用join查询时，一定要建立关联字段的索引，且两张表的关联字段在设计之初就要做到字段类型、长度是一致的，否则索引失效。</p><h2 id="6-in和exists优化"><a href="#6-in和exists优化" class="headerlink" title="6.in和exists优化"></a>6.in和exists优化</h2><p>在sql中如果A表是大表，B表是小表，那么使用in会更加合适。反之应该使用exists。</p><ul><li>in: B的数据量&lt;A的数据量</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> id <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> B) <br># 相当于：<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> B)&#123; <span class="hljs-operator">/</span><span class="hljs-operator">/</span>B的数据量少，所以循环次数少。<br><br>   <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> A.id <span class="hljs-operator">=</span> B.id<br><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>exists:  B的数据量&gt;A的数据量 (10: id 1. 2. 3. 4)</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> <span class="hljs-keyword">exists</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> B <span class="hljs-keyword">where</span> B.id <span class="hljs-operator">=</span> A.id)  <span class="hljs-literal">true</span> <span class="hljs-operator">/</span> <span class="hljs-literal">false</span><br>等价于<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A)&#123;<br>   <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> B <span class="hljs-keyword">where</span> B.id <span class="hljs-operator">=</span> A.id<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="7-count优化"><a href="#7-count优化" class="headerlink" title="7.count优化"></a>7.count优化</h2><p>对于count的优化应该是架构层面的优化，因为count的统计是在一个产品会经常出现，而且每个用户访问，所以对于访问频率过高的数据建议维护在缓存中。</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210518155019048.png" class="" title="image-20210518155019048"></div><h1 id="四、锁的定义和分类"><a href="#四、锁的定义和分类" class="headerlink" title="四、锁的定义和分类"></a>四、锁的定义和分类</h1><h2 id="1-锁的定义"><a href="#1-锁的定义" class="headerlink" title="1.锁的定义"></a>1.锁的定义</h2><p>锁是用来解决多个任务（线程、进程）在并发访问同一共享资源时带来的数据安全问题。虽然使用锁解决了数据安全问题，但是会带来性能的影响，频繁使用锁的程序的性能是必然很差的。</p><p>对于数据管理软件MySQL来说，必然会到任务的并发访问。那么MySQL是怎么样在数据安全和性能上做权衡的呢？——MVCC设计思想。</p><h2 id="2-锁的分类"><a href="#2-锁的分类" class="headerlink" title="2.锁的分类"></a>2.锁的分类</h2><h3 id="1）从性能上划分：乐观锁和悲观锁"><a href="#1）从性能上划分：乐观锁和悲观锁" class="headerlink" title="1）从性能上划分：乐观锁和悲观锁"></a>1）从性能上划分：乐观锁和悲观锁</h3><ul><li>悲观锁：悲观的认为当前的并发是非常严重的，所以在任何时候操作都是互斥。保证了线程的安全，但牺牲了并发性。——总有刁民要害朕。</li><li>乐观锁：乐观的认为当前的并发并不严重，因此对于读的情况，大家都可以进行，但是对于写的情况，再进行上锁。以CAS自旋锁，在某种情况下性能是ok的，但是频繁自旋会消耗很大的资源。——天网恢恢疏而不漏</li></ul><h3 id="2）从数据的操作细粒度上划分：表锁和行锁"><a href="#2）从数据的操作细粒度上划分：表锁和行锁" class="headerlink" title="2）从数据的操作细粒度上划分：表锁和行锁"></a>2）从数据的操作细粒度上划分：表锁和行锁</h3><ul><li>表锁：对整张表上锁</li><li>行锁：对表中的某一行上锁。</li></ul><h3 id="3）从数据库的操作类型上划分：读锁和写锁"><a href="#3）从数据库的操作类型上划分：读锁和写锁" class="headerlink" title="3）从数据库的操作类型上划分：读锁和写锁"></a>3）从数据库的操作类型上划分：读锁和写锁</h3><p>这两种锁都是属于悲观锁</p><ul><li>读锁（共享锁）：对于同一行数据进行”读“来说，是可以同时进行但是写不行。</li><li>写锁（拍他锁）：在上了写锁之后，及释放写锁之前，在整个过程中是不能进行任何的其他并发操作（其他任务的读和写是都不能进行的）。</li></ul><h2 id="3-表锁"><a href="#3-表锁" class="headerlink" title="3.表锁"></a>3.表锁</h2><p>对整张表进行上锁。MyISAM存储引擎是天然支持表锁的，也就是说在MyISAM的存储引擎的表中如果出现并发的情况，将会出现表锁的效果。MyISAM不支持事务。InnoDB支持事务</p><p>在InnoDB中上一下表锁:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 对一张表上读锁<span class="hljs-operator">/</span>写锁格式：<br>lock <span class="hljs-keyword">table</span> 表名 read<span class="hljs-operator">/</span>write;<br># 例子<br>lock <span class="hljs-keyword">table</span> tb_book read;<br># 查看当前会话对所有表的上锁情况<br><span class="hljs-keyword">show</span> <span class="hljs-keyword">open</span> tables;<br># 释放当前会话的所有锁<br>unlock tables;<br></code></pre></td></tr></table></figure><p>读锁： 其他任务可以进行读，但是不能进行写</p><p>写锁：其他任务不能进行读和写。</p><h2 id="4-行锁"><a href="#4-行锁" class="headerlink" title="4.行锁"></a>4.行锁</h2><p>MyISAM只支持表锁，但不支持行锁，InnoDB可以支持行锁。</p><p>在并发事务里，每个事务的增删改的操作相当于是上了行锁。</p><p>上行锁的方式：</p><ul><li>update tb_book set name&#x3D;’qfjava2101’ where id&#x3D;8;  对id是8的这行数据上了行锁。</li><li>select * from tb_book where id&#x3D;5 for update; 对id是5的这行数据上了行锁。</li></ul><h1 id="五、MVCC设计思想"><a href="#五、MVCC设计思想" class="headerlink" title="五、MVCC设计思想"></a>五、MVCC设计思想</h1><p>MySQL为了权衡数据安全和性能，使用了MVCC多版本并发控制的设计。</p><h2 id="1-事务的特性"><a href="#1-事务的特性" class="headerlink" title="1.事务的特性"></a>1.事务的特性</h2><ul><li>原子性：一个事务是一个最小的操作单位（原子），多条sql语句在一个事务中要么同时成功，要么同时失败。</li><li>一致性：事务提交之前和回滚之后的数据是一致的。</li><li>持久性：事务一旦提交，对数据的影响是持久的。</li><li>隔离性：多个事务在并发访问下，提供了一套隔离机制，不同的隔离级别会有不同的并发效果。</li></ul><h2 id="2-事务的隔离级别"><a href="#2-事务的隔离级别" class="headerlink" title="2.事务的隔离级别"></a>2.事务的隔离级别</h2><ul><li>read uncommitted（读未提交）： 在一个事务中读取到另一个事务还没有提交的数据——脏读。</li><li>Read committed（读已提交）: 已经解决了脏读问题，在一个事务中只会读取另一个事务已提交的数据，这种情况会出现不可重复读的问题。就是：在事务中重复读数据，数据的内容是不一样的。</li><li>repeatable read（可重复读）：在一个事务中每次读取的数据都是一致的，不会出现脏读和不可重复读的问题。会出现虚读（幻读）的问题。</li></ul><p>什么是幻读：</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210519100046820.png" class="" title="image-20210519100046820"></div><p>解决方案：</p><p>通过上行锁来解决虚读问题：</p><img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210519100825916.png" class="" title="image-20210519100825916"><ul><li>Serializable:串行化的隔离界别直接不允许事务的并发发生，不存在任何的并发性。相当于锁表，性能非常差，一般都不考虑</li></ul><p>脏读、不可重复读、虚读（幻读）</p><h2 id="3-MVCC思想解读"><a href="#3-MVCC思想解读" class="headerlink" title="3.MVCC思想解读"></a>3.MVCC思想解读</h2><p>MySQL在读和写的操作中，对读的性能做了并发性的保障，让所有的读都是快照读，对于写的时候，进行版本控制，如果真实数据的版本比快照版本要新，那么写之前就要进行版本（快照）更新，这样就可以既能够提高读的并发性，又能够保证写的数据安全。</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210519095148255.png" class="" title="image-20210519095148255"></div><h1 id="六、死锁和间隙锁"><a href="#六、死锁和间隙锁" class="headerlink" title="六、死锁和间隙锁"></a>六、死锁和间隙锁</h1><h2 id="1-死锁"><a href="#1-死锁" class="headerlink" title="1.死锁"></a>1.死锁</h2><p>所谓的死锁，就是开启的锁没有办法关闭，导致资源的访问因为无法获得锁而处于阻塞状态。</p><p>演示：事务A和事物B相互持有对方需要的锁而不释放，造成死锁的情况。</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210519104203183.png" class="" title="image-20210519104203183"></div><h2 id="2-间隙锁"><a href="#2-间隙锁" class="headerlink" title="2.间隙锁"></a>2.间隙锁</h2><p>行锁只能对某一行上锁，如果相对某一个范围上锁，就可以使用间隙锁。间隙锁给的条件where id&gt;13 and id&lt;19，会对13 和19 所处的间隙进行上锁。</p><div align=center>    <img src="/2021/01/13/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BC%98%E5%8C%96/image-20210519105034758.png" class="" title="image-20210519105034758"></div>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>关系型数据库</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>进程管理</title>
    <link href="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"/>
    <url>/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="一、进程的组成、组织、特征"><a href="#一、进程的组成、组织、特征" class="headerlink" title="一、进程的组成、组织、特征"></a>一、进程的组成、组织、特征</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/1.png" class=""></div><h2 id="2-组成"><a href="#2-组成" class="headerlink" title="2.组成"></a>2.组成</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/2.png" class=""></div><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/3.png" class=""></div><h2 id="3-组织"><a href="#3-组织" class="headerlink" title="3.组织"></a>3.组织</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/4.png" class=""></div><h2 id="4-特征"><a href="#4-特征" class="headerlink" title="4.特征"></a>4.特征</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/5.png" class=""></div><h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a>5.总结</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/6.png" class=""></div><h1 id="二、进程的状态与转化"><a href="#二、进程的状态与转化" class="headerlink" title="二、进程的状态与转化"></a>二、进程的状态与转化</h1><h2 id="1-状态"><a href="#1-状态" class="headerlink" title="1.状态"></a>1.状态</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/7.png" class=""></div><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/8.png" class=""></div><h2 id="2-转换"><a href="#2-转换" class="headerlink" title="2.转换"></a>2.转换</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/9.png" class=""></div><h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/10.png" class=""></div><h1 id="三、进程控制"><a href="#三、进程控制" class="headerlink" title="三、进程控制"></a>三、进程控制</h1><h2 id="1-概念"><a href="#1-概念" class="headerlink" title="1.概念"></a>1.概念</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/11.png" class=""></div><p>简而言之，就是上图中的绿色箭头部分</p><h2 id="2-实现"><a href="#2-实现" class="headerlink" title="2.实现"></a>2.实现</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/12.png" class=""></div><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/13.png" class=""></div><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/14.png" class=""></div><h2 id="3-总结-1"><a href="#3-总结-1" class="headerlink" title="3.总结"></a>3.总结</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/15.png" class=""></div><h1 id="四、进程通信"><a href="#四、进程通信" class="headerlink" title="四、进程通信"></a>四、进程通信</h1><h2 id="1-概念-1"><a href="#1-概念-1" class="headerlink" title="1.概念"></a>1.概念</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/16.png" class=""></div><h2 id="2-方式一：共享存储"><a href="#2-方式一：共享存储" class="headerlink" title="2.方式一：共享存储"></a>2.方式一：共享存储</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/17.png" class=""></div><h2 id="3-方式二：管道通信"><a href="#3-方式二：管道通信" class="headerlink" title="3.方式二：管道通信"></a>3.方式二：管道通信</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/18.png" class=""></div><h2 id="4-方式三：消息传递"><a href="#4-方式三：消息传递" class="headerlink" title="4.方式三：消息传递"></a>4.方式三：消息传递</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/19.png" class=""></div><h2 id="5-总结-1"><a href="#5-总结-1" class="headerlink" title="5.总结"></a>5.总结</h2><div align=center>    <img src="/2020/11/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/20.png" class=""></div>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>操作系统</category>
      
    </categories>
    
    
    <tags>
      
      <tag>操作系统</tag>
      
      <tag>进程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL</title>
    <link href="/2020/11/19/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/"/>
    <url>/2020/11/19/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/</url>
    
    <content type="html"><![CDATA[<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="什么数据结构"><a href="#什么数据结构" class="headerlink" title="什么数据结构"></a>什么数据结构</h2><p>B+树</p><h2 id="MySQL的索引失效有哪些场景？"><a href="#MySQL的索引失效有哪些场景？" class="headerlink" title="MySQL的索引失效有哪些场景？"></a>MySQL的索引失效有哪些场景？</h2><ol><li>不符合最左匹配原则</li><li>在索引上使用计算、函数、类型的转换</li><li>使用了不等于</li><li>使用了 is null 或 is not null</li><li>使用了 like</li><li>字符串不加单引号</li></ol><h2 id="InnoDB引擎为什么使用B-树？"><a href="#InnoDB引擎为什么使用B-树？" class="headerlink" title="InnoDB引擎为什么使用B+树？"></a>InnoDB引擎为什么使用B+树？</h2><ol><li><p><strong>B+树空间利用率更高，可减少I&#x2F;O次数</strong></p><p> 一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。这样的话，索引查找过程中就要产生磁盘I&#x2F;O消耗。而因为B+树的内部节点只是作为索引使用，而不像B-树那样每个节点都需要存储硬盘指针。</p><p> 也就是说：B+树中每个非叶节点没有指向某个关键字具体信息的指针，所以每一个节点可以存放更多的关键字数量，即一次性读入内存所需要查找的关键字也就越多，减少了I&#x2F;O操作。</p><p> e.g.假设磁盘中的一个盘块容纳16bytes，而一个关键字2bytes，一个关键字具体信息指针2bytes。一棵9阶B-tree(一个结点最多8个关键字)的内 部结点需要2个盘快。而B+ 树内部结点只需要1个盘快。当需要把内部结点读入内存中的时候，B 树就比B+ 树多一次盘块查找时间(在磁盘中是盘片旋转的时间)。</p></li><li><p><strong>增删文件（节点）时，效率更高</strong></p><p> 因为B+树的叶子节点包含所有关键字，并以有序的链表结构存储，这样可很好提高增删效率，基于范围查询更好。</p></li><li><p><strong>B+树的查询效率更加稳定</strong></p><p> 因为B+树的每次查询过程中，都需要遍历从根节点到叶子节点的某条路径。所有关键字的查询路径长度相同，导致每一次查询的效率相当。</p><p> B-树的每个节点都有data域</p></li></ol><h2 id="为什么不适用-B-树"><a href="#为什么不适用-B-树" class="headerlink" title="为什么不适用 B- 树"></a>为什么不适用 B- 树</h2><p>B-树的每个节点都有data域，增加了 I&#x2F;O 操作，而B+数除了叶子节点有数据其他没有</p><h2 id="Innodb-和-myisam-分别适用于哪些场景"><a href="#Innodb-和-myisam-分别适用于哪些场景" class="headerlink" title="Innodb 和 myisam 分别适用于哪些场景"></a>Innodb 和 myisam 分别适用于哪些场景</h2><p>innodb 是一种事务性的存储引擎，一般的业务其实都是对可靠性有要求的，所以基本上都是用 innodb</p><p>而 myisam 是一种 olap 存储引擎，适用于读多写少的场景，比如像年度总结这种，我们只用来读取的数据，我们就可以适用 myisam 作为存储引擎</p><h2 id="为什么-myisam-在只读的情况下比-innodb-快"><a href="#为什么-myisam-在只读的情况下比-innodb-快" class="headerlink" title="为什么 myisam 在只读的情况下比 innodb 快"></a>为什么 myisam 在只读的情况下比 innodb 快</h2><p>存储结构有区别，myisam 是非聚簇索引，它的索引存储的都是我们具体的记录行的地址，</p><p>而 innodb 是聚簇索引，它可能会出现回表查询，而且每次查询都需要去维护一个 mvcc 版本的情况，因此相对而言会比较慢</p><h2 id="有一亿条数据，走主键索引，-mysql-底层-IO-次数"><a href="#有一亿条数据，走主键索引，-mysql-底层-IO-次数" class="headerlink" title="有一亿条数据，走主键索引， mysql 底层 IO 次数"></a>有一亿条数据，走主键索引， mysql 底层 IO 次数</h2><p>传统来看，如果是一个二叉树存了1亿条数据，是需要花费以2为底100000000的对数，向上取也就是27，也就是说如果以二叉树存储的话，获取一个节点最小可以1一次到，最多要27次，考虑到IO操作是非常消耗性能的，所以MySQL使用了B+树</p><p>一般来说，IO扫描一次磁盘块的大小是 4KB，而非叶子节点通常占用 16Byte，所以一个磁盘块可以存256个叶子节点<br>也就是说，不会像二叉树一样只能从左右两个节点进行判断，而是会通过 256 个节点判断，并且B+树的数据是存在叶子节点上的，所以速度非常稳定，所以花费的时间是 256 为底 1000000000 的对数，向上取也就是 4</p><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="执行一条语句的整体流程"><a href="#执行一条语句的整体流程" class="headerlink" title="执行一条语句的整体流程"></a>执行一条语句的整体流程</h2><h3 id="宏观上"><a href="#宏观上" class="headerlink" title="宏观上"></a>宏观上</h3><ol><li>通过连接器和 MySQL 建立连接</li><li>通过分析器、优化器、执行器</li><li>返回执行结果</li></ol><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p><strong>连接器</strong>：管理连接，权限认证</p><p><strong>分析器</strong>：词法分析，语法分析</p><p><strong>优化器</strong>：执行计划生成，索引选择</p><p><strong>执行器</strong>：操作引擎，返回结果</p><h3 id="微观上"><a href="#微观上" class="headerlink" title="微观上"></a>微观上</h3><ol><li>客户端通过连接器权限认证后</li><li>查询缓存，命中则直接返回</li><li>通过分析器进行词法和语法的分析</li><li>优化器会根据一些成本的计算，去决定具体走哪个索引，或者连表的顺序，最终生成执行计划</li><li>执行器通过执行计划去调用存储引擎层的 API 接口</li><li>存储引擎层，它是一个可插拔的设计，不同的存储引擎会去实现一套统一的 API 接口</li></ol><p>因此可以自由的去更换我们的存储引擎，上层是无感知的</p><h2 id="redolog、undolog、binlog"><a href="#redolog、undolog、binlog" class="headerlink" title="redolog、undolog、binlog"></a>redolog、undolog、binlog</h2><p>redoLog：属于物理日志，事务中修改的任何数据，将最新的数据备份存储的位置，被称为重做日志</p><p>undoLog：数据库事务开始之前，会将要修改的记录存放到undo日志里，当事务回滚时或数据库崩溃时，可以利用undo日志撤销未提交事务对数据库产生的影响</p><p>binLog：属于innodb，binlog是属于mysql server自带功能，帮助实现数据恢复达到主从数据一致性</p><h1 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h1><h2 id="MySQL的调优看过吗？有调优经验吗？"><a href="#MySQL的调优看过吗？有调优经验吗？" class="headerlink" title="MySQL的调优看过吗？有调优经验吗？"></a>MySQL的调优看过吗？有调优经验吗？</h2><p>确保命中索引，在复合索引的条件下符合最左匹配原则<br>分页优化：先通过覆盖索引查找，再使用join连接查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> id <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> B) <br># 相当于：A <span class="hljs-operator">&gt;</span> B<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> B) &#123; <span class="hljs-operator">/</span><span class="hljs-operator">/</span>B的数据量少，所以循环次数少。<br>   <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> A.id <span class="hljs-operator">=</span> B.id<br>&#125;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> <span class="hljs-keyword">exists</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> B <span class="hljs-keyword">where</span> B.id <span class="hljs-operator">=</span> A.id)  <span class="hljs-literal">true</span> <span class="hljs-operator">/</span> <span class="hljs-literal">false</span><br># 等价于 B <span class="hljs-operator">&gt;</span> A<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A) &#123;<br>   <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> B <span class="hljs-keyword">where</span> B.id <span class="hljs-operator">=</span> A.id<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="如何发现慢SQL"><a href="#如何发现慢SQL" class="headerlink" title="如何发现慢SQL"></a>如何发现慢SQL</h2><p>万能的 explain 语句</p><h2 id="解决脏数据、可重复读、幻读的方式"><a href="#解决脏数据、可重复读、幻读的方式" class="headerlink" title="解决脏数据、可重复读、幻读的方式"></a>解决脏数据、可重复读、幻读的方式</h2><ol><li><strong>Read uncommitted（读未提交）</strong>： 在一个事务中读取到另一个事务还没有提交的数据</li><li><strong>Read committed（读已提交）</strong>: 已经解决了脏读问题，在一个事务中只会读取另一个事务已提交的数据，这种情况会出现不可重复读的问题。就是：在事务中重复读数据，数据的内容是不一样的</li><li><strong>Repeatable read（可重复读）</strong>：在一个事务中每次读取的数据都是一致的，不会出现脏读和不可重复读的问题。会出现虚读（幻读）的问题</li></ol><h2 id="怎么避免回表查询"><a href="#怎么避免回表查询" class="headerlink" title="怎么避免回表查询"></a>怎么避免回表查询</h2><p>覆盖索引，也就是 select 的数据列只用从索引中就能够取得，不必读取数据行，换句话说查询列要被所建的索引覆盖。</p><h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><h2 id="MySQL中都有哪些锁？"><a href="#MySQL中都有哪些锁？" class="headerlink" title="MySQL中都有哪些锁？"></a>MySQL中都有哪些锁？</h2><ul><li>行锁</li><li>表锁</li></ul><h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><h2 id="基本语句，如何增加列？"><a href="#基本语句，如何增加列？" class="headerlink" title="基本语句，如何增加列？"></a>基本语句，如何增加列？</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">ALTERTABLE table_name <span class="hljs-keyword">ADD</span> column_name datatype<br></code></pre></td></tr></table></figure><h2 id="查询语句的执行顺序"><a href="#查询语句的执行顺序" class="headerlink" title="查询语句的执行顺序"></a>查询语句的执行顺序</h2><ol><li>FROM table1 left join table2 on 将table1和table2中的数据产生笛卡尔积，生成Temp1</li><li>JOIN table2 所以先是确定表，再确定关联条件</li><li>ON table1.column &#x3D; table2.columu 确定表的绑定条件 由Temp1产生中间表Temp2</li><li>WHERE 对中间表Temp2产生的结果进行过滤 产生中间表Temp3</li><li>GROUP BY 对中间表Temp3进行分组，产生中间表Temp4</li><li>HAVING 对分组后的记录进行聚合 产生中间表Temp5</li><li>SELECT 对中间表Temp5进行列筛选，产生中间表 Temp6</li><li>DISTINCT 对中间表 Temp6进行去重，产生中间表 Temp7</li><li>ORDER BY 对Temp7中的数据进行排序，产生中间表Temp8</li><li>LIMIT 对中间表Temp8进行分页，产生中间表Temp9</li></ol>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>关系型数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>关系型数据库</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JUC</title>
    <link href="/2020/11/06/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/JUC/"/>
    <url>/2020/11/06/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/JUC/</url>
    
    <content type="html"><![CDATA[<h1 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h1><h2 id="synchronized的锁优化有哪些、讲一下锁状态和锁升级"><a href="#synchronized的锁优化有哪些、讲一下锁状态和锁升级" class="headerlink" title="synchronized的锁优化有哪些、讲一下锁状态和锁升级"></a>synchronized的锁优化有哪些、讲一下锁状态和锁升级</h2><ol><li><p>优化 Monitor 这类的重量级锁 （轻量级锁）<br>每个线程中的栈帧都会包含一个锁记录对象（Lock Record），<br>内部可以通过 CAS 的方式存储锁定对象的 Mark Word（从而不再一开始就使用 Monitor）</p></li><li><p>自旋优化<br>当升级到重量级锁竞争时，如果发生竞争失败不会立即进入到 EntryList 进行阻塞，<br>而是会重试一会儿再阻塞</p></li><li><p>优化轻量级锁重入（偏向锁）轻量级锁在没有竞争时，每次重入操作仍需要 CAS，为了避免性能降低，所以引入了偏向锁优化轻量级锁重入，在第一次 CAS 时会将线程的 ID 写入对象的 Mark Word 中,此后线程发现锁定对象中的 Mark Word 存在自己的线程 ID，则不会再次进行 CAS，因为这个对象就归这个线程所有</p></li></ol><hr><h2 id="voliate关键字"><a href="#voliate关键字" class="headerlink" title="voliate关键字"></a>voliate关键字</h2><p>原理：</p><p>内存屏障，Memory Barrier（Memory Fence）</p><p>对 volatile 变量的写指令后会加入写屏障（屏障之前，对贡献变量的修改都是会同步到主存中）</p><p>对 volatile 变量的读指令前会加入读屏障（屏障之后，对共享变量的读取都是主存中的新数据）</p><p>作用：</p><ol><li>确保可见性</li><li>确保有序性</li></ol><p>保持内存可见性。所有线程都能看到共享内存的最新状态。每次读取前必须先从主内存刷新最新的值。每次写入后必须立即同步回主内存当中。</p><p>禁止指令重排。提供内存屏障的方式来防止指令被重排，编译器在生成字节码文件时，会在指令序列中插入内存屏障来禁止特定类型的处理器重排序。</p><h1 id="主要类"><a href="#主要类" class="headerlink" title="主要类"></a>主要类</h1><h2 id="什么情况下用-ReentrantLock-而不用-synchronized"><a href="#什么情况下用-ReentrantLock-而不用-synchronized" class="headerlink" title="什么情况下用 ReentrantLock 而不用 synchronized"></a>什么情况下用 ReentrantLock 而不用 synchronized</h2><ol><li>阻塞时可被中断</li><li>可以设置获取锁的超时时间</li><li>可以设置为公平锁</li><li>支持多个条件变量（condition）</li></ol><h2 id="Java的中断怎么实现，为什么-synchronized-不能中断，ReentrantLock-可以中断"><a href="#Java的中断怎么实现，为什么-synchronized-不能中断，ReentrantLock-可以中断" class="headerlink" title="Java的中断怎么实现，为什么 synchronized 不能中断，ReentrantLock 可以中断"></a>Java的中断怎么实现，为什么 synchronized 不能中断，ReentrantLock 可以中断</h2><ol><li>synchronized 是在JVM层面上实现的，在字节码中会有 monitorenter、monitorexit 介入，<br>会自动释放锁定（代码执行完成或者出现异常）</li><li>ReentrantLock 是实现 lock 接口和内部类继承 AQS 实现的，是通过代码实现的</li></ol><h2 id="ReentrantLock-怎么实现的（AQS）"><a href="#ReentrantLock-怎么实现的（AQS）" class="headerlink" title="ReentrantLock 怎么实现的（AQS）"></a>ReentrantLock 怎么实现的（AQS）</h2><p>通过实现 lock 接口以及结合继承了 AQS 的内部类 Sync 实现的</p><h2 id="AQS源码看过吗-能说一下么？"><a href="#AQS源码看过吗-能说一下么？" class="headerlink" title="AQS源码看过吗?能说一下么？"></a>AQS源码看过吗?能说一下么？</h2><ol><li><p>使用 CLH 队列，实现线程阻塞等待以及被唤醒时锁分配的机制</p></li><li><p>独享模式：</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">2.1 acquire 操作：<br>    2.1.1. 查看当前是否有线程占用锁，没有则修改 state 和 exclusiveOwnerThread <br>    为当前线程，否则加入 CLH 队列<br>    2.1.2. 加入 CLH 队列的第一个线程，需要初始化头节点，并设置头节点的 waitstatus 为 -1，<br>    next 节点指向当前线程，当前线程的 pre 指向头节点<br>    2.1.3. 当有新的线程加入 CLH 队列时，会重复将 pre 指向上一个节点，上一个节点<br>    的 next 节点指向当前线程并设置上一个节点的 waitstatus 为 -1，而自己的 waitstatus <br>    设置为 0。重复此操作。<br>    2.1.4. 当加入到 CLH 队列的线程获取到锁时，会修改 state 和持有锁的线程修改为当前<br>    线程，并且将 head 移至到当前节点，pre 节点也相应会断掉，之前的 head 节点会被 GC 回收<br>2.2 release 操作：<br>    2.2.1. 检查当前线程是否和 exclusiveOwnerThread 是同一个线程<br>    2.2.2. 修改锁的状态 status ，具体什么是有锁，什么是无锁，由 AQS 的子类定义<br>    2.2.3. 唤醒队列中头节点的下一个节点的线程<br>        2.2.3.1. 将自己的 waitStatus 设为 0<br>        2.2.3.2. 唤醒线程    <br></code></pre></td></tr></table></figure></li><li><p>共享模式：</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">3.1 acquire 操作：<br>    3.1.1. 检查当前的 state，是否去持有锁。根据不同的 AQS 子类实现，来允许是否<br>    可以多个线程持有锁比如 CountDownLatch 类不允许，而 ReentrantReadWriteLock 类是允许的<br>    持有锁时只会去修改 state，而不会去修改 exclusiveOwnerThread<br>    3.1.2. 其他情况与独享模式类似<br><br>3.2 release 操作：<br>    3.2.1. 修改 state 字段<br>    3.2.2. 唤醒队列中头节点的下一个节点，如果被唤醒的节点的下一个节点也是 SHARED 模式，<br>    则一同唤醒<br></code></pre></td></tr></table></figure></li><li><p>条件队列</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">4.1 await 操作<br>     4.1.1. 创建条件节点，如果是作为第一个节点加入，则需要初始化队列，<br>     即初始化一个 head 节点，再把自己加入进去，作为 head 节点的 nextWaiter；<br>     否则直接加入，并使上一个节点的 nextWaiter 指向自己<br>     4.1.2. 释放当前线程占用的锁，执行 AQS 的 release 操作<br>     4.1.3. 挂起当前线程<br>     4.1.4. 被唤醒以后，执行 AQS 的 acquire 操作<br> 4.2 signal 操作：<br>     4.2.1. 将队列中的 firstWaiter 节点转移到同步队列中<br>     4.2.2. 把刚刚加入到同步队列中的节点的前驱的 waitStatus 设置为 -1 <br></code></pre></td></tr></table></figure></li></ol><h2 id="ThreadLocal，底层如何实现"><a href="#ThreadLocal，底层如何实现" class="headerlink" title="ThreadLocal，底层如何实现"></a>ThreadLocal，底层如何实现</h2><p>每个线程内都有一个ThreadLocalMap类型的成员变量，用来存储资源对象</p><p>ThreadLocal是JDK包提供的，它提供了线程本地变量，也就是如果你创建了一个ThreadLocal变量，<br>那么但凡有一个线程对这个变量进行 set 操作时，这个线程中的 threadLocals 属性就会被创建赋值</p><p>所以当多个线程操作这个变量时，实际操作的是自己本地内存里面的变量，从而避免了线程安全问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;            <br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<span class="hljs-comment">// 拿到当前线程</span><br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);   <span class="hljs-comment">// 拿到当前线程的 threadLocals 属性</span><br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;                <br>        map.set(<span class="hljs-built_in">this</span>, value);         <span class="hljs-comment">// 不为空进行覆盖</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;                          <br>        createMap(t, value);          <span class="hljs-comment">// 为空则创建赋值</span><br>    &#125;                                 <br>&#125;                                     <br></code></pre></td></tr></table></figure><h1 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h1><h2 id="Java并发包下的原子工具类，能说一下么？源码看过吗？"><a href="#Java并发包下的原子工具类，能说一下么？源码看过吗？" class="headerlink" title="Java并发包下的原子工具类，能说一下么？源码看过吗？"></a>Java并发包下的原子工具类，能说一下么？源码看过吗？</h2><p>AtomicBoolean</p><p>AtomicInteger</p><p>AtomicLong</p><p>AtomicReference</p><p>AtomicIntegerArray</p><p>AtomicLongArray</p><p>AtomicReferenceArray</p><p>都是以CAS方式确保原子性，但是可能会触发ABA问题</p><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="为什么使用CAS就能保证并发"><a href="#为什么使用CAS就能保证并发" class="headerlink" title="为什么使用CAS就能保证并发?"></a>为什么使用CAS就能保证并发?</h2><p>无需阻塞等待，立马执行，立马返回成功或失败</p><h2 id="ABA问题及解决办法"><a href="#ABA问题及解决办法" class="headerlink" title="ABA问题及解决办法"></a>ABA问题及解决办法</h2><ol><li>AtomicStampedReference 需要我们传入整型变量作为版本号，来判定是否被更改过<br>但是有时候，并不关心引用变量更改了几次，只是单纯的关心是否更改过，就使用：</li><li>AtomicMarkableReference 需要我们传入布尔变量作为标记，来判断是否被更改过</li></ol><h2 id="IO密集和CPU密集两种情况下，线程池里的线程数应该怎么设置"><a href="#IO密集和CPU密集两种情况下，线程池里的线程数应该怎么设置" class="headerlink" title="IO密集和CPU密集两种情况下，线程池里的线程数应该怎么设置"></a>IO密集和CPU密集两种情况下，线程池里的线程数应该怎么设置</h2><p>IO密集型的话，是指系统大部分时间在跟I&#x2F;O交互，而这个时间线程不会占用CPU来处理，即在这个时间范围内，可以由其他线程来使用CPU，因而可以多配置一些线程。</p><p>CPU密集型的话，一般配置CPU处理器个数+1个线程， n + 1<br>所谓CPU密集型就是指系统大部分时间是在做程序正常的计算任务，例如数字运算、赋值、分配内存、内存拷贝、循环、查找、排序等，这些处理都需要CPU来完成。</p><h2 id="Java中创建多线程的方式有哪些"><a href="#Java中创建多线程的方式有哪些" class="headerlink" title="Java中创建多线程的方式有哪些"></a>Java中创建多线程的方式有哪些</h2><ol><li>继承Thread，重写run方法；方便传参，但不支持多继承</li><li>使用Runnable配合Thread；解耦强，灵活</li><li>FutureTask结合Thread；可以获得放回结果</li></ol><h2 id="乐观锁和悲观锁的区别"><a href="#乐观锁和悲观锁的区别" class="headerlink" title="乐观锁和悲观锁的区别"></a>乐观锁和悲观锁的区别</h2><p>悲观锁：拿到资源时，就对资源上锁，并在提交后，才释放锁资源，其他线程才能使用资源。</p><p>乐观锁：拿到资源时，上乐观锁，在提交之前，其他的锁也可以操作这个资源，当有冲突的时候，并发机制会保留前一个提交，打回后一个提交，让后一个线程重新获取资源后，再操作，然后提交。类似于 Git</p><p>吞吐量：乐观锁 &gt; 悲观锁</p><p>适用场景：读取频繁用乐观锁，写入频繁用悲观锁</p><p>特别地，如果吞吐量大，但是乐观锁获取锁的所消耗的性能又高，这个时候就不推荐适用乐观锁了</p><h2 id="什么是死锁，怎么破坏死锁"><a href="#什么是死锁，怎么破坏死锁" class="headerlink" title="什么是死锁，怎么破坏死锁"></a>什么是死锁，怎么破坏死锁</h2><p>死锁成立的四个条件：</p><p><strong>互斥</strong>：某种资源只允许一个进程访问</p><p><strong>占有且等待</strong>：一个进程本身占有了资源（一个或多个），同时还有资源未得到满足，正在等待其他进程释放该资源</p><p><strong>不可抢占</strong>：无法抢占别人占有的资源</p><p><strong>循环等待</strong>：存在一个进程链，使得每个进程都占有下一个进程所需的至少一种资源</p><p>打破上述任何一个条件，便可让死锁消失</p><h1 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h1><h2 id="线程池有哪些参数"><a href="#线程池有哪些参数" class="headerlink" title="线程池有哪些参数"></a>线程池有哪些参数</h2><ol><li>核心线程数</li><li>最大线程数</li><li>保持存活时间</li><li>时间单位</li><li>线程工厂</li><li>阻塞队列</li><li>拒绝策略</li></ol><h2 id="执行流程是什么？"><a href="#执行流程是什么？" class="headerlink" title="执行流程是什么？"></a>执行流程是什么？</h2><p>当一个任务传给线程池以后，可能有以下几种可能</p><ol><li>将任务分配给一个核心线程来执行</li><li>核心线程都在执行任务，将任务放到阻塞队列workQueue中等待被执行</li><li>阻塞队列满了，使用救急线程来执行任务；救急线程用完以后，超过生存时间（keepAliveTime）后会被释放</li><li>任务总数大于了 最大线程数（maximumPoolSize）与阻塞队列容量的最大值（workQueue.capacity），使用拒接策略</li></ol><h2 id="拒绝策略有哪些？"><a href="#拒绝策略有哪些？" class="headerlink" title="拒绝策略有哪些？"></a>拒绝策略有哪些？</h2><ol><li>AbortPolicy（堕胎政策-默认）：直接<strong>抛出RejectedExecutionException</strong>异常阻止系统正常运行</li><li>CallerRunsPolicy （调用者运行政策）:一种调节机制，该策略<strong>既不会抛弃任务，也不会抛出异常</strong>，而是将某些任务回退到调用者，从而降低新任务的流量</li><li>DiscardOldestPolicy（丢弃老的政策）：<strong>抛弃队列中等待最久的任务</strong>，然后把当前任务加入队列中尝试再次提交当前任务</li><li>DiscardPolicy（丢弃政策）：该策略默默地<strong>丢弃无法处理的任务，无予任何处理也不抛出异常</strong>。如果允许任务丢失，这是最好的一种策略</li></ol>]]></content>
    
    
    <categories>
      
      <category>Java并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>并发编程</tag>
      
      <tag>多线程</tag>
      
      <tag>锁</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring</title>
    <link href="/2020/10/18/Spring-Project/Spring/Spring/"/>
    <url>/2020/10/18/Spring-Project/Spring/Spring/</url>
    
    <content type="html"><![CDATA[<h1 id="Bean"><a href="#Bean" class="headerlink" title="Bean"></a>Bean</h1><h2 id="bean-的生命周期"><a href="#bean-的生命周期" class="headerlink" title="bean 的生命周期"></a>bean 的生命周期</h2><ol><li>创建前准备。Bean 在开始加载之前，会去上下文配置中查找并解析 Bean 相关的扩张，比如：<br>初始化的方法 init-method 和 destroy-method<br>以及 BeanFactoryPostProcessor 这一类 Bean 加载过程中前置后置的处理</li><li>创建实例。通过反射创建出 Bean 的实例对象，并且会扫描和解析 Bean 声明的属性。<br>但是此时的 Bean 是 Spring 内部的 Bean，不对外使用</li><li>依赖注入。检查 Bean 是否依赖于其他的 Bean，如果存在则需要的这些 Bean 进行依赖注入<br>常见的注解有：@Autowired、@Qualifier、@Resource<br>特别注意：@Resource的注解是属于J2EE的，按照名称进行装配<br>与此同时会去执行 BeanPostProcessors 接口实例的 postProcessBeforeInitialization()方法</li><li>初始化。组装成能够被使用的 Bean 对象。<br>如果Bean在XML文件中配置了init-method的方法、<br>实现了InitializingBean接口或者加上了@PostConstruct，会在这个阶段被调用<br>初始化结束后会去执行实现了<br>BeanPostProcessors接口的实例的postProcessAfterInitialization()方法</li><li>容器缓存。将 Bean 保存到对应的容器以及 Spring 的缓存中，这个阶段结束，<br>Bean就可以被开发者使用了</li><li>销毁实例。当应用上下文，也就是容器被关闭时，其中所有的 Bean 都会被销毁<br>如果Bean在XML文件中配置了destroy-method的方法、<br>实现了DisposableBean接口或者加上了@PreDestroy，会在这个阶段被调用</li></ol><h2 id="如何解决循环依赖"><a href="#如何解决循环依赖" class="headerlink" title="如何解决循环依赖"></a>如何解决循环依赖</h2><p>例如有两个 Bean A 和 B，A 依赖于 B，B 也依赖 A<br>初始化 bean 的时候会去一级缓存中查找，没有则去二级，<br>再没有则会通过存放 ObjectFactory 的三级缓存中得到一个半成品 bean，并放到二级缓存</p><p>而第一次加载 A，一级缓存和二级缓存肯定都是没有的，<br>所以会去三级缓存中拿到一个半成品 A，并放到二级缓存<br>此时 A 需要注入 B，同样的，第一次加载 B 肯定一二级缓存都没有，所以也会去三级缓存中</p><p>拿到一个半成品 B，并放到二级缓存</p><p>当 B 发现也需要注入 A 时，它此时就会在二级缓存中找到 A<br>这个时候将 A 注入到 B 中，同时删除二级缓存中的 B，添加到一级缓存中</p><p>当 B 注入完成后，A 又把一级缓存中的 B 注入到自己中来，并且删除二级缓存中的 A，添加到一级缓存</p><h1 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h1><h2 id="实现自动注入的方式"><a href="#实现自动注入的方式" class="headerlink" title="实现自动注入的方式"></a>实现自动注入的方式</h2><ol><li>@Autowired 一个实现类匹配</li><li>@Qualified 多个实现类指定</li><li>@Resource J2EE的，指定一个类</li></ol><h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><h2 id="Spring-AOP-原理"><a href="#Spring-AOP-原理" class="headerlink" title="Spring AOP 原理"></a>Spring AOP 原理</h2><p>AOP，Aspect Oriented Programming，面向切面编程<br>AOP分静态AOP和动态AOP。</p><p>静态 AOP 是指 AspectJ 实现的 AOP，将切面代码直接编译到 Java 类文件中</p><p>动态 AOP 是指将切面代码进行动态织入实现的 AOP</p><p>Spring AOP使用的是动态 AOP，主要采用了 JDK 提供的动态代理技术和 CGLIB 中的动态字节码增强技术</p><ol><li><p><strong>动态代理技术：</strong><br>实现原理是通过 target 和代理类实现同一个接口，代理类持有 target 对象，<br>来达到方法拦截的作用。<br>弊端：</p><p> i. 必须保证 target 类实现接口</p><p> ii. 如果想要对 target 方法进行拦截，那么这些方法都要在接口中声明，略微限制</p></li><li><p><strong>动态字节码增强技术：</strong><br>它既可以代理实现类，也可以代理接口。<br>底层是使用了 ASM （一个通用的 Java 字节码操作和分析框架）从而动态地生成被代理的子类<br>而它的原理是通过对字节码进行 CURD 操作，从而在 target 类的基础上生成 target 子类进而达到对方法的拦截</p></li></ol><h1 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h1><h2 id="Spring-MVC-执行流程"><a href="#Spring-MVC-执行流程" class="headerlink" title="Spring MVC 执行流程"></a>Spring MVC 执行流程</h2><center><img src="/2020/10/18/Spring-Project/Spring/Spring/1.png" class=""></center><h1 id="Boot"><a href="#Boot" class="headerlink" title="Boot"></a>Boot</h1><h2 id="Spring-Boot-启动机制"><a href="#Spring-Boot-启动机制" class="headerlink" title="Spring Boot 启动机制"></a>Spring Boot 启动机制</h2><ol><li>@SpringBootConfiguration<br>它将启动类作为一个配置类加载到 Spring 容器中</li><li>@EnableAutoConfiguration &#x3D; @AutoConfigurationPackage + @Import<br>注册 spring 内部的 bean 以及插件式 bean，<br>例如 Nacos 里面的一些类就是在这一步通过 SPI注入进来</li><li>@ComponentScan<br>扫描程序员在启动类目录下的 bean</li></ol><h2 id="Spring-Boot-有哪些优点"><a href="#Spring-Boot-有哪些优点" class="headerlink" title="Spring Boot 有哪些优点"></a>Spring Boot 有哪些优点</h2><ol><li>配置变得简单，支持yml、properties进行配置</li><li>快速整合第三方框架</li><li>内嵌了servlet容器，比如Tomcat</li><li>注解化配置，避免了编写大量的样板代码，注释和XML配置</li></ol>]]></content>
    
    
    <categories>
      
      <category>Spring Project</category>
      
      <category>Spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据结构</title>
    <link href="/2020/10/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <url>/2020/10/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="线性表"><a href="#线性表" class="headerlink" title="线性表"></a>线性表</h1><h2 id="ArrayList、LinkedList和Vector的异同以及底层数据结构是"><a href="#ArrayList、LinkedList和Vector的异同以及底层数据结构是" class="headerlink" title="ArrayList、LinkedList和Vector的异同以及底层数据结构是"></a>ArrayList、LinkedList和Vector的异同以及底层数据结构是</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">1、ArrayList  底层：是数组结构，查询快，增删慢，线程不安全，效率高。<br><br>2、LinkedList底层：是链表数据结构，查询慢，增删快，线程不安全，效率高。<br><br>3、Vector      底层：是数组结构，查询快，增删慢，线程安全，效率低。<br></code></pre></td></tr></table></figure><h3 id="ArrayList如何动态扩展"><a href="#ArrayList如何动态扩展" class="headerlink" title="ArrayList如何动态扩展"></a>ArrayList如何动态扩展</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">// 初始化：<br>1. ArrayList()会使用长度为 0 的数组<br>2. ArrayList(int initialCapacity)会使用指定容量的数组<br>3. public ArrayList(Collection&lt;? extends E&gt; c)会使用 c 的大小作为数组容量<br>    <br>// 添加：<br>1. add(Object o)首次扩容为 10，再次扩容为上次容量的1.5倍<br>2. addAll(Collection c) <br>    2.1 没有元素时，扩容为Math.max(10,实际元素个数)<br>    2.2 有元素时，扩容为Math.max(原容量1.5倍,实际元素个数)<br></code></pre></td></tr></table></figure><h1 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h1><h2 id="HashMap的底层数据结构"><a href="#HashMap的底层数据结构" class="headerlink" title="HashMap的底层数据结构"></a>HashMap的底层数据结构</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">JDK1.7 数组+链表<br><br>JDK 1.8 数组+（链表/红黑树）<br></code></pre></td></tr></table></figure><h3 id="为何要用红黑树"><a href="#为何要用红黑树" class="headerlink" title="为何要用红黑树"></a>为何要用红黑树</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">1. 数值较大时，使用红黑树可以优化查询性能<br>2. 可以避免DoS攻击，防止有人恶意使用多个hashcode一样的值注入攻击，避免链表超长性能下降<br></code></pre></td></tr></table></figure><h3 id="为何一上来不树化"><a href="#为何一上来不树化" class="headerlink" title="为何一上来不树化"></a>为何一上来不树化</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">数值较小时，链表的查询性能、内存占用较优于红黑树，所以不需要一上就树化<br>查找更新的时间复杂度是O(log&lt;sub&gt;2&lt;/sub&gt;n)<br>TreeNode占用空间也比普通Node要大<br>如非必要尽量使用链表<br></code></pre></td></tr></table></figure><h3 id="树化阈值为何是8"><a href="#树化阈值为何是8" class="headerlink" title="树化阈值为何是8"></a>树化阈值为何是8</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">hash表内按泊松分布，在负载因子是0.75的情况下，长度超过8的链表出现概率是0.00000006，选择8是为了让树化几率足够小<br></code></pre></td></tr></table></figure><h3 id="何时会树化"><a href="#何时会树化" class="headerlink" title="何时会树化"></a>何时会树化</h3><blockquote><p>链表长度超过树化阈值8；数组容量&gt;&#x3D;64</p></blockquote><h3 id="何时会退化为链表"><a href="#何时会退化为链表" class="headerlink" title="何时会退化为链表"></a>何时会退化为链表</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">情况1：在扩容时如果树被拆分了，且树的元素个数&lt;=6则会退化成链表<br>情况2：remove树节点时，若移除节点之前root、root.left、root.right、root.left.left有一个为null时，也会退化成链表<br></code></pre></td></tr></table></figure><h3 id="索引如何计算"><a href="#索引如何计算" class="headerlink" title="索引如何计算"></a>索引如何计算</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">计算对象的hashCode()，再进行HashMap的hash()方法进行二次哈希，最后hash 求模% 或 &amp;(capacity - 1) 得到索引<br></code></pre></td></tr></table></figure><h3 id="为什么要二次哈希"><a href="#为什么要二次哈希" class="headerlink" title="为什么要二次哈希"></a>为什么要二次哈希</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">二次哈希是为了综合高位数据，让哈希分布更为均匀<br></code></pre></td></tr></table></figure><h3 id="数组容量为何是2的n次幂"><a href="#数组容量为何是2的n次幂" class="headerlink" title="数组容量为何是2的n次幂"></a>数组容量为何是2的n次幂</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>. 计算索引时，<span class="hljs-number">2</span>的n次幂可以使用位与运算取代取模，效率更高<br><span class="hljs-attribute">2</span>. 扩容时可以根据hash &amp; oldCap == <span class="hljs-number">0</span> 来判断元素是否留在原来位置，否则 新位置 = 旧位置 + oldCap<br><span class="hljs-attribute">3</span>. 是为了配合索引计算、二次哈希的优化手段，例如HashTable的容量就不是<span class="hljs-number">2</span>的n次幂，并不能说那种设计更优，应该是设计者综合了各种因素，最终选择了使用<span class="hljs-number">2</span>的n次幂作为容量<br></code></pre></td></tr></table></figure><h3 id="HashTable与HashMap的区别"><a href="#HashTable与HashMap的区别" class="headerlink" title="HashTable与HashMap的区别"></a>HashTable与HashMap的区别</h3><table><thead><tr><th align="center">HashMap</th><th align="center">线程不安全</th><th align="center">允许有null的键和值</th><th align="center">效率高一点</th><th align="center">方法不是Synchronize的</th><th align="center">有containsValue和containsKey方法</th></tr></thead><tbody><tr><td align="center">HashTable</td><td align="center">线程安全</td><td align="center">不允许有null的键和值</td><td align="center">效率稍低</td><td align="center">方法是Synchronize的</td><td align="center">有contains方法方法</td></tr></tbody></table><h3 id="HashMap的扩容机制"><a href="#HashMap的扩容机制" class="headerlink" title="HashMap的扩容机制"></a>HashMap的扩容机制</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>. HashMap的容量是有上限的，必须小于 <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>，也就是<span class="hljs-number">2</span>的<span class="hljs-number">30</span>次幂 = <span class="hljs-number">1073741824</span><br><span class="hljs-attribute">2</span>. 空参数的构造函数：实例化的HashMap默认内部数组是null，即没有实例化。第一次调用put方法时，则会开始第一次初始化扩容，长度是<span class="hljs-number">16</span><br><span class="hljs-attribute">3</span>. 有参构造函数：用于指定容量。会根据指定的正整数找到不小于指定容量的<span class="hljs-number">2</span>的幂数，将这个数设置赋值给阈值（threshold）。第一次调用put方法时，会将阈值赋值给容量。<br><span class="hljs-attribute">4</span>. 如果不是第一次扩容，则容量变为原来的<span class="hljs-number">2</span>倍，阈值也变为原来的<span class="hljs-number">2</span>倍。（容量和阈值都变为原来的<span class="hljs-number">2</span>倍时，负载因子还是不变）<br></code></pre></td></tr></table></figure><h3 id="HashMap是不是线程安全的"><a href="#HashMap是不是线程安全的" class="headerlink" title="HashMap是不是线程安全的"></a>HashMap是不是线程安全的</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">不是，会发生数据错乱<br>并发情况下使用ConcurrentHashMap<br></code></pre></td></tr></table></figure><h3 id="HashMap的put元素的过程"><a href="#HashMap的put元素的过程" class="headerlink" title="HashMap的put元素的过程"></a>HashMap的put元素的过程</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>. HashMap是懒惰创建数组的，首次使用才创建数组<br><span class="hljs-attribute">2</span>. 计算索引（桶下标）<br><span class="hljs-attribute">3</span>. 如果桶下标没有被占用，创建Node占位返回<br><span class="hljs-attribute">4</span>. 如果桶下标已经被占用<br><span class="hljs-attribute">4</span>.<span class="hljs-number">1</span> 如果节点是TreeNode走红黑树的添加或更新逻辑<br><span class="hljs-attribute">4</span>.<span class="hljs-number">2</span> 如果节点是Node，走链表的添加或更新逻辑<br><span class="hljs-attribute">4</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span> 如果添加时超过树化阈值且容量大于<span class="hljs-number">64</span>，走树化逻辑<br><span class="hljs-attribute">5</span>. 返回容量是否超过阈值，一旦超过就进行扩容<br><span class="hljs-attribute">5</span>.<span class="hljs-number">1</span> 如果进行扩容，要对旧元素重新计算索引<br></code></pre></td></tr></table></figure><h3 id="为什么加载因子是0-75"><a href="#为什么加载因子是0-75" class="headerlink" title="为什么加载因子是0.75"></a>为什么加载因子是0.75</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 在空间占用与查询时间之间取得较好的权衡<br><span class="hljs-bullet">2.</span> 大于这个值，空间节省了，但链表会比较长，影响性能<br><span class="hljs-bullet">3.</span> 小于这个字，冲突减少了，但扩容会比较频繁，空间占用多<br></code></pre></td></tr></table></figure><h3 id="Node的数据结构"><a href="#Node的数据结构" class="headerlink" title="Node的数据结构"></a>Node的数据结构</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-comment">// 链表节点结构</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> Map.Entry&lt;K,V&gt; &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> hash;<br>        <span class="hljs-keyword">final</span> K key;<br>        V value;<br>        Node&lt;K,V&gt; <span class="hljs-keyword">next</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="寻址算法"><a href="#寻址算法" class="headerlink" title="寻址算法"></a>寻址算法</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-comment">// 将高16位和低16位进行了异或运算</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span>(<span class="hljs-built_in">Object</span> <span class="hljs-built_in">key</span>)&#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-title function_">return</span> (<span class="hljs-built_in">key</span> == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = <span class="hljs-built_in">key</span>.<span class="hljs-property">hashColde</span>()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="树"><a href="#树" class="headerlink" title="树"></a>树</h1><h2 id="红黑树的数据结构，左旋和右旋是怎样实现的"><a href="#红黑树的数据结构，左旋和右旋是怎样实现的" class="headerlink" title="红黑树的数据结构，左旋和右旋是怎样实现的"></a>红黑树的数据结构，左旋和右旋是怎样实现的</h2><ul><li>所有节点非红即黑</li><li>根节点是黑色</li><li>叶子节点是黑色</li><li>不能有连续的红色</li><li>任意节点到叶子节点路径中有相同数量的黑色节点</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">左旋：当前父结点是红色，叔叔是黑色的时候，且当前的结点是右子树。左旋以父节点作为左旋<br><br>右旋：当前父结点是红色，叔叔是黑色的时候，且当前的结点是左子树。右旋<br></code></pre></td></tr></table></figure><h2 id="什么是Huffman树"><a href="#什么是Huffman树" class="headerlink" title="什么是Huffman树"></a>什么是Huffman树</h2><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">给定<span class="hljs-built_in">N</span>个权值作为<span class="hljs-built_in">N</span>个叶子结点，构造一棵二叉树，若该树的带权路径长度达到最小，称这样的二叉树为最优二叉树，也称为哈夫曼树(Huffman Tree)。哈夫曼树是带权路径长度最短的树，权值较大的结点离根较近。<br></code></pre></td></tr></table></figure><h2 id="Huffman树的用途"><a href="#Huffman树的用途" class="headerlink" title="Huffman树的用途"></a>Huffman树的用途</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">哈夫曼编码<br></code></pre></td></tr></table></figure><h2 id="Huffman树什么情况下压缩效率高"><a href="#Huffman树什么情况下压缩效率高" class="headerlink" title="Huffman树什么情况下压缩效率高"></a>Huffman树什么情况下压缩效率高</h2><h2 id="B树和B-树"><a href="#B树和B-树" class="headerlink" title="B树和B+树"></a>B树和B+树</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">B</span>树也称为<span class="hljs-selector-tag">B</span>-树<br><br><span class="hljs-selector-tag">B</span>+树是<span class="hljs-selector-tag">B</span>-树的一种变体<br><br><span class="hljs-selector-tag">B</span>+树把数据存放在叶子节点上，并有序排列，这样做刚好适用于范围查询<br><span class="hljs-selector-tag">B</span>+树最终会呈现出一个矮胖地形式，<span class="hljs-selector-tag">B</span>-树则是高瘦<br></code></pre></td></tr></table></figure><h2 id="对TreeMap的理解"><a href="#对TreeMap的理解" class="headerlink" title="对TreeMap的理解"></a>对TreeMap的理解</h2><h2 id="TreeMap的底层数据结构"><a href="#TreeMap的底层数据结构" class="headerlink" title="TreeMap的底层数据结构"></a>TreeMap的底层数据结构</h2><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">TreeMap</span>基于红黑树（<span class="hljs-built_in">Red</span><span class="hljs-operator">-</span><span class="hljs-built_in">Black</span> <span class="hljs-variable">tree</span>）实现。该映射根据其键的自然顺序进行排序，或者根据创建映射时提供的 <span class="hljs-variable">Comparator</span> 进行排序，具体取决于使用的构造方法。<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>数据结构与算法</category>
      
      <category>数据结构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机基础</tag>
      
      <tag>数据结构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>操作系统概述</title>
    <link href="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/"/>
    <url>/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/1.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/2.png" class=""></div> <h1 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h1><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/3.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/4.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/5.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/6.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/7.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/8.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/9.png" class=""></div> <div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/10.png" class=""></div> <h1 id="运行机制"><a href="#运行机制" class="headerlink" title="运行机制"></a>运行机制</h1><h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><p>就是<strong>处理器（CPU）</strong>能识别、执行的最基本命令</p><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/11.png" class=""></div> <h2 id="处理器状态"><a href="#处理器状态" class="headerlink" title="处理器状态"></a>处理器状态</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/12.png" class=""></div> <h2 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/13.png" class=""></div> <h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/14.png" class=""></div> 操作系统中的哪些功能应该由内核程序实现呢？<h1 id="体系结构"><a href="#体系结构" class="headerlink" title="体系结构"></a>体系结构</h1><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/15.png" class=""></div> <h2 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/16.png" class=""></div><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/17.png" class=""></div><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/18.png" class=""></div><h1 id="中断和异常"><a href="#中断和异常" class="headerlink" title="中断和异常"></a>中断和异常</h1><h2 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/19.png" class=""></div><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/20.png" class=""></div><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/21.png" class=""></div><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/22.png" class=""></div><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/23.png" class=""></div><h1 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h1><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/24.png" class=""></div><h2 id="与库函数的区别"><a href="#与库函数的区别" class="headerlink" title="与库函数的区别"></a>与库函数的区别</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/25.png" class=""></div><h2 id="调用细节"><a href="#调用细节" class="headerlink" title="调用细节"></a>调用细节</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/26.png" class=""></div> <h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><div align=center>    <img src="/2020/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/27.png" class=""></div> ]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>操作系统</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机基础</tag>
      
      <tag>操作系统</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>快速排序</title>
    <link href="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/"/>
    <url>/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<blockquote><p>主要参考<a href="https://leetcode.cn/u/liweiwei1419/">liweiwei1419</a>的<a href="https://leetcode.cn/problems/kth-largest-element-in-an-array/solution/partitionfen-er-zhi-zhi-you-xian-dui-lie-java-dai-/">题解</a>以及下方评论</p><p>关于快速排序的总结也是参考<a href="https://space.bilibili.com/236935093">liweiwei1419</a>的<a href="https://www.bilibili.com/video/BV1fS4y1a7zF/?spm_id_from=333.999.0.0&vd_source=6e718059dd9214836c56510c968c9987">《算法不好玩》专题六：快速排序</a></p></blockquote><p><strong>下面有一段无关标题的废话要说，不想看直接点击跳过</strong></p><h3 id="1-摘要"><a href="#1-摘要" class="headerlink" title="1 摘要"></a>1 摘要</h3><p>前天写完<a href="https://huajframe.github.io/2020/12/24/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/">十个经典排序</a>的博客后就寻思找几个题试试手，结果找到了力扣的<a href="https://leetcode-cn.com/problems/kth-largest-element-in-an-array/description/">215. Kth Largest Element in an Array (Medium)</a>，结果证明自己还是太年轻，不过经过努力奋斗，对优先队列，堆排序，选择排序的有了更深一步的认识。</p><h4 id="1-1-优先队列是没啥好说的，主要使用到Java的PriorityQueue（小顶堆）-出队，入队已经封装好了、调整堆的过程已经省去，只要调用就行；贴一个题解"><a href="#1-1-优先队列是没啥好说的，主要使用到Java的PriorityQueue（小顶堆）-出队，入队已经封装好了、调整堆的过程已经省去，只要调用就行；贴一个题解" class="headerlink" title="1.1 优先队列是没啥好说的，主要使用到Java的PriorityQueue（小顶堆）,出队，入队已经封装好了、调整堆的过程已经省去，只要调用就行；贴一个题解:"></a>1.1 优先队列是没啥好说的，主要使用到Java的<code>PriorityQueue</code>（小顶堆）,出队，入队已经封装好了、调整堆的过程已经省去，只要调用就行；贴一个题解:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findKthLargest</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> k)</span> &#123;<br>    <span class="hljs-comment">// 小顶堆</span><br>    PriorityQueue&lt;Integer&gt; pq = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(); <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : nums) &#123;<br>        pq.add(val);<br>        <span class="hljs-comment">// 维护堆的大小为 K</span><br>        <span class="hljs-keyword">if</span> (pq.size() &gt; k)  <br>            pq.poll();<br>    &#125;<br>    <span class="hljs-keyword">return</span> pq.peek();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-2再就是基于堆排序，不了解堆排序的可以参考堆排序-Heap-Sort-，主要是建堆、调整堆，也贴一个题解："><a href="#1-2再就是基于堆排序，不了解堆排序的可以参考堆排序-Heap-Sort-，主要是建堆、调整堆，也贴一个题解：" class="headerlink" title="1.2再就是基于堆排序，不了解堆排序的可以参考堆排序(Heap Sort)，主要是建堆、调整堆，也贴一个题解："></a>1.2再就是基于堆排序，不了解堆排序的可以参考<a href="https://huajframe.github.io/2020/12/24/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/#2-7-%E5%A0%86%E6%8E%92%E5%BA%8F-Heap-Sort">堆排序(Heap Sort)</a>，主要是建堆、调整堆，也贴一个题解：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findKthLargest</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> k)</span> &#123;<br>    <span class="hljs-comment">//创建大根堆</span><br>    buildMaxHeap(nums);<br>    <span class="hljs-comment">//开始排序，这里只需要排 k - 1次序，就可以保证堆顶的数第K大</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; k; i++)&#123;<br>        <span class="hljs-comment">//交换堆顶和堆尾</span><br>        swap(nums, <span class="hljs-number">0</span>, nums.length - i);<br>        <span class="hljs-comment">//调整堆，保持大根堆的状态</span><br>        adjustHeap(nums, <span class="hljs-number">0</span>, nums.length - i);<br>    &#125;<br>    <span class="hljs-comment">//返回堆顶元素</span><br>    <span class="hljs-keyword">return</span> nums[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildMaxHeap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> nums.length / <span class="hljs-number">2</span> - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &gt;= <span class="hljs-number">0</span>; --i)&#123;<br>        adjustHeap(nums, i, nums.length);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">adjustHeap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> parent, <span class="hljs-type">int</span> high)</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> parent * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> parent * <span class="hljs-number">2</span> + <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">largest</span> <span class="hljs-operator">=</span> parent;<br>    <span class="hljs-comment">//找出左右孩子中的最大值，与根节点交换</span><br>    <span class="hljs-keyword">if</span>(right &lt; high &amp;&amp; nums[largest] &lt; nums[right])&#123;<br>        largest = right;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(left &lt; high &amp;&amp; nums[largest] &lt; nums[left])&#123;<br>        largest = left;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(largest != parent)&#123;<br>        swap(nums, parent, largest);<br>        <span class="hljs-comment">//如果左右孩子与根节点交换成功，以左右孩子为根节点的数就要进行调整</span><br>        adjustHeap(nums, largest, high);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> index1, <span class="hljs-type">int</span> index2)</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> nums[index1];<br>    nums[index1] = nums[index2];<br>    nums[index2] = temp;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-3-快速选择"><a href="#1-3-快速选择" class="headerlink" title="1.3 快速选择"></a>1.3 快速选择</h4><p>节省点篇幅，主要是讲快速排序而不是快速选择的[狗头]，看题解吧<br><a href="https://leetcode.cn/problems/kth-largest-element-in-an-array/solution/partitionfen-er-zhi-zhi-you-xian-dui-lie-java-dai-/">https://leetcode.cn/problems/kth-largest-element-in-an-array/solution/partitionfen-er-zhi-zhi-you-xian-dui-lie-java-dai-/</a></p><h3 id="2-快速排序"><a href="#2-快速排序" class="headerlink" title="2 快速排序"></a>2 快速排序</h3><p>以力扣<a href="https://leetcode.cn/problems/sort-an-array/">912. 排序数组</a>作为性能评判标准</p><h4 id="2-1-单方向遍历快排"><a href="#2-1-单方向遍历快排" class="headerlink" title="2.1 单方向遍历快排"></a>2.1 单方向遍历快排</h4><p>详情可见<a href="http://localhost:4000/2020/12/24/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/#2-6-%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F-Quick-Sort">2.6 快速排序(Quick Sort)</a></p><p>代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sortArray(<span class="hljs-type">int</span>[] nums) &#123;<br>        quickSort(nums, <span class="hljs-number">0</span>, nums.length - <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> nums;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)</span>&#123;<br>        <span class="hljs-keyword">if</span>(left &lt; right)&#123;<br>            <span class="hljs-comment">//划分</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">pivotIndex</span> <span class="hljs-operator">=</span> partition(nums, left, right);<br>            quickSort(nums, left, pivotIndex - <span class="hljs-number">1</span>);<br>            quickSort(nums, pivotIndex + <span class="hljs-number">1</span>, right);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)</span>&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> nums[left];<br>        <span class="hljs-comment">//记录比基准值大的数的指针</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>; i &lt;= right; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] &lt; pivot)&#123;<br>                swap(nums, i, index);<br>                index++;<br>            &#125; <br>        &#125;<br>        swap(nums, left, --index);<br>        <span class="hljs-keyword">return</span> index;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>        arr[i] = arr[j];<br>        arr[j] = temp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>效率，很不幸，超时</p><center><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E5%8D%95%E5%90%91%E5%BF%AB%E6%8E%92.png" class=""></center><p>超时要向出改进方法，快速排序要求数组的顺序越随机越好</p><ul><li>问题：对于顺序数组或者逆序数组来说，递归树高度增加、递归树倾斜；</li><li>再提出解决方案：破坏顺序性，随机选择 pivot。</li></ul><p>快速排序对于有序的数组并没有那么友好</p><center><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E9%9A%8F%E6%9C%BA%E5%88%92%E5%88%86.jpg" class=""></center><p>避免这种最坏的情况出现，我们在切分 partition 之前，只需要在待排序的区间里，随机选择一个元素交换到数组的第 1 个位置就可以了，这样，最坏的情况出现的概率就极其低了。</p><p>针对特殊测试用例（顺序数组或者逆序数组）一定要随机化选择切分元素（<code>pivot</code>），否则在输入数组是有序数组或者是逆序数组的时候，快速排序会变得非常慢（等同于冒泡排序或者「选择排序」）。</p><p><strong>优化：随机选择标定点元素，降低递归树结构不平衡的情况</strong></p><p>由于快速排序在近乎有序的时候会非常差，此时递归树的深度会增加。此时快速排序的算法就退化为 &#96;O(N^2)。</p><p>解决办法：我们在每一次迭代开始之前，随机选取一个元素作为基准元素与第 1 个元素交换即可。</p><p>改进后代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">RANDOM</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sortArray(<span class="hljs-type">int</span>[] nums) &#123;<br>        quickSort(nums, <span class="hljs-number">0</span>, nums.length - <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> nums;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)</span>&#123;<br>        <span class="hljs-keyword">if</span>(left &lt; right)&#123;<br>            <span class="hljs-comment">//划分</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">pivotIndex</span> <span class="hljs-operator">=</span> partition(nums, left, right);<br>            quickSort(nums, left, pivotIndex - <span class="hljs-number">1</span>);<br>            quickSort(nums, pivotIndex + <span class="hljs-number">1</span>, right);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)</span>&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">randomIndex</span> <span class="hljs-operator">=</span> RANDOM.nextInt(right - left + <span class="hljs-number">1</span>) + left;<br>        swap(nums, left, randomIndex);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> nums[left];<br>        <span class="hljs-comment">//记录比基准值大的数的指针</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>; i &lt;= right; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] &lt; pivot)&#123;<br>                swap(nums, i, index);<br>                index++;<br>            &#125; <br>        &#125;<br>        swap(nums, left, --index);<br>        <span class="hljs-keyword">return</span> index;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>        arr[i] = arr[j];<br>        arr[j] = temp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>性能：</p><center><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E9%9A%8F%E6%9C%BA%E5%88%92%E5%88%86%E5%8D%95%E5%90%91%E5%BF%AB%E6%8E%92.png" class=""></center><h4 id="2-2-双路快排"><a href="#2-2-双路快排" class="headerlink" title="2.2 双路快排"></a>2.2 双路快排</h4><p>当数组中有很多值相同元素的时候，此时随机选择一个元素来与首位值来交换，这样很容易选到和首位相同的数，这样的交换是没有意义的</p><p>解决办法：</p><blockquote><p>双路快排：把和pivot相等的值<strong>平均</strong>分配到数组两侧</p><p>三路快排：把和pivot相等的值放在数组中间</p></blockquote><p>这里讲解双路快排</p><p>参考代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">RANDOM</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sortArray(<span class="hljs-type">int</span>[] nums) &#123;<br>        quickSort(nums, <span class="hljs-number">0</span>, nums.length - <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> nums;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)</span>&#123;<br>        <span class="hljs-keyword">if</span>(left &lt; right)&#123;<br>            <span class="hljs-comment">//划分</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">pivotIndex</span> <span class="hljs-operator">=</span> partition(nums, left, right);<br>            quickSort(nums, left, pivotIndex - <span class="hljs-number">1</span>);<br>            quickSort(nums, pivotIndex + <span class="hljs-number">1</span>, right);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)</span>&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">randomIndex</span> <span class="hljs-operator">=</span> RANDOM.nextInt(right - left + <span class="hljs-number">1</span>) + left;<br>        swap(nums, left, randomIndex);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> nums[left];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">low</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>, high = right;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-keyword">while</span>(low &lt;= high &amp;&amp; nums[low] &lt; pivot)&#123;<br>                ++low;<br>            &#125;<br>            <span class="hljs-keyword">while</span>(low &lt;= high &amp;&amp; nums[high] &gt; pivot)&#123;<br>                --high;<br>            &#125;<br>            <span class="hljs-keyword">if</span>(low &gt;= high)&#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            swap(nums, low, high);<br>            ++low;<br>            --high;<br>        &#125;<br>        swap(nums, left, high);<br>        <span class="hljs-keyword">return</span> high;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>        arr[i] = arr[j];<br>        arr[j] = temp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>性能分析：快了不只一个档次</p><center><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E5%8F%8C%E8%B7%AF%E5%BF%AB%E6%8E%92%E6%80%A7%E8%83%BD.png" class=""></center><h4 id="2-3-三路快排"><a href="#2-3-三路快排" class="headerlink" title="2.3 三路快排"></a>2.3 三路快排</h4><p>三路快排就是将等于<code>pivot</code>的数字都放在数组中间，这样就只需要对大于和小于<code>pivot</code>值进行递归排序了，如果当划分值等于大量重复的值的时候，可以大大减少排序区间</p><p>weiwei哥的视频讲的更加详细，截了几张图，帮助自己加深印象</p><center><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E4%B8%89%E8%B7%AF%E5%BF%AB%E6%8E%92%E4%B8%89%E7%A7%8D%E6%83%85%E5%86%B5.png" class=""><br><br><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E4%B8%89%E8%B7%AF%E5%BF%AB%E6%8E%92%E5%8C%BA%E9%97%B4.png" class=""><br><br><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E4%B8%89%E8%B7%AF%E5%BF%AB%E6%8E%92%E5%8E%9F%E7%90%86.png" class=""></center><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">RANDOM</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sortArray(<span class="hljs-type">int</span>[] nums) &#123;<br>        quickSort(nums, <span class="hljs-number">0</span>, nums.length - <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> nums;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)</span>&#123;<br>        <span class="hljs-keyword">if</span>(left &lt; right)&#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">randomIndex</span> <span class="hljs-operator">=</span> RANDOM.nextInt(right - left + <span class="hljs-number">1</span>) + left;<br>            swap(nums, left, randomIndex);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> nums[left];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">low</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>, high = right;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span>(i &lt;= high)&#123;<br>                <span class="hljs-keyword">if</span>(nums[i] &lt; pivot)&#123;<br>                    swap(nums, i, low);<br>                    ++i;<br>                    ++low;<br>                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(nums[i] == pivot)&#123;<br>                    ++i;<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    swap(nums, i, high);<br>                    --high;<br>                    <span class="hljs-comment">//此时交换的的数可能比pivot, 不需要i++</span><br>                &#125;  <br>            &#125;<br>            <span class="hljs-comment">//low此时刚好位于比第一个等于pivot的位置，</span><br>            <span class="hljs-comment">//前一个位置才小于pivot</span><br>            swap(nums, left, low - <span class="hljs-number">1</span>);<br>            <span class="hljs-comment">//交换后要low的前面两个位置才会小于pivot</span><br>            <span class="hljs-comment">//递归排序小于pivot的数组</span><br>            quickSort(nums, left, low - <span class="hljs-number">2</span>);<br>            <span class="hljs-comment">//此时high位于等于pivot的最后一个位置</span><br>            <span class="hljs-comment">//high+1到right为大于pivot的位置</span><br>            quickSort(nums, high + <span class="hljs-number">1</span>, right);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>        arr[i] = arr[j];<br>        arr[j] = temp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>性能分析：和二路快排差不多，慢了一点，可能是没有很多重复值的测试用例</p><center><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E4%B8%89%E8%B7%AF%E5%BF%AB%E6%8E%92%E6%95%88%E7%8E%87.png" class=""></center><h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h3><p>一般情况只需要掌握二路快排就够了，但是三路快排的思想要掌握，且在一些特殊情况很有用，如很多重复值的数组排序，贴一张截图，完成快速排序学习！！！</p><center><img src="/2020/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/%E6%80%BB%E7%BB%931.png" class=""></center>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>数据结构与算法</category>
      
      <category>算法</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机基础</tag>
      
      <tag>算法</tag>
      
      <tag>排序</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>排序</title>
    <link href="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/"/>
    <url>/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本文转自 <a href="http://www.guoyaohua.com/sorting.html">十大经典排序算法最强总结（含Java、Python码实现）</a> </p><p>代码自己理解实现，掌握算法</p><p>学艺不精，如果有错误请在关于页通过QQ或邮箱联系我</p></blockquote><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1 简介"></a>1 简介</h3><p>排序算法可以分为：</p><ul><li>内部排序 ：数据记录在内存中进行排序。</li><li><a href="https://baike.baidu.com/item/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/10595890?fr=aladdin">外部排序</a> ：因排序的数据很大，一次不能容纳全部的排序记录，在排序过程中需要访问外存。</li></ul><p>常见的内部排序算法有：插入排序、希尔排序、选择排序、冒泡排序、归并排序、快速排序、堆排序、基数排序等，本文只讲解内部排序算法。用一张图概括：</p><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/sort1.png" class="" title="各种排序比较"></center><p><strong>图片名词解释</strong>：</p><ul><li><code>n</code>：数据规模</li><li><code>k</code>：“桶”的个数</li><li><code>In-place</code>：占用常数内存，不占用额外内存</li><li><code>Out-place</code>：占用额外内存</li></ul><p><strong>术语说明</strong></p><ul><li>稳定：如果A原本在B前面，而A&#x3D;B，排序之后A仍然在B的前面。</li><li>不稳定：如果A原本在B的前面，而A&#x3D;B，排序之后A可能会出现在B的后面。</li><li>内排序：所有排序操作都在内存中完成。</li><li>外排序：由于数据太大，因此把数据放在磁盘中，而排序通过磁盘和内存的数据传输才能进行。</li><li>时间复杂度： 定性描述一个算法执行所耗费的时间。</li><li>空间复杂度：定性描述一个算法执行所需内存的大小。</li></ul><h4 id="1-1-算法分类"><a href="#1-1-算法分类" class="headerlink" title="1.1 算法分类"></a>1.1 算法分类</h4><p>十种常见排序算法可以分类两大类别：<strong>比较类排序</strong>和<strong>非比较类排序</strong>。</p><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/sort2.png" class="" title="排序分类"></center><p>常见的快<strong>速排序</strong>、<strong>归并排序</strong>、<strong>堆排序</strong>以及<strong>冒泡排序</strong>等都属于<strong>比较类排序算法</strong>。<strong>比较类排序</strong>是通过比较来决定元素间的相对次序，由于其时间复杂度不能突破<code> O(nlogn)</code>，因此也称为<strong>非线性时间比较类排序</strong>。在<strong>冒泡排序</strong>之类的排序中，问题规模为 <code>n</code>，又因为需要比较 <code>n </code>次，所以平均时间复杂度为 <code>O(n²)</code>。在<strong>归并排序</strong>、<strong>快速排序</strong>之类的排序中，问题规模通过分治法消减为 <code>logn </code>次，所以时间复杂度平均 <code>O(nlogn)</code>。</p><p><strong>比较类排序</strong>的<strong>优势</strong>是，适用于各种规模的数据，也不在乎数据的分布，都能进行排序。可以说，比较排序适用于一切需要排序的情况。</p><p>而<strong>计数排序</strong>、<strong>基数排序</strong>、<strong>桶排序</strong>则属于<strong>非比较类排序算法</strong>。<strong>非比较排序</strong>不通过比较来决定元素间的相对次序，而是通过确定每个元素之前，应该有多少个元素来排序。<br>由于它可以突破基于比较排序的时间下界，以线性时间运行，因此称为<strong>线性时间非比较类排序</strong>。 非比较排序只要确定每个元素之前的已有的元素个数即可，所有一次遍历即可解决。算法时间复杂度 <code>O(n)</code>。</p><p>非比较排序时间复杂度底，但由于非比较排序需要占用空间来确定唯一位置。所以对数据规模和数据分布有一定的要求。</p><h2 id="2-排序算法"><a href="#2-排序算法" class="headerlink" title="2 排序算法"></a>2 排序算法</h2><h3 id="2-1-冒泡排序-Bubble-Sort"><a href="#2-1-冒泡排序-Bubble-Sort" class="headerlink" title="2.1 冒泡排序(Bubble Sort)"></a>2.1 冒泡排序(Bubble Sort)</h3><p>冒泡排序是一种简单的排序算法。它重复地遍历要排序的序列，依次比较两个元素，如果它们的顺序错误就把它们交换过来。遍历序列的工作是重复地进行直到没有再需要交换为止，此时说明该序列已经排序完成。这个算法的名字由来是因为越小的元素会经由交换慢慢“浮”到数列的顶端。</p><h4 id="2-1-1-算法步骤"><a href="#2-1-1-算法步骤" class="headerlink" title="2.1.1 算法步骤"></a>2.1.1 算法步骤</h4><ol><li>比较相邻的元素。如果第一个比第二个大，就交换它们两个；</li><li>对每一对相邻元素作同样的工作，从开始第一对到结尾的最后一对，这样在最后的元素应该会是最大的数；</li><li>针对所有的元素重复以上的步骤，除了最后一个；</li><li>重复步骤1~3，直到排序完成。</li></ol><h4 id="2-1-2-图解算法"><a href="#2-1-2-图解算法" class="headerlink" title="2.1.2 图解算法"></a>2.1.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/bubble_sort.gif" class="" title="冒泡排序"></center><h4 id="2-1-3-代码实现"><a href="#2-1-3-代码实现" class="headerlink" title="2.1.3 代码实现"></a>2.1.3 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 冒泡排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 需要排序的数组</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bubbleSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span>&#123;<br>    <span class="hljs-type">boolean</span> flag;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length; i++)&#123;<br>        <span class="hljs-comment">// 用来判断此次循环是否发生数据交换</span><br>        flag = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; arr.length - i - <span class="hljs-number">1</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(arr[j] &gt; arr[j + <span class="hljs-number">1</span>])&#123;<br>                <span class="hljs-comment">// 交换顺序</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[j + <span class="hljs-number">1</span>];<br>                arr[j + <span class="hljs-number">1</span>] = arr[j];<br>                arr[j] = temp;<br>                <span class="hljs-comment">// 发生交换后置为false</span><br>                flag = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (flag)&#123;<br>            <span class="hljs-comment">// 没有发生交换则终止循环</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>此处对代码做了一个小优化，加入了<code>flag</code>，目的是将算法的最佳时间复杂度优化为<code>O(n)</code>，即当原输入序列就是排序好的情况下，该算法的时间复杂度就是<code>O(n)</code></p><h4 id="2-1-4-冒泡排序算法分析"><a href="#2-1-4-冒泡排序算法分析" class="headerlink" title="2.1.4 冒泡排序算法分析"></a>2.1.4 冒泡排序算法分析</h4><ul><li>稳定性：稳定</li><li>时间复杂度 ：最佳：<code>O(n)</code> ，最差：<code>O(n2)</code>， 平均：<code>O(n2)</code></li><li>空间复杂度 ：<code>O(1)</code></li><li>排序方式 ：<code>In-place</code></li></ul><h3 id="2-2-选择排序-Selection-Sort"><a href="#2-2-选择排序-Selection-Sort" class="headerlink" title="2.2 选择排序(Selection Sort)"></a>2.2 选择排序(Selection Sort)</h3><p>选择排序是一种简单直观的排序算法，无论什么数据进去都是<code>O(n²)</code>的时间复杂度。所以用到它的时候，数据规模越小越好。唯一的好处可能就是不占用额外的内存空间了吧。它的工作原理：首先在未排序序列中找到最小（大）元素，存放到排序序列的起始位置，然后，再从剩余未排序元素中继续寻找最小（大）元素，然后放到已排序序列的末尾。以此类推，直到所有元素均排序完毕。</p><h4 id="2-2-1-算法步骤"><a href="#2-2-1-算法步骤" class="headerlink" title="2.2.1 算法步骤"></a>2.2.1 算法步骤</h4><ol><li>首先在未排序序列中找到最小（大）元素，存放到排序序列的起始位置</li><li>再从剩余未排序元素中继续寻找最小（大）元素，然后放到已排序序列的末尾。</li><li>重复第 2 步，直到所有元素均排序完毕。</li></ol><h4 id="2-2-2-图解算法"><a href="#2-2-2-图解算法" class="headerlink" title="2.2.2 图解算法"></a>2.2.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/selection_sort.gif" class="" title="选择排序"></center><h4 id="2-2-3-代码实现"><a href="#2-2-3-代码实现" class="headerlink" title="2.2.3 代码实现"></a>2.2.3 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 选择排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 需要排序的数组</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">selectionSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length; i++)&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">minIndex</span> <span class="hljs-operator">=</span> i;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i + <span class="hljs-number">1</span>; j &lt; arr.length; j++)&#123;<br>            <span class="hljs-keyword">if</span> (arr[j] &lt; arr[i])&#123;<br>                minIndex = j;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//交换</span><br>        <span class="hljs-keyword">if</span>(minIndex != i)&#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>            arr[i] = arr[minIndex];<br>            arr[minIndex] = temp;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-4-选择排序算法分析"><a href="#2-2-4-选择排序算法分析" class="headerlink" title="2.2.4 选择排序算法分析"></a>2.2.4 选择排序算法分析</h4><ul><li><p>稳定性：不稳定</p><blockquote><p>例子：</p><p>排序前：8 4* 7 4 1 3</p><p>排序后：1 3 4 4* 7 8</p></blockquote></li><li><p>时间复杂度 ：最佳：<code>O(n2)</code> ，最差：<code>O(n2)</code>， 平均：<code>O(n2)</code></p></li><li><p>空间复杂度 ：<code>O(1)</code></p></li><li><p>排序方式 ：<code>In-place</code></p></li></ul><h3 id="2-3-插入排序-Insertion-Sort"><a href="#2-3-插入排序-Insertion-Sort" class="headerlink" title="2.3 插入排序(Insertion Sort)"></a>2.3 插入排序(Insertion Sort)</h3><p>插入排序是一种简单直观的排序算法。它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入。插入排序在实现上，通常采用 <code>in-place</code> 排序（即只需用到 <code>O(1)</code> 的额外空间的排序），因而在从后向前扫描过程中，需要反复把已排序元素逐步向后挪位，为最新元素提供插入空间。</p><p>插入排序的代码实现虽然没有冒泡排序和选择排序那么简单粗暴，但它的原理应该是最容易理解的了，因为只要打过扑克牌的人都应该能够秒懂。插入排序是一种最简单直观的排序算法，它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入。</p><p>插入排序和冒泡排序一样，也有一种优化算法，叫做拆半插入。</p><h4 id="2-3-1-算法步骤"><a href="#2-3-1-算法步骤" class="headerlink" title="2.3.1 算法步骤"></a>2.3.1 算法步骤</h4><ol><li>从第一个元素开始，该元素可以认为已经被排序；</li><li>取出下一个元素，在已经排序的元素序列中从后向前扫描；</li><li>如果该元素（已排序）大于新元素，将该元素移到下一位置；</li><li>重复步骤 3，直到找到已排序的元素小于或者等于新元素的位置；</li><li>将新元素插入到该位置后；</li><li>重复步骤 2~5。</li></ol><h4 id="2-3-2-图解算法"><a href="#2-3-2-图解算法" class="headerlink" title="2.3.2 图解算法"></a>2.3.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/insertion_sort.gif" class="" title="插入排序"></center><h4 id="2-3-3-代码实现"><a href="#2-3-3-代码实现" class="headerlink" title="2.3.3 代码实现"></a>2.3.3 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 插入排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 需要排序的数组</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertionSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; arr.length; i++) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pre</span> <span class="hljs-operator">=</span> i;<br>        <span class="hljs-keyword">while</span>(pre &gt; <span class="hljs-number">0</span> &amp;&amp; temp &lt; arr[pre - <span class="hljs-number">1</span>])&#123;<br>            arr[pre] = arr[pre - <span class="hljs-number">1</span>];<br>            --pre;<br>        &#125;<br>        arr[pre] = temp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3-4-插入排序算法分析"><a href="#2-3-4-插入排序算法分析" class="headerlink" title="2.3.4 插入排序算法分析"></a>2.3.4 插入排序算法分析</h4><p>稳定性：稳定<br>时间复杂度 ：最佳：<code>O(n)</code> ，最差：<code>O(n2)</code>， 平均：<code>O(n2)</code><br>空间复杂度 ：<code>O(1)</code><br>排序方式 ：<code>In-place</code></p><h3 id="2-4-希尔排序-Shell-Sort"><a href="#2-4-希尔排序-Shell-Sort" class="headerlink" title="2.4 希尔排序(Shell Sort)"></a>2.4 希尔排序(Shell Sort)</h3><p>希尔排序是希尔 (Donald Shell) 于 1959 年提出的一种排序算法。希尔排序也是一种插入排序，它是简单插入排序经过改进之后的一个更高效的版本，也称为递减增量排序算法，同时该算法是冲破 <code>O(n²)</code> 的第一批算法之一。</p><p>希尔排序的基本思想是：先将整个待排序的记录序列分割成为若干子序列分别进行直接插入排序，待整个序列中的记录 “基本有序” 时，再对全体记录进行依次直接插入排序。</p><h4 id="2-4-1-算法步骤"><a href="#2-4-1-算法步骤" class="headerlink" title="2.4.1 算法步骤"></a>2.4.1 算法步骤</h4><p>我们来看下希尔排序的基本步骤，在此我们选择增量 <code>gap=length/2</code>，缩小增量继续以 <code>gap = gap/2</code> 的方式，这种增量选择我们可以用一个序列来表示，<code>&#123;n/2, (n/2)/2, ..., 1&#125;</code>，称为<strong>增量序列</strong>。希尔排序的增量序列的选择与证明是个数学难题，我们选择的这个增量序列是比较常用的，也是希尔建议的增量，称为希尔增量，但其实这个增量序列不是最优的。此处我们做示例使用希尔增量。</p><p>先将整个待排序的记录序列分割成为若干子序列分别进行直接插入排序，具体算法描述：</p><ul><li>选择一个增量序列 <code>&#123;t1, t2, …, tk&#125;</code>，其中 <code>(ti &gt; tj, i &lt; j, tk = 1)</code>；</li><li>按增量序列个数 <code>k</code>，对序列进行 <code>k</code> 趟排序；</li><li>每趟排序，根据对应的增量<code>t</code>，将待排序列分割成若干长度为<code>m</code>的子序列，分别对各子表进行直接<strong>插入排序</strong>。仅增量因子为 <code>1</code> 时，整个序列作为一个表来处理，表长度即为整个序列的长度。</li></ul><h4 id="2-4-2-图解算法"><a href="#2-4-2-图解算法" class="headerlink" title="2.4.2 图解算法"></a>2.4.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/shell_sort.png" class="" title="希尔排序"></center><h4 id="2-4-3-代码实现"><a href="#2-4-3-代码实现" class="headerlink" title="2.4.3 代码实现"></a>2.4.3 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 希尔排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 需要排序的数组</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shellSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> arr.length;<br>    <span class="hljs-comment">//增量</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">gap</span> <span class="hljs-operator">=</span> len;<br>    <span class="hljs-keyword">while</span>(gap &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">//计算增量</span><br>        gap /= <span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> gap; i &lt; len; i++)&#123;<br>            <span class="hljs-comment">//此循环体相当于插入排序</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">pre</span> <span class="hljs-operator">=</span> i - gap;<br>            <span class="hljs-keyword">while</span> (pre &gt;= <span class="hljs-number">0</span> &amp;&amp; arr[pre] &gt; temp)&#123;<br>                arr[pre + gap] = arr[pre];<br>                pre -= gap;<br>            &#125;<br>            arr[pre + gap] = temp;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-4-4-希尔排序算法分析"><a href="#2-4-4-希尔排序算法分析" class="headerlink" title="2.4.4 希尔排序算法分析"></a>2.4.4 希尔排序算法分析</h4><ul><li>稳定性：不稳定<blockquote><p>由于多次插入排序，我们知道一次插入排序是稳定的，不会改变相同元素的相对顺序，但在不同的插入排序过程中，相同的元素可能在各自的插入排序中移动，最后其稳定性就会被打乱，所以shell排序是不稳定的。对于排序算法，所谓的不稳定指的就是相同元素在排序过程中被移动</p><p>如：</p><p>排序前： 4* 4 1 3 2</p><p>排序后： 1 2 3 4 4*</p></blockquote></li><li>时间复杂度 ：最佳：<code>O(nlogn)</code>， 最差：<code>O(n2)</code> 平均：<code>O(nlogn)</code></li><li>空间复杂度 ：<code>O(1)</code></li></ul><h3 id="2-5-归并排序-Merge-Sort"><a href="#2-5-归并排序-Merge-Sort" class="headerlink" title="2.5 归并排序(Merge Sort)"></a>2.5 归并排序(Merge Sort)</h3><p>归并排序是建立在归并操作上的一种有效的排序算法。该算法是采用<strong>分治法</strong> (Divide and Conquer) 的一个非常典型的应用。归并排序是一种<strong>稳定</strong>的排序方法。将已有序的子序列合并，得到完全有序的序列；即先使每个子序列有序，再使子序列段间有序。若将两个有序表合并成一个有序表，称为 <code>2 - 路</code>归并。</p><p>和选择排序一样，归并排序的性能不受输入数据的影响，但表现比选择排序好的多，因为始终都是 <code>O(nlogn)</code> 的时间复杂度。代价是需要额外的内存空间。</p><h4 id="2-5-1-算法步骤"><a href="#2-5-1-算法步骤" class="headerlink" title="2.5.1 算法步骤"></a>2.5.1 算法步骤</h4><p>归并排序算法是一个递归过程，边界条件为当输入序列仅有一个元素时，直接返回，具体过程如下：</p><ol><li>如果输入内只有一个元素，则直接返回，否则将长度为 n 的输入序列分成两个长度为 n&#x2F;2 的子序列；</li><li>分别对这两个子序列进行归并排序，使子序列变为有序状态；</li><li>设定两个指针，分别指向两个已经排序子序列的起始位置；</li><li>比较两个指针所指向的元素，选择相对小的元素放入到合并空间（用于存放排序结果），并移动指针到下一位置；</li><li>重复步骤 3 ~4 直到某一指针达到序列尾；</li><li>将另一序列剩下的所有元素直接复制到合并序列尾。</li></ol><h4 id="2-5-2-图解算法"><a href="#2-5-2-图解算法" class="headerlink" title="2.5.2 图解算法"></a>2.5.2 图解算法</h4><center>    <img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/merge_sort.gif" class="" title="归并排序"></center><h4 id="2-5-3-代码实现"><a href="#2-5-3-代码实现" class="headerlink" title="2.5.3 代码实现"></a>2.5.3 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 归并排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 需要排序的数组</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] mergeSort(<span class="hljs-type">int</span>[] arr)&#123;<br>    <span class="hljs-keyword">if</span>(arr.length == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">return</span> arr;<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> arr.length / <span class="hljs-number">2</span>;<br>    <span class="hljs-comment">//对半拷贝数组</span><br>    <span class="hljs-type">int</span>[] arr1 = Arrays.copyOfRange(arr, <span class="hljs-number">0</span>, mid);<br>    <span class="hljs-type">int</span>[] arr2 = Arrays.copyOfRange(arr, mid, arr.length);<br>    <span class="hljs-comment">//递归</span><br>    <span class="hljs-keyword">return</span> merge(mergeSort(arr1), mergeSort(arr2));<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 合并两个数组</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr1 数组1</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr2 数组2</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] merge(<span class="hljs-type">int</span>[] arr1, <span class="hljs-type">int</span>[] arr2) &#123;<br>    <span class="hljs-comment">//结果数组</span><br>    <span class="hljs-type">int</span>[] resArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[arr1.length + arr2.length];<br>    <span class="hljs-comment">//三个数组的指针</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">indexRes</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, indexA1 = <span class="hljs-number">0</span>, indexA2 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(indexA1 &lt; arr1.length &amp;&amp; indexA2 &lt; arr2.length)&#123;<br>        <span class="hljs-keyword">if</span>(arr1[indexA1] &lt; arr2[indexA2])&#123;<br>            resArr[indexRes++] = arr1[indexA1++];<br><br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            resArr[indexRes++] = arr2[indexA2++];<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//arr1可能没遍历完</span><br>    <span class="hljs-keyword">while</span> (indexA1 &lt; arr1.length)&#123;<br>        resArr[indexRes++] = arr1[indexA1++];<br>    &#125;<br>    <span class="hljs-comment">//arr2可能没遍历完</span><br>    <span class="hljs-keyword">while</span> (indexA2 &lt; arr2.length)&#123;<br>        resArr[indexRes++] = arr2[indexA2++];<br>    &#125;<br>    <span class="hljs-keyword">return</span> resArr;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-5-4-归并排序算法分析"><a href="#2-5-4-归并排序算法分析" class="headerlink" title="2.5.4 归并排序算法分析"></a>2.5.4 归并排序算法分析</h4><ul><li>稳定性：稳定</li><li>时间复杂度 ：最佳：<code>O(nlogn)</code>， 最差：<code>O(nlogn)</code>， 平均：<code>O(nlogn)</code></li><li>空间复杂度 ：<code>O(n)</code></li></ul><h3 id="2-6-快速排序-Quick-Sort"><a href="#2-6-快速排序-Quick-Sort" class="headerlink" title="2.6 快速排序(Quick Sort)"></a>2.6 快速排序(Quick Sort)</h3><p>快速排序用到了<strong>分治思想</strong>，同样的还有归并排序。乍看起来快速排序和归并排序非常相似，都是将问题变小，先排序子串，最后合并。不同的是快速排序在划分子问题的时候经过多一步处理，将划分的两组数据划分为一大一小，这样在最后合并的时候就不必像归并排序那样再进行比较。但也正因为如此，划分的不定性使得快速排序的时间复杂度并<strong>不稳定</strong>。</p><p>快速排序的基本思想：通过一趟排序将待排序列分隔成独立的两部分，其中一部分记录的元素均比另一部分的元素小，则可分别对这两部分子序列继续进行排序，以达到整个序列有序。</p><h4 id="2-6-1-算法步骤"><a href="#2-6-1-算法步骤" class="headerlink" title="2.6.1 算法步骤"></a>2.6.1 算法步骤</h4><p>快速排序使用分治法（Divide and conquer）策略来把一个序列分为较小和较大的 2 个子序列，然后递回地排序两个子序列。具体算法描述如下：</p><ol><li>从序列中随机挑出一个元素，做为 “基准”(pivot)；</li><li>重新排列序列，将所有比基准值小的元素摆放在基准前面，所有比基准值大的3. 摆在基准的后面（相同的数可以到任一边）。在这个操作结束之后，该基准就处于数列的中间位置。这个称为分区（partition）操作；</li><li>递归地把小于基准值元素的子序列和大于基准值元素的子序列进行快速排序。</li></ol><h4 id="2-6-2-图解算法"><a href="#2-6-2-图解算法" class="headerlink" title="2.6.2 图解算法"></a>2.6.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/random_quick_sort.gif" class="" title="快速排序"></center><h4 id="2-6-3-代码实现"><a href="#2-6-3-代码实现" class="headerlink" title="2.6.3 代码实现"></a>2.6.3 代码实现</h4><blockquote><p>代码参考： <a href="https://www.runoob.com/w3cnote/quick-sort-2.html">https://www.runoob.com/w3cnote/quick-sort-2.html</a></p><p>下列代码是默认将第一个数设为基准</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 快速排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 待排序数组</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> low 第一个位置</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> high 末位置</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] quickSort(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high)&#123;<br>    <span class="hljs-keyword">if</span>(low &lt; high)&#123;<br>        <span class="hljs-comment">//划分</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">partitionIndex</span> <span class="hljs-operator">=</span> partition(arr, low, high);<br>        quickSort(arr, low, partitionIndex - <span class="hljs-number">1</span>);<br>        quickSort(arr, partitionIndex + <span class="hljs-number">1</span>, high);<br>    &#125;<br>    <span class="hljs-keyword">return</span> arr;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 划分方法，将数组变为基准值前面比基准值小，后面比基准值大</span><br><span class="hljs-comment">* 将数组的第一个数设为基准</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 数组</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> low 第一个位置</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> high 末位置</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high)</span> &#123;<br>    <span class="hljs-comment">//将第一个数设为基准,记录其索引</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> low;<br>    <span class="hljs-comment">//记录比基准值大的数的指针</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> low + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> low + <span class="hljs-number">1</span>; i &lt;= high; i++) &#123;<br>        <span class="hljs-keyword">if</span>(arr[i] &lt; arr[pivot])&#123;<br>            <span class="hljs-comment">//如果当前的值比基准值要小，与大于基准值的数交换位置</span><br>            swap(arr, index, i);<br>            <span class="hljs-comment">//索引加一</span><br>            index++;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//交换基准值和小于基准值的最后一个值的位置</span><br>    swap(arr, pivot, --index);<br>    <span class="hljs-comment">//返回基准值现在得位置</span><br>    <span class="hljs-keyword">return</span> index;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 交换数组两个元素位置</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 目标数组</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> i 位置1</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> j 位置2</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];<br>    arr[i] = arr[j];<br>    arr[j] = temp;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-6-4-快速排序算法分析"><a href="#2-6-4-快速排序算法分析" class="headerlink" title="2.6.4 快速排序算法分析"></a>2.6.4 快速排序算法分析</h4><ul><li>稳定性 ：不稳定</li><li>时间复杂度 ：最佳：<code>O(nlogn)</code>， 最差：<code>O(nlogn)</code>，平均：<code>O(nlogn)</code></li><li>空间复杂度 ：<code>O(nlogn)</code></li></ul><h3 id="2-7-堆排序-Heap-Sort"><a href="#2-7-堆排序-Heap-Sort" class="headerlink" title="2.7 堆排序(Heap Sort)"></a>2.7 堆排序(Heap Sort)</h3><p>堆排序是指利用堆这种数据结构所设计的一种排序算法。堆是一个近似完全二叉树的结构，并同时满足堆的性质：即子结点的值总是小于（或者大于）它的父节点。</p><h4 id="2-7-1-算法步骤"><a href="#2-7-1-算法步骤" class="headerlink" title="2.7.1 算法步骤"></a>2.7.1 算法步骤</h4><ol><li>将初始待排序列 <code>(R1, R2, ……, Rn)</code> 构建成大顶堆，此堆为初始的无序区；</li><li>将堆顶元素 <code>R[1]</code> 与最后一个元素 <code>R[n]</code> 交换，此时得到新的无序区 <code>(R1, R2, ……, Rn-1)</code> 和新的有序区 <code>(Rn)</code>, 且满足 <code>R[1, 2, ……, n-1]&lt;=R[n]</code>；</li><li>由于交换后新的堆顶 <code>R[1]</code>可能违反堆的性质，因此需要对当前无序区<code>(R1, R2, ……, Rn-1)</code> 调整为新堆，然后再次将 <code>R [1]</code> 与无序区最后一个元素交换，得到新的无序区 <code>(R1, R2, ……, Rn-2)</code> 和新的有序区 <code>(Rn-1, Rn)</code>。不断重复此过程直到有序区的元素个数为 <code>n-1</code>，则整个排序过程完成。</li></ol><h4 id="2-7-2-图解算法"><a href="#2-7-2-图解算法" class="headerlink" title="2.7.2 图解算法"></a>2.7.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/heap_sort.gif" class="" title="堆排序"></center><h4 id="2-7-3-代码实现"><a href="#2-7-3-代码实现" class="headerlink" title="2.7.3 代码实现"></a>2.7.3 代码实现</h4><blockquote><p>代码参考：<a href="https://www.cnblogs.com/luomeng/p/10618709.html">https://www.cnblogs.com/luomeng/p/10618709.html</a></p><p>以下代码省略了void swap(int[] arr, int i, int j)方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 堆排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 待排序数组</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> arr.length;<br>    <span class="hljs-comment">//创建大根堆</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (len/<span class="hljs-number">2</span> - <span class="hljs-number">1</span>); i &gt;= <span class="hljs-number">0</span>; i--)&#123;<br>        adjustHeap(arr, i, len);<br>    &#125;<br>    <span class="hljs-comment">//调整堆结构+交换堆顶元素与末尾元素</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> arr.length - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-comment">//将堆顶元素与末尾元素进行交换</span><br>        swap(arr, <span class="hljs-number">0</span>, i);<br>        <span class="hljs-comment">//重新对堆进行调整</span><br>        adjustHeap(arr, <span class="hljs-number">0</span>, i);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 调整堆</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 待排序数组</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> parent 父节点</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> len 待排序数组长度</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">adjustHeap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> parent, <span class="hljs-type">int</span> len)</span> &#123;<br>    <span class="hljs-comment">//左孩子</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> * parent + <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//右孩子</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> * parent + <span class="hljs-number">2</span>;<br>    <span class="hljs-comment">//记录父节点，左右孩子中最大值的索引</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">largest</span> <span class="hljs-operator">=</span> parent;<br>    <span class="hljs-comment">//如果存在右孩子且大于父节点，将索引值设为右孩子的索引</span><br>    <span class="hljs-keyword">if</span> (right &lt; len &amp;&amp; arr[right] &gt; arr[largest]) &#123;<br>        largest = right;<br>    &#125;<br>    <span class="hljs-comment">//如果存在左孩子且大于父节点或大于右孩子，将索引值设为左孩子的索引</span><br>    <span class="hljs-keyword">if</span> (left &lt; len &amp;&amp; arr[left] &gt; arr[largest]) &#123;<br>        largest = left;<br>    &#125;<br>    <span class="hljs-comment">//如果此时最大值的索引已经改变，那么交换父节点左右孩子节点的数值</span><br>    <span class="hljs-keyword">if</span> (largest != parent) &#123;<br>        swap(arr, largest, parent);<br>        <span class="hljs-comment">//交换后，对以左右孩子为根的树会造成影响，递归进行左或右孩子为根的树进行调整</span><br>        adjustHeap(arr, largest, len);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-7-4-堆排序算法分析"><a href="#2-7-4-堆排序算法分析" class="headerlink" title="2.7.4 堆排序算法分析"></a>2.7.4 堆排序算法分析</h4><ul><li>稳定性 ：不稳定</li><li>时间复杂度 ：最佳：<code>O(nlogn)</code>， 最差：<code>O(nlogn)</code>， 平均：<code>O(nlogn)</code></li><li>空间复杂度 ：<code>O(1)</code></li></ul><h3 id="2-8-计数排序-Counting-Sort"><a href="#2-8-计数排序-Counting-Sort" class="headerlink" title="2.8 计数排序(Counting Sort)"></a>2.8 计数排序(Counting Sort)</h3><p>计数排序的核心在于将输入的数据值转化为键存储在额外开辟的数组空间中。 作为一种线性时间复杂度的排序，计数排序要求输入的数据必须是<strong>有确定范围的整数</strong>。</p><p>计数排序 (Counting sort) 是一种稳定的排序算法。计数排序使用一个额外的数组 <code>C</code>，其中第 i 个元素是待排序数组 <code>A</code> 中值等于 <code>i</code> 的元素的个数。然后根据数组 <code>C</code> 来将 <code>A</code> 中的元素排到正确的位置。它只能对整数进行排序。</p><h4 id="2-8-1-算法步骤"><a href="#2-8-1-算法步骤" class="headerlink" title="2.8.1 算法步骤"></a>2.8.1 算法步骤</h4><ol><li>找出数组中的最大值 <code>max</code>、最小值 <code>min</code>；</li><li>创建一个新数组 <code>C</code>，其长度是 <code>max-min+1</code>，其元素默认值都为 <code>0</code>；</li><li>遍历原数组 <code>A</code>中的元素 <code>A[i]</code>，以 <code>A[i]-min</code> 作为 <code>C</code> 数组的索引，以 <code>A[i]</code> 的值在 <code>A</code> 中元素出现次数作为 <code>C[A[i]-min]</code> 的值；</li><li>对 <code>C</code> 数组变形，新元素的值是该元素与前一个元素值的和，即当 <code>i&gt;1</code> 时 <code>C[i] = C[i] + C[i-1]</code>；</li><li>创建结果数组 <code>R</code>，长度和原始数组一样。</li><li><strong>从后向前</strong>遍历原始数组 <code>A</code> 中的元素 <code>A[i]</code>，使用 <code>A[i]</code> 减去最小值 <code>min</code> 作为索引，在计数数组 <code>C</code> 中找到对应的值 <code>C[A[i]-min]</code>，<code>C[A[i]-min]-1</code> 就是 <code>A[i]</code> 在结果数组 <code>R</code> 中的位置，做完上述这些操作，将 <code>count[A[i]-min]</code> 减小 <code>1</code>。</li></ol><h4 id="2-8-2-图解算法"><a href="#2-8-2-图解算法" class="headerlink" title="2.8.2 图解算法"></a>2.8.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/counting_sort.gif" class="" title="计数排序"></center><h4 id="2-8-3-代码实现"><a href="#2-8-3-代码实现" class="headerlink" title="2.8.3 代码实现"></a>2.8.3 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 计数排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 待排序数组</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] countingSort(<span class="hljs-type">int</span>[] arr)&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> arr.length;<br>    <span class="hljs-keyword">if</span>(len &lt; <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-keyword">return</span> arr;<br>    &#125;<br>    <span class="hljs-comment">//记录数组中的最大值</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> arr[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">//记录数组中的最小值</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> arr[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">//遍历找出最大值和最小值</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : arr) &#123;<br>        <span class="hljs-keyword">if</span>(num &gt; max)&#123;<br>            max = num;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (num &lt; min)&#123;<br>            min = num;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//计数数组</span><br>    <span class="hljs-type">int</span>[] countArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[max - min + <span class="hljs-number">1</span>];<br>    <span class="hljs-comment">//排序后的结果数组</span><br>    <span class="hljs-type">int</span>[] res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[len];<br>    <span class="hljs-comment">//统计数量</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : arr) &#123;<br>        countArr[num - min] += <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-comment">//计算是第几个数</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; countArr.length; i++) &#123;<br>        <span class="hljs-comment">//值是该元素与前一个元素值的和</span><br>        countArr[i] += countArr[i - <span class="hljs-number">1</span>];<br>    &#125;<br>    <span class="hljs-comment">//开始排序操作</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> len - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-comment">//计算索引</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> countArr[arr[i] - min] - <span class="hljs-number">1</span>;<br>        res[index] = arr[i];<br>        <span class="hljs-comment">//数量减 1</span><br>        --countArr[arr[i] - min];<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-8-4-计数排序算法分析"><a href="#2-8-4-计数排序算法分析" class="headerlink" title="2.8.4 计数排序算法分析"></a>2.8.4 计数排序算法分析</h4><p>当输入的元素是 <code>n</code> 个 <code>0</code> 到 <code>k</code> 之间的整数时，它的运行时间是 <code>O(n+k)</code>。计数排序不是比较排序，排序的速度快于任何比较排序算法。由于用来计数的数组 <code>C</code> 的长度取决于待排序数组中数据的范围（等于待排序数组的最大值与最小值的差加上 <code>1</code>），这使得计数排序对于数据范围很大的数组，需要大量额外内存空间。</p><ul><li>稳定性：稳定</li><li>时间复杂度：最佳：<code>O(n+k)</code> 最差：<code>O(n+k)</code> 平均：<code>O(n+k)</code></li><li>空间复杂度：<code>O(k)</code></li></ul><h3 id="2-9-桶排序-Bucket-Sort"><a href="#2-9-桶排序-Bucket-Sort" class="headerlink" title="2.9 桶排序(Bucket Sort)"></a>2.9 桶排序(Bucket Sort)</h3><p>桶排序是计数排序的升级版。它利用了函数的映射关系，高效与否的关键就在于这个映射函数的确定。为了使桶排序更加高效，我们需要做到这两点：</p><ol><li>在额外空间充足的情况下，尽量增大桶的数量</li><li>使用的映射函数能够将输入的 N 个数据均匀的分配到 K 个桶中</li></ol><p>桶排序的工作的原理：假设输入数据服从均匀分布，将数据分到有限数量的桶里，每个桶再分别排序（有可能再使用别的排序算法或是以递归方式继续使用桶排序进行。</p><h4 id="2-9-1-算法步骤"><a href="#2-9-1-算法步骤" class="headerlink" title="2.9.1 算法步骤"></a>2.9.1 算法步骤</h4><ol><li>设置一个 BucketSize，作为每个桶所能放置多少个不同数值；</li><li>遍历输入数据，并且把数据依次映射到对应的桶里去；</li><li>对每个非空的桶进行排序，可以使用其它排序方法，也可以递归使用桶排序；</li><li>从非空桶里把排好序的数据拼接起来。</li></ol><h4 id="2-9-2-图解算法"><a href="#2-9-2-图解算法" class="headerlink" title="2.9.2 图解算法"></a>2.9.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/bucket_sort.gif" class="" title="桶排序"></center><h4 id="2-9-3-代码实现"><a href="#2-9-3-代码实现" class="headerlink" title="2.9.3 代码实现"></a>2.9.3 代码实现</h4><blockquote><p>代码参考：<a href="https://www.runoob.com/w3cnote/bucket-sort.html">https://www.runoob.com/w3cnote/bucket-sort.html</a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 桶排序</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 待排序数组</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> bucketSize 桶的尺寸</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] bucketSort(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> bucketSize)&#123;<br>    <span class="hljs-keyword">if</span> (arr.length &lt; <span class="hljs-number">2</span> || bucketSize == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> arr;<br>    &#125;<br><br>    <span class="hljs-comment">//获取最大值</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">minValue</span> <span class="hljs-operator">=</span> arr[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">//获取最小值</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">maxValue</span> <span class="hljs-operator">=</span> arr[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> value : arr) &#123;<br>        <span class="hljs-keyword">if</span> (value &lt; minValue) &#123;<br>            minValue = value;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value &gt; maxValue) &#123;<br>            maxValue = value;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//计算桶的数量</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">bucketCount</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) Math.floor((maxValue - minValue) / bucketSize) + <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//创建多个桶</span><br>    <span class="hljs-type">int</span>[][] buckets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[bucketCount][<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">// 利用映射函数将数据分配到各个桶中</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : arr) &#123;<br>        <span class="hljs-comment">//根据映射关系计算位于第几个桶</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) Math.floor((num - minValue) / bucketSize);<br>        <span class="hljs-comment">//添加到index桶的末尾</span><br>        buckets[index] = arrAppend(buckets[index], num);<br>    &#125;<br>    <span class="hljs-comment">//结果数组的索引</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">arrIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] bucket : buckets) &#123;<br>        <span class="hljs-keyword">if</span> (bucket.length &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 如果桶中没有数据，执行下一循环</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">// 对每个桶进行排序，这里使用了插入排序</span><br>        insertionSort(bucket);<br>        <span class="hljs-comment">// 将桶中的数组添加到结果中</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> value : bucket) &#123;<br>            arr[arrIndex++] = value;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> arr;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 自动扩容，并保存数据</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> arr 数组</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> value 需要添加进入数组的数</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] arrAppend(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> value) &#123;<br>    arr = Arrays.copyOf(arr, arr.length + <span class="hljs-number">1</span>);<br>    arr[arr.length - <span class="hljs-number">1</span>] = value;<br>    <span class="hljs-keyword">return</span> arr;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-9-4-桶排序算法分析"><a href="#2-9-4-桶排序算法分析" class="headerlink" title="2.9.4 桶排序算法分析"></a>2.9.4 桶排序算法分析</h4><ul><li>稳定性 ：稳定</li><li>时间复杂度 ：最佳：<code>O(n+k)</code> 最差：<code>O(n²)</code> 平均：<code>O(n+k)</code></li><li>空间复杂度 ：<code>O(k)</code></li></ul><h3 id="2-10-基数排序-Radix-Sort"><a href="#2-10-基数排序-Radix-Sort" class="headerlink" title="2.10 基数排序(Radix Sort)"></a>2.10 基数排序(Radix Sort)</h3><p>基数排序也是非比较的排序算法，对元素中的每一位数字进行排序，从最低位开始排序，复杂度为 O(n×k)，n 为数组长度，k 为数组中元素的最大的位数；</p><p>基数排序是按照低位先排序，然后收集；再按照高位排序，然后再收集；依次类推，直到最高位。有时候有些属性是有优先级顺序的，先按低优先级排序，再按高优先级排序。最后的次序就是高优先级高的在前，高优先级相同的低优先级高的在前。基数排序基于分别排序，分别收集，所以是稳定的。</p><h4 id="2-10-1-算法步骤"><a href="#2-10-1-算法步骤" class="headerlink" title="2.10.1 算法步骤"></a>2.10.1 算法步骤</h4><p>1。 取得数组中的最大数，并取得位数，即为迭代次数 <code>N</code>（例如：数组中最大数值为 <code>1000</code>，则 <code>N=4</code>）；<br>2. <code>A</code> 为原始数组，从最低位开始取每个位组成 <code>radix</code> 数组；<br>3. 对 <code>radix</code> 进行计数排序（利用计数排序适用于小范围数的特点）；<br>4. 将 <code>radix</code> 依次赋值给原数组；<br>5. 重复 2~4 步骤 <code>N</code> 次</p><h4 id="2-10-2-图解算法"><a href="#2-10-2-图解算法" class="headerlink" title="2.10.2 图解算法"></a>2.10.2 图解算法</h4><center><img src="/2020/10/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/radix_sort.gif" class="" title="基数排序"></center><h4 id="2-10-3-代码实现"><a href="#2-10-3-代码实现" class="headerlink" title="2.10.3 代码实现"></a>2.10.3 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自动扩容，并保存数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> arr 数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value 需要添加进入数组的数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] arrAppend(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> value) &#123;<br>        arr = Arrays.copyOf(arr, arr.length + <span class="hljs-number">1</span>);<br>        arr[arr.length - <span class="hljs-number">1</span>] = value;<br>        <span class="hljs-keyword">return</span> arr;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 基数排序</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> arr 待排序数组</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">radixSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> &#123;<br>        <span class="hljs-keyword">if</span> (arr.length &lt; <span class="hljs-number">2</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//最大值的位数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-comment">//最大值</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">maxValue</span> <span class="hljs-operator">=</span> arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-comment">//找到最大值</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : arr) &#123;<br>            <span class="hljs-keyword">if</span> (num &gt; maxValue) &#123;<br>                maxValue = num;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//判断最大值有多少位</span><br>        <span class="hljs-keyword">while</span> (maxValue / <span class="hljs-number">10</span> != <span class="hljs-number">0</span>) &#123;<br>            maxValue = maxValue / <span class="hljs-number">10</span>;<br>            N += <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-comment">//开始排序操作</span><br>        <span class="hljs-comment">// 第一次循环可以让数组内部的一位的数字变得相对有序，当然这其中会穿插的其余位数的数字；</span><br>        <span class="hljs-comment">// 第二次循环就是一位，二位的数字相对有序</span><br>        <span class="hljs-comment">// ...</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>            <span class="hljs-comment">//数组的一维表示可能的余数0-9</span><br>            <span class="hljs-type">int</span>[][] radixes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">10</span>][<span class="hljs-number">0</span>];<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : arr) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> (num / (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">10</span>, i)) % <span class="hljs-number">10</span>;<br>                <span class="hljs-comment">//添加到余数对应的二维数组的一维数组</span><br>                radixes[idx] = arrAppend(radixes[idx], num);<br>            &#125;<br>            <span class="hljs-comment">//结果数组的索引</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-comment">//改边原数组，让原数组中i位大小的数字1相对有序</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] radix : radixes) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : radix) &#123;<br>                    arr[idx++] = num;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="2-10-4-基数排序算法分析"><a href="#2-10-4-基数排序算法分析" class="headerlink" title="2.10.4 基数排序算法分析"></a>2.10.4 基数排序算法分析</h4><ul><li>稳定性：稳定</li><li>时间复杂度：最佳：<code>O(n×k)</code> 最差：<code>O(n×k)</code> 平均：<code>O(n×k)</code></li><li>空间复杂度：<code>O(n+k)</code></li></ul><p><strong>基数排序 vs 计数排序 vs 桶排序</strong></p><p>这三种排序算法都利用了桶的概念，但对桶的使用方法上有明显差异：</p><ul><li>基数排序：根据键值的每位数字来分配桶</li><li>计数排序：每个桶只存储单一键值</li><li>桶排序：每个桶存储一定范围的数值</li></ul>]]></content>
    
    
    <categories>
      
      <category>计算机基础</category>
      
      <category>数据结构与算法</category>
      
      <category>算法</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机基础</tag>
      
      <tag>算法</tag>
      
      <tag>排序</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>深入理解synchronized</title>
    <link href="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/"/>
    <url>/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本学习笔记来自教程  <a href="https://www.bilibili.com/video/BV1aJ411V763/">Java面试热点问题，synchronized原理剖析与优化</a></p></blockquote><h1 id="深入学习并发编程中的synchronized"><a href="#深入学习并发编程中的synchronized" class="headerlink" title="深入学习并发编程中的synchronized"></a>深入学习并发编程中的synchronized</h1><h2 id="第一章：并发编程中的三个问题"><a href="#第一章：并发编程中的三个问题" class="headerlink" title="第一章：并发编程中的三个问题"></a>第一章：并发编程中的三个问题</h2><h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><hr><h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><p>学习什么是可见性问题</p><h4 id="可见性概念"><a href="#可见性概念" class="headerlink" title="可见性概念"></a>可见性概念</h4><p>可见性（Visibility）：是指一个线程对共享变量进行修改,另一个先立即得到修改后的最新值。</p><h4 id="可见性演示"><a href="#可见性演示" class="headerlink" title="可见性演示"></a>可见性演示</h4><p>案例演示：一个线程根据boolean类型的标记flag, while循环,另一个线程改变这个flag变量的值,另<br>一个线程并不会停止循环。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo01_concurrent_problem;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 可见性（Visibility）：是指一个线程对共享变量进行修改,另一个线程立即得到修改后的最新值</span><br><span class="hljs-comment"> * 可见性演示</span><br><span class="hljs-comment"> *      一个线程对共享变量的修改,另一个线程不能立即得到最新值</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test01Visibility</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">//线程2修改后线程1并没有结束,程序一直在运行</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (run)&#123;<br><br>            &#125;<br>        &#125;);<br><br>        t1.start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            run = <span class="hljs-literal">false</span>;<br>            System.out.println(<span class="hljs-string">&quot;时间到,线程2设置为false&quot;</span>);<br>        &#125;);<br>        t2.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>并发编程时,会出现可见性问题,当一个线程对共享变量进行了修改,另外的线程并没有立即看到修改<br>后的最新值。</p><h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><hr><h4 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h4><p>学习什么是原子性问题</p><h4 id="原子性概念"><a href="#原子性概念" class="headerlink" title="原子性概念"></a>原子性概念</h4><p>原子性（Atomicity）：在一次或多次操作中,要么所有的操作都执行并且不会受其他因素干扰而中<br>断,要么所有的操作都不执行。</p><h4 id="原子性演示"><a href="#原子性演示" class="headerlink" title="原子性演示"></a>原子性演示</h4><p>案例演示:5个线程各执行1000次 i++;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo01_concurrent_problem;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 原子性（Atomicity）：在一次或多次操作中,要么所有的操作都执行并且不会受其他因素干扰而中</span><br><span class="hljs-comment"> * 断,要么所有的操作都不执行。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test02Atomicity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">increment</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>                number++;<br>            &#125;<br>        &#125;;<br><br>        List&lt;Thread&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(increment);<br>            t.start();<br>            list.add(t);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : list)&#123;<br>            t.join();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;number = &quot;</span> + number);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用javap反汇编class文件,得到下面的字节码指令：</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/1.png" class=""></div>其中,对于 number++ 而言（number 为静态变量）,实际会产生如下的 JVM 字节码指令：<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">9: getstatic #12          // Field number:I<br>12: iconst_1<br>13: iadd<br>14: putstatic #12         // Field number:I<br></code></pre></td></tr></table></figure><p>由此可见number++是由多条语句组成,以上多条指令在一个线程的情况下是不会出问题的,但是在多<br>线程情况下就可能会出现问题。比如一个线程在执行13: iadd时,另一个线程又执行9: getstatic。会导<br>致两次number++,实际上只加了1。</p><h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>并发编程时,会出现原子性问题,当一个线程对共享变量操作到一半时,另外的线程也有可能来操作共<br>享变量,干扰了前一个线程的操作。</p><h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><hr><h4 id="目标-2"><a href="#目标-2" class="headerlink" title="目标"></a>目标</h4><p>学习什么是有序性问题</p><h4 id="有序性概念"><a href="#有序性概念" class="headerlink" title="有序性概念"></a>有序性概念</h4><p>有序性（Ordering）：是指程序中代码的执行顺序,Java在编译时和运行时会对代码进行优化,会导致<br>程序最终的执行顺序不一定就是我们编写代码时的顺序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="有序性演示"><a href="#有序性演示" class="headerlink" title="有序性演示"></a>有序性演示</h4><p>jcstress是java并发压测工具。<a href="https://wiki.openjdk.java.net/display/CodeTools/jcstress">https://wiki.openjdk.java.net/display/CodeTools/jcstress</a><br>修改pom文件,添加依赖(后续依赖及插件一起加上)：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">javac.target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">javac.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">jcstress.version</span>&gt;</span>0.5<span class="hljs-tag">&lt;/<span class="hljs-name">jcstress.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">uberjar.name</span>&gt;</span>jcstress<span class="hljs-tag">&lt;/<span class="hljs-name">uberjar.name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jcstress<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jcstress-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;jcstress.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jol<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jol-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">compilerVersion</span>&gt;</span>$&#123;javac.target&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">compilerVersion</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;javac.target&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;javac.target&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-shade-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>main<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>shade<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;uberjar.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">transformers</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">transformer</span></span><br><span class="hljs-tag">                                    <span class="hljs-attr">implementation</span>=<span class="hljs-string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>org.openjdk.jcstress.Main<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">transformer</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">transformer</span> <span class="hljs-attr">implementation</span>=<span class="hljs-string">&quot;org.apache.maven.plugins.shade.resource.AppendingTransformer&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>META-INF/TestList<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">transformer</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">transformers</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>代码：<br>Test03Orderliness.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo01_concurrent_problem;<br><br><span class="hljs-keyword">import</span> org.openjdk.jcstress.annotations.*;<br><span class="hljs-keyword">import</span> org.openjdk.jcstress.infra.results.I_Result;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有序性</span><br><span class="hljs-comment"> * 是指程序中代码的执行顺序,Java在编译时和运行时会对代码进行优化,会导致</span><br><span class="hljs-comment"> * 程序最终的执行顺序不一定就是我们编写代码时的顺序。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 出现0的结果就是线程2执行顺序出现问题</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@JCStressTest</span><br><span class="hljs-meta">@Outcome(id = &#123;&quot;1&quot;, &quot;4&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)</span><br><span class="hljs-meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;danger&quot;)</span><br><span class="hljs-meta">@State</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test03Orderliness</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">ready</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">//线程1</span><br>    <span class="hljs-meta">@Actor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor1</span><span class="hljs-params">(I_Result r)</span>&#123;<br>        <span class="hljs-keyword">if</span>(ready)&#123;<br>            r.r1 = num + num;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            r.r1 = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//线程2</span><br>    <span class="hljs-meta">@Actor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor2</span><span class="hljs-params">(I_Result r)</span>&#123;<br>        num = <span class="hljs-number">2</span>;<br>        ready = <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>I_Result 是一个对象,有一个属性r1 用来保存结果,在多线程情况下可能出现几种结果？ 情况1：线<br>程1先执行actor1,这时ready &#x3D; false,所以进入else分支结果为1。</li><li>情况2：线程2执行到actor2,执行了num &#x3D; 2;和ready &#x3D; true,线程1执行,这回进入 if 分支,结果为<br>4。</li><li>情况3：线程2先执行actor2,只执行num &#x3D; 2；但没来得及执行 ready &#x3D; true,线程1执行,还是进入<br>else分支,结果为1。</li><li><font color="red">还有一种结果0</font></li></ul><p>运行测试：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">mvn clean install<br>java -jar target/jcstress.jar<br></code></pre></td></tr></table></figure><h4 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h4><p>程序代码在执行过程中的先后顺序,由于Java在编译期以及运行期的优化,导致了代码的执行顺序未必<br>就是开发者编写代码时的顺序。</p><h2 id="第二章：Java内存模型-JMM"><a href="#第二章：Java内存模型-JMM" class="headerlink" title="第二章：Java内存模型(JMM)"></a>第二章：Java内存模型(JMM)</h2><p>在介绍Java内存模型之前,先来看一下到底什么是计算机内存模型。</p><h3 id="计算机结构"><a href="#计算机结构" class="headerlink" title="计算机结构"></a>计算机结构</h3><hr><h4 id="目标-3"><a href="#目标-3" class="headerlink" title="目标"></a>目标</h4><p>学习计算机的主要组成</p><p>学习缓存的作用</p><h4 id="计算机结构简介"><a href="#计算机结构简介" class="headerlink" title="计算机结构简介"></a>计算机结构简介</h4><p>冯诺依曼,提出计算机由五大组成部分,输入设备,输出设备存储器,控制器,运算器。</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/2.png" class=""></div><h5 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h5><p>中央处理器,是计算机的控制和运算的核心,我们的程序最终都会变成指令让CPU去执行,处理程序中<br>的数据。</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/3.png" class=""></div><h5 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h5><p>我们的程序都是在内存中运行的,内存会保存程序运行时的数据,供CPU处理。</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/4.png" class=""></div><h5 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h5><p>CPU的运算速度和内存的访问速度相差比较大。这就导致CPU每次操作内存都要耗费很多等待时间。内<br>存的读写速度成为了计算机运行的瓶颈。于是就有了在CPU和主内存之间增加缓存的设计。最靠近CPU<br>的缓存称为L1,然后依次是 L2,L3和主内存,CPU缓存模型如图下图所示。</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/5.png" class=""></div><p>CPU Cache分成了三个级别: L1, L2, L3。级别越小越接近CPU,速度也更快,同时也代表着容量越<br>小。</p><ol><li>L1是最接近CPU的,它容量最小,例如32K,速度最快,每个核上都有一个L1 Cache。</li><li>L2 Cache 更大一些,例如256K,速度要慢一些,一般情况下每个核上都有一个独立的L2 Cache。</li><li>L3 Cache是三级缓存中最大的一级,例如12MB,同时也是缓存中最慢的一级,在同一个CPU插槽<br>之间的核共享一个L3 Cache。</li></ol><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/6.png" class=""></div>Cache的出现是为了解决CPU直接访问内存效率低下问题的,程序在运行的过程中,CPU接收到指令后,它会最先向CPU中的一级缓存（L1 Cache）去寻找相关的数据,如果命中缓存,CPU进行计算时就可以直接对CPU Cache中的数据进行读取和写人,当运算结束之后,再将CPUCache中的最新数据刷新到主内存当中,CPU通过直接访问Cache的方式替代直接访问主存的方式极大地提高了CPU 的吞吐能力。但是由于一级缓存（L1 Cache）容量较小,所以不可能每次都命中。这时CPU会继续向下一级的二级缓存（L2 Cache）寻找,同样的道理,当所需要的数据在二级缓存中也没有的话,会继续转向L3Cache、内存(主存)和硬盘。<h4 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h4><p>计算机的主要组成CPU,内存,输入设备,输出设备。</p><h3 id="Java内存模型"><a href="#Java内存模型" class="headerlink" title="Java内存模型"></a>Java内存模型</h3><hr><h4 id="目标-4"><a href="#目标-4" class="headerlink" title="目标"></a>目标</h4><p>学习Java内存模型的概念和作用</p><h4 id="Java内存模型的概念"><a href="#Java内存模型的概念" class="headerlink" title="Java内存模型的概念"></a>Java内存模型的概念</h4><p>Java Memory Molde (Java内存模型&#x2F;JMM),千万不要和Java内存结构混淆</p><p>关于“Java内存模型”的权威解释,请参考 <a href="https://download.oracle.com/otn-pub/jcp/memory_model-">https://download.oracle.com/otn-pub/jcp/memory_model-</a><br>1.0-pfd-spec-oth-JSpec&#x2F;memory_model-1_0-pfd-spec.pdf。</p><p>Java内存模型,是Java虚拟机规范中所定义的一种内存模型,Java内存模型是标准化的,屏蔽掉了底层<br>不同计算机的区别。</p><p>Java内存模型是一套规范,描述了Java程序中各种变量(线程共享变量)的访问规则,以及在JVM中将变量<br>存储到内存和从内存中读取变量这样的底层细节,具体如下。</p><ul><li><p>主内存</p><p> 主内存是所有线程都共享的,都能访问的。所有的共享变量都存储于主内存。</p></li><li><p>工作内存</p><p>每一个线程有自己的工作内存,工作内存只存储该线程对共享变量的副本。线程对变量的所有的操<br>作(读,取)都必须在工作内存中完成,而不能直接读写主内存中的变量,不同线程之间也不能直接<br>访问对方工作内存中的变量</p></li></ul><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/7.png" class=""></div><h4 id="Java内存模型的作用"><a href="#Java内存模型的作用" class="headerlink" title="Java内存模型的作用"></a>Java内存模型的作用</h4><p>Java内存模型是一套在多线程读写共享数据时,对共享数据的可见性、有序性、和原子性的规则和保<br>障。</p><p><code>synchronized</code>,<code>volatile</code></p><h4 id="CPU缓存-内存与Java内存模型的关系"><a href="#CPU缓存-内存与Java内存模型的关系" class="headerlink" title="CPU缓存,内存与Java内存模型的关系"></a>CPU缓存,内存与Java内存模型的关系</h4><p>通过对前面的CPU硬件内存架构、Java内存模型以及Java多线程的实现原理的了解,我们应该已经意识<br>到,多线程的执行最终都会映射到硬件处理器上进行执行。</p><p>但Java内存模型和硬件内存架构并不完全一致。对于硬件内存来说只有寄存器、缓存内存、主内存的概<br>念,并没有工作内存和主内存之分,也就是说Java内存模型对内存的划分对硬件内存并没有任何影响,<br>因为JMM只是一种抽象的概念,是一组规则,不管是工作内存的数据还是主内存的数据,对于计算机硬<br>件来说都会存储在计算机主内存中,当然也有可能存储到CPU缓存或者寄存器中,因此总体上来说,<br>Java内存模型和计算机硬件内存架构是一个相互交叉的关系,是一种抽象概念划分与真实物理硬件的交<br>叉。</p><p><font color="red">JMM内存模型与CPU硬件内存架构的关系：</font></p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/8.png" class=""></div><h4 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h4><p>Java内存模型是一套规范,描述了Java程序中各种变量(线程共享变量)的访问规则,以及在JVM中将变量<br>存储到内存和从内存中读取变量这样的底层细节,Java内存模型是对共享数据的可见性、有序性、和原<br>子性的规则和保障。</p><h3 id="主内存与工作内存之间的交互"><a href="#主内存与工作内存之间的交互" class="headerlink" title="主内存与工作内存之间的交互"></a>主内存与工作内存之间的交互</h3><hr><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/9.png" class=""></div><h4 id="目标-5"><a href="#目标-5" class="headerlink" title="目标"></a>目标</h4><p>了解主内存与工作内存之间的数据交互过程</p><p>Java内存模型中定义了以下8种操作来完成,主内存与工作内存之间具体的交互协议,即一个变量如何<br>从主内存拷贝到工作内存、如何从工作内存同步回主内存之类的实现细节,虚拟机实现时必须保证下面<br>提及的每一种操作都是原子的、不可再分的。</p><p>对应如下的流程图：</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/10.png" class=""></div><p>注意：</p><ol><li>如果对一个变量执行lock操作,将会清空工作内存中此变量的值</li><li>对一个变量执行unlock操作之前,必须先把此变量同步到主内存中</li></ol><h4 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h4><p>主内存与工作内存之间的数据交互过程</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">lock -&gt; read -&gt; load -&gt; use -&gt; assign -&gt; store -&gt; write -&gt; unlock<br></code></pre></td></tr></table></figure><h2 id="第三章：synchronized保证三大特性"><a href="#第三章：synchronized保证三大特性" class="headerlink" title="第三章：synchronized保证三大特性"></a>第三章：synchronized保证三大特性</h2><p>synchronized能够保证在同一时刻最多只有一个线程执行该段代码,以达到保证并发安全的效果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (锁对象) &#123;<br>    <span class="hljs-comment">// 受保护资源;</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="synchronized与原子性"><a href="#synchronized与原子性" class="headerlink" title="synchronized与原子性"></a>synchronized与原子性</h3><hr><h4 id="目标-6"><a href="#目标-6" class="headerlink" title="目标"></a>目标</h4><p>学习使用synchronized保证原子性的原理</p><h4 id="使用synchronized保证原子性"><a href="#使用synchronized保证原子性" class="headerlink" title="使用synchronized保证原子性"></a>使用synchronized保证原子性</h4><p>案例演示:5个线程各执行1000次 i++;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo02_concurrent_problem;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * synchronized保证原子性操作</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 原子性（Atomicity）：在一次或多次操作中,要么所有的操作都执行并且不会受其他因素干扰而中</span><br><span class="hljs-comment"> * 断,要么所有的操作都不执行。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test02Atomicity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">increment</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>                <span class="hljs-keyword">synchronized</span> (obj)&#123;<br>                    number++;<br>                &#125;<br>            &#125;<br>        &#125;;<br><br>        List&lt;Thread&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(increment);<br>            t.start();<br>            list.add(t);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : list)&#123;<br>            t.join();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;number = &quot;</span> + number);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>    <span class="hljs-keyword">synchronized</span> (obj)&#123;<br>        number++;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="synchronized保证原子性的原理"><a href="#synchronized保证原子性的原理" class="headerlink" title="synchronized保证原子性的原理"></a>synchronized保证原子性的原理</h4><p>对number++;增加同步代码块后,保证同一时间只有一个线程操作number++;。就不会出现安全问题。</p><h4 id="小结-6"><a href="#小结-6" class="headerlink" title="小结"></a>小结</h4><p>synchronized保证原子性的原理,synchronized保证只有一个线程拿到锁,能够进入同步代码块。</p><h3 id="synchronized与可见性"><a href="#synchronized与可见性" class="headerlink" title="synchronized与可见性"></a>synchronized与可见性</h3><hr><h4 id="目标-7"><a href="#目标-7" class="headerlink" title="目标"></a>目标</h4><p>学习使用synchronized保证可见性的原理</p><h4 id="使用synchronized保证可见性"><a href="#使用synchronized保证可见性" class="headerlink" title="使用synchronized保证可见性"></a>使用synchronized保证可见性</h4><p>案例演示：一个线程根据boolean类型的标记flag, while循环,另一个线程改变这个flag变量的值,另<br>一个线程并不会停止循环。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo02_concurrent_problem;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * synchronized保证可见性操作</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 可见性（Visibility）：是指一个线程对共享变量进行修改,另一个线程立即得到修改后的最新值</span><br><span class="hljs-comment"> * 可见性演示</span><br><span class="hljs-comment"> *      一个线程对共享变量的修改,另一个线程不能立即得到最新值</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test01Visibility</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当写一个volatile变量时,JMM会把该线程本地内存中的变量强制刷新到主内存中去；</span><br><span class="hljs-comment">     *     这个写会操作会导致其他线程中的volatile变量缓存无效</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// private static volatile boolean run = true;</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">//线程2修改后线程1并没有结束,程序一直在运行</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (run)&#123;<br>                <span class="hljs-keyword">synchronized</span> (Test01Visibility.class)&#123;<br><br>                &#125;<br>                <span class="hljs-comment">// System.out.println(run);</span><br>            &#125;<br>        &#125;);<br><br>        t1.start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            run = <span class="hljs-literal">false</span>;<br>            System.out.println(<span class="hljs-string">&quot;时间到,线程2设置为false&quot;</span>);<br>        &#125;);<br>        t2.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="synchronized保证可见性的原理"><a href="#synchronized保证可见性的原理" class="headerlink" title="synchronized保证可见性的原理"></a>synchronized保证可见性的原理</h4><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/10.png" class=""></div><h4 id="小结-7"><a href="#小结-7" class="headerlink" title="小结"></a>小结</h4><p>synchronized保证可见性的原理,执行synchronized时,会对应lock原子操作会刷新工作内存中共享变<br>量的值</p><h3 id="synchronized与有序性"><a href="#synchronized与有序性" class="headerlink" title="synchronized与有序性"></a>synchronized与有序性</h3><hr><h4 id="目标-8"><a href="#目标-8" class="headerlink" title="目标"></a>目标</h4><p>学习使用synchronized保证有序性的原理</p><h4 id="为什么要重排序"><a href="#为什么要重排序" class="headerlink" title="为什么要重排序"></a>为什么要重排序</h4><p>为了提高程序的执行效率,编译器和CPU会对程序中代码进行重排序。</p><h5 id="as-if-serial语义"><a href="#as-if-serial语义" class="headerlink" title="as-if-serial语义"></a>as-if-serial语义</h5><p>as-if-serial语义的意思是：不管编译器和CPU如何重排序,必须保证在单线程情况下程序的结果是正确<br>的。</p><p>以下数据有依赖关系,不能重排序。</p><p>写后读：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a;<br></code></pre></td></tr></table></figure><p>写后写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p>读后写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p>编译器和处理器不会对存在数据依赖关系的操作做重排序,因为这种重排序会改变执行结果。但是,如<br>果操作之间不存在数据依赖关系,这些操作就可能被编译器和处理器重排序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;<br></code></pre></td></tr></table></figure><p>如上所示a和c之间存在数据依赖关系,同时b和c之间也存在数据依赖关系。因此在最终执行的指令序<br>列中,c不能被重排序到a和b的前面。但a和b之间没有数据依赖关系,编译器和处理器可以重排序a和b<br>之间的执行顺序。下面是该程序的两种执行顺序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//可以这样：</span><br><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;<br><br><span class="hljs-comment">//也可以重排序这样：</span><br><span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;<br></code></pre></td></tr></table></figure><h4 id="使用synchronized保证有序性"><a href="#使用synchronized保证有序性" class="headerlink" title="使用synchronized保证有序性"></a>使用synchronized保证有序性</h4><p>Test03Orderliness.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo02_concurrent_problem;<br><br><span class="hljs-keyword">import</span> org.openjdk.jcstress.annotations.*;<br><span class="hljs-keyword">import</span> org.openjdk.jcstress.infra.results.I_Result;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * synchronized保证有序性操作</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 有序性</span><br><span class="hljs-comment"> * 是指程序中代码的执行顺序,Java在编译时和运行时会对代码进行优化,会导致</span><br><span class="hljs-comment"> * 程序最终的执行顺序不一定就是我们编写代码时的顺序。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 出现0的结果就是线程2执行顺序出现问题</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@JCStressTest</span><br><span class="hljs-meta">@Outcome(id = &#123;&quot;1&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok1&quot;)</span><br><span class="hljs-meta">@Outcome(id = &#123;&quot;4&quot;&#125;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;danger1&quot;)</span><br><span class="hljs-meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;danger2&quot;)</span><br><span class="hljs-meta">@State</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test03Orderliness</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">ready</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-comment">//线程1</span><br>    <span class="hljs-meta">@Actor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor1</span><span class="hljs-params">(I_Result r)</span>&#123;<br>        <span class="hljs-keyword">synchronized</span> (obj)&#123;<br>            <span class="hljs-keyword">if</span>(ready)&#123;<br>                r.r1 = num + num;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                r.r1 = <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//线程2</span><br>    <span class="hljs-meta">@Actor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor2</span><span class="hljs-params">(I_Result r)</span>&#123;<br>        <span class="hljs-keyword">synchronized</span> (obj)&#123;<br>            num = <span class="hljs-number">2</span>;<br>            ready = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="synchronized保证有序性的原理"><a href="#synchronized保证有序性的原理" class="headerlink" title="synchronized保证有序性的原理"></a>synchronized保证有序性的原理</h4><p>synchronized后,虽然进行了重排序,保证只有一个线程会进入同步代码块,也能保证有序性。</p><h4 id="小结-8"><a href="#小结-8" class="headerlink" title="小结"></a>小结</h4><p>synchronized保证有序性的原理,我们加synchronized后,依然会发生重排序,只不过,我们有同步<br>代码块,可以保证只有一个线程执行同步代码中的代码。保证有序性</p><h2 id="第四章：synchronized的特性"><a href="#第四章：synchronized的特性" class="headerlink" title="第四章：synchronized的特性"></a>第四章：synchronized的特性</h2><h3 id="可重入特性"><a href="#可重入特性" class="headerlink" title="可重入特性"></a>可重入特性</h3><hr><h4 id="目标-9"><a href="#目标-9" class="headerlink" title="目标"></a>目标</h4><p>了解什么是可重入</p><p>了解可重入的原理</p><h4 id="什么是可重入"><a href="#什么是可重入" class="headerlink" title="什么是可重入"></a>什么是可重入</h4><p>一个线程可以多次执行synchronized,重复获取同一把锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo03_concurrent_problem;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>().start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>().start();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">synchronized</span> (MyThread.class)&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();<br>            System.out.println(name + <span class="hljs-string">&quot;进入了同步代码快2&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (MyThread.class)&#123;<br>            System.out.println(getName() + <span class="hljs-string">&quot;进入了同步代码快1&quot;</span>);<br><br>            <span class="hljs-comment">// synchronized (MyThread.class)&#123;</span><br>            <span class="hljs-comment">//     System.out.println(getName() + &quot;进入了同步代码快2&quot;);</span><br>            <span class="hljs-comment">// &#125;</span><br>            Demo01.test01();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="可重入原理"><a href="#可重入原理" class="headerlink" title="可重入原理"></a>可重入原理</h4><p>synchronized的锁对象中有一个计数器（recursions变量）会记录线程获得几次锁.</p><h4 id="可重入的好处"><a href="#可重入的好处" class="headerlink" title="可重入的好处"></a>可重入的好处</h4><ol><li>可以避免死锁</li><li>可以让我们更好的来封装代码</li></ol><h4 id="小结-9"><a href="#小结-9" class="headerlink" title="小结"></a>小结</h4><p>synchronized是可重入锁,内部锁对象中会有一个计数器记录线程获取几次锁啦,在执行完同步代码块<br>时,计数器的数量会-1,知道计数器的数量为0,就释放这个锁。</p><h3 id="不可中断特性"><a href="#不可中断特性" class="headerlink" title="不可中断特性"></a>不可中断特性</h3><hr><h4 id="目标-10"><a href="#目标-10" class="headerlink" title="目标"></a>目标</h4><p>学习synchronized不可中断特性</p><p>学习Lock的可中断特性</p><h4 id="什么是不可中断"><a href="#什么是不可中断" class="headerlink" title="什么是不可中断"></a>什么是不可中断</h4><p>一个线程获得锁后,另一个线程想要获得锁,必须处于阻塞或等待状态,如果第一个线程不释放锁,第<br>二个线程会一直阻塞或等待,不可被中断。</p><h4 id="synchronized不可中断演示"><a href="#synchronized不可中断演示" class="headerlink" title="synchronized不可中断演示"></a>synchronized不可中断演示</h4><p>synchronized是不可中断,处于阻塞状态的线程会一直等待锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo03_concurrent_problem;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 目标:演示synchronized不可中断</span><br><span class="hljs-comment"> *      1.定义一个Runnable</span><br><span class="hljs-comment"> *      2.在Runnable定义同步代码块</span><br><span class="hljs-comment"> *      3.先开启一个线程来执行同步代码块,保证不退出同步代码块</span><br><span class="hljs-comment"> *      4.后开启一个线程来执行同步代码块(阻塞状态)</span><br><span class="hljs-comment"> *      5.停止第二个线程</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo02_Uninterruptible</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">// 1.定义一个Runnable</span><br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>            <span class="hljs-comment">// 2.在Runnable定义同步代码块</span><br>            <span class="hljs-keyword">synchronized</span> (obj)&#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();<br>                System.out.println(name + <span class="hljs-string">&quot;进入同步代码块&quot;</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">8888888</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// 3.先开启一个线程来执行同步代码块,保证不退出同步代码块</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(run);<br>        t1.start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-comment">// 4.后开启一个线程来执行同步代码块(阻塞状态)</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(run);<br>        t2.start();<br>        <span class="hljs-comment">// 5.停止第二个线程</span><br>        System.out.println(<span class="hljs-string">&quot;停止线程前&quot;</span>);<br>        t2.interrupt();<br>        System.out.println(<span class="hljs-string">&quot;停止线程后&quot;</span>);<br><br>        System.out.println(t1.getState());<br>        System.out.println(t2.getState());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ReentrantLock可中断演示"><a href="#ReentrantLock可中断演示" class="headerlink" title="ReentrantLock可中断演示"></a>ReentrantLock可中断演示</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo03_concurrent_problem;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ReentrantLock可中断演示</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo03_Interruptible</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        test02();<br>    &#125;<br><br>    <span class="hljs-comment">// 演示Lock不可中断</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock.lock();<br>                System.out.println(name + <span class="hljs-string">&quot;获得锁,进入锁执行&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">88888</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>                System.out.println(name + <span class="hljs-string">&quot;释放锁&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(run);<br>        t1.start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(run);<br>        t2.start();<br><br>        System.out.println(<span class="hljs-string">&quot;停止t2线程前&quot;</span>);<br>        t2.interrupt();<br>        System.out.println(<span class="hljs-string">&quot;停止t2线程后&quot;</span>);<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        System.out.println(t1.getState());<br>        System.out.println(t2.getState());<br>    &#125;<br><br>    <span class="hljs-comment">//演示Lock可中断</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                b = lock.tryLock(<span class="hljs-number">3</span>, TimeUnit.SECONDS);<br>                <span class="hljs-keyword">if</span>(b) &#123;<br>                    System.out.println(name + <span class="hljs-string">&quot;获得锁,进入锁执行&quot;</span>);<br>                    Thread.sleep(<span class="hljs-number">88888</span>);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    System.out.println(name + <span class="hljs-string">&quot;在指定时间没有得到锁做其他操作&quot;</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span>(b)&#123;<br>                    lock.unlock();<br>                    System.out.println(name + <span class="hljs-string">&quot;释放锁&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(run);<br>        t1.start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(run);<br>        t2.start();<br><br>        <span class="hljs-comment">// System.out.println(&quot;停止t2线程前&quot;);</span><br>        <span class="hljs-comment">// t2.interrupt();</span><br>        <span class="hljs-comment">// System.out.println(&quot;停止t2线程后&quot;);</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">//</span><br>        Thread.sleep(<span class="hljs-number">5000</span>);<br>        System.out.println(t1.getState());<br>        System.out.println(t2.getState());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="小结-10"><a href="#小结-10" class="headerlink" title="小结"></a>小结</h4><p>不可中断是指,当一个线程获得锁后,另一个线程一直处于阻塞或等待状态,前一个线程不释放锁,后<br>一个线程会一直阻塞或等待,不可被中断。</p><p>synchronized属于不可被中断</p><p>Lock的lock方法是不可中断的</p><p>Lock的tryLock方法是可中断的</p><h2 id="第五章：synchronized原理"><a href="#第五章：synchronized原理" class="headerlink" title="第五章：synchronized原理"></a>第五章：synchronized原理</h2><h3 id="javap-反汇编"><a href="#javap-反汇编" class="headerlink" title="javap 反汇编"></a>javap 反汇编</h3><hr><h4 id="目标-11"><a href="#目标-11" class="headerlink" title="目标"></a>目标</h4><p>通过javap反汇编学习synchronized的原理</p><p>我们编写一个简单的synchronized代码,如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo04_concurrent_problem;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>            System.out.println(<span class="hljs-string">&quot;1&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们要看synchronized的原理,但是synchronized是一个关键字,看不到源码。我们可以将class文件<br>进行反汇编。</p><p>JDK自带的一个工具： javap ,对字节码进行反汇编,查看字节码指令。</p><p>在DOS命令行输入：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">javap -p -v -c .\target\classes\com\huajframe\demo04_concurrent_problem\Demo01.class<br></code></pre></td></tr></table></figure><p>反汇编后的效果如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs text">public static void main(java.lang.String[]);<br>    descriptor: ([Ljava/lang/String;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>      stack=2, locals=3, args_size=1<br>         0: getstatic     #2                  // Field obj:Ljava/lang/Object;<br>         3: dup<br>         4: astore_1<br>         5: monitorenter<br>         6: getstatic     #3                  // Field java/lang/System.out:Ljava/io/Print<br>Stream;<br>         9: ldc           #4                  // String 1<br>        11: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava<br>/lang/String;)V<br>        14: aload_1<br>        15: monitorexit<br>        16: goto          24<br>        19: astore_2<br>        20: aload_1<br>        21: monitorexit<br>        22: aload_2<br>        23: athrow<br>        24: return<br>      Exception table:<br>         from    to  target type<br>             6    16    19   any<br>            19    22    19   any<br>      LineNumberTable:<br>        line 6: 0<br>        line 7: 6<br>        line 8: 14<br>        line 9: 24<br>      LocalVariableTable:<br>        Start  Length  Slot  Name   Signature<br>            0      25     0  args   [Ljava/lang/String;<br>      StackMapTable: number_of_entries = 2<br>        frame_type = 255 /* full_frame */<br>          offset_delta = 19<br>          locals = [ class &quot;[Ljava/lang/String;&quot;, class java/lang/Object ]<br>          stack = [ class java/lang/Throwable ]<br>        frame_type = 250 /* chop */<br>          offset_delta = 4<br><br>  public synchronized void test();<br>    descriptor: ()V<br>    flags: ACC_PUBLIC, ACC_SYNCHRONIZED<br>    Code:<br>      stack=2, locals=1, args_size=1<br>         0: getstatic     #3                  // Field java/lang/System.out:Ljava/io/Print<br>Stream;<br>         3: ldc           #6                  // String a<br>         5: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava<br>/lang/String;)V<br>         8: return<br>      LineNumberTable:<br>        line 12: 0<br>        line 13: 8<br>      LocalVariableTable:<br>        Start  Length  Slot  Name   Signature<br>            0       9     0  this   Lcom/huajframe/demo04_concurrent_problem/Demo01;<br></code></pre></td></tr></table></figure><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/11.png" class=""></div><h4 id="monitorenter"><a href="#monitorenter" class="headerlink" title="monitorenter"></a>monitorenter</h4><p><strong>首先我们来看一下JVM规范中对于monitorenter的描述：</strong></p><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorenter">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorenter</a></p><blockquote><p>Each object is associated with a monitor. A monitor is locked if and only if it has an owner.<br>The thread that executes monitorenter attempts to gain ownership of the monitor<br>associated with objectref, as follows: • If the entry count of the monitor associated with<br>objectref is zero, the thread enters the monitor and sets its entry count to one. The thread<br>is then the owner of the monitor. • If the thread already owns the monitor associated with<br>objectref, it reenters the monitor, incrementing its entry count. • If another thread already owns the monitor associated with objectref, the thread blocks until the monitor’s<br>entry count is zero, then tries again to gain ownership.</p></blockquote><p>翻译过来： 每一个对象都会和一个监视器monitor关联。监视器被占用时会被锁住,其他线程无法来获<br>取该monitor。 当JVM执行某个线程的某个方法内部的monitorenter时,它会尝试去获取当前对象对应<br>的monitor的所有权。其过程如下：</p><ol><li>若monior的进入数为0,线程可以进入monitor,并将monitor的进入数置为1。当前线程成为<br>monitor的owner（所有者）</li><li>若线程已拥有monitor的所有权,允许它重入monitor,则进入monitor的进入数加1</li><li>若其他线程已经占有monitor的所有权,那么当前尝试获取monitor的所有权的线程会被阻塞,直<br>到monitor的进入数变为0,才能重新尝试获取monitor的所有权。</li></ol><p>monitorenter小结:</p><p>synchronized的锁对象会关联一个monitor,这个monitor不是我们主动创建的,是JVM的线程执行到这个<br>同步代码块,发现锁对象没有monitor就会创建monitor,monitor内部有两个重要的成员变量owner:拥有<br>这把锁的线程,recursions会记录线程拥有锁的次数,当一个线程拥有monitor后其他线程只能等待</p><h4 id="monitorexit"><a href="#monitorexit" class="headerlink" title="monitorexit"></a>monitorexit</h4><p><strong>首先我们来看一下JVM规范中对于monitorexit的描述：</strong><br><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorexit">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorexit</a></p><blockquote><p>The thread that executes monitorexit must be the owner of the monitor associated with the<br>instance referenced by objectref. The thread decrements the entry count of the monitor<br>associated with objectref. If as a result the value of the entry count is zero, the thread<br>exits the monitor and is no longer its owner. Other threads that are blocking to enter the<br>monitor are allowed to attempt to do so.</p></blockquote><p>翻译过来：</p><ol><li>能执行monitorexit指令的线程一定是拥有当前对象的monitor的所有权的线程。</li><li>执行monitorexit时会将monitor的进入数减1。当monitor的进入数减为0时,当前线程退出<br>monitor,不再拥有monitor的所有权,此时其他被这个monitor阻塞的线程可以尝试去获取这个<br>monitor的所有权</li></ol><p>monitorexit释放锁。</p><p>monitorexit插入在方法结束处和异常处,JVM保证每个monitorenter必须有对应的monitorexit。</p><blockquote><p>面试题synchroznied出现异常会释放锁吗?</p><p>会释放锁</p></blockquote><h4 id="同步方法"><a href="#同步方法" class="headerlink" title="同步方法"></a>同步方法</h4><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.11.10">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.11.10</a></p><p>可以看到同步方法在反汇编后,会增加ACC_SYNCHRONIZED 修饰。会隐式调用monitorenter和<br>monitorexit。在执行同步方法前会调用monitorenter,在执行完同步方法后会调用monitorexit。</p><h4 id="小结-11"><a href="#小结-11" class="headerlink" title="小结"></a>小结</h4><p>通过javap反汇编我们看到synchronized使用编程了monitorentor和monitorexit两个指令.每个锁对象<br>都会关联一个monitor(监视器,它才是真正的锁对象),它内部有两个重要的成员变量owner会保存获得锁<br>的线程,recursions会保存线程获得锁的次数,当执行到monitorexit时,recursions会-1,当计数器减到0时<br>这个线程就会释放锁</p><h4 id="面试题：synchronized与Lock的区别"><a href="#面试题：synchronized与Lock的区别" class="headerlink" title="面试题：synchronized与Lock的区别"></a>面试题：synchronized与Lock的区别</h4><ol><li>synchronized是关键字,而Lock是一个接口。</li><li>synchronized会自动释放锁,而Lock必须手动释放锁。</li><li>synchronized是不可中断的,Lock可以中断也可以不中断。</li><li>通过Lock可以知道线程有没有拿到锁,而synchronized不能。</li><li>synchronized能锁住方法和代码块,而Lock只能锁住代码块。</li><li>Lock可以使用读锁提高多线程读效率。</li><li>synchronized是非公平锁,ReentrantLock可以控制是否是公平锁。</li></ol><h3 id="深入JVM源码"><a href="#深入JVM源码" class="headerlink" title="深入JVM源码"></a>深入JVM源码</h3><hr><h4 id="目标-12"><a href="#目标-12" class="headerlink" title="目标"></a>目标</h4><p>通过JVM源码分析synchronized的原理</p><h4 id="JVM源码下载"><a href="#JVM源码下载" class="headerlink" title="JVM源码下载"></a>JVM源码下载</h4><p><a href="http://openjdk.java.net/">http://openjdk.java.net/</a>    –&gt; Mercurial –&gt; jdk8 –&gt; hotspot –&gt; zip</p><h4 id="IDE-Clion-下载"><a href="#IDE-Clion-下载" class="headerlink" title="IDE(Clion )下载"></a>IDE(Clion )下载</h4><p><a href="https://www.jetbrains.com/">https://www.jetbrains.com/</a></p><h4 id="monitor监视器锁"><a href="#monitor监视器锁" class="headerlink" title="monitor监视器锁"></a>monitor监视器锁</h4><p>可以看出无论是synchronized代码块还是synchronized方法,其线程安全的语义实现最终依赖一个叫<br>monitor的东西,那么这个神秘的东西是什么呢？下面让我们来详细介绍一下。</p><p>在HotSpot虚拟机中,monitor是由ObjectMonitor实现的。其源码是用c++来实现的,位于HotSpot虚<br>拟机源码ObjectMonitor.hpp文件中(src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;objectMonitor.hpp)。ObjectMonitor主<br>要数据结构如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">ObjectMonitor</span>() &#123;<br>    _header = <span class="hljs-literal">NULL</span>;<br>    _count = <span class="hljs-number">0</span>;<br>    _waiters = <span class="hljs-number">0</span>,<br>    _recursions = <span class="hljs-number">0</span>; <span class="hljs-comment">// 线程的重入次数</span><br>    _object = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 存储该monitor的对象</span><br>    _owner = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 标识拥有该monitor的线程</span><br>    _WaitSet = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 处于wait状态的线程,会被加入到_WaitSet</span><br>    _WaitSetLock = <span class="hljs-number">0</span> ;<br>    _Responsible = <span class="hljs-literal">NULL</span>;<br>    _succ = <span class="hljs-literal">NULL</span>;<br>    _cxq = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 多线程竞争锁时的单向列表</span><br>    FreeNext = <span class="hljs-literal">NULL</span>;<br>    _EntryList = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 处于等待锁block状态的线程,会被加入到该列表</span><br>    _SpinFreq = <span class="hljs-number">0</span>;<br>    _SpinClock = <span class="hljs-number">0</span>;<br>    OwnerIsThread = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>_owner：初始时为NULL。当有线程占有该monitor时,owner标记为该线程的唯一标识。当线程<br>释放monitor时,owner又恢复为NULL。owner是一个临界资源,JVM是通过CAS操作来保证其线<br>程安全的。</li><li>_cxq：竞争队列,所有请求锁的线程首先会被放在这个队列中（单向链接）。_cxq是一个临界资<br>源,JVM通过CAS原子指令来修改_cxq队列。修改前_cxq的旧值填入了node的next字段,_cxq指<br>向新值（新线程）。因此_cxq是一个后进先出的stack（栈）。</li><li>_EntryList：_cxq队列中有资格成为候选资源的线程会被移动到该队列中。</li><li>_WaitSet：因为调用wait方法而被阻塞的线程会被放在该队列中。</li></ol><p>每一个Java对象都可以与一个监视器monitor关联,我们可以把它理解成为一把锁,当一个线程想要执<br>行一段被synchronized圈起来的同步方法或者代码块时,该线程得先获取到synchronized修饰的对象<br>对应的monitor。</p><p>我们的Java代码里不会显示地去创造这么一个monitor对象,我们也无需创建,事实上可以这么理解：<br>monitor并不是随着对象创建而创建的。我们是通过synchronized修饰符告诉JVM需要为我们的某个对<br>象创建关联的monitor对象。每个线程都存在两个ObjectMonitor对象列表,分别为free和used列表。<br>同时JVM中也维护着global locklist。当线程需要ObjectMonitor对象时,首先从线程自身的free表中申<br>请,若存在则使用,若不存在则从global list中申请。</p><p>ObjectMonitor的数据结构中包含：_owner、_WaitSet和_EntryList,它们之间的关系转换可以用下图<br>表示：</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/12.png" class=""></div><h4 id="monitor竞争"><a href="#monitor竞争" class="headerlink" title="monitor竞争"></a>monitor竞争</h4><ol><li><p>执行monitorenter时,会调用InterpreterRuntime.cpp </p><p> (位于：src&#x2F;share&#x2F;vm&#x2F;interpreter&#x2F;interpreterRuntime.cpp) 的 InterpreterRuntime::monitorenter函<br>数。具体代码可参见HotSpot源码。</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">IRT_ENTRY_NO_ASYNC</span>(<span class="hljs-type">void</span>, InterpreterRuntime::<span class="hljs-built_in">monitorenter</span>(JavaThread* thread,<br>BasicObjectLock* elem))<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> ASSERT</span><br>    thread-&gt;<span class="hljs-built_in">last_frame</span>().<span class="hljs-built_in">interpreter_frame_verify_monitor</span>(elem);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">if</span> (PrintBiasedLockingStatistics) &#123;<br>        Atomic::<span class="hljs-built_in">inc</span>(BiasedLocking::<span class="hljs-built_in">slow_path_entry_count_addr</span>());<br>    &#125;<br>    <span class="hljs-function">Handle <span class="hljs-title">h_obj</span><span class="hljs-params">(thread, elem-&gt;obj())</span></span>;<br>    <span class="hljs-built_in">assert</span>(Universe::<span class="hljs-built_in">heap</span>()-&gt;<span class="hljs-built_in">is_in_reserved_or_null</span>(<span class="hljs-built_in">h_obj</span>()),<br>            <span class="hljs-string">&quot;must be NULL or an object&quot;</span>);<br>    <span class="hljs-keyword">if</span> (UseBiasedLocking) &#123;<br>        <span class="hljs-comment">// Retry fast entry if bias is revoked to avoid unnecessary inflation</span><br>        ObjectSynchronizer::<span class="hljs-built_in">fast_enter</span>(h_obj, elem-&gt;<span class="hljs-built_in">lock</span>(), <span class="hljs-literal">true</span>, CHECK);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ObjectSynchronizer::<span class="hljs-built_in">slow_enter</span>(h_obj, elem-&gt;<span class="hljs-built_in">lock</span>(), CHECK);<br>    &#125;<br>    <span class="hljs-built_in">assert</span>(Universe::<span class="hljs-built_in">heap</span>()-&gt;<span class="hljs-built_in">is_in_reserved_or_null</span>(elem-&gt;<span class="hljs-built_in">obj</span>()),<br>            <span class="hljs-string">&quot;must be NULL or an object&quot;</span>); <br></code></pre></td></tr></table></figure><ol start="2"><li>对于重量级锁,monitorenter函数中会调用 ObjectSynchronizer::slow_enter</li><li>最终调用 ObjectMonitor::enter（位于：src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;objectMonitor.cpp）,源码如下：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> ATTR <span class="hljs-title">ObjectMonitor::enter</span><span class="hljs-params">(TRAPS)</span> </span>&#123;<br>    <span class="hljs-comment">// The following code is ordered to check the most common cases first</span><br>    <span class="hljs-comment">// and to reduce RTS-&gt;RTO cache line upgrades on SPARC and IA32 processors.</span><br>    Thread * <span class="hljs-type">const</span> Self = THREAD ;<br>    <span class="hljs-type">void</span> * cur ;<br>    <br>    <span class="hljs-comment">// 通过CAS操作尝试把monitor的_owner字段设置为当前线程</span><br>    cur = Atomic::<span class="hljs-built_in">cmpxchg_ptr</span> (Self, &amp;_owner, <span class="hljs-literal">NULL</span>) ;<br>    <span class="hljs-keyword">if</span> (cur == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-comment">// Either ASSERT _recursions == 0 or explicitly set _recursions = 0.</span><br>        <span class="hljs-built_in">assert</span> (_recursions == <span class="hljs-number">0</span> , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">assert</span> (_owner == Self, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-comment">// CONSIDER: set or assert OwnerIsThread == 1</span><br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    <span class="hljs-comment">// 线程重入,recursions++</span><br>    <span class="hljs-keyword">if</span> (cur == Self) &#123;<br>        <span class="hljs-comment">// TODO-<span class="hljs-doctag">FIXME:</span> check for integer overflow! BUGID 6557169.</span><br>        _recursions ++ ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    <span class="hljs-comment">// 如果当前线程是第一次进入该monitor,设置_recursions为1,_owner为当前线程</span><br>    <span class="hljs-keyword">if</span> (Self-&gt;<span class="hljs-built_in">is_lock_owned</span> ((address)cur)) &#123;<br>        <span class="hljs-built_in">assert</span> (_recursions == <span class="hljs-number">0</span>, <span class="hljs-string">&quot;internal state error&quot;</span>);<br>        _recursions = <span class="hljs-number">1</span> ;<br>        <span class="hljs-comment">// Commute owner from a thread-specific on-stack BasicLockObject address to</span><br>        <span class="hljs-comment">// a full-fledged &quot;Thread *&quot;.</span><br>        _owner = Self ;<br>        OwnerIsThread = <span class="hljs-number">1</span> ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    <span class="hljs-comment">// 省略一些代码</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        jt-&gt;<span class="hljs-built_in">set_suspend_equivalent</span>();<br>        <span class="hljs-comment">// cleared by handle_special_suspend_equivalent_condition()</span><br>        <span class="hljs-comment">// or java_suspend_self()</span><br>        <span class="hljs-comment">// 如果获取锁失败,则等待锁的释放；</span><br>        <span class="hljs-built_in">EnterI</span> (THREAD) ;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ExitSuspendEquivalent</span>(jt)) <span class="hljs-keyword">break</span> ;<br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// We have acquired the contended monitor, but while we were</span><br>        <span class="hljs-comment">// waiting another thread suspended us. We don&#x27;t want to enter</span><br>        <span class="hljs-comment">// the monitor while suspended because that would surprise the</span><br>        <span class="hljs-comment">// thread that suspended us.</span><br>        <span class="hljs-comment">//</span><br>            _recursions = <span class="hljs-number">0</span> ;<br>        _succ = <span class="hljs-literal">NULL</span> ;<br>        <span class="hljs-built_in">exit</span> (<span class="hljs-literal">false</span>, Self) ;<br>        jt-&gt;<span class="hljs-built_in">java_suspend_self</span>();<br>    &#125;<br>    Self-&gt;<span class="hljs-built_in">set_current_pending_monitor</span>(<span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>此处省略锁的自旋优化等操作,统一放在后面synchronzied优化中说。</p><p>以上代码的具体流程概括如下：</p><ol><li>通过CAS尝试把monitor的owner字段设置为当前线程。</li><li>如果设置之前的owner指向当前线程,说明当前线程再次进入monitor,即重入锁,执行<br>recursions ++ ,记录重入的次数。</li><li>如果当前线程是第一次进入该monitor,设置recursions为1,_owner为当前线程,该线程成功获<br>得锁并返回。</li><li>如果获取锁失败,则等待锁的释放。</li></ol><h4 id="monitor等待"><a href="#monitor等待" class="headerlink" title="monitor等待"></a>monitor等待</h4><p>竞争失败等待调用的是ObjectMonitor对象的EnterI方法（位于：src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;objectMonitor.cpp）,源码如下所示：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> ATTR <span class="hljs-title">ObjectMonitor::EnterI</span> <span class="hljs-params">(TRAPS)</span> </span>&#123;<br>    Thread * Self = THREAD ;<br>    <span class="hljs-comment">// Try the lock - TATAS</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TryLock</span> (Self) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">assert</span> (_succ != Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">assert</span> (_owner == Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">assert</span> (_Responsible != Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TrySpin</span> (Self) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">assert</span> (_owner == Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">assert</span> (_succ != Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">assert</span> (_Responsible != Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    <span class="hljs-comment">// 省略部分代码</span><br>        <br>    <span class="hljs-comment">// 当前线程被封装成ObjectWaiter对象node,状态设置成ObjectWaiter::TS_CXQ；</span><br>    <span class="hljs-function">ObjectWaiter <span class="hljs-title">node</span><span class="hljs-params">(Self)</span> </span>;<br>    Self-&gt;_ParkEvent-&gt;<span class="hljs-built_in">reset</span>() ;<br>    node._prev = (ObjectWaiter *) <span class="hljs-number">0xBAD</span> ;<br>    node.TState = ObjectWaiter::TS_CXQ ;<br>    <br>    <span class="hljs-comment">// 通过CAS把node节点push到_cxq列表中</span><br>    ObjectWaiter * nxt ;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        node._next = nxt = _cxq ;<br>        <span class="hljs-keyword">if</span> (Atomic::<span class="hljs-built_in">cmpxchg_ptr</span> (&amp;node, &amp;_cxq, nxt) == nxt) <span class="hljs-keyword">break</span> ;<br>        <span class="hljs-comment">// Interference - the CAS failed because _cxq changed. Just retry.</span><br>        <span class="hljs-comment">// As an optional optimization we retry the lock.</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TryLock</span> (Self) &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">assert</span> (_succ != Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>            <span class="hljs-built_in">assert</span> (_owner == Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>            <span class="hljs-built_in">assert</span> (_Responsible != Self , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>            <span class="hljs-keyword">return</span> ;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 省略部分代码</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">// 线程在被挂起前做一下挣扎,看能不能获取到锁</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TryLock</span> (Self) &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span> ;<br>            <span class="hljs-built_in">assert</span> (_owner != Self, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>            <span class="hljs-keyword">if</span> ((SyncFlags &amp; <span class="hljs-number">2</span>) &amp;&amp; _Responsible == <span class="hljs-literal">NULL</span>) &#123;<br>            Atomic::<span class="hljs-built_in">cmpxchg_ptr</span> (Self, &amp;_Responsible, <span class="hljs-literal">NULL</span>) ;<br>        &#125;<br>        <span class="hljs-comment">// park self</span><br>        <span class="hljs-keyword">if</span> (_Responsible == Self || (SyncFlags &amp; <span class="hljs-number">1</span>)) &#123;<br>            <span class="hljs-built_in">TEVENT</span> (Inflated enter - park TIMED) ;<br>            Self-&gt;_ParkEvent-&gt;<span class="hljs-built_in">park</span> ((jlong) RecheckInterval) ;<br>            <span class="hljs-comment">// Increase the RecheckInterval, but clamp the value.</span><br>            RecheckInterval *= <span class="hljs-number">8</span> ;<br>        <span class="hljs-keyword">if</span> (RecheckInterval &gt; <span class="hljs-number">1000</span>) RecheckInterval = <span class="hljs-number">1000</span> ;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">TEVENT</span> (Inflated enter - park UNTIMED) ;<br>            <span class="hljs-comment">// 通过park将当前线程挂起,等待被唤醒</span><br>            Self-&gt;_ParkEvent-&gt;<span class="hljs-built_in">park</span>() ;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TryLock</span>(Self) &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span> ;<br>        <span class="hljs-comment">// 省略部分代码</span><br>    &#125;<br>    <span class="hljs-comment">// 省略部分代码</span><br>&#125;<br></code></pre></td></tr></table></figure><p>当该线程被唤醒时,会从挂起的点继续执行,通过ObjectMonitor::TryLock 尝试获取锁,TryLock方<br>法实现如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">ObjectMonitor::TryLock</span> <span class="hljs-params">(Thread * Self)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">void</span> * own = _owner ;<br>        <span class="hljs-keyword">if</span> (own != <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;<br>        <span class="hljs-keyword">if</span> (Atomic::<span class="hljs-built_in">cmpxchg_ptr</span> (Self, &amp;_owner, <span class="hljs-literal">NULL</span>) == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-comment">// Either guarantee _recursions == 0 or set _recursions = 0.</span><br>            <span class="hljs-built_in">assert</span> (_recursions == <span class="hljs-number">0</span>, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>            <span class="hljs-built_in">assert</span> (_owner == Self, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>            <span class="hljs-comment">// CONSIDER: set or assert that OwnerIsThread == 1</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> ;<br>        &#125;<br>        <span class="hljs-comment">// The lock had been free momentarily, but we lost the race to the lock.</span><br>        <span class="hljs-comment">// Interference -- the CAS failed.</span><br>        <span class="hljs-comment">// We can either return -1 or retry.</span><br>        <span class="hljs-comment">// Retry doesn&#x27;t make as much sense because the lock was just acquired.</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span> ;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上代码的具体流程概括如下：</p><ol><li>当前线程被封装成ObjectWaiter对象node,状态设置成ObjectWaiter::TS_CXQ。</li><li>在for循环中,通过CAS把node节点push到_cxq列表中,同一时刻可能有多个线程把自己的node<br>节点push到_cxq列表中。</li><li>node节点push到_cxq列表之后,通过自旋尝试获取锁,如果还是没有获取到锁,则通过park将当<br>前线程挂起,等待被唤醒。</li><li>当该线程被唤醒时,会从挂起的点继续执行,通过ObjectMonitor::TryLock 尝试获取锁。</li></ol><h4 id="monitor释放"><a href="#monitor释放" class="headerlink" title="monitor释放"></a>monitor释放</h4><p>当某个持有锁的线程执行完同步代码块时,会进行锁的释放,给其它线程机会执行同步代码,在<br>HotSpot中,通过退出monitor的方式实现锁的释放,并通知被阻塞的线程,具体实现位于<br>ObjectMonitor的exit方法中。（位于：src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;objectMonitor.cpp）,源码如下所示：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> ATTR <span class="hljs-title">ObjectMonitor::exit</span><span class="hljs-params">(<span class="hljs-type">bool</span> not_suspended, TRAPS)</span> </span>&#123;<br>    Thread * Self = THREAD ;<br>    <span class="hljs-comment">// 省略部分代码</span><br>    <span class="hljs-keyword">if</span> (_recursions != <span class="hljs-number">0</span>) &#123;<br>        _recursions--;   <span class="hljs-comment">// this is simple recursive enter</span><br>        <span class="hljs-built_in">TEVENT</span> (Inflated exit - recursive) ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    <span class="hljs-comment">// 省略部分代码</span><br>    ObjectWaiter * w = <span class="hljs-literal">NULL</span> ;<br>    <span class="hljs-type">int</span> QMode = Knob_QMode ;<br>    <span class="hljs-comment">// qmode = 2：直接绕过EntryList队列,从cxq队列中获取线程用于竞争锁</span><br>    <span class="hljs-keyword">if</span> (QMode == <span class="hljs-number">2</span> &amp;&amp; _cxq != <span class="hljs-literal">NULL</span>) &#123;<br>        w = _cxq ;<br>        <span class="hljs-built_in">assert</span> (w != <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">assert</span> (w-&gt;TState == ObjectWaiter::TS_CXQ, <span class="hljs-string">&quot;Invariant&quot;</span>) ;<br>        <span class="hljs-built_in">ExitEpilog</span> (Self, w) ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    <span class="hljs-comment">// qmode =3：cxq队列插入EntryList尾部；</span><br>    <span class="hljs-keyword">if</span> (QMode == <span class="hljs-number">3</span> &amp;&amp; _cxq != <span class="hljs-literal">NULL</span>) &#123;<br>        w = _cxq ;<br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-built_in">assert</span> (w != <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;Invariant&quot;</span>) ;<br>            ObjectWaiter * u = (ObjectWaiter *) Atomic::<span class="hljs-built_in">cmpxchg_ptr</span> (<span class="hljs-literal">NULL</span>,&amp;_cxq, w) ;<br>                <span class="hljs-keyword">if</span> (u == w) <span class="hljs-keyword">break</span> ;<br>                w = u ;<br>        &#125;<br>        <span class="hljs-built_in">assert</span> (w != <span class="hljs-literal">NULL</span> , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        ObjectWaiter * q = <span class="hljs-literal">NULL</span> ;<br>        ObjectWaiter * p ;<br>        <span class="hljs-keyword">for</span> (p = w ; p != <span class="hljs-literal">NULL</span> ; p = p-&gt;_next) &#123;<br>            <span class="hljs-built_in">guarantee</span> (p-&gt;TState == ObjectWaiter::TS_CXQ, <span class="hljs-string">&quot;Invariant&quot;</span>) ;<br>            p-&gt;TState = ObjectWaiter::TS_ENTER ;<br>            p-&gt;_prev = q ;<br>            q = p ;<br>        &#125;<br>        ObjectWaiter * Tail ;<br>        <span class="hljs-keyword">for</span> (Tail = _EntryList ; Tail != <span class="hljs-literal">NULL</span> &amp;&amp; Tail-&gt;_next != <span class="hljs-literal">NULL</span> ; Tail = Tail-&gt;_next) ;<br>        <span class="hljs-keyword">if</span> (Tail == <span class="hljs-literal">NULL</span>) &#123;<br>            _EntryList = w ;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Tail-&gt;_next = w ;<br>            w-&gt;_prev = Tail ;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// qmode =4：cxq队列插入到_EntryList头部</span><br>    <span class="hljs-keyword">if</span> (QMode == <span class="hljs-number">4</span> &amp;&amp; _cxq != <span class="hljs-literal">NULL</span>) &#123;<br>        w = _cxq ;<br>        <span class="hljs-keyword">for</span> (;;)&#123;<br>            <span class="hljs-built_in">assert</span>(w!=<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;Invariant&quot;</span>);<br>            ObjectWaiter*u=(ObjectWaiter*)Atomic::<span class="hljs-built_in">cmpxchg_ptr</span>(<span class="hljs-literal">NULL</span>,<br>            &amp;_cxq, w);<br>            <span class="hljs-keyword">if</span>(u==w)<span class="hljs-keyword">break</span>;<br>            w=u;<br>        &#125;<br><br>        <span class="hljs-built_in">assert</span> (w != <span class="hljs-literal">NULL</span> , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        ObjectWaiter * q = <span class="hljs-literal">NULL</span> ;<br>        ObjectWaiter * p ;<br>        <span class="hljs-keyword">for</span> (p = w ; p != <span class="hljs-literal">NULL</span> ; p = p-&gt;_next) &#123;<br>            <span class="hljs-built_in">guarantee</span> (p-&gt;TState == ObjectWaiter::TS_CXQ, <span class="hljs-string">&quot;Invariant&quot;</span>) ;<br>            p-&gt;TState = ObjectWaiter::TS_ENTER ;<br>            p-&gt;_prev = q ;<br>            q = p ;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (_EntryList != <span class="hljs-literal">NULL</span>) &#123;<br>            q-&gt;_next = _EntryList ;<br>            _EntryList-&gt;_prev = q ;<br>        &#125;<br>        _EntryList = w ;<br>    &#125;<br><br>    w = _EntryList ;<br>    <span class="hljs-keyword">if</span> (w != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">assert</span> (w-&gt;TState == ObjectWaiter::TS_ENTER, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">ExitEpilog</span> (Self, w) ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    w = _cxq ;<br>    <span class="hljs-keyword">if</span> (w == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">continue</span> ;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-built_in">assert</span> (w != <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;Invariant&quot;</span>) ;<br>        ObjectWaiter * u = (ObjectWaiter *) Atomic::<span class="hljs-built_in">cmpxchg_ptr</span> (<span class="hljs-literal">NULL</span>, &amp;_cxq,w) ;<br>        <span class="hljs-keyword">if</span> (u == w) <span class="hljs-keyword">break</span> ;<br>        w = u ;<br>    &#125;<br>    <span class="hljs-built_in">TEVENT</span> (Inflated exit - drain cxq into EntryList) ;<br>    <span class="hljs-built_in">assert</span> (w != <span class="hljs-literal">NULL</span> , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>    <span class="hljs-built_in">assert</span> (_EntryList == <span class="hljs-literal">NULL</span> , <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>    <span class="hljs-keyword">if</span> (QMode == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// QMode == 1 : drain cxq to EntryList, reversing order</span><br>        <span class="hljs-comment">// We also reverse the order of the list.</span><br>        ObjectWaiter * s = <span class="hljs-literal">NULL</span> ;<br>        ObjectWaiter * t = w ;<br>        ObjectWaiter * u = <span class="hljs-literal">NULL</span> ;<br>        <span class="hljs-keyword">while</span> (t != <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-built_in">guarantee</span> (t-&gt;TState == ObjectWaiter::TS_CXQ, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>            t-&gt;TState = ObjectWaiter::TS_ENTER ;<br>            u = t-&gt;_next ;<br>            t-&gt;_prev = u ;<br>            t-&gt;_next = s ;<br>            s = t;<br>            t = u ;<br>        &#125;<br>        _EntryList = s ;<br>        <span class="hljs-built_in">assert</span> (s != <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;invariant&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// QMode == 0 or QMode == 2</span><br>        _EntryList = w ;<br>        ObjectWaiter * q = <span class="hljs-literal">NULL</span> ;<br>        ObjectWaiter * p ;<br>        <span class="hljs-keyword">for</span> (p = w ; p != <span class="hljs-literal">NULL</span> ; p = p-&gt;_next) &#123;<br>            <span class="hljs-built_in">guarantee</span> (p-&gt;TState == ObjectWaiter::TS_CXQ, <span class="hljs-string">&quot;Invariant&quot;</span>) ;<br>            p-&gt;TState = ObjectWaiter::TS_ENTER ;<br>            p-&gt;_prev = q ;<br>            q = p ;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (_succ != <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">continue</span>;<br>    w = _EntryList ;<br>    <span class="hljs-keyword">if</span> (w != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">guarantee</span> (w-&gt;TState == ObjectWaiter::TS_ENTER, <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>        <span class="hljs-built_in">ExitEpilog</span> (Self, w) ;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>退出同步代码块时会让_recursions减1，当_recursions的值减为0时，说明线程释放了锁。</li><li>根据不同的策略（由QMode指定），从cxq或EntryList中获取头节点，通过<br>ObjectMonitor::ExitEpilog 方法唤醒该节点封装的线程，唤醒操作最终由unpark完成，实现<br>如下：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ObjectMonitor::ExitEpilog</span> <span class="hljs-params">(Thread * Self， ObjectWaiter * Wakee)</span> </span>&#123;<br>    <span class="hljs-built_in">assert</span> (_owner == Self， <span class="hljs-string">&quot;invariant&quot;</span>) ;<br>    _succ = Knob_SuccEnabled ? Wakee-&gt;_thread : <span class="hljs-literal">NULL</span> ;<br>    ParkEvent * Trigger = Wakee-&gt;_event ;<br>    Wakee = <span class="hljs-literal">NULL</span> ;<br>    <span class="hljs-comment">// Drop the lock</span><br>    OrderAccess::<span class="hljs-built_in">release_store_ptr</span> (&amp;_owner， <span class="hljs-literal">NULL</span>) ;<br>    OrderAccess::<span class="hljs-built_in">fence</span>() ; <span class="hljs-comment">// ST _owner vs LD in</span><br>    <span class="hljs-built_in">unpark</span>()<br>    <span class="hljs-keyword">if</span> (SafepointSynchronize::<span class="hljs-built_in">do_call_back</span>()) &#123;<br>        <span class="hljs-built_in">TEVENT</span> (unpark before SAFEPOINT) ;<br>    &#125;<br>    <span class="hljs-built_in">DTRACE_MONITOR_PROBE</span>(contended__exit， <span class="hljs-keyword">this</span>， <span class="hljs-built_in">object</span>()， Self);<br>    Trigger-&gt;<span class="hljs-built_in">unpark</span>() ; <span class="hljs-comment">// 唤醒之前被pack()挂起的线程.</span><br>    <span class="hljs-comment">// Maintain stats and report events to JVMTI</span><br>    <span class="hljs-keyword">if</span> (ObjectMonitor::_sync_Parks != <span class="hljs-literal">NULL</span>) &#123;<br>        ObjectMonitor::_sync_Parks-&gt;<span class="hljs-built_in">inc</span>() ;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>被唤醒的线程，会回到void ATTR ObjectMonitor::EnterI (TRAPS) 的第600行，继续执行monitor<br>的竞争</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// park self</span><br><span class="hljs-keyword">if</span> (_Responsible == Self || (SyncFlags &amp; <span class="hljs-number">1</span>)) &#123;<br>        <span class="hljs-built_in">TEVENT</span> (Inflated enter - park TIMED) ;<br>        Self-&gt;_ParkEvent-&gt;<span class="hljs-built_in">park</span> ((jlong) RecheckInterval) ;<br>        <span class="hljs-comment">// Increase the RecheckInterval， but clamp the value.</span><br>        RecheckInterval *= <span class="hljs-number">8</span> ;<br>        <span class="hljs-keyword">if</span> (RecheckInterval &gt; <span class="hljs-number">1000</span>) RecheckInterval = <span class="hljs-number">1000</span> ;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">TEVENT</span> (Inflated enter - park UNTIMED) ;<br>        Self-&gt;_ParkEvent-&gt;<span class="hljs-built_in">park</span>() ;<br>    &#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">TryLock</span>(Self) &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span> ;<br></code></pre></td></tr></table></figure><h4 id="monitor是重量级锁"><a href="#monitor是重量级锁" class="headerlink" title="monitor是重量级锁"></a>monitor是重量级锁</h4><p>可以看到ObjectMonitor的函数调用中会涉及到Atomic::cmpxchg_ptr，Atomic::inc_ptr等内核函数，<br>执行同步代码块，没有竞争到锁的对象会park()被挂起，竞争到锁的线程会unpark()唤醒。这个时候就<br>会存在操作系统用户态和内核态的转换，这种切换会消耗大量的系统资源。所以synchronized是Java语<br>言中是一个重量级(Heavyweight)的操作。</p><p>用户态和和内核态是什么东西呢？要想了解用户态和内核态还需要先了解一下Linux系统的体系架构：</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/13.png" class=""></div><p>从上图可以看出，Linux操作系统的体系架构分为：用户空间（应用程序的活动空间）和内核。</p><p>内核：本质上可以理解为一种软件，控制计算机的硬件资源，并提供上层应用程序运行的环境。</p><p>用户空间：上层应用程序活动的空间。应用程序的执行必须依托于内核提供的资源，包括CPU资源、存<br>储资源、I&#x2F;O资源等。</p><p>系统调用：为了使上层应用能够访问到这些资源，内核必须为上层应用提供访问的接口：即系统调用。</p><p>所有进程初始都运行于用户空间，此时即为用户运行状态（简称：用户态）；但是当它调用系统调用执<br>行某些操作时，例如 I&#x2F;O调用，此时需要陷入内核中运行，我们就称进程处于内核运行态（或简称为内<br>核态）。 系统调用的过程可以简单理解为：</p><ol><li>用户态程序将一些数据值放在寄存器中， 或者使用参数创建一个堆栈， 以此表明需要操作系统提<br>供的服务。</li><li>用户态程序执行系统调用。</li><li>CPU切换到内核态，并跳到位于内存指定位置的指令。</li><li>系统调用处理器(system call handler)会读取程序放入内存的数据参数，并执行程序请求的服务。</li><li>系统调用完成后，操作系统会重置CPU为用户态并返回系统调用的结果。</li></ol><p>由此可见用户态切换至内核态需要传递许多变量，同时内核还需要保护好用户态在切换时的一些寄存器<br>值、变量等，以备内核态切换回用户态。这种切换就带来了大量的系统资源消耗，这就是在<br>synchronized未优化之前，效率低的原因。</p><h2 id="第六章：JDK6-synchronized优化"><a href="#第六章：JDK6-synchronized优化" class="headerlink" title="第六章：JDK6 synchronized优化"></a>第六章：JDK6 synchronized优化</h2><h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><hr><h4 id="目标-13"><a href="#目标-13" class="headerlink" title="目标"></a>目标</h4><p>学习CAS的作用</p><p>学习CAS的原理</p><h4 id="CAS概述和作用"><a href="#CAS概述和作用" class="headerlink" title="CAS概述和作用"></a>CAS概述和作用</h4><p>CAS的全成是： Compare And Swap(比较相同再交换)。是现代CPU广泛支持的一种对内存中的共享数<br>据进行操作的一种特殊指令。</p><p>CAS的作用：CAS可以将比较和交换转换为原子操作，这个原子操作直接由CPU保证。CAS可以保证共<br>享变量赋值时的原子操作。CAS操作依赖3个值：内存中的值V，旧的预估值X，要修改的新值B，如果旧<br>的预估值X等于内存中的值V，就将新的值B保存到内存中。</p><h4 id="CAS和volatile实现无锁并发"><a href="#CAS和volatile实现无锁并发" class="headerlink" title="CAS和volatile实现无锁并发"></a>CAS和volatile实现无锁并发</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.huajframe.demo05_cas;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01</span> &#123;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>      <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">atomicInteger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();<br>      <span class="hljs-type">Runnable</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>         <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>            atomicInteger.incrementAndGet();<br>         &#125;<br>      &#125;;<br><br>      List&lt;Thread&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>      <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)&#123;<br>         <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(run);<br>         thread.start();<br>         list.add(thread);<br>      &#125;<br><br>      <span class="hljs-keyword">for</span>(Thread t : list)&#123;<br>         t.join();<br>      &#125;<br>      System.out.println(<span class="hljs-string">&quot;number = &quot;</span> + atomicInteger.get());<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CAS原理"><a href="#CAS原理" class="headerlink" title="CAS原理"></a>CAS原理</h4><p>通过刚才AtomicInteger的源码我们可以看到，Unsafe类提供了原子操作。</p><h4 id="Unsafe类介绍"><a href="#Unsafe类介绍" class="headerlink" title="Unsafe类介绍"></a>Unsafe类介绍</h4><p>Unsafe类使Java拥有了像C语言的指针一样操作内存空间的能力，同时也带来了指针的问题。过度的使<br>用Unsafe类会使得出错的几率变大，因此Java官方并不建议使用的，官方文档也几乎没有。Unsafe对<br>象不能直接调用，只能通过反射获得</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/14.png" class=""></div><h4 id="Unsafe实现CAS"><a href="#Unsafe实现CAS" class="headerlink" title="Unsafe实现CAS"></a>Unsafe实现CAS</h4><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/15.png" class=""></div><h4 id="乐观锁和悲观锁"><a href="#乐观锁和悲观锁" class="headerlink" title="乐观锁和悲观锁"></a>乐观锁和悲观锁</h4><p>悲观锁从悲观的角度出发：</p><p>总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这<br>样别人想拿这个数据就会阻塞。因此synchronized我们也将其称之为悲观锁。JDK中的ReentrantLock<br>也是一种悲观锁。性能较差！</p><p>乐观锁从乐观的角度出发:</p><p>总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，就算改了也没关系，再重试即可。所<br>以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去修改这个数据，如何没有人修改则更<br>新，如果有人修改则重试。</p><p>CAS这种机制我们也可以将其称之为乐观锁。综合性能较好！</p><blockquote><p>CAS获取共享变量时，为了保证该变量的可见性，需要使用volatile修饰。结合CAS和volatile可以<br>实现无锁并发，适用于竞争不激烈、多核 CPU 的场景下。</p><ol><li>因为没有使用 synchronized，所以线程不会陷入阻塞，这是效率提升的因素之一。</li><li>但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响。</li></ol></blockquote><h4 id="小结-12"><a href="#小结-12" class="headerlink" title="小结"></a>小结</h4><p>CAS的作用? Compare And Swap，CAS可以将比较和交换转换为原子操作，这个原子操作直接由处理<br>器保证。</p><p>CAS的原理？CAS需要3个值:内存地址V，旧的预期值A，要修改的新值B，如果内存地址V和旧的预期值<br>A相等就修改内存地址值为B</p><h3 id="synchronized锁升级过程"><a href="#synchronized锁升级过程" class="headerlink" title="synchronized锁升级过程"></a>synchronized锁升级过程</h3><hr><p>高效并发是从JDK 5到JDK 6的一个重要改进，HotSpot虛拟机开发团队在这个版本上花费了大量的精力<br>去实现各种锁优化技术，包括偏向锁( Biased Locking )、轻量级锁( Lightweight Locking )和如适应性<br>自旋(Adaptive Spinning)、锁消除( Lock Elimination)、锁粗化( Lock Coarsening )等，这些技术都是为<br>了在线程之间更高效地共享数据，以及解决竞争问题，从而提高程序的执行效率。</p><p>无锁–》偏向锁–》轻量级锁–》重量级锁</p><h3 id="Java对象的布局"><a href="#Java对象的布局" class="headerlink" title="Java对象的布局"></a>Java对象的布局</h3><hr><h4 id="目标-14"><a href="#目标-14" class="headerlink" title="目标"></a>目标</h4><p>学习Java对象的布局</p><p>术语参考: <a href="http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.html">http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.html</a></p><p>在JVM中，对象在内存中的布局分为三块区域：对象头、实例数据和对齐填充。如下图所示：</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/16.png" class=""></div><h4 id="对象头"><a href="#对象头" class="headerlink" title="对象头"></a>对象头</h4><p>当一个线程尝试访问synchronized修饰的代码块时，它首先要获得锁，那么这个锁到底存在哪里呢？是<br>存在锁对象的对象头中的。</p><p>HotSpot采用instanceOopDesc和arrayOopDesc来描述对象头，arrayOopDesc对象用来描述数组类<br>型。instanceOopDesc的定义的在Hotspot源码的 instanceOop.hpp 文件中，另外，arrayOopDesc<br>的定义对应 arrayOop.hpp 。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">instanceOopDesc</span> : <span class="hljs-keyword">public</span> oopDesc &#123;<br><span class="hljs-keyword">public</span>:<br>   <span class="hljs-comment">// aligned header size.</span><br>   <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">header_size</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">sizeof</span>(instanceOopDesc)/HeapWordSize; &#125;<br>   <span class="hljs-comment">// If compressed, the offset of the fields of the instance may not be aligned.</span><br>   <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">base_offset_in_bytes</span><span class="hljs-params">()</span> </span>&#123;<br>   <span class="hljs-comment">// offset computation code breaks if UseCompressedClassPointers</span><br>   <span class="hljs-comment">// only is true</span><br>   <span class="hljs-keyword">return</span> (UseCompressedOops &amp;&amp; UseCompressedClassPointers) ?<br>            <span class="hljs-built_in">klass_gap_offset_in_bytes</span>() :<br>            <span class="hljs-built_in">sizeof</span>(instanceOopDesc);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">contains_field_offset</span><span class="hljs-params">(<span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> nonstatic_field_size)</span> </span>&#123;<br>         <span class="hljs-type">int</span> base_in_bytes = <span class="hljs-built_in">base_offset_in_bytes</span>();<br>         <span class="hljs-keyword">return</span> (offset &gt;= base_in_bytes &amp;&amp;<br>                (offset-base_in_bytes) &lt; nonstatic_field_size * heapOopSize);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>从instanceOopDesc代码中可以看到 instanceOopDesc继承自oopDesc，oopDesc的定义载Hotspot<br>源码中的 oop.hpp 文件中。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">oopDesc</span> &#123;<br>   <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VMStructs</span>;<br>   <span class="hljs-keyword">private</span>:<br>      <span class="hljs-keyword">volatile</span> markOop _mark;<br>      <span class="hljs-keyword">union</span> <span class="hljs-title class_">_metadata</span> &#123;<br>         Klass* _klass;<br>         narrowKlass _compressed_klass;<br>      &#125; _metadata;<br>      <span class="hljs-comment">// Fast access to barrier set. Must be initialized.</span><br>      <span class="hljs-type">static</span> BarrierSet* _bs;<br>      <span class="hljs-comment">// 省略其他代码</span><br>&#125;;<br></code></pre></td></tr></table></figure><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/16.png" class=""></div><p>在普通实例对象中，oopDesc的定义包含两个成员，分别是 _mark 和 _metadata</p><p>_mark 表示对象标记、属于markOop类型，也就是接下来要讲解的Mark World，它记录了对象和锁有<br>关的信息</p><p>_metadata 表示类元信息，类元信息存储的是对象指向它的类元数据(Klass)的首地址，其中Klass表示<br>普通指针、 _compressed_klass 表示压缩类指针。</p><p>对象头由两部分组成，一部分用于存储自身的运行时数据，称之为 Mark Word，另外一部分是类型指<br>针，及对象指向它的类元数据的指针。</p><h4 id="Mark-Word"><a href="#Mark-Word" class="headerlink" title="Mark Word"></a>Mark Word</h4><p>Mark Word用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄、锁状态标志、<br>线程持有的锁、偏向线程ID、偏向时间戳等等，占用内存大小与虚拟机位长一致。Mark Word对应的类<br>型是markOop 。源码位于markOop.hpp 中。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// Bit-format of an object header (most significant first, big endian layout below):</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// 32 bits:</span><br><span class="hljs-comment">// --------</span><br><span class="hljs-comment">// hash:25 ------------&gt;| age:4 biased_lock:1 lock:2 (normal object)</span><br><span class="hljs-comment">// JavaThread*:23 epoch:2 age:4 biased_lock:1 lock:2 (biased object)</span><br><span class="hljs-comment">// size:32 ------------------------------------------&gt;| (CMS free block)</span><br><span class="hljs-comment">// PromotedObject*:29 ----------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// 64 bits:</span><br><span class="hljs-comment">// --------</span><br><span class="hljs-comment">// unused:25 hash:31 --&gt;| unused:1 age:4 biased_lock:1 lock:2 (normal object)</span><br><span class="hljs-comment">// JavaThread*:54 epoch:2 unused:1 age:4 biased_lock:1 lock:2 (biased object)</span><br><span class="hljs-comment">// PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span><br><span class="hljs-comment">// size:64 -----------------------------------------------------&gt;| (CMS free block)</span><br><span class="hljs-comment">// [JavaThread* | epoch | age | 1 | 01] lock is biased toward given thread</span><br><span class="hljs-comment">// [0 | epoch | age | 1 | 01] lock is anonymously biased</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// - the two lock bits are used to describe three states: locked/unlocked and monitor.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// [ptr | 00] locked ptr points to real header on stack</span><br><span class="hljs-comment">// [header | 0 | 01] unlocked regular object header</span><br><span class="hljs-comment">// [ptr | 10] monitor inflated lock (header is wapped out)</span><br><span class="hljs-comment">// [ptr | 11] marked used by markSweep to mark an object</span><br><span class="hljs-comment">// not valid at any other time</span><br></code></pre></td></tr></table></figure><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/17.png" class=""></div><p>在64位虚拟机下，Mark Word是64bit大小的，其存储结构如下：</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/18.png" class=""></div><p>在32位虚拟机下，Mark Word是32bit大小的，其存储结构如下：</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/19.png" class=""></div><h4 id="klass-pointer"><a href="#klass-pointer" class="headerlink" title="klass pointer"></a>klass pointer</h4><p>这一部分用于存储对象的类型指针，该指针指向它的类元数据，JVM通过这个指针确定对象是哪个类的<br>实例。该指针的位长度为JVM的一个字大小，即32位的JVM为32位，64位的JVM为64位。 如果应用的对<br>象过多，使用64位的指针将浪费大量内存，统计而言，64位的JVM将会比32位的JVM多耗费50%的内<br>存。为了节约内存可以使用选项-XX:+UseCompressedOops 开启指针压缩，其中，oop即ordinary<br>object pointer普通对象指针。开启该选项后，下列指针将压缩至32位：</p><ol><li>每个Class的属性指针（即静态变量）</li><li>每个对象的属性指针（即对象变量）</li><li>普通对象数组的每个元素指针</li></ol><p>当然，也不是所有的指针都会压缩，一些特殊类型的指针JVM不会优化，比如指向PermGen的Class对<br>象指针(JDK8中指向元空间的Class对象指针)、本地变量、堆栈元素、入参、返回值和NULL指针等。</p><p>对象头 &#x3D; Mark Word + 类型指针（未开启指针压缩的情况下）</p><p>在32位系统中，Mark Word &#x3D; 4 bytes，类型指针 &#x3D; 4bytes，对象头 &#x3D; 8 bytes &#x3D; 64 bits；</p><p>在64位系统中，Mark Word &#x3D; 8 bytes，类型指针 &#x3D; 8bytes，对象头 &#x3D; 16 bytes &#x3D; 128bits；</p><h4 id="实例数据"><a href="#实例数据" class="headerlink" title="实例数据"></a>实例数据</h4><p>就是类中定义的成员变量。</p><h4 id="对齐填充"><a href="#对齐填充" class="headerlink" title="对齐填充"></a>对齐填充</h4><p>对齐填充并不是必然存在的，也没有什么特别的意义，他仅仅起着占位符的作用，由于HotSpot VM的<br>自动内存管理系统要求对象起始地址必须是8字节的整数倍，换句话说，就是对象的大小必须是8字节的<br>整数倍。而对象头正好是8字节的倍数，因此，当对象实例数据部分没有对齐时，就需要通过对齐填充<br>来补全。</p><h4 id="查看Java对象布局"><a href="#查看Java对象布局" class="headerlink" title="查看Java对象布局"></a>查看Java对象布局</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jol<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jol-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="小结-13"><a href="#小结-13" class="headerlink" title="小结"></a>小结</h4><p>Java对象由3部分组成，对象头，实例数据，对齐数据</p><p>对象头分成两部分：Mark World + Klass pointer</p><h3 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h3><hr><h4 id="目标-15"><a href="#目标-15" class="headerlink" title="目标"></a>目标</h4><p>学习偏向锁的原理和好处</p><h4 id="什么是偏向锁"><a href="#什么是偏向锁" class="headerlink" title="什么是偏向锁"></a>什么是偏向锁</h4><p>偏向锁是JDK 6中的重要引进，因为HotSpot作者经过研究实践发现，在大多数情况下，锁不仅不存在多<br>线程竞争，而且总是由同一线程多次获得，为了让线程获得锁的代价更低，引进了偏向锁。</p><p>偏向锁的“偏”，就是偏心的“偏”、偏袒的“偏”，它的意思是这个锁会偏向于第一个获得它的线程，会在对<br>象头存储锁偏向的线程ID，以后该线程进入和退出同步块时只需要检查是否为偏向锁、锁标志位以及<br>ThreadID即可。</p><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/18.png" class=""></div><p>不过一旦出现多个线程竞争时必须撤销偏向锁，所以撤销偏向锁消耗的性能必须小于之前节省下来的<br>CAS原子操作的性能消耗，不然就得不偿失了。</p><h4 id="偏向锁原理"><a href="#偏向锁原理" class="headerlink" title="偏向锁原理"></a>偏向锁原理</h4><p>当线程第一次访问同步块并获取锁时，偏向锁处理流程如下：</p><blockquote><ol><li>虚拟机将会把对象头中的标志位设为“01”，即偏向模式。</li><li>同时使用CAS操作把获取到这个锁的线程的ID记录在对象的Mark Word之中 ，<br>如果CAS操作 成功，持有偏向锁的线程以后每次进入这个锁相关的同步块时，<br>虚拟机都可以不再进行任何 同步操作，偏向锁的效率高。</li></ol></blockquote><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/18.png" class=""></div><p>持有偏向锁的线程以后每次进入这个锁相关的同步块时，虚拟机都可以不再进行任何同步操作，偏向锁<br>的效率高。</p><h4 id="偏向锁的撤销"><a href="#偏向锁的撤销" class="headerlink" title="偏向锁的撤销"></a>偏向锁的撤销</h4><ol><li>偏向锁的撤销动作必须等待全局安全点</li><li>暂停拥有偏向锁的线程，判断锁对象是否处于被锁定状态</li><li>撤销偏向锁，恢复到无锁（标志位为 01）或轻量级锁（标志位为 00）的状态</li></ol><p>偏向锁在Java 6之后是默认启用的，但在应用程序启动几秒钟之后才激活，可以使用-<br>XX:BiasedLockingStartupDelay&#x3D;0 参数关闭延迟，如果确定应用程序中所有锁通常情况下处于竞争<br>状态，可以通过XX:-UseBiasedLocking&#x3D;false 参数关闭偏向锁。</p><h4 id="偏向锁好处"><a href="#偏向锁好处" class="headerlink" title="偏向锁好处"></a>偏向锁好处</h4><p>偏向锁是在只有一个线程执行同步块时进一步提高性能，适用于一个线程反复获得同一锁的情况。偏向<br>锁可以提高带有同步但无竞争的程序性能。</p><p>它同样是一个带有效益权衡性质的优化，也就是说，它并不一定总是对程序运行有利，如果程序中大多<br>数的锁总是被多个不同的线程访问比如线程池，那偏向模式就是多余的。</p><p>在JDK5中偏向锁默认是关闭的，而到了JDK6中偏向锁已经默认开启。但在应用程序启动几秒钟之后才<br>激活，可以使用-XX:BiasedLockingStartupDelay&#x3D;0 参数关闭延迟，如果确定应用程序中所有锁通常<br>情况下处于竞争状态，可以通过XX:-UseBiasedLocking&#x3D;false 参数关闭偏向锁。</p><h4 id="小结-14"><a href="#小结-14" class="headerlink" title="小结"></a>小结</h4><p>偏向锁的原理是什么?</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">当锁对象第一次被线程获取的时候，虚拟机将会把对象头中的标志位设为“01”，即偏向模式。同时使用CAS操<br>作把获取到这个锁的线程的ID记录在对象的Mark Word之中 ，如果CAS操作成功，持有偏向锁的线程以后每<br>次进入这个锁相关的同步块时，虚拟机都可以不再进行任何同步操作，偏向锁的效率高。<br></code></pre></td></tr></table></figure><p>偏向锁的好处是什么?</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">偏向锁是在只有一个线程执行同步块时进一步提高性能，适用于一个线程反复获得同一锁的情况。偏向锁可以<br>提高带有同步但无竞争的程序性能。<br></code></pre></td></tr></table></figure><h3 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h3><hr><h4 id="目标-16"><a href="#目标-16" class="headerlink" title="目标"></a>目标</h4><p>学习轻量级锁的原理和好处</p><h4 id="什么是轻量级锁"><a href="#什么是轻量级锁" class="headerlink" title="什么是轻量级锁"></a>什么是轻量级锁</h4><p>轻量级锁是JDK 6之中加入的新型锁机制，它名字中的“轻量级”是相对于使用monitor的传统锁而言的，<br>因此传统的锁机制就称为“重量级”锁。首先需要强调一点的是，轻量级锁并不是用来代替重量级锁的。</p><p>引入轻量级锁的目的：在多线程交替执行同步块的情况下，尽量避免重量级锁引起的性能消耗，但是如<br>果多个线程在同一时刻进入临界区，会导致轻量级锁膨胀升级重量级锁，所以轻量级锁的出现并非是要<br>替代重量级锁。</p><h4 id="轻量级锁原理"><a href="#轻量级锁原理" class="headerlink" title="轻量级锁原理"></a>轻量级锁原理</h4><p>当关闭偏向锁功能或者多个线程竞争偏向锁导致偏向锁升级为轻量级锁，则会尝试获取轻量级锁，其步<br>骤如下： 获取锁</p><ol><li>判断当前对象是否处于无锁状态（hashcode、0、01），如果是，则JVM首先将在当前线程的栈帧<br>中建立一个名为锁记录（Lock Record）的空间，用于存储锁对象目前的Mark Word的拷贝（官方<br>把这份拷贝加了一个Displaced前缀，即Displaced Mark Word），将对象的Mark Word复制到栈<br>帧中的Lock Record中，将Lock Reocrd中的owner指向当前对象。</li><li>JVM利用CAS操作尝试将对象的Mark Word更新为指向Lock Record的指针，如果成功表示竞争到<br>锁，则将锁标志位变成00，执行同步操作。</li><li>如果失败则判断当前对象的Mark Word是否指向当前线程的栈帧，如果是则表示当前线程已经持<br>有当前对象的锁，则直接执行同步代码块；否则只能说明该锁对象已经被其他线程抢占了，这时轻<br>量级锁需要膨胀为重量级锁，锁标志位变成10，后面等待的线程将会进入阻塞状态。</li></ol><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/20.png" class=""></div><h4 id="轻量级锁的释放"><a href="#轻量级锁的释放" class="headerlink" title="轻量级锁的释放"></a>轻量级锁的释放</h4><p>轻量级锁的释放也是通过CAS操作来进行的，主要步骤如下：</p><ol><li>取出在获取轻量级锁保存在Displaced Mark Word中的数据。</li><li>用CAS操作将取出的数据替换当前对象的Mark Word中，如果成功，则说明释放锁成功。</li><li>如果CAS操作替换失败，说明有其他线程尝试获取该锁，则需要将轻量级锁需要膨胀升级为重量级<br>锁。</li></ol><p>对于轻量级锁，其性能提升的依据是“对于绝大部分的锁，在整个生命周期内都是不会存在竞争的”，如<br>果打破这个依据则除了互斥的开销外，还有额外的CAS操作，因此在有多线程竞争的情况下，轻量级锁<br>比重量级锁更慢。</p><h4 id="轻量级锁好处"><a href="#轻量级锁好处" class="headerlink" title="轻量级锁好处"></a>轻量级锁好处</h4><p>在多线程交替执行同步块的情况下，可以避免重量级锁引起的性能消耗。</p><h4 id="小结-15"><a href="#小结-15" class="headerlink" title="小结"></a>小结</h4><p>轻量级锁的原理是什么？</p><p>将对象的Mark Word复制到栈帧中的Lock Recod中。Mark Word更新为指向Lock Record的指针。</p><p>轻量级锁好处是什么？</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">在多线程交替执行同步块的情况下，可以避免重量级锁引起的性能消耗。<br></code></pre></td></tr></table></figure><h3 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h3><hr><h4 id="目标-17"><a href="#目标-17" class="headerlink" title="目标"></a>目标</h4><p>学习自旋锁原理</p><h4 id="自旋锁原理"><a href="#自旋锁原理" class="headerlink" title="自旋锁原理"></a>自旋锁原理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (Demo01.class) &#123;<br>    ...<br>    System.out.println(<span class="hljs-string">&quot;aaa&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>前面我们讨论monitor实现锁的时候，知道monitor会阻塞和唤醒线程，线程的阻塞和唤醒需要CPU从<br>用户态转为核心态，频繁的阻塞和唤醒对CPU来说是一件负担很重的工作，这些操作给系统的并发性能<br>带来了很大的压力。同时，虚拟机的开发团队也注意到在许多应用上，共享数据的锁定状态只会持续很<br>短的一段时间，为了这段时间阻塞和唤醒线程并不值得。如果物理机器有一个以上的处理器，能让两个<br>或以上的线程同时并行执行，我们就可以让后面请求锁的那个线程“稍等一下”，但不放弃处理器的执行<br>时间，看看持有锁的线程是否很快就会释放锁。为了让线程等待，我们只需让线程执行一个忙循环(自<br>旋) , 这项技术就是所谓的自旋锁。</p><p>自旋锁在JDK 1.4.2中就已经引入 ，只不过默认是关闭的，可以使用-XX:+UseSpinning参数来开启，在<br>JDK 6中 就已经改为默认开启了。自旋等待不能代替阻塞，且先不说对处理器数量的要求，自旋等待本<br>身虽然避免了线程切换的开销，但它是要占用处理器时间的，因此，如果锁被占用的时间很短，自旋等<br>待的效果就会非常好，反之，如果锁被占用的时间很长。那么自旋的线程只会白白消耗处理器资源，而<br>不会做任何有用的工作，反而会带来性 能上的浪费。因此，自旋等待的时间必须要有一定的限度，如果<br>自旋超过了限定的次数仍然没有成功获得锁，就应当使用传统的方式去挂起线程了。自旋次数的默认值<br>是10次，用户可以使用参数-XX : PreBlockSpin来更改。</p><h4 id="适应性自旋锁"><a href="#适应性自旋锁" class="headerlink" title="适应性自旋锁"></a>适应性自旋锁</h4><p>在JDK 6中引入了自适应的自旋锁。自适应意味着自旋的时间不再固定了，而是由前一次在同一个锁上<br>的自旋时间及锁的拥有者的状态来决定。如果在同一个锁对象上，自旋等待刚刚成功获得过锁，并且持<br>有锁的线程正在运行中，那么虚拟机就会认为这次自旋也很有可能再次成功，进而它将允许自旋等待持<br>续相对更长的时间，比如100次循环。另外，如果对于某个锁，自旋很少成功获得过，那在以后要获取<br>这个锁时将可能省略掉自旋过程，以避免浪费处理器资源。有了自适应自旋，随着程序运行和性能监控<br>信息的不断完善，虚拟机对程序锁的状况预测就会越来越准确，虛拟机就会变得越来越“聪明”了。</p><h3 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h3><hr><h4 id="目标-18"><a href="#目标-18" class="headerlink" title="目标"></a>目标</h4><p>学习如何进行锁消除</p><p>锁消除是指虚拟机即时编译器（JIT）在运行时，对一些代码上要求同步，但是被检测到不可能存在共享<br>数据竞争的锁进行消除。锁消除的主要判定依据来源于逃逸分析的数据支持，如果判断在一段代码中，<br>堆上的所有数据都不会逃逸出去从而被其他线程访问到，那就可以把它们当做栈上数据对待，认为它们<br>是线程私有的，同步加锁自然就无须进行。变量是否逃逸，对于虚拟机来说需要使用数据流分析来确<br>定，但是程序员自己应该是很清楚的，怎么会在明知道不存在数据争用的情况下要求同步呢?实际上有<br>许多同步措施并不是程序员自己加入的，同步的代码在Java程序中的普遍程度也许超过了大部分读者的<br>想象。下面这段非常简单的代码仅仅是输出3个字符串相加的结果，无论是源码字面上还是程序语义上<br>都没有同步。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        contactString(<span class="hljs-string">&quot;aa&quot;</span>, <span class="hljs-string">&quot;bb&quot;</span>, <span class="hljs-string">&quot;cc&quot;</span>);<br>   &#125;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">contactString</span><span class="hljs-params">(String s1, String s2, String s3)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>().append(s1).append(s2).append(s3).toString();<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>StringBuffer的append ( ) 是一个同步方法，锁就是this也就是(new StringBuilder())。虚拟机发现它的<br>动态作用域被限制在concatString( )方法内部。也就是说, new StringBuilder()对象的引用永远不会“逃<br>逸”到concatString ( )方法之外，其他线程无法访问到它，因此，虽然这里有锁，但是可以被安全地消除<br>掉，在即时编译之后，这段代码就会忽略掉所有的同步而直接执行了。</p><h3 id="锁粗化"><a href="#锁粗化" class="headerlink" title="锁粗化"></a>锁粗化</h3><hr><h4 id="目标-19"><a href="#目标-19" class="headerlink" title="目标"></a>目标</h4><p>学习锁粗化的原理</p><p>原则上，我们在编写代码的时候，总是推荐将同步块的作用范围限制得尽量小，只在共享数据的实际作<br>用域中才进行同步，这样是为了使得需要同步的操作数量尽可能变小，如果存在锁竞争，那等待锁的线<br>程也能尽快拿到锁。大部分情况下，上面的原则都是正确的，但是如果一系列的连续操作都对同一个对<br>象反复加锁和解锁，甚至加锁操作是出现在循环体中的，那即使没有线程竞争，频繁地进行互斥同步操<br>作也会导致不必要的性能损耗。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>            sb.append(<span class="hljs-string">&quot;aa&quot;</span>);<br>        &#125;<br>        System.out.println(sb.toString());<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="小结-16"><a href="#小结-16" class="headerlink" title="小结"></a>小结</h4><p>什么是锁粗化？JVM会探测到一连串细小的操作都使用同一个对象加锁，将同步代码块的范围放大，放<br>到这串操作的外面，这样只需要加一次锁即可。</p><h3 id="平时写代码如何对synchronized优化"><a href="#平时写代码如何对synchronized优化" class="headerlink" title="平时写代码如何对synchronized优化"></a>平时写代码如何对synchronized优化</h3><hr><h4 id="减少synchronized的范围"><a href="#减少synchronized的范围" class="headerlink" title="减少synchronized的范围"></a>减少synchronized的范围</h4><p>同步代码块中尽量短，减少同步代码块中代码的执行时间，减少锁的竞争</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (Demo01.class) &#123;<br>    System.out.println(<span class="hljs-string">&quot;aaa&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="降低synchronized锁的粒度"><a href="#降低synchronized锁的粒度" class="headerlink" title="降低synchronized锁的粒度"></a>降低synchronized锁的粒度</h4><p>将一个锁拆分为多个锁提高并发度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Hashtable</span> <span class="hljs-variable">hs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>hs.put(<span class="hljs-string">&quot;aa&quot;</span>, <span class="hljs-string">&quot;bb&quot;</span>);<br>hs.put(<span class="hljs-string">&quot;xx&quot;</span>, <span class="hljs-string">&quot;yy&quot;</span>);<br></code></pre></td></tr></table></figure><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/21.png" class=""></div><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/22.png" class=""></div><div align=center>    <img src="/2020/10/05/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3synchronized/23.png" class=""></div><h4 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h4><p><font color="red">读取时不加锁，写入和删除时加锁</font> </p><p>ConcurrentHashMap，CopyOnWriteArrayList和ConyOnWriteSet</p>]]></content>
    
    
    <categories>
      
      <category>Java并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>并发编程</tag>
      
      <tag>多线程</tag>
      
      <tag>同步锁</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java泛型和泛型通配符</title>
    <link href="/2020/10/02/Java%E5%9F%BA%E7%A1%80/Java%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%B3%9B%E5%9E%8B%E9%80%9A%E9%85%8D%E7%AC%A6/"/>
    <url>/2020/10/02/Java%E5%9F%BA%E7%A1%80/Java%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%B3%9B%E5%9E%8B%E9%80%9A%E9%85%8D%E7%AC%A6/</url>
    
    <content type="html"><![CDATA[<h3 id="1-泛型"><a href="#1-泛型" class="headerlink" title="1 泛型"></a>1 泛型</h3><h4 id="1-1-什么是泛型"><a href="#1-1-什么是泛型" class="headerlink" title="1.1 什么是泛型"></a>1.1 什么是泛型</h4><p>泛型是 Java SE5 出现的新特性，泛型的本质是<strong>类型参数化或参数化类型</strong>，在不创建新的类型的情况下，通过泛型指定的不同类型来控制形参具体限制的类型。</p><h4 id="1-2-泛型的好处"><a href="#1-2-泛型的好处" class="headerlink" title="1.2 泛型的好处"></a>1.2 泛型的好处</h4><p>在没有泛型的情况的下，通过对类型 Object 的引用来实现参数的“任意化”，“任意化”带来的缺点是要做显式的强制类型转换，而这种转换是要求开发者对实际参数类型可以预知的情况下进行的。对于强制类型转换错误的情况，编译器可能不提示错误，在运行的时候才出现异常，这是本身就是一个安全隐患。</p><p>那么泛型的好处就是在编译的时候能够检查类型安全，并且所有的强制转换都是自动和隐式的。</p><h4 id="1-3-泛型的使用方式"><a href="#1-3-泛型的使用方式" class="headerlink" title="1.3 泛型的使用方式"></a>1.3 泛型的使用方式</h4><p><strong>泛型类，泛型接口，泛型方法</strong></p><h5 id="1-3-1-泛型类"><a href="#1-3-1-泛型类" class="headerlink" title="1.3.1 泛型类"></a>1.3.1 泛型类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Generic</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">private</span> T key;<br><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKey</span><span class="hljs-params">(T key)</span> &#123;<br>        <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里的T可以换成任意标识符，但约定俗成的常用<code>E,T,K,N,V,?</code>表示</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">E</span><span class="hljs-operator">-</span><span class="hljs-built_in">Element</span>（在集合中使用，因为集合中存放的是元素）<br><span class="hljs-variable">T</span><span class="hljs-operator">-</span><span class="hljs-variable">Type</span>（<span class="hljs-variable">Java</span>类）<br><span class="hljs-built_in">K</span><span class="hljs-operator">-</span><span class="hljs-built_in">Key</span>（键）<br><span class="hljs-built_in">N</span><span class="hljs-operator">-</span><span class="hljs-built_in">Number</span>（数值类型）<br><span class="hljs-variable">V</span><span class="hljs-operator">-</span><span class="hljs-built_in">Value</span><span class="hljs-punctuation">(</span>值<span class="hljs-punctuation">)</span><br><span class="hljs-operator">?-</span>表示不确定的<span class="hljs-variable">java</span>类型<br></code></pre></td></tr></table></figure><p>如何实例化泛型类:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java">Generic&lt;String&gt; generic = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generic</span>&lt;String&gt;();<br></code></pre></td></tr></table></figure><h5 id="1-3-2-泛型接口"><a href="#1-3-2-泛型接口" class="headerlink" title="1.3.2.泛型接口"></a>1.3.2.泛型接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Generator</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>实现泛型接口，不指定类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneratorImpl</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Generator</span>&lt;T&gt;&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">method</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>实现泛型接口，指定类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneratorImpl</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Generator</span>&lt;String&gt;&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">method</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;szh&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="1-3-3-泛型方法"><a href="#1-3-3-泛型方法" class="headerlink" title="1.3.3 泛型方法"></a>1.3.3 泛型方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">printList</span><span class="hljs-params">(List&lt;E&gt; list)</span>&#123;<br>    <span class="hljs-keyword">for</span> (E e : list) &#123;<br>        System.out.println(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//创建不同类型的list----String和Integer</span><br>List&lt;String&gt; strings = Arrays.asList(<span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;z&quot;</span>, <span class="hljs-string">&quot;h&quot;</span>);<br>List&lt;Integer&gt; integers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);<br>printList(strings);<br>printList(integers);<br></code></pre></td></tr></table></figure><p>注意: <code>public static &lt;E&gt; void printList(List&lt;E&gt; list)</code> 一般被称为静态泛型方法;在 java 中泛型只是一个占位符，必须在传递类型后才能使用。类在实例化时才能真正的传递类型参数，由于静态方法的加载先于类的实例化，也就是说类中的泛型还没有传递真正的类型参数，静态的方法的加载就已经完成了，所以静态泛型方法是没有办法使用类上声明的泛型的。只能使用自己声明的 <code>&lt;E&gt;</code></p><h3 id="2-泛型的通配符"><a href="#2-泛型的通配符" class="headerlink" title="2 泛型的通配符"></a>2 泛型的通配符</h3><h4 id="2-1-无界通配符-lt-gt"><a href="#2-1-无界通配符-lt-gt" class="headerlink" title="2.1 无界通配符&lt;?&gt;"></a>2.1 无界通配符<code>&lt;?&gt;</code></h4><p>我有一个父类 <code>Fruit</code> 和几个子类，如<code>Apple</code>,<code>Pear</code>等，现在我需要一个水果的列表，我的第一个想法是像这样的：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">List<span class="hljs-tag">&lt;<span class="hljs-name">Fruit</span>&gt;</span> Fruits<br></code></pre></td></tr></table></figure><p>但是老板的想法确实这样的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">List<span class="hljs-meta">&lt;?</span> <span class="hljs-keyword">extends</span> Fruit&gt; fruits<br></code></pre></td></tr></table></figure><p>为什么要使用通配符而不是简单的泛型呢？通配符其实在声明局部变量时是没有什么意义的，但是当你为一个方法声明一个参数时，它是非常重要的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countFruits</span><span class="hljs-params">(List&lt;? extends Fruit&gt; fruits)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Fruit fruit : fruits) &#123;<br>        System.out.println(fruit.getName());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countFruits1</span><span class="hljs-params">(List&lt;Fruit&gt; fruits)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Fruit fruit : fruits) &#123;<br>        System.out.println(fruit.getName());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    List&lt;Apple&gt; apples = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// 不会报错</span><br>    countFruits(apples);<br>    <span class="hljs-comment">// 报错</span><br>    countFruits1(apples);<br>&#125;<br></code></pre></td></tr></table></figure><p>运行后提示：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java: 不兼容的类型: java<span class="hljs-selector-class">.util</span>.List&lt;fanxing<span class="hljs-selector-class">.demo05</span>.Apple&gt;无法转换为<br>java<span class="hljs-selector-class">.util</span>.List&lt;fanxing<span class="hljs-selector-class">.demo05</span>.Fruit&gt;<br></code></pre></td></tr></table></figure><p>所以，对于不确定或者不关心实际要操作的类型，可以使用无限制通配符<code>&lt;?&gt;</code>，表示可以持有任何类型。<code>countFruits</code>方法中，限定了上届，但是不关心具体类型是什么，所以对于传入的<code>Fruit</code>的所有子类都可以支持，并且不会报错。而 <code>countFruits1</code> 就不行。**<code>LIst&lt;?&gt;</code>相当于<code>LIst&lt;? extends Object&gt;</code>**</p><h4 id="2-2-上界通配符-lt-extends-E-gt"><a href="#2-2-上界通配符-lt-extends-E-gt" class="headerlink" title="2.2 上界通配符 &lt; ? extends E&gt;"></a>2.2 上界通配符 <code>&lt; ? extends E&gt;</code></h4><p>在类型参数中使用 extends 表示这个泛型中的参数必须是 E 或者 E 的子类，这样有两个好处：</p><ul><li>如果传入的类型不是 E 或者 E 的子类，编译不成功</li><li>泛型中可以使用 E 的方法，要不然还得强转成 E 才能使用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(List&lt;? extends Number&gt; numbers)</span>&#123;<br>        <span class="hljs-keyword">for</span> (Number number : numbers) &#123;<br>            System.out.println(number);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Test</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br>        List&lt;Integer&gt; integers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>));<br>        <span class="hljs-comment">//通过</span><br>        test.print(integers);<br><br>        List&lt;Double&gt; doubles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-number">1D</span>,<span class="hljs-number">2D</span>,<span class="hljs-number">3D</span>));<br>        <span class="hljs-comment">//通过</span><br>        test.print(doubles);<br><br>        List&lt;String&gt; strings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;z&quot;</span>, <span class="hljs-string">&quot;h&quot;</span>));<br>        <span class="hljs-comment">//不通过</span><br>        <span class="hljs-comment">// test.print(strings);</span><br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>上述代码中<code>print</code>方法只能传入<code>Number</code>及<code>Number</code>子类的集合，传入<code>String</code>的集合后编译不通过</li></ul><p><strong>注意</strong>：<br>对于上限通配符需要注意的一点就是使用上限通配符<strong>只能从结构中获取值而不能将值放入结构中</strong>。比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java">List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fruit</span>&gt; ls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-type">Apple</span> <span class="hljs-variable">apple</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Apple</span>();<br><span class="hljs-type">Pear</span> <span class="hljs-variable">pear</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pear</span>();<br><span class="hljs-type">Fruit</span> <span class="hljs-variable">fruit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fruit</span>();<br><span class="hljs-comment">//报错</span><br>ls.add(fruit);<br><span class="hljs-comment">//报错</span><br>ls.add(apple);<br><span class="hljs-comment">//报错</span><br>ls.add(pear);<br><span class="hljs-comment">//不报错</span><br><span class="hljs-type">Fruit</span> <span class="hljs-variable">fruit1</span> <span class="hljs-operator">=</span> ls.get(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h4 id="2-3-下界通配符-lt-super-E-gt"><a href="#2-3-下界通配符-lt-super-E-gt" class="headerlink" title="2.3 下界通配符 &lt;? super E&gt;"></a>2.3 下界通配符 <code>&lt;? super E&gt;</code></h4><p>顾名思义，下界通配符就是已经规定好了下界，只能传入参数必须是<code>E</code>或者是<code>E</code>的父类。</p><p>如下是一个三级继承</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e6b329d3a1f410f828323594ef6fd2f~tplv-k3u1fbpfcp-watermark.image" alt="屏幕截图 2022-10-06 160330.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(List&lt;? <span class="hljs-built_in">super</span> Pear&gt; pears)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;----&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Test2</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test2</span>();<br>        List&lt;Fruit&gt; fruits = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//通过</span><br>        test.print(fruits);<br><br>        List&lt;Pear&gt; pears = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//通过</span><br>        test.print(pears);<br><br>        List&lt;FragrantPear&gt; fragrantPears = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//不通过</span><br>        test.print(fragrantPears);<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上代码可见<code>Pear</code>及其父类的集合可以传入<code>print</code>方法中，但是<code>Pear</code>的子类<code>FragrantPear</code>的集合却不行。</p><p><strong>注意</strong>：<br>对于下限通配符需要注意的一点就是使用下限通配符<strong>只能将值放入结构中或者将读取结果转换为Object</strong>。比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java">List&lt;? <span class="hljs-built_in">super</span> Fruit&gt; ls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-type">Apple</span> <span class="hljs-variable">apple</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Apple</span>();<br><span class="hljs-type">Pear</span> <span class="hljs-variable">pear</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pear</span>();<br><span class="hljs-type">Fruit</span> <span class="hljs-variable">fruit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fruit</span>();<br><span class="hljs-comment">//不报错</span><br>ls.add(fruit);<br><span class="hljs-comment">//不报错</span><br>ls.add(apple);<br><span class="hljs-comment">//不报错</span><br>ls.add(pear);<br><span class="hljs-comment">//不报错</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> ls.get(<span class="hljs-number">1</span>);<br><span class="hljs-comment">//不报错</span><br><span class="hljs-type">Fruit</span> <span class="hljs-variable">fruit1</span> <span class="hljs-operator">=</span> (Fruit) ls.get(<span class="hljs-number">0</span>);<br><span class="hljs-comment">//报错</span><br><span class="hljs-type">Fruit</span> <span class="hljs-variable">fruit2</span> <span class="hljs-operator">=</span> ls.get(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h4 id="2-4-多重边界限定"><a href="#2-4-多重边界限定" class="headerlink" title="2.4 多重边界限定"></a>2.4 多重边界限定</h4><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">public static &lt;<span class="hljs-built_in">T</span> extends Number &amp; Comparable&lt;<span class="hljs-built_in">T</span>&gt;&gt; <span class="hljs-built_in">T</span> maximum(<span class="hljs-built_in">T</span> x, <span class="hljs-built_in">T</span> y, <span class="hljs-built_in">T</span> z)<br></code></pre></td></tr></table></figure><p>T是传递给泛型类的类型参数应该是Number类的子类型，并且必须包含Comparable接口。<br>如果一个类作为绑定传递，它应该在接口之前先传递，否则编译时会发生错误。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericMoreTypeExtends</span> &#123; <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123; <br>        System.out.println(maxMum(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)); <br>        System.out.println(maxMum(<span class="hljs-number">1.1</span>,<span class="hljs-number">2.2</span>,<span class="hljs-number">3.3</span>)); <br>    &#125; <br>    <br>    <span class="hljs-comment">//限制类型参数T必须实现Comparable 和 必须是Number的子类，限制上界 </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Number</span> &amp; Comparable&lt;T&gt;&gt; T <span class="hljs-title function_">maxMum</span><span class="hljs-params">(T x, T y, T z)</span> &#123; <br>        <span class="hljs-type">T</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> x; <br>        <span class="hljs-keyword">if</span> (y.compareTo(max) &gt; <span class="hljs-number">0</span>) &#123; <br>            max = y; <br>        &#125; <br>        <span class="hljs-keyword">if</span> (z.compareTo(max) &gt; <span class="hljs-number">0</span>) &#123; <br>            max = z; <br>        &#125; <br>        <span class="hljs-keyword">return</span> max; <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>而<code>System.out.println(maxMum(&quot;s&quot;,&quot;z&quot;,&quot;h&quot;));</code>编译则不会通过!</p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java的String学习总结</title>
    <link href="/2020/09/28/Java%E5%9F%BA%E7%A1%80/Java%E7%9A%84String%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/"/>
    <url>/2020/09/28/Java%E5%9F%BA%E7%A1%80/Java%E7%9A%84String%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h3 id="1-String是不可变的"><a href="#1-String是不可变的" class="headerlink" title="1 String是不可变的"></a>1 <code>String</code>是不可变的</h3><h4 id="1-1-首先String是不可变的，具体原因主要有以下两点"><a href="#1-1-首先String是不可变的，具体原因主要有以下两点" class="headerlink" title="1.1 首先String是不可变的，具体原因主要有以下两点"></a>1.1 首先<code>String</code>是不可变的，具体原因主要有以下两点</h4><ol><li><code>String</code>中保存字符串的数组被<code>final</code>修饰且是私有属性，而且<code>String</code>没有暴露给外界任何可以修改该字符串的方法；</li><li><code>String</code> 类被 <code>final</code> 修饰导致其不能被继承，进而避免了子类破坏 <code>String</code> 不可变。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">String</span><br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;<br>    <span class="hljs-comment">/** The value is used for character storage. */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> value[];<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>注意：JDK9及后将保存字符串的数组由<code>char</code>改为了<code>byte</code></li></ol><p>详细参见：<a href="https://www.zhihu.com/question/20618891/answer/114125846" title="如何理解 String 类型值的不可变？">如何理解 String 类型值的不可变？</a></p><h4 id="1-2-既然String不可变那它是怎样实现修改的呢？"><a href="#1-2-既然String不可变那它是怎样实现修改的呢？" class="headerlink" title="1.2 既然String不可变那它是怎样实现修改的呢？"></a>1.2 既然<code>String</code>不可变那它是怎样实现修改的呢？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;1&quot;</span>;<br>s = <span class="hljs-string">&quot;2&quot;</span>;<br></code></pre></td></tr></table></figure><p>上述代码转换为字节码后</p><div align=center>    <img src="/2020/09/28/Java%E5%9F%BA%E7%A1%80/Java%E7%9A%84String%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/10004.jpg" class="" title="加载失败"></div><p>上述字节码表示会在字符串常量池中新建一个字符串并加载</p><h3 id="2-String拼接"><a href="#2-String拼接" class="headerlink" title="2 String拼接"></a>2 <code>String</code>拼接</h3><h4 id="2-1-拼接方式"><a href="#2-1-拼接方式" class="headerlink" title="2.1 拼接方式"></a>2.1 拼接方式</h4><p><code>String</code>有两种拼接字符串方法</p><ul><li><code>+</code>和<code>+=</code>拼接</li><li><code>StringBuilder</code>和<code>StringBuffer</code>的<code>append(String str)</code>方法，拼接完成后调用他们的<code>toString()</code>方法获得<code>String</code>对象</li></ul><p><strong>注意</strong>：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-built_in">String</span> 中的对象是不可变的，也就可以理解为常量，线程安全;<br><span class="hljs-built_in">StringBuffer</span> 对方法加了同步锁或者对调用的方法加了同步锁，所以是线程安全的。StringBuilder并没有对方法进行加<br>同步锁，所以是非线程安全的。<br></code></pre></td></tr></table></figure><h4 id="2-2-和-拼接的实质"><a href="#2-2-和-拼接的实质" class="headerlink" title="2.2 +和+=拼接的实质"></a>2.2 <code>+</code>和<code>+=</code>拼接的实质</h4><p>实际上<code>+</code>和<code>+=</code>是Java专门为<code>String</code>重载的运算符，java本身是不支持运算符重载的，<code>+</code>和<code>+=</code>也是 Java 中仅有的两个重载过的运算符</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zh&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str4</span> <span class="hljs-operator">=</span> str1 + str2;<br></code></pre></td></tr></table></figure><p>上述代码对应的字节码为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zh&quot;</span>;<br>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>()).append(str1).append(str2).toString();<br></code></pre></td></tr></table></figure><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56ab1aedc97546908c74352416442b09~tplv-k3u1fbpfcp-watermark.image" alt="2.png"><br>由字节码看出实际上是由<code>StringBuilder</code>实现拼接的</p><h4 id="2-3-注意"><a href="#2-3-注意" class="headerlink" title="2.3 注意"></a>2.3 注意</h4><p>有一点注意的是：在循环内最好不要用<code>+</code>和<code>+=</code>来拼接字符串，因为不会在循环外部创建一个<code>StringBuild</code>对象来进行复用，而是在每次循环是都会创建一个<code>StringBuild</code>对象，造成资源的浪费</p><h5 id="2-3-1-拼接"><a href="#2-3-1-拼接" class="headerlink" title="2.3.1 +=拼接"></a>2.3.1 <code>+=</code>拼接</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] arr = &#123;<span class="hljs-string">&quot;he&quot;</span>, <span class="hljs-string">&quot;llo&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>&#125;;<br><span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">for</span> (String value : arr) &#123;<br>    str += value;<br>&#125;<br></code></pre></td></tr></table></figure><p>字节码在循环体内部创建<code>StringBuild</code>对象：<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/851a6ceee3074ec8ba3c04de82f2afbd~tplv-k3u1fbpfcp-watermark.image" alt="Snipaste_2022-10-02_14-49-03.png"></p><h5 id="2-3-2-循环外部创建StringBuild对象"><a href="#2-3-2-循环外部创建StringBuild对象" class="headerlink" title="2.3.2 循环外部创建StringBuild对象"></a>2.3.2 循环外部创建<code>StringBuild</code>对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] arr = &#123;<span class="hljs-string">&quot;he&quot;</span>, <span class="hljs-string">&quot;llo&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>&#125;;<br><span class="hljs-type">StringBuilder</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><span class="hljs-keyword">for</span> (String value : arr) &#123;<br>    s.append(value);<br>&#125;<br></code></pre></td></tr></table></figure><p>字节码只创建了一个<code>StringBuild</code>对象<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc9bb12d712e47c1a57ea16fa96334b4~tplv-k3u1fbpfcp-watermark.image" alt="3.png"></p><h3 id="3-符串常量池"><a href="#3-符串常量池" class="headerlink" title="3 符串常量池"></a>3 符串常量池</h3><h4 id="3-1-什么是字符串常量池"><a href="#3-1-什么是字符串常量池" class="headerlink" title="3.1 什么是字符串常量池"></a>3.1 什么是字符串常量池</h4><p><strong>字符串常量池</strong> 是 JVM 为了提升性能和减少内存消耗针对字符串（String 类）专门开辟的一块区域，主要目的是为了避免字符串的重复创建。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;111&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;111&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;111&quot;</span>);<br><span class="hljs-comment">//str1和str2都是常量池中的地址，所以他们是相同的</span><br>System.out.println(str1 == str2); <span class="hljs-comment">//true</span><br><span class="hljs-comment">//str1是常量池中的地址，str3是堆内存中的地址</span><br>System.out.println(str1 == str3);  <span class="hljs-comment">//false</span><br></code></pre></td></tr></table></figure><p>注意：在 Jdk6 以及以前的版本中，字符串的常量池是放在堆的 Perm 区的，Perm 区是一个类静态的区域，主要存储一些加载类的信息，常量池，方法片段等内容，默认大小只有4m，一旦常量池中大量使用 intern 是会直接产生<code>java.lang.OutOfMemoryError: PermGen space</code>错误的。 所以在 jdk7 的版本中，字符串常量池已经从 Perm 区移到正常的 Java Heap 区域了。为什么要移动，Perm 区域太小是一个主要原因，当然据消息称 jdk8 已经直接取消了 Perm 区域，而新建立了一个元区域。应该是 jdk 开发者认为 Perm 区域已经不适合现在 JAVA 的发展了。</p><h4 id="3-2-String-s1-x3D-new-String-“111”-这句话创建了几个字符串对象？"><a href="#3-2-String-s1-x3D-new-String-“111”-这句话创建了几个字符串对象？" class="headerlink" title="3.2 String s1 &#x3D; new String(“111”);这句话创建了几个字符串对象？"></a>3.2 String s1 &#x3D; new String(“111”);这句话创建了几个字符串对象？</h4><p>答：会创建1个或两个对象</p><h5 id="3-2-1-如果常量池中不存在111字符串，那么该句子会创建两个对象，在堆区创建一个字符串对象，在常量池中创建一个对象"><a href="#3-2-1-如果常量池中不存在111字符串，那么该句子会创建两个对象，在堆区创建一个字符串对象，在常量池中创建一个对象" class="headerlink" title="3.2.1 如果常量池中不存在111字符串，那么该句子会创建两个对象，在堆区创建一个字符串对象，在常量池中创建一个对象"></a>3.2.1 如果常量池中不存在<code>111</code>字符串，那么该句子会创建两个对象，在堆区创建一个字符串对象，在常量池中创建一个对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;111&quot;</span>);<br></code></pre></td></tr></table></figure><p>对应的字节码：<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0faf1ff599714be0a1efb95ee1bda147~tplv-k3u1fbpfcp-watermark.image" alt="5.png"><br><code>ldc</code> 命令用于判断字符串常量池中是否保存了对应的字符串对象的引用，如果保存了的话直接返回，如果没有保存的话，会在堆中创建对应的字符串对象并将该字符串对象的引用保存到字符串常量池中。</p><h5 id="3-2-2-如果常量池中存在111字符串，那么该句子指挥创建一个对象，即在堆区创建一个字符串对象"><a href="#3-2-2-如果常量池中存在111字符串，那么该句子指挥创建一个对象，即在堆区创建一个字符串对象" class="headerlink" title="3.2.2 如果常量池中存在111字符串，那么该句子指挥创建一个对象，即在堆区创建一个字符串对象"></a>3.2.2 如果常量池中存在<code>111</code>字符串，那么该句子指挥创建一个对象，即在堆区创建一个字符串对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;111&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;111&quot;</span>);<br></code></pre></td></tr></table></figure><p>对应的字节码：<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7e67b6a73da54772bdc99dd383e65fbb~tplv-k3u1fbpfcp-watermark.image" alt="4.png"></p><p>第7行已经存在就不会再添加了</p><h4 id="3-3-String的intern方法"><a href="#3-3-String的intern方法" class="headerlink" title="3.3 String的intern方法"></a>3.3 <code>String</code>的<code>intern</code>方法</h4><p><code>String.intern()</code> 是一个 native（本地）方法，其作用是将指定的字符串对象的引用保存在字符串常量池中，可以简单分为两种情况：</p><ul><li>如果字符串常量池中保存了对应的字符串，就直接返回该引用</li><li>如果字符串常量池中没有保存对应的字符串，那就在常量池中创建一个指向该字符串对象的引用并返回</li></ul><p>示例代码（JDK 8） :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在堆中创建字符串对象”Java“</span><br><span class="hljs-comment">// 将字符串对象”Java“的引用保存在字符串常量池中</span><br><span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Java&quot;</span>;<br><span class="hljs-comment">// 直接返回字符串常量池中字符串对象”Java“对应的引用</span><br><span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> s1.intern();<br><span class="hljs-comment">// 会在堆中在单独创建一个字符串对象</span><br><span class="hljs-type">String</span> <span class="hljs-variable">s3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;Java&quot;</span>);<br><span class="hljs-comment">// 直接返回字符串常量池中字符串对象”Java“对应的引用</span><br><span class="hljs-type">String</span> <span class="hljs-variable">s4</span> <span class="hljs-operator">=</span> s3.intern();<br><span class="hljs-comment">// s1 和 s2 指向的是堆中的同一个对象</span><br>System.out.println(s1 == s2); <span class="hljs-comment">// true</span><br><span class="hljs-comment">// s3 和 s4 指向的是堆中不同的对象</span><br>System.out.println(s3 == s4); <span class="hljs-comment">// false</span><br><span class="hljs-comment">// s1 和 s4 指向的是堆中的同一个对象</span><br>System.out.println(s1 == s4); <span class="hljs-comment">//true</span><br><br></code></pre></td></tr></table></figure><p>摘自：<a href="https://javaguide.cn/java/basis/java-basic-questions-02.html#intern-%E6%96%B9%E6%B3%95%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8">Java Guide intern 方法有什么作用</a></p><p>更加详细的解释：<a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">深入解析String#intern</a></p><h3 id="4-常量折叠"><a href="#4-常量折叠" class="headerlink" title="4 常量折叠"></a>4 常量折叠</h3><h4 id="4-1-无final修饰"><a href="#4-1-无final修饰" class="headerlink" title="4.1 无final修饰"></a>4.1 无final修饰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zh&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span> + <span class="hljs-string">&quot;zh&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str4</span> <span class="hljs-operator">=</span> str1 + str2;<br></code></pre></td></tr></table></figure><p>字节码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zh&quot;</span>;<br><span class="hljs-comment">//直接拼接了</span><br><span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;szh&quot;</span>;<br>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>()).append(str1).append(str2).toString();<br></code></pre></td></tr></table></figure><p>常量折叠会把常量表达式的值求出来作为常量嵌在最终生成的代码中，这是 Javac 编译器会对源代码做的极少量优化措施之一(代码优化几乎都在即时编译器中进行)。</p><p>并不是所有的常量都会进行折叠，只有编译器在程序编译期就可以确定值的常量才可以：</p><ul><li>基本数据类型( <code>byte</code>、<code>boolean</code>、<code>short</code>、<code>char</code>、<code>int</code>、<code>float</code>、<code>long</code>、<code>double</code>)以及字符串常量。</li><li><code>final</code> 修饰的基本数据类型和字符串变量</li><li>字符串通过 “+”拼接得到的字符串、基本数据类型之间算数运算（加减乘除）、基本数据类型的位运算（&lt;&lt;、&gt;&gt;、&gt;&gt;&gt; ）</li></ul><p><strong>引用的值在程序编译期是无法确定的，编译器无法对其进行优化。</strong></p><h4 id="4-2-与final修饰"><a href="#4-2-与final修饰" class="headerlink" title="4.2 与final修饰"></a>4.2 与final修饰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zh&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span> + <span class="hljs-string">&quot;zh&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str4</span> <span class="hljs-operator">=</span> str1 + str2;<br></code></pre></td></tr></table></figure><p>字节码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zh&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;szh&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">str4</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;szh&quot;</span>;<br><span class="hljs-comment">//str3和str4都进行了折叠</span><br></code></pre></td></tr></table></figure><p>被 <code>final</code> 关键字修改之后的 <code>String</code> 会被编译器当做常量来处理，编译器在程序编译期就可以确定它的值，其效果就相当于访问常量。</p><p>详细介绍：<a href="https://www.zhihu.com/question/55976094/answer/147302764">常量折叠</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>Java Guide Java基础常见面试题总结(中) String &amp;nbsp;&amp;nbsp;&amp;nbsp;<a href="https://javaguide.cn/java/basis/java-basic-questions-02.html#string">https://javaguide.cn/java/basis/java-basic-questions-02.html#string</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java基础</tag>
      
      <tag>String</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java的深拷贝和浅拷贝</title>
    <link href="/2020/09/24/Java%E5%9F%BA%E7%A1%80/Java%E7%9A%84%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D/"/>
    <url>/2020/09/24/Java%E5%9F%BA%E7%A1%80/Java%E7%9A%84%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D/</url>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><strong>深拷贝</strong>：深拷贝会完全复制整个对象，包括这个对象所包含的内部对象。<br>​<br><strong>浅拷贝</strong>：浅拷贝会在堆上创建一个新的对象（区别于引用拷贝的一点），不过，如果原对象内部的属性是引用类型的话，浅拷贝会直接复制内部对象的引用地址，也就是说拷贝对象和原对象共用同一个内部对象。<br>​</p><h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><h4 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h4><p>我们实现<code>Cloneable</code>接口，重写<code>clone()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span>&#123;<br>    <span class="hljs-keyword">private</span> String addressName;<br>​<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">(String addressName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.addressName = addressName;<br>    &#125;<br>​<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAddressName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> addressName;<br>    &#125;<br>​<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddressName</span><span class="hljs-params">(String addressName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.addressName = addressName;<br>    &#125;<br>​<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Address <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>        <span class="hljs-keyword">return</span> (Address) <span class="hljs-built_in">super</span>.clone();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">&quot;长沙&quot;</span>));<br><span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> person.clone();<br>System.out.println(person == person1);  <span class="hljs-comment">//输出false</span><br>System.out.println(person.getAddress() == person1.getAddress()); <span class="hljs-comment">//输出true</span><br></code></pre></td></tr></table></figure><p>两个Address都指向同一块内存中的数据</p><h4 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h4><p>修改浅拷贝的<code>Person</code>类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span>&#123;<br>    <span class="hljs-keyword">private</span> Address address;<br>​<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(Address address)</span>&#123;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br>​<br>    <span class="hljs-keyword">public</span> Address <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br>​<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddress</span><span class="hljs-params">(Address address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br>​<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Person <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) <span class="hljs-built_in">super</span>.clone();<br>        person.setAddress(person.getAddress().clone());<br>        <span class="hljs-keyword">return</span> person;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Person person <span class="hljs-operator">=</span> new Person(new Address(<span class="hljs-string">&quot;长沙&quot;</span>))<span class="hljs-comment">;</span><br>Person person1 <span class="hljs-operator">=</span> person.clone()<span class="hljs-comment">;</span><br>System.out.println(person <span class="hljs-operator">=</span><span class="hljs-operator">=</span> person1)<span class="hljs-comment">;  //输出false</span><br>System.out.println(person.getAddress() <span class="hljs-operator">=</span><span class="hljs-operator">=</span> person1.getAddress())<span class="hljs-comment">; //输出false</span><br></code></pre></td></tr></table></figure><p>person1的address也已经被clone<br>​</p><h3 id="引用拷贝、浅拷贝、深拷贝三者区别"><a href="#引用拷贝、浅拷贝、深拷贝三者区别" class="headerlink" title="引用拷贝、浅拷贝、深拷贝三者区别"></a>引用拷贝、浅拷贝、深拷贝三者区别</h3><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d57e5bf73f054ad096e7364b1740cf82~tplv-k3u1fbpfcp-watermark.image" alt="shallow&amp;deep-copy.png"><br>​<br>惨考链接：<a href="https://javaguide.cn/java/basis/java-basic-questions-02.html#%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D%E5%8C%BA%E5%88%AB%E4%BA%86%E8%A7%A3%E5%90%97-%E4%BB%80%E4%B9%88%E6%98%AF%E5%BC%95%E7%94%A8%E6%8B%B7%E8%B4%9D">Java Guide 深拷贝和浅拷贝区别</a></p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java包装类型的缓存机制</title>
    <link href="/2020/09/21/Java%E5%9F%BA%E7%A1%80/Java%E5%8C%85%E8%A3%85%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/"/>
    <url>/2020/09/21/Java%E5%9F%BA%E7%A1%80/Java%E5%8C%85%E8%A3%85%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<p>Java中基本类型都有对应的包装类分别有：<code>Byte</code>、<code>Short</code>、<code>Integer</code>、<code>Long</code>、<code>Float</code>、<code>Double</code>、<code>Character</code>、<code>Boolean</code>。而它们大部分都用到了缓存机制来提升性能。<code>Byte</code>,<code>Short</code>,<code>Integer</code>,<code>Long</code> 这 4 种包装类默认创建了数值  <strong>[-128，127]</strong>  的相应类型的缓存数据，<code>Character</code> 创建了数值在  <strong>[0,127]</strong>  范围的缓存数据，<code>Boolean</code> 直接返回 <code>True</code> or <code>False</code>。<br>​</p><h3 id="Integer缓存源码"><a href="#Integer缓存源码" class="headerlink" title="Integer缓存源码"></a><strong>Integer缓存源码</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerCache</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">low</span> <span class="hljs-operator">=</span> -<span class="hljs-number">128</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> high;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer cache[];<br>​<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-comment">// high value may be configured by property</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">integerCacheHighPropValue</span> <span class="hljs-operator">=</span><br>            sun.misc.VM.getSavedProperty(<span class="hljs-string">&quot;java.lang.Integer.IntegerCache.high&quot;</span>);<br>        <span class="hljs-keyword">if</span> (integerCacheHighPropValue != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> parseInt(integerCacheHighPropValue);<br>                i = Math.max(i, <span class="hljs-number">127</span>);<br>                <span class="hljs-comment">// Maximum array size is Integer.MAX_VALUE</span><br>                h = Math.min(i, Integer.MAX_VALUE - (-low) -<span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">catch</span>( NumberFormatException nfe) &#123;<br>                <span class="hljs-comment">// If the property cannot be parsed into an int, ignore it.</span><br>            &#125;<br>        &#125;<br>        high = h;<br>​<br>        cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>[(high - low) + <span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> low;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; cache.length; k++)<br>            cache[k] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(j++);<br>​<br>        <span class="hljs-comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span><br>        <span class="hljs-keyword">assert</span> IntegerCache.high &gt;= <span class="hljs-number">127</span>;<br>    &#125;<br>​<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">IntegerCache</span><span class="hljs-params">()</span> &#123;&#125;<br>&#125;<br>​<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">valueOf</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>    <span class="hljs-keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)<br>        <span class="hljs-keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(i);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CharacterCache</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">CharacterCache</span><span class="hljs-params">()</span>&#123;&#125;<br>​<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Character cache[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Character</span>[<span class="hljs-number">127</span> + <span class="hljs-number">1</span>];<br>​<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; cache.length; i++)<br>            cache[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Character</span>((<span class="hljs-type">char</span>)i);<br>    &#125;<br>&#125;<br>​<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Character <span class="hljs-title function_">valueOf</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> &#123;<br>    <span class="hljs-keyword">if</span> (c &lt;= <span class="hljs-number">127</span>) &#123; <span class="hljs-comment">// must cache</span><br>        <span class="hljs-keyword">return</span> CharacterCache.cache[(<span class="hljs-type">int</span>)c];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Character</span>(c);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Boolean缓存源码"><a href="#Boolean缓存源码" class="headerlink" title="Boolean缓存源码"></a><strong>Boolean缓存源码</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title function_">valueOf</span><span class="hljs-params">(<span class="hljs-type">boolean</span> b)</span> &#123;<br>    <span class="hljs-keyword">return</span> (b ? TRUE : FALSE);<br>&#125;<br></code></pre></td></tr></table></figure><p>由源码可见，超出范围了仍然会创建对象，缓存的范围区间的大小只是在性能和资源之间的权衡。<br><code>Float</code>、<code>Double</code>没有缓存机制</p><h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Integer</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> <span class="hljs-number">33</span>;<br><span class="hljs-type">Integer</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> <span class="hljs-number">33</span>;<br><span class="hljs-comment">/*直接是使用的缓存中的对象*/</span><br>System.out.println(i1 == i2);<span class="hljs-comment">// 输出 true</span><br>​<br><span class="hljs-type">Float</span> <span class="hljs-variable">i11</span> <span class="hljs-operator">=</span> <span class="hljs-number">333f</span>;<br><span class="hljs-type">Float</span> <span class="hljs-variable">i22</span> <span class="hljs-operator">=</span> <span class="hljs-number">333f</span>;<br><span class="hljs-comment">/*Float没有缓存机制*/</span><br>System.out.println(i11 == i22);<span class="hljs-comment">// 输出 false</span><br>​<br><span class="hljs-type">Double</span> <span class="hljs-variable">i3</span> <span class="hljs-operator">=</span> <span class="hljs-number">1.2</span>;<br><span class="hljs-type">Double</span> <span class="hljs-variable">i4</span> <span class="hljs-operator">=</span> <span class="hljs-number">1.2</span>;<br><span class="hljs-comment">/*Double没有缓存机制*/</span><br>System.out.println(i3 == i4);<span class="hljs-comment">// 输出 false</span><br>​<br><span class="hljs-type">Integer</span> <span class="hljs-variable">i5</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;<br><span class="hljs-type">Integer</span> <span class="hljs-variable">i6</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">127</span>);<br><span class="hljs-comment">/*i5是用的缓存中的对象，i6是直接创建的对象*/</span><br>System.out.println(i5 == i6); <span class="hljs-comment">//输出false</span><br>​<br><span class="hljs-type">Integer</span> <span class="hljs-variable">i7</span> <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;<br><span class="hljs-type">Integer</span> <span class="hljs-variable">i8</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">128</span>);<br><span class="hljs-type">Integer</span> <span class="hljs-variable">i9</span> <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;<br>System.out.println(i7 == i8); <span class="hljs-comment">//输出false</span><br><span class="hljs-comment">/*i7、i9超出 -128~127 的范围了，都是创建的对象*/</span><br>System.out.println(i7 == i9);  <span class="hljs-comment">//输出false</span><br></code></pre></td></tr></table></figure><p>谨记: <strong>所有包装类型之间的值比较，尽量都要用equals</strong><br>​<br>参考链接：<br><a href="https://javaguide.cn/java/basis/java-basic-questions-01.html#%E5%8C%85%E8%A3%85%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E4%BA%86%E8%A7%A3%E4%B9%88">Java Guide 包装类型的缓存机制了解么？</a></p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
